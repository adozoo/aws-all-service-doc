
## AWS集中式日志存储架构

=== AWS集中式日志存储架构

> - 当前，在**绝大多数组织**中，**日志的管理**和**分析**都被列为是**非常核心的任务**。
> - 它**使组织能够更加了解业务运营情况**、**安全性**、**变更管理**、**各事件之间的关系**等，可**帮助持续**对整个组织的**架构运转情况全面的掌控**。
> - 一般来说，当讨论的是AWS时, 需要我们**关注的日志服务有** 像**``AWS Cloudtrail`` ,``VPC flow 日志``，``AWS Config日志``**，可能还会有来自**EC2的日志**等等
> - 因此，将所有AWS账户的日志**转发到一个作为**中央区域的账户的**S3存储桶**，**集中管理和存储**是非常有**必要的**。
> - 然后可以在这个**中心区域**分析整个组织的日志，也可以**使用splunk等工具**从S3存储桶中**获取日志**，**进行安全、审计、监控、排错等其他的需求分析**
> - 通过**单一的节点**实现所有管理的AWS账户的**日志存储、分析、监控需求**。

=== 实现集中日志架构注意事项

> - 首先，尽早**定义日志**所需**保留时间等要求**，以及**日志生命周期策略**，这对于您的组织在**遵循某种审计**、**合规政策时**显得**更加的重要**，对于不同的日志类型对应不同的日志保留要求是非常常见的。
> * 我们假设有一个日志**需要保留5年**，就要确保如果您把**日志存储**到了一个**集中的中央账户的S3存储桶**，你要确保**日志将在存储桶中保留5年且不会被自动删除**。
> - 同样，**生命周期策略**也是同样重要，尤其是出于**成本因素考虑的时候**。比如，当**组织的某个应用程序产生了重要的日志**，并需要**集中存储**时，数据**达到了TB级别**
> * 我们可以先**分析一下后续对于此日志的需求**，评估**后续日志的检索次数**和**对于检索时间的要求**，根据**这些需求**您可能**不需要一直将全部TB级别**的日志**放在S3存储桶**
> * 可以将大部分**日志转移至glacier满足**您的**需求并为您节省很多的成本**，这一点恰好就是**生命周期策略起到重要作用**的地方。
> - 第二个是生命周期策略要**自动化执行**，比如上面提到的程序日志，将产生时间在1个月内的日志保存在S3中，以便在程序出现问题或其他需要的时候**快速，高频进行检索**
> * 当在S3保留时间**超过1个月后**，将所有旧的应用程序日志**自动转移到glacier以节省大量的成本**。这些应该是**自动化执行**不需要我们人工去干预的。
> - 第三点是我们的系统要能够**自动化安装和配置日志传输代理程序**。
> * 假设你有ec2实例在autoscaling环境，在后半夜一个**新的ec2启动了**，你需要**确保这个新启动的实例的应用程序日志或者服务器日志**，也要**传输到S3存储桶中**。
> * 要实现这个需求，就需要**确保日志传输代理程序自动安装在了这个新启动的实例上**。取决于**不同的环境案例**，可以将其**在UserData实现**，或者也可以将它**集成在AMI中**。
> * 因为如果您**使用了autoscaling**，非常可能**发生的一个情况**是一个**EC2实例在后半夜因扩展规则自动启动**，然后在运行一段时间比如**当cpu使用率降低后这个新启动的实例又被终止了**，如果您**没有自动安装和配置日志传输代理程序**，那么这个新启动的实例上的**日志将会丢失**。
> - 最后一点是**确保您实现的解决方案支持混合云架构**。当前出于**安全考虑**企业更愿意**将数据存放在本地私有云中**，但是同时**又希望可以获得公有云的资源**
> * 在这种情况下，现在很多组织都在**朝着混合云架构方向发展**，既拥有**私有云**，又同时使用**多家公有云**，如AWS ，阿里云等，所以不管你采用的什么解决方案，确认它**支持混合云架构**。

=== AWS日志相关服务

> - **``AWS ElasticSearch Service``、``AWS S3``、``AWS CloudWatch Service`` 、``Kinesis Firehose``**等等

== 实验步骤

> - 使用**两个AWS账户**，把第一个账户作为**中央账户**，第二个账户作为**发送日志账户**。我们将第二个账户的**CloudTrail日志**集中**存储至中央账户的S3对应的存储桶中**。
> - 首先我们先来到**中央账户创建S3存储桶**
> - 菜单**导航到S3**，**创建S3存储桶**
> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域。
> - 顶部菜单**导航到 S3**

image::/图片/09图片/导航到S3.png[导航到S3]

> - 在 S3 页面上，单击**``创建存储桶``**并**填写存储桶详细信息**。
> - 桶名称：输入**``center-log-s3``**
> * 注意： S3 存储桶名称是**全局唯一**的，请**选择一个可用的名称**。
> - AWS 区域：选择**美国东部（弗吉尼亚北部）美国东部-1**
> - 将**其他设置保留**为默认值。
> - **创建存储桶按钮**
> - S3 **存储桶已创建**。

image::/图片/101图片/存储桶已创建.png[存储桶已创建]

---

=== 配置S3存储桶策略

> - 单击**``权限``**选项卡，然后**配置以下内容**
> * 向下滚动到**存储桶策略**，单击右侧的**编辑**按钮。
> * 此时将显示一个空白的**存储桶策略编辑器**。
> * 将存储桶的 ARN 复制到**剪贴板**。
> * 例如**``arn:aws:s3:::center-log-s3``**
> - 复制下方**整个策略**，将其粘贴到存储桶策略中，
> - 下面 JSON 中的 ``Resource`` **改为自己的存储桶ARN**

```json
  {
      "Version": "2012-10-17",
      "Statement": [
          {
              "Sid": "AWSCloudTrailAclCheck20150319",
              "Effect": "Allow",
              "Principal": {
                  "Service": "cloudtrail.amazonaws.com"
              },
              "Action": "s3:GetBucketAcl",
              "Resource": "arn:aws:s3:::center-log-s3"
          },
          {
              "Sid": "AWSCloudTrailWrite20150319",
              "Effect": "Allow",
              "Principal": {
                  "Service": "cloudtrail.amazonaws.com"
              },
              "Action": "s3:PutObject",
              "Resource": "arn:aws:s3:::center-log-s3/*",
              "Condition": {
                  "StringEquals": {
                      "s3:x-amz-acl": "bucket-owner-full-control"
                  }
              }
          }
      ]
  }
```

> - 点击**``保存更改``**按钮**。
> - 现在已**通过修改存储桶策略**的方式**允许其他AWS账户**发送日志到此**存储桶**中

---

=== 配置 CloudTrail 跟踪

> - 现在来到**发送日志信息的其他AWS账户中**
> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域
> - 通过菜单**导航到 CloudTrail**,单击**创建跟踪**。
> - 在创建跟踪下，输入以下**详细信息**：
> * 跟踪名称 ： 输入**``My_Cloud_Trail``**
> * 存储位置 ： 选择**``使用现有的 S3 存储桶``**
> ** 跟踪日志存储桶名称：输入中央账户**S3存储桶名称**
> * 日志文件 SSE-KMS 加密：**取消选中**已启用
> * 其他设置：
> ** 日志文件验证：**取消选中**已启用
> ** SNS 通知发送 ：将其**保留为默认值**

image::/图片/101图片/创建trail.png[创建trail]

> - CloudWatch Logs：将其**保留为默认值**
> - 单击**"下一步"**。
> - 选择**"日志事件"**：
> ** 将**所有内容保留为默认值**，然后单击**"下一步"**。
> * 查看并单击**创建跟踪**按钮。
> - 现已创建将日志传送到**中央 S3 存储桶**的** CloudTrail 实例**。

image::/图片/101图片/创建完成.png[创建完成]

---

=== 中央账户验证 S3 存储桶日志

> - AWS CloudTrail **捕获由 AWS 账户**或代表 AWS 账户进行的 **AWS API 调用**和**相关事件**，并将**日志文件**传送到**指定的 S3 存储桶**。
> - CloudTrail 通常在 **API 调用后 15 分钟内**交付**日志文件**，每小时多次发布**新的日志文件**，通常大约**每 5 分钟发布一次**。
> - 我们**来到中央账户**
> - 菜单**导航到S3**
> - 点击**进入我们刚刚创建的S3存储桶**
> - 可以**看到AWSLogs文件夹**

image::/图片/101图片/AWSLogs.png[AWSLogs]

> - 单击并依次打开存储桶中的**文件夹**。
> - 您可以看到其他账户在**中央存储桶**中创建的**日志信息**。

image::/图片/101图片/查看对象.png[查看对象]

---
