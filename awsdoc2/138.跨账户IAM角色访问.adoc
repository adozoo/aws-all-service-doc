## 跨账户IAM角色访问

=== 身份账户体系结构

==== 由单一AWS账户发展成多个，带来的管理问题

> - 现在很多**创业型**以及**小、中型企业**使用**AWS是从一个单一的AWS账户开始的**，如果**您只有一个AWS账户，管理任务就变的简单多了**
> - 假设有**一个开发人员``zhangsan``**想要访问这个 AWS账户，只需要**给``zhangsan``建立一个IAM用户和密码**，如业务需要你**可以继续为其创建一个访问密钥**，这样**即可满足需求**
> - **如果``zhangsan``离职了**，您可以**禁用其用户和密码**，然后**停用访问密钥**，这部分**管理任务非常的简单**
> - 然而当**组织逐步发展壮大后**，管理AWS账户将变的**相当有挑战性**。假设我们企业**由1个AWS账户发展的到了4个账户**，**ACCOUNT A、B、C、D**
> - 同样， 我们假设这个**开发人员``zhangsan``**有业务需要**访问这4个AWS账户的资源**，那么常规的**做法是在ACCOUNT A、B、C、D**分别为**开发人员``zhangsan``创建IAM用户**
> - 而且要在这4个账户中分别为这个**开发人员zhangsan建立访问密钥**
> - 假设开发人员**``zhangsan``离开组织了**，您需要分别**登录这4个AWS账户**，**禁用 ``zhangsan``的IAM用户**，并在每一个AWS账户中**停用访问密钥**
> - 这肯定**不是一个理想的管理方式**。因为**随着组织的逐步发展**，可能有**几十、几百个员工需要使用AWS**，需要**创建和管理用户**，您肯定**不希望每天的工作都是在添加、管理IAM用户**

image::/图片2/138图片/身份账户体系结构1.png[身份账户体系结构1]

=== 中央身份账户体系

> - 为了**解决这个管理问题**，您**需要中央身份账户体系**。在组织中**设置一个独立的**、**专用的AWS账户**，作为**身份账户（Identity Account）**
> - 在这个**身份账户中**，集中为您的**组织建立用户**、**密码以及访问密钥、管理用户**
> - 假设我们也已经为**身份账户**和组织拥有的**其他AWS账户建立了信任策略**，并**完成了相应的配置**
> - 在前面提到的这个**多AWS账户场景下**，只需要在**作为身份账户（Identity Account）的AWS账户下**，为**开发人员``zhangsan``建立IAM用户**
> - 然后**只需要使用``zhangsan``登录身份账户**，就可以**切换并登录其他不同的AWS账户A、B、C、D，访问其他AWS账户中的资源**，当然**取决于``zhangsan``拥有的权限**
> - 在中央身份账户体系下，如果**一个新的员工加入您的组织**，所有您要做的你**只需要将他加入这个身份账户（Identity Account）中**
> - 如果他**离开组织**，你也**只需要将他从这个身份账户（Identity Account）中移除即可**
> - 如果他**忘记密码**，您也只需要在**这个身份账户中重置他的密码即可**。所以，用户管理任务在这个中央账户体系中将会**变的非常容易**。因为您**只需要在作为身份账户**的AWS账户中**集中管理用户**

image::/图片2/138图片/中央身份账户体系.png[中央身份账户体系]

== 实验步骤

=== 首先需要准备两个 AWS 账户

> - 一个**作为身份账户（Identity Account）**，另一个账户**作为生产环境账户**
> - 我们在**身份账户中创建开发人员用户``shangsan``**，并且**不会在生产环境账户中创建这个用户**。
> - 我们看下**``zhangsan``这个用户在登陆身份账户（Identity Account）的情况下**，**切换至生产环境账户下的角色``CA-TEST``**
> - 并**拥有生产环境账户下的S3存储桶的完全访问权限**。
> - 通过这种方式实现了通过**中央身份账户统一**、**集中管理所有用户**，通过**切换至其他AWS账户下的角色**，定义**角色权限策略**，访问**其他AWS账户下的资源**。

==== 实现中央身份账户体系的演示主要有三个步骤：

> - 在**身份账户**中**创建一个开发用户**，**IAM用户名为``zhangsan``**。
> - 在**生成环境账户**中创建一个**跨账户角色**：**``CA-TEST``**
> - 在**身份账户**中**配置允许用户``zhangsan``**切换到**生产环境账户的``CA-TEST``角色**。

---

=== 创建zhangsan用户

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域
> - 顶部菜单**导航到 IAM**
> - 单击**``添加用户``**该按钮以**创建新的 IAM 用户**。

image::/图片/59图片/创建用户.png[创建用户]

> - 在**添加用户**部分，**设置用户详细信息**：
> - 用户名：**``zhangsan``**
> - 在选择 **AWS 访问类型**部分，选择 **AWS 凭证类型**为**``密码 - AWS 管理控制台访问``**

image::/图片2/138图片/添加用户.png[添加用户]

> * 单击**下一步**
> - 设置权限：现在，您可以看到**策略列表**。
> - 在这里您**无需添加任何权限策略**
> - 现在点击 **下一页：标签**按钮。**无需更改**
> - 单击**"下一步：审核"**按钮。
> - **查看选择是否有误**，然后单击**"创建用户"**。
> - 会得到**账户登录密码信息**
> - 请**保存好它**

---

=== 创建生产账户角色，并分配S3存储桶权限

> - 在**生产环境账户**中**创建一个跨账户角色**
> - 切换到**生产环境账户**
> - 导航到**``IAM``**
> - 在**左侧菜单**中，单击``角色`` 。单击``创建角色``该按钮以**创建新的 IAM 角色**。
> - 在创建角色部分，为角色选择**可信实体类型**：
> * **AWS 账户**
> * **AWS 账户:另一个 AWS 账户**
> * **账户 ID:输入zhangsan所在的``身份账户的ACCOUNT ID``**

image::/图片2/138图片/创建IAM.png[创建IAM]

> * 单击**下一步**
> - 添加权限：现在，您可以看到**策略列表**。按名称**``AmazonS3FullAccess``**搜索权限并**添加**。
> - 单击**下一步**
> - 角色名称：输入 **``CA-TEST``**
> - 您**已成功**按名称 CA-TEST 创建了一个 IAM 角色。
> ** 注意：您可以使用**其他名称创建角色**
> * 点击新创建的角色**``CA-TEST``**，可以看到目前该**角色只有一个``AmazonS3FullAccess``的访问策略**
> * **信任关系**:**委托人``Principal``**指定了**可承担该角色的对象**，就是**我们的zhangsan所在的``身份账户的ARN``**，**允许执行``sts:AssumeRole``动作**

image::/图片2/138图片/信任关系.png[信任关系]

---

=== 配置zhangsan承担角色权限

> - 在**身份账户**中**配置允许用户``zhangsan``承担生产环境账户的``CA-TEST`` 角色**。
> - 切换到**身份账户**
> - 顶部菜单**导航到 IAM**
> - 单击**``zhangsan用户``**，我们**添加一个内联策略**
> - 选择**JSON选项卡**，**复制粘贴下方代码**
> * **修改``Resource``为生产账户的``CA-TEST``的角色ARN**

```json
{
  "Version": "2012-10-17",
  "Statement": {
    "Effect": "Allow",
    "Action": "sts:AssumeRole",
    "Resource": "arn:aws:iam::174527162356:role/CA-TEST"
  }
}
```

> - **整体策略的内容**是**允许用户承担生产账户的这个角色**。

image::/图片2/138图片/承担生产账户的这个角色.png[承担生产账户的这个角色]

> - 下一步**查看策略**，然后策略**名称输入``CA-TEST``**，然后点击**创建策略**。

---

=== 测试

> - 首先，我们**使用IAM用户``zhangshan``登陆身份账户**。账户填写**身份账户的账户ID**，用户名**为``zhangsan``，填写对应zhangsan的密码**。

image::/图片2/138图片/登陆身份账户.png[登陆身份账户]

> - 我们在**生产账户的CA-TES角色摘要中找到``切换链接``**
> * 例如：**``https://signin.awTs.amazon.com/switchrole?roleName=CA-TEST&account=174527162356``**

image::/图片2/138图片/切换链接.png[切换链接]

> - 复制到**身份账户的浏览器中进行访问**
> - 接下来将**进入到切换角色页面**，其中账户为**生产环境账户**
> - 角色为我们在生产环境账户中**已经建立的CA-TEST角色**。
> - 在**显示名称**输入框我们输入**生产账户**，这样**标识会看着比较清楚**，然后**点击切换角色**按钮。

image::/图片2/138图片/标识.png[标识]

> - 点击**切换角色**后**实际发生的是身份账户的``zhangsan``用户**，已经**登录到了生产环境账户**
> - 且已经**切换成为我们在生产环境账户中创建的角色``CA-TEST``**。管理控制台**右上角的图标**可以看到这**已经是登陆到生产环境账户了**

image::/图片2/138图片/已经是登陆.png[已经是登陆]

> - 我们**测试下访问下S3存储桶**，**没有问题**。

image::/图片2/138图片/访问下S3.png[访问下S3]

> - **目前用户``zhangsan``已经可以通过登陆身份账户**，然后**通过跨AWS账户角色访问的方式**，**拥有生产环境账户中的S3存储桶资源的完全访问权限了**。
> - 在AWS管理控制台点击**生产账户—返回**,将会从**生产账户**的角色**返回到身份账户的``zhangsan``环境中**。

image::/图片2/138图片/返回.png[返回]

> - **``zhangsan``如需再次访问生产账户的S3存储桶**，只需要在**控制台右上角的角色历史记录中**，再次**选择生产账户**即可**直接切换至生产账户角色**，**非常方便**

image::/图片2/138图片/直接切换.png[直接切换]

> - 我们**用了两个AWS账户实操配置并演示了在不同的账户间实现跨账户角色访问**，这在**企业有多个AWS的场景下**
> - **提供了用户权限的集中化管理和控制**，并当有访问**其他账户资源需求时**，通过**跨账户角色访问的方式**，**避免了来回切换账户带来的繁琐操作**。

---
