
## AWS Organizations简介

=== 什么是AWS Organizations？

> - AWS Organizations 是**一项账户管理服务**，使您能够将**多个 AWS 账户**整合到您**创建并集中管理的组织中**。
> - 包含**账户管理**和**整合账单**功能，可利用这些功能**更好地满足企业的预算**、**安全性**和**合规性**需求。

=== AWS Organizations的主账户和成员账户

> - 主账户是**创建组织的AWS账户**，你在一个**AWS账号中创建了组织**，那么这个**AWS账号就是主账户**
> * 在主账户中**可以进行创建账户**，**邀请其他账户加入组织**、**删除账户**，将策略**应用到组织内的实体**，比如（根、OU 或者账户）等；
> - 那**成员账户**是什么呢，**加入了组织**，**属于组织的其他账户**称为**成员账户**。这是**主账户和成员账户的概念**。

=== AWS Organizations两个功能集

==== AWS Organizations可用的功能集，主要有两个：

> - 提供了**所有功能** – 这是AWS Organizations 可用的**默认功能集**。它包括**整合账单的所有功能**，此外还**包括高级功能**，可让您**更好地控制组织中的账户**。
> * 例如，当启用了**所有功能**时，组织的**主账户**将**能够完全控制成员账户**可以执行的操作。
> * 主账户可以**应用 SCP 来限制成员账户**中的**用户和角色**可以访问的**服务和操作**，这里**限制的用户包括根用户在内**。
> - **整合账单功能** – 您可以使用组织的**主账户整合**和**支付所有成员账户**。它不包括上面**提到的使用策略限制**不同账户中的**用户和角色**可以执行的操作。要使这些功能，您必须**启用组织中的所有功能**。

=== 服务控制策SCP（Service control policy）

> - 我们还是拿**两个AWS账户来举例**（下图）左边的账户，我们在这个**账户创建了组织**，所以是**主账户**，右边的账户是**已经加入了组织的成员账户**。
> - 当我们**创建了组织**后，会自动**创建一个根**，也就是**ROOT**，它是**组织所有账户的父容器**，什么意思呢，如果将**策略附加到根**，则它**应用于组织中的所有OU和账户**。
> - 那**服务控制策略**都能**应用到组织的哪些地方**呢：
> * 可以用到到 **根** – **应用到根的策略会应用于组织中的所有账户**
> * 还可以应用到 **OU** – **应用于 OU 的策略会应用于 OU 及其任何子 OU 中的所有账户**
> * 也可以直接应用到 **账户**，就是我们这个例子 – **应用于账户的策略仅应用于这一个账户**
> - 我们举例说明下，我们**假设在主账户中定义了策略**，策略的内容是**禁止访问S3服务**，我们将它**应用到这个成员账户**，将会**发生什么**呢？
> * 应用之后，在**成员账户**中，**所有用户将不能访问S3的任何功能**，**即使**是这个**成员账户的根用户**，**也没有任何S3的权限**。

image::/图片/100图片/SCP.png[SCP]

== 实验步骤

> - 首先来到**主账户**的AWS Organizations**管理控制台**，也就是我们**现在当前登陆的账户**
> - 导航到**``AWS Organizations``**
> - 点击**创建组织**按钮

image::/图片/100图片/创建组织.png[创建组织]

> - 创建组织后将会跳转到**组织页面**

image::/图片/100图片/组织页面.png[组织页面]

> - 登录您的电子邮件以**确认验证信息**。
> - 通过左侧面板点击**邀请**可以**邀请其他AWS账户加入到组织中**
> - 选择**邀请现有 AWS 账户选项**
> * **输入被邀请的AWS账户邮件地址或账户ID**
> * 点击**发送邀请**按钮以发送邀请

image::/图片/100图片/发送邀请.png[发送邀请]

==== 被邀请AWS账户

> - 来到**被邀请的AWS账户下**，通过菜单导航到**``AWS Organizations``**
> - 点击**查看一个邀请**按钮，并点击**接受邀请**以**加入主账户的 Organizations 组织**

image::/图片/100图片/接受邀请.png[接受邀请]

> - 现在被邀请AWS账户**已成功加入**主账户 Organizations 组织

image::/图片/100图片/已成功加入.png[已成功加入]

> - 现在通过菜单**导航到S3**，**创建S3存储桶**
> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域。
> - 顶部菜单**导航到 S3**

image::/图片/09图片/导航到S3.png[导航到S3]

> - 在 S3 页面上，单击**``创建存储桶``**并**填写存储桶详细信息**。
> - 桶名称：输入**``mys3buckettestingorganizations``**
> * 注意： S3 存储桶名称是**全局唯一**的，请**选择一个可用的名称**。
> - AWS 区域：选择**美国东部（弗吉尼亚北部）美国东部-1**
> - 将**其他设置保留**为默认值。
> - **创建存储桶按钮**
> - S3 **存储桶已创建**。

image::/图片/100图片/存储桶已创建.png[存储桶已创建]

> - 并且现在可以**成功列出S3存储桶资源**

---

=== 主账户

> - 回到主账户，可以看到刚刚**邀请的AWS账户**已经**成功加入到Organizations 组织中**

image::/图片/100图片/加入到Organizations.png[加入到Organizations]

> - 现在**管理员账户**打开**服务控制功能**
> - 左侧面板点击**策略**，选择**服务控制策略**
> - 点击**启用服务控制策略**按钮

image::/图片/100图片/启用服务控制策略.png[启用服务控制策略]

> - 我们现在**选择成员账户**，然后查看**它的策略**，点击**成员账户**后在下面的**策略选项**卡，我们看一下：
> - 可以看到成员账户**已附加了策略**，**``FullAWSAccess``**，这个是**默认存在的策略**

image::/图片/100图片/默认存在的策略.png[默认存在的策略]

> - 我们现在**测试Organizations 服务控制功能**
> - 左侧面板点击**策略**，选择**服务控制策略**
> - 点击**创建策略**按钮
> * 策略名称：**``denyS3``**
> * 策略描述-可选：**``保持默认``**
> * 标签：**``保持默认``**
> - 下方JSON策略选项中**删除存在的策略代码**
> - **复制粘贴以下策略**进行更新

```json
  {
      "Version": "2012-10-17", 
      "Statement": [
          {
              "Sid": "Statement1", 
              "Effect": "Deny", 
              "Action": [
                  "s3:*"
              ], 
              "Resource": [
                  "*"
              ]
          }
      ]
  }
```

> - 最后点击**创建策略**按钮
> - 现在可以**将``denyS3``策略**附加至**成员账户以测试服务控制**
> - 回到上一级菜单**点击成员账户**
> - 策略选项卡中点击**附加**按钮
> - **选中``denyS3``策略**，单击**附加策略**为**成员账户**添加**禁止访问S3权限策略**

image::/图片/100图片/附加策略.png[附加策略]

==== 成员账户验证

> - 现在回到**成员账户**中进行验证，通过菜单**导航到S3**
> - 可以发现**成员账户**直接**处于无法列出S3存储桶的状态**
> - 即使**成员账户**是使用的**根账户进行登录的**

image::/图片/100图片/无法列出S3.png[无法列出S3]

> - 证明**我们前面的添加的服务控制策略**已经**生效**了

==== 结论：当AWS Organizations的**主账户**将**服务控制策略内容**为禁止S3访问的策略**分配给成员账户**后，即便是**成员账户的ROOT用户**，也会**受到策略限制**，**无法访问S3服务**

---
