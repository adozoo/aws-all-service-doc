
## SQS 可见性超时和延迟队列

=== 架构图

image::/图片2/104图片/架构图.png[架构图]

== 实验步骤

=== 创建 IAM 角色

> - 导航到**``IAM``**
> - 在**左侧菜单**中，单击**``角色``** 。单击**``创建角色``**该按钮以**创建新的 IAM 角色**。
> - 在**创建角色**部分，为角色选择**可信实体类型**：
> * **AWS 服务**
> * **使用案例:Lambda**

image::/图片/09图片/IAM创建角色2.png[IAM创建角色2]

> * 单击**下一步**
> - 添加权限：现在，您可以看到**策略列表**。按名称**``AmazonSQSFullAccess``**搜索权限并添加。
> - 单击**下一步**
> - 角色名称：输入 **``Lambda_sqs_fullaccess``**
> - 您**已成功**按名称 Lambda_sqs_fullaccess 创建了一个 IAM 角色。
> * 注意：您可以使用**其他名称创建角色**，然后将其**附加到 Lambda 函数**

---

=== 创建 SQS 队列

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域
> - 顶部菜单**导航到 SQS**，单击**创建队列**按钮。
> - **详细信息**：
> * 类型 ： 选择**``标准``**
> * 名称 ： 输入**``awslabs-sqs``**
> * 配置 ：
> ** 可见性超时 ：输入**``1 分钟``**
> - 将所有内容**保留为默认值**，然后单击**创建队列**按钮

image::/图片2/104图片/创建队列.png[创建队列]

> - 单击**“创建队列”**后，您将收到**一条成功消息**。
> - 现在**复制详细信息**下的**队列 URL **并将其放在文本编辑器中，我们将在**创建 Lambda 函数时使用它**。

---

=== 创建 Lambda 函数

> - 确保您位于**美国东部（弗吉尼亚北部）区域**。
> - 转到菜单，然后单击 **Lambda**。

image::/图片/09图片/导航到Lambda.png[导航到Lambda]

> - 单击**创建函数**该按钮。
> - 选择**``从头开始创建``**
> - 函数名称：输入 **``my_sqs_Lambda``**
> - 运行时：**``Python 3.9``**
> - 角色：在权限部分中，单击**"更改默认执行角色"**，然后单击**"使用现有角色"**。
> - 现有角色：选择**``Lambda_sqs_fullaccess``**
> - 点击**创建函数**该按钮。
> - 配置页面：在此页面上，我们需要**配置我们的 Lambda 函数**。
> - 向下滚动，可以看到**"代码源"**部分。
> - **删除 lambda_function.py 中的现有代码**。
> - 复制以下代码并将其**粘贴到您的 ``lambda_function.py`` 文件中**。

```py
  import json
  import boto3
  def lambda_handler(event, context):
      try:
          sqsClient = boto3.client("sqs", region_name="us-east-1")
          try:
              response = sqsClient.receive_message(
                  QueueUrl="<your Queue URL>",
                  AttributeNames=['All'],
              )
              print(response)
              return response
          except Exception as e:
              print("Get queue message failed because ", e)
      except Exception as e:
          print("Client connection to SQS failed because ", e)
```

> - 注意： 请**粘贴您复制**并放置在**文本编辑器中的 SQS 队列 URL**，**修改上方代码**。
> - 通过单击**“部署”**按钮来**保存函数**。
> - 现在，单击**“测试”**按钮“，事件名称”：输入**``LambdaTest``**，然后单击**“创建”**按钮。

---

=== 发送可见性超时的消息

> - 转到 SQS 队列**浏览器选项卡**。
> - 单击右上角的**发送和接收消息**按钮。
> - 在**“发送消息”**下：
> * 消息正文：输入**``Test Visibility timeout``**
> - 点击**发送消息**按钮。
> - 现在**转到 Lambda 函数**浏览器选项卡。
> - 单击函数的**“测试”**按钮，然后**检查 Lambda 函数执行输出**。
> - 您将能够在队列中看到您**发送的消息**，如下所示。

image::/图片2/104图片/1.png[1]

> - 现在再次单击**“测试”**按钮并**检查 Lambda 输出**。
> - 您将**无法看到该消息**，这是因为**一旦 Lambda 函数（使用者）收到该消息**。可见性超时开始，您已将其**设置为 1 分钟**。

image::/图片2/104图片/2.png[2]

> - 在 1 分钟内，该消息在**使用者要接收的队列中将不可用**。这是**可见性超时设置的内容**。
> - 尝试在 **1 分钟后测试 Lambda 函数**，您将能够**再次收到该消息**。

image::/图片2/104图片/3.png[3]

---

=== 清除队列

> - **导航到 SQS 浏览器选项卡**。
> - 现在点击**清除**按钮。
> - 在确认框中输入**清除**，然后单击**“清除”**按钮。
> - 清除将**删除队列中存在的所有消息**。

---

=== 发送交付延迟的消息

> - 单击右上角的**发送和接收消息**按钮。
> - 在**“发送消息”**下：
> * 消息正文：输入**``Test delivery delay``**
> - 交付延迟：输入**``30秒``**
> - 点击**发送消息**按钮。
> - 现在**转到 Lambda 函数浏览器选项**卡。
> - 单击函数的**“测试”**按钮，然后**检查 Lambda 函数执行输出**。

image::/图片2/104图片/4.png[4]


> - **消息不可用**，因为我们**添加**了将消息**传递给使用者的延迟（Lambda 函数）**
> - 现在**等待 30 秒**，然后再次**单击函数**的**“测试”**按钮并**检查 Lambda 函数执行输出**。

image::/图片2/104图片/5.png[5]

---
