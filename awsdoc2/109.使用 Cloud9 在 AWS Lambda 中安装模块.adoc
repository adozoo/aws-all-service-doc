
## 使用 Cloud9 在 AWS Lambda 中安装模块

=== 个案研究

> - 在**使用 Lambda 时**，我们**需要在代码**中**使用大量包**，其中一些包**在 Lambda 函数中不可用**。这些称为**附加依赖项**。
> - **请求模块**是当今下载量最大的**Python软件包之一**，根据GitHub的数据，每周**约有1400万次下载**。
> - 我们将**使用 Cloud9 将请求模块添加到 Lambda 函数中**。
> - 您还可以在**本地计算机终端**或**使用 AWS Powershell 执行此实验**，并将**部署包**上传到 Lambda 函数。

=== 架构图

image::/图片2/109图片/架构图.png[架构图]

== 实验步骤

=== 创建 Lambda 函数

> - 确保您位于**美国东部（弗吉尼亚北部）区域**。
> - 转到菜单，然后单击 **Lambda**。

image::/图片/09图片/导航到Lambda.png[导航到Lambda]

> - 单击**创建函数**该按钮。
> - 选择**``从头开始创建``**
> - 函数名称：输入 **``install_request_module``**
> - 运行时：**``Python 3.9``**
> - 角色：在权限部分中，单击**"更改默认执行角色"**，然后单击**"创建具有基本 Lambda 权限的新角色"**。
> - 点击**创建函数**该按钮。
> - 配置页面：在此页面上，我们需要**配置我们的 Lambda 函数**。
> - 向下滚动，可以看到**"代码源"**部分。
> - **删除 lambda_function.py 中的现有代码**。
> - 复制以下代码并将其**粘贴到您的 ``lambda_function.py`` 文件中**。

```py
  import json
  import requests
  def lambda_handler(event, context):
      r = requests.get('https://github.com') 
      print(r.status_code)
      print(r.headers['Date'])
      print(r.headers['server'])
      return {
          'statusCode': 200,
          'body': json.dumps('success')
      }
```

> - 通过单击**“部署”**按钮来**保存函数**。
> - **代码说明**：
> * 将**请求 python 模块**导入到代码中
> * **对 github URL 进行 HTTP 请求**
> * **打印连接状态**、**服务器日期**和**服务器名称**。
> - 现在，单击**“测试”**按钮，然后单击**“配置测试事件”**。
> * 事件名称 ： 输入**``TestCode``**
> * 事件模板 ： 选择**``hello-world``**
> * 单击**“保存”**按钮。
> - 现在**再次**单击**“测试”**按钮，您将在**“执行结果”**中收到以下**错误消息**。

image::/图片2/109图片/错误消息.png[错误消息]

> - 这是因为**请求模块**在 Lambda 中**不可用**，因此我们**需要安装此库包来运行此代码**。

---

=== 创建 AWS Cloud9 开发环境

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域。
> - 顶部菜单**导航到 Cloud9**
> - 点击**“创建环境”**按钮。
> - 在**“名称环境”**页上，对于**“名称”**，输入**环境的名称**。
> * 名称：输入**``aws_lambda_env``**
> - 要向环境**添加描述**，请在描述中**输入**。
> * 描述： 输入**``Creating a new Cloud9 Environment for Lambda``**
> - 选择**“下一步”**。

image::/图片2/109图片/描述.png[描述]

> - 在**配置设置**页面，环境类型，选择**``Create a new EC2 instance for environment (direct access)``**。
> - 对于**实例类型**，选择**``t2.micro （1 GiB RAM + 1 vCPU）``**。

image::/图片2/108图片/实例类型.png[实例类型]

> - 在**平台**下，选择 Amazon EC2 实例的类型为**``Amazon Linux 2（推荐）``**。AWS Cloud9 创建实例并将其**连接到环境**。
> - 在**“节省成本”**设置下，将其**保留为默认值**。

image::/图片2/108图片/平台.png[平台]

> - 将**“网络设置（高级）”**保留为默认值。单击**“下一步”**。
> - 在**“查看”**页上，点击**“创建环境”**。**等待 AWS Cloud9 创建您的环境**。这可能**需要几分钟时间**。
> - AWS Cloud9 **创建您的环境后**，将显示该**环境的 AWS Cloud9 IDE**。
> - 如果 AWS Cloud9 在**五分钟后未显示 IDE**，则**您的 Web 浏览器或实例**可能存在问题。

---

=== 将 Lambda 函数导入 Cloud9

> - **环境准备就绪后**。
> - 在左侧，您可以看到环境**aws_lambda_env文件夹**。
> - 现在在**左侧单击AWS图标**，单击**美国东部（弗吉尼亚北部）**，然后单击**Lambda**。
> - 现在选择**``install_request_module``**，右键单击它并选择**下载**。
> - 它要求为**您的新项目选择一个工作区文件夹**，只需**按键盘上的 [Enter] 键**即可。
> - 现在，您在 Lambda 函数中保存的 Lambda 代码**在 Cloud9 环境中可用**。

image::/图片2/109图片/下载.png[下载]

> - 现在点击**文件夹**图标。
> - 在文件夹**层次结构**中，您将**能够看到** Lambda 函数名称**``install_request_module``**创建的**文件夹**。

image::/图片2/109图片/文件夹.png[文件夹]

---

=== 安装请求模块并下载

> - 现在选择**``install_request_module``**文件夹，然后右键单击并选择**打开终端**。
> - 此操作将会在 Lambda 函数文件夹路径中**打开了一个 ``bash`` 窗口**。
> - 运行**以下命令**，在 Lambda 函数模块中**安装请求 python 模块**。
> * 语法 ： **``pip install --target ~/environment/<Your lambda function name>/ request``**
> * 示例 ： **``pip install --target ~/environment/install_request_module/ requests``**
> - 现在，在**左侧模块**中，您将能够看到**请求模块**已安装在 Lambda 函数名称的**文件夹**中。

image::/图片2/109图片/已安装在.png[已安装在]

> - 运行以下**命令以压缩 Lambda 函数名称的文件夹中的所有文件和文件夹**
> * 语法 ： **``zip -r ../<zip folder name>.zip *``**
> * 示例 ： **``zip -r ../my-deployment-package.zip *``**
> - 现在，您将**能够看到在 Lambda 函数名称的**文件夹中**创建的 zip 文件**。

image::/图片2/109图片/创建的.png[创建的]

> - 右键**单击在上述步骤中创建的Zip文件``my-deployment-package``**，然后单击下载选项。
> - 现在，Zip文件**将下载到您的本地计算机**。

---

=== 上传部署包并进行测试

> - **打开 Lambda 控制台**
> - 从左侧菜单导航到**您的函数**。
> - 单击**您的 Lambda 函数名称**，即**``install_request_module``**。
> - 向下滚动到**“代码源”**部分，然后单击**上传自**按钮，然后选择**“.zip文件”**。
> - 点击**上传**按钮。
> - 现在，从**本地计算机中**选择zip文件**``my-deployment-package.zip``**然后单击**打开**按钮。
> - 最后点击**保存**按钮。
> - 现在，整个部署包已**添加到 Lambda 函数中**。

image::/图片2/109图片/添加到.png[添加到]

> - 再次单击**“测试”**按钮，您将在**执行结果**中收到以下**成功消息**。

image::/图片2/109图片/成功消息.png[成功消息]

> - 现在，我们已经**成功地将请求模块安装到 Lambda **并**成功运行了代码**。像这样，您可以在 Lambda 函数中**安装任何外部依赖项**。

---
