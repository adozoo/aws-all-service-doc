
## AWS 中使用 WAF阻止Web 流量

=== WAF（网络应用防火墙）

> - AWS WAF 是**一种 Web 应用程序防火墙**，可帮助您**保护 Web 应用程序**免受可能影响可用性和**危害安全性的常见 Web 漏洞的攻击**。
> - 借助 AWS WAF，您可以**创建安全规则来阻止 SQL 注入**和**跨站点脚本**等常见攻击模式，从而**控制流量到达应用程序的方式**。
> - 它仅**允许请求根据您定义的规则或模式到达服务器**。
> - WAF 的成本**仅针对您使用的内容**。
> - 定价**取决于您部署的规则数**以及**应用程序收到的 Web 请求数**。
> - 例如，您可以**在 Amazon CloudFront 上部署 AWS WAF**，并在**您的 Web 服务器**或 EC2 上运行的**服务器前面部署应用程序负载均衡器**。

=== WAF 的特点

> - 使用**自定义规则**进行 Web **流量筛选**
> * 您可以**创建自己的规则**，具体**取决于您的需求**，即是**阻止还是允许传入和传出请求**。您还可以**自定义 Web 请求**中**显示的字符串**。
> - **阻止恶意请求**
> * 您还可以**在 AWS WAF 中配置规则**，以**识别和阻止 SQL 注入**和**跨站点脚本**等 Web 请求**威胁**。
> - **调整规则并监控流量**
> * AWS WAF 还**允许我们查看规则**并对其**进行自定义**，以**防止新的攻击到达服务器**。

=== 架构图

image::/图片2/132图片/架构图.png[架构图]

== 实验步骤

=== 为负载均衡器创建安全组

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域
> - 顶部菜单**导航到 EC2**
> - 从左侧菜单中**转到"网络和安全"下的"安全组"**，然后单击**创建安全组**。
> - 安全组名称：输入**``LoadBalancer-SG``**
> - 描述：**``Security group for Load balancer``**
> - VPC：选择**默认VPC**
> - 在"入站规则"下，单击**"添加规则"**。
> - 添加 **HTTP**

----
  . 选择类型： 选择 HTTP
  . 协议：TCP
  . 端口范围：80
  . 源：选择"任何位置"
----

> - 添加 **SSH**

----
  . 选择类型： 选择 SSH
  . 协议：TCP
  . 端口范围：22
  . 源：选择"任何位置"
----

> - 将其他内容**保留为默认值**，然后单击**创建安全组按钮**。

---

=== 创建 Web 服务器

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域。
> - 顶部菜单**导航到 EC2**
> - 左侧面板，单击**"实例"**，然后单击**"启动新实例"**。

==== (1)控制台启动实例

image::/图片/07图片/控制台2.png[控制台启动实例]

==== (2)选择系统镜像

image::/图片/07图片/控制台3.png[选择系统镜像]

==== (3)选择实例类型

image::/图片/07图片/配置1.png[选择实例类型]

==== (4)配置实例

> - 实例数：**输入 ``1``**
> - 单击**“高级详细信息”**。
> - 在**“用户数据”**部分下，**输入以下脚本**以**创建由 Apache HTTPD Web 服务器提供的 HTML 页面**。

```shell
  #!/bin/bash
  sudo su
  yum update -y
  yum install -y httpd
  systemctl start httpd
  systemctl enable httpd
  echo "Response coming from server A" > /var/www/html/index.html
```

> - 将所有**其他设置保留为默认值**。单击**"下一步：添加存储"**

==== (5)添加存储

image::/图片/07图片/配置2.png[添加存储]

==== (6)添加标签

> - 添加标签：点击**添加标签**按钮
> * 键：**``Name``**
> * 值：**``webserver-A``**
> * 点击**``下一步:配置安全组``**

==== (7) 配置安全组

> - 选择一个现有的安全组：从列表中选择**LoadBalancer-SG**
> - 点击下一步 `审核和启动`

==== (8) 审核启动

> - **检查**所有选定的设置，**无误点击启动**
> - 选择**现有密钥对**，确认并单击**启动实例**

image::/图片/07图片/现有密钥.png[现有密钥]

> - **重复上述步骤**，创建**``webserver-B``**：
> * **用户数据**：

```shell
  #!/bin/bash
  sudo su
  yum update -y
  yum install -y httpd
  systemctl start httpd
  systemctl enable httpd
  echo "Response coming from server B" > /var/www/html/index.html
```
> - 添加标签：点击**添加标签**按钮
> * 键：**``Name``**
> * 值：**``webserver-B``**

---

=== 创建目标组和负载均衡器

==== 在 EC2 控制台中，**导航到**左侧面板中**负载平衡**下的**目标群组**。

> - 单击``创建目标组``按钮。
> - 步骤 1，指定组**详细信息**
> * 在"基本配置"下，
> ** 选择目标类型：选择**实例**
> ** 目标组**名称**：输入**"web-server-TG"**
> ** 协议：**选择 HTTP**
> ** 端口：**输入 80**
> ** VPC：**保持默认**
> * 健康检查
> ** 运行状况检查协议：**选择 HTTP**
> ** 运行状况检查路径：输入 **/index.html**
> * 将其他设置保留为**默认值**。
> * 滚动到页面**末尾**，然后单击"下一步"按钮。
>
> - 步骤 2，注册目标
> * **选中**这两个实例，然后单击**"在下面以待注册的形式添加"**按钮。
> * 实例将出现在"查看目标"部分中，运行状况**状态为"待处理"**。
> * 单击**创建目标组**按钮。

image::/图片2/132图片/注册目标.png[注册目标]

> - **现在已创建目标组**。

==== 在 EC2 控制台中，**导航到**左侧面板中**负载平衡**下的**负载均衡器**。

> - 单击左上角``创建负载均衡器``按钮，为我们的 Web 服务器创建负载均衡器。
> - 选择负载均衡器**类型**：选择"应用程序负载均衡器（Application Load Balancer）"，单击**"创建"**按钮。
> - 要创建应用程序负载均衡器，请按如下方式**配置负载均衡器**
> * 对于**基本配置**部分
> ** 负载均衡器**名称**：输入"Web-server-LB"
> ** 模式：选择**面向互联网**
> ** IP 地址类型：**选择 IPv4**
> * 对于**网络映射**部分：
> ** VPC：保持**默认**
> ** 映射：选择**所有存在的可用区**
> * 对于"安全组"部分，
> ** 从下拉列表中**选择 LoadBalancer-SG 安全组**，然后**删除默认安全组**。
> * 对于**侦听器和路由**部分，
> * 侦听器已随协议 HTTP 和端口 80 一起存在。
> ** 为"默认操作转发到"选项**选择目标组** **web-server-TG**。
> - 将其他选项保留为**默认值**，然后单击"创建负载均衡器"按钮。 
> - **您已成功创建应用程序负载均衡器。 单击查看负载均衡器按钮**。
> - 等待 2 到 3 分钟，让负载均衡器变为**活跃**状态。

image::/图片2/132图片/活动.png[活动]

---

=== 测试负载均衡器

> - 接下来，复制 ELB 的 **DNS 名称**，然后在浏览器中**输入地址**。
> * 域名解析示例：**``Web-server-LB-1455482809.us-east-1.elb.amazonaws.com``**

image::/图片2/132图片/ELBDNS.png[ELBDNS]

> - 刷新**浏览器几次**，即您将看到以下**两个响应之一**：
> * **``Response coming from server A``**
> * **``Response coming from server B``**
> ** 注意：这意味着负载通过**应用程序负载均衡器**在**两个 Web 服务器**之间**共享**。

---

=== 创建 IP 集

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域
> - 顶部菜单**导航到 WAF**
> - 在右侧菜单中选择**IP集**，然后单击**“创建IP集”**按钮
> - 在下一个屏幕上，在**“创建 IP 集”**下填写以下**详细信息**。
> * IP 集**详细信息**：
> ** IP 集名称 ： 输入**``MyIPset``**
> ** 描述 ： 输入**``IP set to block my public IP``**
> ** 区域 ： 选择**美国东部（弗吉尼亚北部）**
> ** IP 版本 ： 选择**``IPv4``**
> ** IP地址：输入**``本地网络的IP/32``**。
> ** 注意：**粘贴 IP** 后必须**提供``/32``**，否则您将**无法创建 IP 集**。
> * 提供**上述详细信息后**，**单击“创建IP集”**

---

=== 创建 Web ACL

> - Web ACL **详细信息**
> * **导航到 AWS WAF 控制面板**，然后**选择 Web ACL** 。单击**“创建 Web ACL”**以**创建新的 Web ACL**。
> * 按如下方式**配置 ACL**：
> ** Web ACL **详细信息**
> *** 名称 ： 输入**``MywebACL``**
> *** 描述 ： 输入**``ACL to block my public IP``**
> *** 资源类型：选择**区域资源**（应用程序负载均衡器和 API 网关）
> *** 区域：选择**美国东部（弗吉尼亚北部）**
> *** 要**关联 AWS 资源**，请单击**添加 AWS 资源**
> *** 在**添加 AWS 资源中**，选择**应用程序负载均衡器**，然后**选择 ALB 的名称**。点击**添加**
> * 最后点击**下一步**.

image::/图片2/132图片/ACL.png[ACL]

> - **添加规则和规则组**
> * 在**“规则”**下，单击**“添加规则”**，然后在**下拉菜单中**选择**“添加我自己的规则和规则组”**。
> * 在**“规则类型”**中选择如下**所示的 IP 集**，并填写如下所示的**详细信息**：
> ** 规则类型：选择**IP 集**
> ** 名称 ： 输入**``MywebACL-rule``**
> ** IP集：选择**上面创建的IP集（ MyIPset ）**
> ** 用作原始地址的 IP 地址：**源 IP 地址**
> ** 操作 ： 选择**阻止**
> * 提供上述详细信息后，单击**“添加规则”**。
> * 最后点击**下一页**
> - **设置规则优先级**
> * **保留为默认值**，然后单击**“下一步”**。
> - **配置指标**
> * **保留为默认值**，然后单击**“下一步”**。
> - **查看和创建网络 ACL**
> * 查看**所有设置**，然后单击**“创建 Web ACL”**按钮
> - 等待 1 或 2 分钟，直到您**看到 Web ACL 已成功创建**。

image::/图片2/132图片/已成功创建.png[已成功创建]

> - 现在您已**借助IP 集**成功**创建了 ALB 的 Web ACL**。

---

=== 测试WAF

> - 要**测试 WAF**，请导航到**负载均衡器**
> - 在**“负载平衡器”**部分下，选择**“应用程序负载平衡器 Web-server-LB”**。
> - 复制**“描述”**下的 DNS 名称，然后将其**粘贴到浏览器中**。
> * 示例：**``Web-server-LB-1455482809.us-east-1.elb.amazonaws.com``**
> - 您将**收到 403 禁止访问的错误**，显示 WAF **阻止了您与 ALB 的连接**。

image::/图片2/132图片/403.png[403]

---

=== 取消阻止 IP

> - 要**取消阻止 IP**，请**导航到 IP 集**，然后**单击 MyIPset**。 选择您的 IP集，然后单击**“删除”**
> - 在确认框中键入**删除**，然后单击**删除**。
> - 您**已成功从 WAF 中删除该 IP**。
> - **等待几分钟**。
> - 导航到**负载均衡器**
> - 在**“负载平衡器”**部分下，选择**“应用程序负载平衡器 Web-server-LB”**。
> - 复制**“描述”**下的 DNS 名称，然后将其**粘贴到浏览器中**。
> * 示例：**``Web-server-LB-1455482809.us-east-1.elb.amazonaws.com``**
> - 您将从 Web 服务器**获得响应**，响应**来自**服务器 A 或来自服务器 B，**如下所示**：

image::/图片2/132图片/服务器1.png[服务器1]

image::/图片2/132图片/服务器2.png[服务器2]

---
