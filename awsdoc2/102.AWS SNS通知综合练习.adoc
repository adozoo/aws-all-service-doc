
## AWS SNS通知综合练习

=== 架构图

image::/图片2/102图片/架构图.png[架构图]

== 实验步骤

=== 创建VPC

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域
> - 顶部菜单**导航到 VPC**
> - 单击左侧菜单中的**您的 VPC**
> - 在这里，您可以**看到所有 VPC 的列表**，无需对现有和默认 VPC **执行任何操作**，我们将**创建一个新的 VPC**。
> - 单击**``创建 VPC``**按钮。
> * 名称标签： **输入用于向您的 VPC 标识的 VPC 名称**。例如：**``MyVPC``**
> * IPv4 CIDR 块： 输入 **``10.0.0.0/16``**
> * IPv6 CIDR 块： 无需更改此设置，请确保选中**"无 IPv6 CIDR 块"**
> * 租期： 无需更改此设置，请确保**选中"默认"**。
> - 现在单击**``创建 VPC``**按钮

---

=== 创建并附加互联网网关

> - 单击左侧菜单中的**互联网网关**，然后单击**创建互联网网关**。
> * 名称标签：**``MyInternetGateway``**。
> * 单击**创建互联网网关**。
> - 从列表中**选择您创建的互联网网关**
> * 单击**"操作"**。
> * 单击**附加到VPC**
> * 从列表中**选择您创建的MyVPC**，然后单击**连接互联网网关**。

image::/图片/30图片/igw.png[igw]

---

=== 创建子网

> - 我们将分别在 **us-east-1a** 和 **us-east-1b** 可用区中**创建一个公有子网**和**两个私有子网**，如下所示：
> * 对于公有子网，单击左侧菜单中的子网，然后单击**创建子网**。
> ** VPC ID ：从您之前创建的列表中选择 **``MyVPC``**。
> ** 子网名称 ：输入名称 **``MyPublicSubnet``**
> ** 可用区 ： 选择 **``us-east-1a``**
> ** IPv4 网段：输入范围 **``10.0.1.0/24``**
> ** 单击**"创建子网"**。
> * 对于第一个私有子网，再次单击**"创建子网"**。
> ** VPC ID ：从您之前创建的列表中选择 **``MyVPC``**。
> ** 子网名称 ：输入名称 **``MyPrivateSubnet``**
> ** 可用区 ： 选择 **``us-east-1a``**
> ** IPv4网段：输入范围**``10.0.2.0/24``**
> ** 单击**"创建子网"**。
> * 对于第二个私有子网，再次单击**"创建子网"**。
> ** VPC ID ：从您之前创建的列表中选择 **``MyVPC``**。
> ** 子网名称 ：输入名称 **``MyPrivateSubnet2``**
> ** 可用区 ： 选择 **``us-east-1b``**
> ** IPv4网段：输入范围**``10.0.3.0/24``**
> ** 单击**"创建子网"**。

---

=== 创建路由表

> - 从左侧菜单中**转到路由表**，然后单击**创建路由表**。
> * 名称： 输入**"PublicRouteTable"**。
> * VPC： 从列表中选择**"MyVPC"**。
> * 单击**创建路由表**。
> - 重复相同的步骤，为私有子网**创建路由表**。
> * 名称： 输入 **"PrivateRouteTable"**。
> * VPC： 从列表中选择**"MyVPC"**。
> * 单击**创建路由表**。

image::/图片/30图片/routetable.png[routetable]

> - 现在，将子网**关联到路由表**。
> - 单击 **PublicRouteTable**，单击**``操作``**。
> * 然后转到**"子网关联"**选项卡
> * 从列表中选择**"MyPublicSubnet"**。
> * 单击**保存关联**。
> - 单击 **"PrivateRouteTable"**，单击**``操作``**。
> * 然后转到**"子网关联"**选项卡
> * 从列表中选择 **"MyPrivateSubnet"和"MyPrivateSubnet2"**。
> * 单击**保存关联**。
> - 确保**不要将任何子网与主路由表关联**。
> - PublicRouteTable：添加允许公网流量**流向 VPC 的路由**。
> - 选择**"PublicRouteTable"**。
> - 转到**"路由"**选项卡，然后单击**``编辑路由``**按钮。
> - 然后单击**``添加路由``**按钮。
> - 指定以下值：
> * 目标：输入 **``0.0.0.0/0``**
> * 目标：从下拉菜单中选择互联网网关，选择**``MyInternetGateway``**。
> * 点击**保存更改**。

image::/图片/30图片/route.png[route]

---

=== 为 EC2 和 RDS 实例创建安全组

==== EC2

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域
> - 顶部菜单**导航到 EC2**
> - 左侧面板，单击**"网络和安全"**，然后单击**"创建安全组"**。
> - 安全组名称：输入**``EC2-SG``**
> - 描述：**``Security group for EC2``**
> - VPC：选择**``MyVPC``**
> - 在**"入站规则"**下，单击**"添加规则"**。
> - 添加 **``SSH``**

----
  . 选择类型： 选择 SSH
  . 协议：TCP
  . 端口范围：22
  . 源：选择"任何位置"
----

> - 将其他内容**保留为默认值**，然后单击**创建安全组按钮**。
> - 现**已创建EC2安全组**。

==== RDS

> - 再次单击**"创建安全组"**。
> - 安全组名称：输入**``RDSMulti-AZ``**
> - 描述：**``Security group for RDS``**
> - VPC：选择**``MyVPC``**
> - 在**"入站规则"**下，单击**"添加规则"**。
> - 添加 **``MySQL/Aurora``**

----
  . 选择类型： 选择 MySQL/Aurora
  . 协议：TCP
  . 端口范围：3306
  . 源：选择之前创建的 EC2 安全组 EC2-SG
----

> - 将其他内容**保留为默认值**，然后单击**创建安全组按钮**。
> - 现**已创建RDS安全组**。

---

=== 为 RDS 创建子网组

==== 在此任务中，您将为 RDS 中的多可用区部署创建子网组。

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域
> - 通过菜单**导航到 RDS**。
> - 在左侧面板，选择**子网组**。这主要用于在**私有子网中启动数据库**。
> - 单击**创建数据库子网组**按钮。子网组**详细信息**如下：
> * 名称：输入 **``RDSMultiAZ-SBG``**
> * 描述：输入 **``Subnet group for RDS Multi-AZ``**
> * VPC：选择 **``MyVPC``**
> - 在**"添加子网"**部分下
> * 可用区：选择**``us-east-1a、us-east-1b``**
> * 子网：选择我们**创建**的**私有子网**的两个 IPv4 地址。

image::/图片2/102图片/私有子网的两个.png[私有子网的两个]

> - 单击**创建**按钮。

---

=== 创建 EC2 IAM 角色

> - 导航到**``IAM``**
> - 在**左侧菜单**中，单击**``角色``** 。单击**``创建角色``**该按钮以**创建新的 IAM 角色**。
> - 在创建角色部分，为角色选择**可信实体类型**：
> * **AWS 服务**
> * **使用案例:EC2**

image::/图片/25图片/创建IAM.png[创建IAM]

> * 单击**下一步**
> - 添加权限：现在，您可以看到**策略列表**。
> - 选择**"创建策略"**，将**打开一个新选项卡**，然后将**代码复制并粘贴到 JSON 下**。

```json
  {
      "Version": "2012-10-17",
      "Statement": [
          {
              "Sid": "CloudWatchAccess",
              "Action": "cloudwatch:*",
              "Effect": "Allow",
              "Resource": "*"
          }
      ]
  }
```

> - 现在点击 **下一页：标签** 按钮。**无需更改**
> - 单击**"下一步：查看"**按钮。
> - 输入策略名称：**awspolicy**，然后单击**"创建策略"**。
> - 创建策略后，返回**"创建角色"**选项卡，然后单击右上角的**"刷新"**按钮。
> - 在"筛选策略"部分中**搜索"awspolicy"**并将其**选中**。
> - 单击**下一步**
> - 角色名称：输入 **``awsrole``**
> - 您**已成功**按名称 awsrole 创建了一个 IAM 角色。

---

=== 创建 EC2 实例

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域。
> - 顶部菜单**导航到 EC2**
> - 左侧面板，单击**"实例"**，然后单击**"启动新实例"**。

==== (1)控制台启动实例

image::/图片/07图片/控制台2.png[控制台启动实例]

==== (2)选择系统镜像

image::/图片/07图片/控制台3.png[选择系统镜像]

==== (3)选择实例类型

image::/图片/07图片/配置1.png[选择实例类型]

==== (4)配置实例

> - 实例数：**输入 ``1``**
> - 网络 ： 选择**``MyVPC``**
> - 子网 ：保留为**``MyPublicSubnet``**
> - 自动分配公共 IP ：**"启用"**
> - IAM角色 ：从下拉列表中选择**``awsrole``**
> - 将所有**其他设置保留为默认值**。单击**"下一步：添加存储"**

==== (5)添加存储

image::/图片/07图片/配置2.png[添加存储]


==== (6)添加标签

> - 添加标签：点击**添加标签**按钮
> * 键：**``Name``**
> * 值：**``awsEC2``**
> * 点击**``下一步:配置安全组``**

==== (7) 配置安全组

> - 选择一个现有的安全组：从列表中选择 EC2-SG
> - 点击下一步 `审核和启动`

==== (8) 审核启动

> - **检查**所有选定的设置，**无误点击启动**
> - 选择现有密钥对，确认并单击**启动实例**

image::/图片/07图片/现有密钥.png[现有密钥]

==== 将创建的 EC2 实例 ID 复制并粘贴到记事本中以供将来参考。

---

=== 创建 RDS 数据库实例

==== 在此任务中，您将创建一个启用了多可用区的 RDS 实例 （在两个可用区中）

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域
> - 通过菜单**导航到 RDS**。
> - 单击**"数据库"**部分中的**"创建数据库"**按钮。
> - 指定数据库**详细信息**：
> * 实例**规格**
> ** 数据库创建方法：**``标准创建``**
> ** 引擎选项：选择 **``MySQL``**
> ** 版本 ： **``默认``**
> ** 模板 ：选择**``开发/测试``**
> ** 可用性与持久性 ：选择部署选项为**``多可用区数据库实例``**
> ** 数据库实例标识符：**``database-1``**
> ** 主用户名：**``awslabadmin``**
> ** 主密码和确认密码：**``awslabs123``**
> ** 注意：这是用于登录数据库的用户名/密码组合。请记下它们。
> ** 数据库实例类 ： **``db.t3.micro``**
> ** 存储类型 ： **``通用型 （SSD）``**
> ** 分配的存储：**``20（默认值）``**
> ** 启用存储空间自动缩放：**``取消选中``**
> ** VPC ：选择 **``MyVPC``**
> ** VPC 子网组：选择 **``RDSMultiAZ-SBG``**
> ** 公共访问 ： 选择**``否``**
> ** VPC 安全组： 选择**``现有``**
> ** 安全组注意：**删除默认安全组**，然后**选择``RDSMulti-AZ``**

image::/图片2/102图片/rds安全组.png[rds安全组]

> - 转到**其他配置**选项
> * 初始数据库名称：**默认**
> * 数据库参数组：**默认**
> * 选项组：**默认**
> * 启用自动备份：**取消选中**
> * 启用加密：**取消选中**
> * 日志导出：本练习**不需要日志导出**。
> * 注意：将**其他所有设置保留为默认值**
> - 单击**"创建数据库"**
> - 导航到**"数据库"**。
> - 在 RDS 控制台上，将**显示新数据库实例的详细信息**。数据库实例的状态为**"正在创建"**，直到数据库实例**可供使用**。
> - 当状态更改为可用时，您**可以连接到数据库实例**。新实例状态变为**"可用"**之前最多可能**需要 20 分钟**。

image::/图片2/102图片/数据库创建完成.png[数据库创建完成]

---

=== 配置 CloudWatch 指标并添加订阅

> - 通过菜单**导航到 CloudWatch**。
> - 单击 CloudWatch 控制面板左侧面板中**警报**下的**告警中**。
> - 单击右上角的**"创建警报"**。
> - 在**"指定指标和条件"**页中：
> * 点击选择**指标**。它将打开**"选择指标"**页面。
> * 向下滚动并**选择 ``EC2``**。
> * 选择**``每个实例的指标``**
> * 在搜索栏中**输入您的 EC2 实例 ID** 以**获取 EC2 服务器的指标**
> * 选择**"StatusCheckFailed_System"**指标。
> * 单击**"选择指标"**按钮。
> - 现在，使用以下**详细信息配置警报**：
> * 在"指标"下
> ** 周期：选择** ``1 分钟``**
> * 在条件下
> ** 阈值类型：选择**``静态``**
> ** 每当状态检查失败的系统为：选择**"大于"**
> ** 比 ：输入 **``1``**
> * 将**其他选项保留为默认值**，然后单击**"下一步"**。
> - 在**"配置操作"**页中：
> * 在通知下
> ** 警报状态触发器：选择**``警报中``**
> * 选择 SNS 主题：选择**``创建新主题``**
> * 创建新主题：输入主题名称为**``EC2FailAlarm``**
> * 将收到通知的电子邮件终端节点… ：输入**您的电子邮件地址**以接收警报
> * 提供这些详细信息后，单击**创建主题**按钮。
> ** AWS 将向上面提供的电子邮件地址**发送一封确认电子邮件**。您需要**确认电子邮件订阅**
> - 对于 EC2 的恢复，我们将**创建 EC2 操作**，为此，请向下滚动并**单击添加EC2操作**。
> * 警报状态触发器：选择**警报中**
> * 采取以下操作：选择**"恢复此实例"**

image::/图片2/102图片/恢复此实例.png[恢复此实例]

> * 将**其他字段保留为默认值**。单击**"下一步"**。
> - 在**"添加名称和描述"**页：
> * 定义唯一名称：输入唯一名称**``EC2Recover``**
> * 单击**"下一步"**。
> - 将显示警报的**预览**。向下滚动并**单击创建警报**。
> - 现在**创建了一个新的 CloudWatch 警报**。

---

=== 手动触发 CloudWatch 警报进行测试 

==== 在此任务中，您将模拟 EC2 实例的硬件故障，以便我们可以测试 CloudWatch 警报和通知。

> - **SSH 连接到 EC2 实例**
> - SSH 进入您的实例后，**执行以下命令**
> * **``aws configure``**
> - **按 [Enter] 键**，直到到达**默认区域**配置选项。在**默认区域**中输入 **``us-east-1``**，然后继续**按 [Enter] 键**。

image::/图片2/102图片/默认区域.png[默认区域]

> - 下一个命令是**更改报警状态并模拟故障**。
> * **``aws cloudwatch set-alarm-state --alarm-name "EC2Recover" --state-value ALARM --state-reason "Simulated Hardware Failure"``**
> - 完成此命令后，**转到 CloudWatch 警报**。您可以看到警报**从"确定"更改为"在警报中"**。

image::/图片2/102图片/在警报中.png[在警报中]

> - 单击**``EC2Recover``**。您可以在**"历史记录"**部分**查看操作**。

image::/图片2/102图片/历史记录.png[历史记录]

> - 您还将在电子邮件中**收到 SNS 通知**。

image::/图片2/102图片/收到 SNS 通知.png[收到 SNS 通知]

---

=== 为 RDS 故障转移创建 SNS 订阅

==== 在此任务中，您将模拟 RDS 故障转移以及 SNS 订阅，以便在故障转移发生时立即发送通知。

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域
> - 通过菜单**导航到 RDS**。
> - 在左侧面板上，我们可以**看到事件订阅部分**，单击它。
> - 单击**创建事件订阅**
> * 事件订阅名称：输入**``RDSfailover``**
> * 目标：选择**新的电子邮件主题**
> * 主题名称：输入 **``RDSfailNotification``**
> * 使用这些收件人：输入**您的电子邮件地址**

image::/图片2/102图片/目标.png[目标]


> - 在**源**部分中
> * 源类型：选择**``实例``**
> * 要包含的实例：选择**``特定的实例``**
> * 特定实例：选择**``database-1``**
> * 要包含的事件类别：选择**``全部事件类别``**

image::/图片2/102图片/所有事件类别.png[所有事件类别]

> - 点击**创建**按钮。
> - 现在**转到您的电子邮件**，您将收到**来自AWS的通知**。如果您没有收到它，请在**垃圾邮件中进行检查**。
> - 单击**"确认订阅"**链接。
> - 您的电子邮件地址现**已订阅 SNS 主题 ``RDSfailNotification``**。

image::/图片2/102图片/已订阅.png[已订阅]

> - 现在，**导航到数据库实例**，在左侧面板上，单击选中**``database-1``**
> - 在**操作**中选择**"重启"**，选中**"是否进行重启和故障转移"**选项。

image::/图片2/102图片/是否进行重启和故障转移.png[是否进行重启和故障转移]

> - 点击**确认**按钮。
> - **等待几分钟**。
> - 现在，您将在**收件箱**中收到有关**数据库故障转移的通知/邮件**。

image::/图片2/102图片/故障转移的通知.png[故障转移的通知]

---
