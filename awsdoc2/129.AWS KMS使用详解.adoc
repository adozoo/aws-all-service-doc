
## AWS KMS使用详解

=== AWS KMS

> - AWS KMS 是**一项托管服务**，可让我们**轻松创建和控制用于加密数据的加密密钥**，并使用**硬件安全模块（用于加密密钥的硬件）**来**保护密钥的安全性**。
> - AWS KMS 与**其他几项 AWS 服务集成**，以**帮助我们在使用这些服务时保护我们存储的数据**。
> - AWS KMS 还**与 AWS CloudTrail 集成**，为我们**提供了所有关键使用情况的日志**，以帮助我们**满足法规和合规性需求**。

=== AWS KMS服务的特点和优势

> - **完全托管**，**具有可扩展性**、**持久性**和**高可用性**；
> - KMS提供了**单一控制点**，**集中式管理密钥**，可以**随时创建新密钥**，以及对**密钥的生命周期**和**权限进行集中控制**；
> - KMS与**AWS服务集成**，可**简化密钥使用**以**加密AWS工作负载中的数据**，AWS KMS 可与**大部分其他 AWS 服务无缝集成**，因此在这些服务中**加密数据**甚至**仅需要**勾选**“加密”**复选框即可**完成加密**。
> - **成本低廉**，**使用KMS服务不需要事先承诺用量**，也**没有预付费用**。

=== KMS演示内容

> - 接下来的内容我们来**演示下如何使用KMS服务**，大致**分成三个部分**：
. 首先**创建一个CMK**。CMK也就是**客户主密钥**，是**主密钥的逻辑表示**，它包含**元数据**如**密钥ID、创建日期、描述和密钥状态**，CMK还**包括用于加密和解密数据的密钥材料**。
. 然后**定义密钥管理员及密钥用户**。可以**在创建CMK时定义**，**或者创建后在添加**。
. 完成前面两步后，密钥用户**使用 密钥ID 来加密和解密数据**。

== 实验步骤

=== 创建密钥管理员

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域
> - 顶部菜单**导航到 IAM**
> - 单击**``添加用户``**该按钮以**创建新的 IAM 用户**。

image::/图片/59图片/创建用户.png[创建用户]

> - 在**添加用户**部分，**设置用户详细信息**：
> - 用户名：**``zhangsan``**
> - 在选择 **AWS 访问类型**部分，选择 **AWS 凭证类型**为**``访问密钥 - 编程访问``**

image::/图片2/129图片/添加用户.png[添加用户]

> * 单击**下一步**
> - 设置权限：现在，您可以看到**策略列表**。
> - 在这里您**无需添加任何权限策略**
> - 现在点击 **下一页：标签**按钮。**无需更改**
> - 单击**"下一步：审核"**按钮。
> - **查看选择是否有误**，然后单击**"创建用户"**。
> - 会得到**访问密钥 ID-私有访问密钥**
> - 请**保存好它**

---

=== 创建密钥用户

> - 顶部菜单**导航到 IAM**
> - 单击**``添加用户``**该按钮以**创建新的 IAM 用户**。

image::/图片/59图片/创建用户.png[创建用户]

> - 在**添加用户**部分，**设置用户详细信息**：
> - 用户名：**``lisi``**
> - 在选择 **AWS 访问类型**部分，选择 **AWS 凭证类型**为**``访问密钥 - 编程访问``**

image::/图片2/129图片/添加用户2.png[添加用户2]

> * 单击**下一步**
> - 设置权限：现在，您可以看到**策略列表**。
> - 在这里您**无需添加任何权限策略**
> - 现在点击 **下一页：标签**按钮。**无需更改**
> - 单击**"下一步：审核"**按钮。
> - **查看选择是否有误**，然后单击**"创建用户"**。
> - 会得到**访问密钥 ID-私有访问密钥**
> - 请**保存好它**

---

=== 创建客户主密钥

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域
> - 顶部菜单**导航到 KMS**
> - 点击**创建密钥**按钮。
> - 在**配置密钥**下：
> * 密钥类型 ： 选择**``对称``**
> - 点击**下一步**
> - 在**添加标签**下：
> * 别名 ： 输入**``kmstest``**
> * 描述 ： **保持默认**
> - 点击**下一步**
> - 在**“定义密钥管理权限”**下：
> * 密钥管理员 ：选择您刚刚创建的**``zhangsan``**用户
> - 点击**下一步**
> - 定义密钥使用权限 ：选择您刚刚创建的**``lisi``**用户
> - 点击**下一步**
> - **审核所有内容**，然后单击**“完成”**。
> - CMK就**已经创建完成了**，这里**列出了CMK的别名和密钥ID**。
> - **别名是一个显示名称**，使用它来**表示CMK**。在**拥有多个CMK时**，通过**别名可以让我们更容易辨别CMK**

image::/图片2/129图片/已成功创建.png[已成功创建]

> - **点击密钥ID**，我们可以**查看到具体信息以及配置**。
> * 可以在**“密钥策略”**这里点击**“切换到策略视图”**，**查看和编辑策略信息**。
> * **密钥管理员**部分，可以**看到我们已经添加的``zhangsan``用户作为密钥管理员**，也可以通过**“添加”**按钮**添加更多的密钥管理员**。
> * **密钥用户**，是指**哪些IAM用户和角色**使用此**密钥用于加密操作**。我们已经添加**``lisi``**用户作为**密钥用户**

image::/图片2/129图片/查看具体信息.png[查看具体信息]

> - 最后要**补充一点**，**不论是您创建的CMK**，还是**其他AWS服务创建的CMK**，都**无法从KMS服务中导出**，这样是为了**确保CMK的安全**，也就**避免了您自己遗失了密钥**从而**造成安全隐患**；
> - 如果您有数据**需要加密**，是**通过KMS使用这个密钥ID来加密**、**解密您的数据**。AWS **KMS 服务创建的密钥**永远**不会在创建密钥的 AWS 区域以外传输**，并且**只能在创建密钥的区域内使用**

---

=== 配置本地电脑中的 AWS CLI 

> - 我们在上节课**创建了一个IAM用户``lisi``**，并将这个**用户配置为 ``CMK`` 的密钥用户**。
> - 接下来我们要**在``AWS CLI``使用``lisi``用户访问密钥**，通过``AWS CLI``命令来**演示加密和解密数据**。
> - 切换到**终端**，配置**``AWS CLI``**
> * 输入**``aws configure``**命令
> - 配置**访问密钥 ID-私有访问密钥**：
> * 将 **IAM 用户**的**访问密钥 ID**与**私有访问密钥**复制到**相应的命令**中，然后按 [Enter] 键**确认**

image::/图片2/129图片/awscli配置.png[awscli配置]

---

=== 为密钥用户添加KMS相关IAM权限

> - 在终端中**运行``aws kms list-keys``命令**，命令返回为**``access denied``**，操作被``**拒绝``**，提示密钥用户**没有相应的权限**，因为我们目前**没有为该用户添加kms相应权限**。

image::/图片2/129图片/拒绝.png[拒绝]

> - **访问IAM控制台**，我们现在为**该用户添加权限**，**IAM->用户->lisi->权限**
> - 添加**内联策略**，服务**选择KMS**，操作**选择``ListKeys``**，然后**下一步查看策略**，名称输入**``kmslistkeys``**，然后**完成策略的创建**。现在lisi用户就**拥有``kmslistkeys``权限**。

image::/图片2/129图片/操作选择.png[操作选择]

> - 我们回到终端**再次运行``aws kms list-keys``命令**，可以看到已经**成功将我的账户在这个区域的 ``CMK`` 全部列出来**了。

image::/图片2/129图片/list.png[list]

---

=== KMS加密演示

> - 我们**运行以下命令**。
> * **``aws kms encrypt --key-id 3901c747-8f82-4761-a53b-06b7bda15088 --plaintext "www.google.com"``**
> ** **参数key-id**后面内容为我们**使用的CMK的密钥ID**
> ** **参数plaintext**后面我们**输入一个想要加密的明文内容**，我输入**``www.google.com``**，然后**执行**。

image::/图片2/129图片/加密一个明文内容.png[加密一个明文内容]

> - 我们看下**命令的返回结果**，**包括``CiphertextBlob``和``keyid``**，**以及``EncryptionAlgorithm``加密算法**。
> - **``CiphertextBlob``这个密文blob的内容**就是**我们命令指定的``plaintext``内容``www.google.com``加密后的base64编码的密文**。
> - 我们现在**只需要``CiphertextBlob``的内容**，**不需要命令返回密钥ID以及加密算法**，修改下命令，在命令**后面加上``query CiphertextBlob``**,执行命令：
> * **``aws kms encrypt --key-id 3901c747-8f82-4761-a53b-06b7bda15088 --plaintext "www.google.com" --query CiphertextBlob``**

image::/图片2/129图片/CiphertextBlob.png[CiphertextBlob]

> - 看下**返回结果**。现在的**返回结果只包括了加密后的密文blob**，但是内容**两边的引号也不是密文的内容**，所以我们还**需要在命令后添加一个选项**
> - 让命令**返回的结果不包括加密密文两边的引号**，需要再命令**后添加``output text``**，我们执行下命令：
> * **``aws kms encrypt --key-id 3901c747-8f82-4761-a53b-06b7bda15088 --plaintext "www.google.com" --query CiphertextBlob --output text``**

image::/图片2/129图片/output.png[output]

> - 好的，现在命令**返回的内容**就**只有加密后的密文blob内容**。
> - 我们现在**进行加密的最后一步**，现在加密命令返回的**密文内容是基于base64编码的**，如果后面要**使用AWS CLI进行解密**
> - 就需要**将base64编码**进行**解码为二进制文件**，然后我们将**解码后加密的内容输出至一个文件**。
> * **``aws kms encrypt --key-id 3901c747-8f82-4761-a53b-06b7bda15088 --plaintext "www.google.com" --query CiphertextBlob --output text | base64 --decode > encrypttest``**

image::/图片2/129图片/二进制文件.png[二进制文件]

> - 尝试**查看下生成文件``encrypttest``的内容**，**``cat encrypttest``**,可以看到为**二进制文件**，**无法查看**该文件的内容。
> - 好的，目前我们**已经通过``AWS CLI``命令**，**使用``lisi``用户将明文``www.google.com``内容加密**，将**加密密文生成至``encrypttest``文件**

---

=== KMS解密演示

> - 接下来我们要对**之前加密的内容进行解密**
> - **输入命令**：
> * **``aws kms decrypt --ciphertext-blob fileb://encrypttest``**

image::/图片2/129图片/解密演示.png[解密演示]

> - **``ciphertext-blob``**后面要指定之前**加密步骤生成的密文文件**，通过**fileb://来指定**，然后**执行命令**。
> - 我们看到**命令返回时包括``KEYID``，``plaintext``以及``加密算法``**。
> - 同样，我们**只需要``plaintext``明文的内容**，在命令后**加入参数``query Plaintext``和``output text``**，输入命令：
> * **``aws kms decrypt --ciphertext-blob fileb://encrypttest --query Plaintext --output text``**

image::/图片2/129图片/解密演示2.png[解密演示2]

> - 看下命令**返回结果**，可以看到现在**已经能成功只将``plaintext``的内容返回**
> - 以上我们**通过``AWS CLI``命令**，**完成了加密和解密操作的演示**，在**整个演示的过程中**，使用的**主密钥一直存储在KMS中**，**由AWS进行保存**
> - 我们并**没有接触到主密钥**，而是**通过密钥ID来进行加密操作**，这也在**一定程度上保障了主密钥的安全性**。

---

== KMS信封加密

=== 什么是信封加密？

> - 信封加密是**类似数字信封**技术的**一种加密手段**。
> - 这种技术**将加密数据的数据密钥**封入**信封中存储**、**传递**、和**使用**，**不再使用主密钥直接加解密数据**。
> - 信封加密**使用客户主密钥生成数据密钥**，然后**用离线的数据密钥在本地加密大量数据**，而**不再使用主密钥直接加解密数据**。
> - 我们上节课**演示了使用KMS的客户主密钥**也就是**CMK进行加密**，将需要加密的明文内容为**``www.google.com``**直接发送到AWS KMS中**进行加密**。
> - 那什么情况下**使用信封加密呢**？
> * 首先，AWS KMS支持**发送最大4KB的数据进行直接加密**，如果需要**加密的数据比较大**的话就**需要信封加密**。
> * 其次，**信封加密可提供巨大的性能优势**，当**使用 AWS KMS 直接加密数据时**，整个**数据必须通过网络进行传输**。
> * **信封加密降低了网络负载**，因为**通过网络发送的只有请求**，同时**传输的数据密钥也更小**。**避免向 AWS KMS 发送整个数据块并遭遇网络延迟**。
> * **最后**，将需要**加密的数据通过网络传输至KMS**，虽然是**通过安全信道通信**，也有可能会在**传输过程中存在诸多风险**，如**窃听**、**钓鱼**，且一些组织的**安全政策**也**不允许用户将数据传输至AWS进行加密**。

=== 信封加密的工作流程

> - 我们来看下信封加密是**如何工作**的。
. 首先，我们**创建一个客户主密钥**，也就是**CMK**。
. CMK生成后，我们**使用CMK生成数据密钥**，一旦**请求KMS生成数据密钥时**，用户能够**得到一个明文数据密钥**和**一个密文的数据密钥**，共**2个数据密钥**。
. 然后**使用明文数据密钥加密您服务器上的文件**，生成**密文文件**。
. 将**密文文件**和**密文数据密钥**一同**存储到持久化存储设备或服务中**。
. 完成**加密后**，将**明文文件**，以及**明文数据密钥删除**。
> - 当您完成上述**加密操作后**，**只保留密文密钥和密文文件**，这样即使**密文密钥和密文文件被窃取**，也**无法解密获得用户的明文文件**

=== 信封加密的解密


> . 需要**解密文件时**，首先从**持久化存储设备**或服务中**读取密文数据密钥和密文文件**
. 然后，**调用KMS服务的``Decrypt``接口**，**解密数据密钥**，**取得明文数据密钥**
. 最后，**使用明文数据密钥解密文件**

=== CMK生成数据密钥

> - 通过**调用``generate-data-key``命令**，KMS会**返回明文数据密钥**以及**密文数据密钥**，然后使用**明文数据密钥加密您自己服务器上的数据**。
> - 输入命令：**``aws kms generate-data-key --key-id 3901c747-8f82-4761-a53b-06b7bda15088 --key-spec AES_256``**

image::/图片2/129图片/生成数据密钥.png[生成数据密钥]

> - 可以看到，命令**执行后**，**返回了明文数据密钥以及密文数据密钥**
> - 然后您就**可以使用明文数据密钥**对您的**服务器上的文件进行加密**，加密后您可以**将密文数据密钥和密文文件**一同**存储到持久化存储设备或服务中**。
> - 需要**解密文件时**，**使用KMS的``decrypt``接口**，将**密文数据密钥解密为明文数据密钥**，在**使用明文数据密钥为本地文件解密**。

---
