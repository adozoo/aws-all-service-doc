## AWS STS使用

=== 设计 IAM 用户密钥的最佳实践

==== 一个用户案例：哪个方案最佳？

> - 我们先看一个**用户案例**，**张三是一个开发人员**，他要在他本地的电脑环境**测试他的代码**。代码需要**访问AWS S3**，所以**需要AWS的access & secret key**。那么以下哪个方案是实现需求的**最佳的解决方案**？
> - 这是一个普遍的案例，开发人员想要在**本地的电脑上测试他的代码**，这样的话就**不能附加角色到EC2**，然后在要求研发人员**登陆EC2上去做测试**。在这种情况下，有**三种方案**能够满足开发人员的**测试需求**：
> * 第一个方案，**提供给研发人员access & secret key**，然后告诉他**不要与其他人员共享凭证**。相信很多组织**都是这么做的**，**可以满足需求，但不安全**。
> * 第二个方案，**提供给研发人员access & secret key**，然后**确保凭证每90天进行一次轮换**，这种方式看似**比第一种方式安全些**，因为**增加了凭证的轮换**。但是同样，如果**这个凭证被泄露**，90天的**轮换间隔是一个很长的时间间隔**，在**泄露后轮换时间前**，同样会**造成安全隐患**；而**缩短轮换时间**同样**不是一个很好的解决方案**，尤其是**您的组织有几十、几百个用户需要凭证时**，会给您的工作**带来很高的复杂度**。所以整体这个方案**也不太理想**。
> * 第三个方案是**允许研发人员使用AWS STS服务生成临时凭证**，使用**临时凭证访问资源**。这个是**最佳的解决方案**。如果您在您的组织是**解决方案架构师或者负责安全工程师**，当开发人员或者其他人员**请求凭证访问AWS资源时**，请您**采用这个方案**。
> - 在**上面将EC2元数据的临时凭证拷贝到本地电脑**，在**本地访问AWS资源**，那**不是一个很理想的方式**，接下来演示**第三个方案的具体配置步骤**。

==== AWS STS服务生成临时凭证，使用临时凭证访问S3的实现步骤：

> - 第三个方案是**允许开发人员使用AWS STS服务生成临时凭证**，使用**临时凭证访问S3**。
> - 所以我们要**配置**：通过将**允许访问S3的权限策略附加到角色**，**开发人员通过``sts:AssumeRole``的方式获得该角色的临时访问凭证**，然后使用此**临时访问凭证访问AWS S3**。
> - 开发人员在**本地执行AssumeRole**，然后**IAM角色返回临时凭证**，然后用户**使用这个临时凭证访问S3**，这种方式是**AWS推荐的最佳实践**，而**不是通过将持久性凭证分配给用户**直接使用。
> * 第一步，在**IAM中建立一个角色（角色名：Stroll）**
> * 第二步，**附加一个S3ReadOnly策略到IAM角色**，让这个角色有**只读访问S3的权限**
> * 第三步，**允许IAM用户也就是开发人员使用的用户执行STS Assume Role 权限**，获得**临时凭证**
> * **最终开发人员使用临时凭证访问S3**。
> - 注意：其中**IAM角色，IAM用户，以及S3存储桶**都在**同一个AWS账号**下，并**未跨AWS账号**
> - 当然，您也可以**自行应用在跨AWS账户的方案中**，比如**实现在A账户中的用户通过B账户的角色临时凭证**，**访问B账户中的存储桶**。

== 实验步骤

=== 创建 IAM 用户

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域
> - 顶部菜单**导航到 IAM**
> - 单击**``添加用户``**该按钮以**创建新的 IAM 用户**。

image::/图片/59图片/创建用户.png[创建用户]

> - 在**添加用户**部分，**设置用户详细信息**：
> - 用户名：**``zhangsan``**
> - 在选择 **AWS 访问类型**部分，选择 **AWS 凭证类型**为**``访问密钥 - 编程访问``**

image::/图片2/129图片/添加用户.png[添加用户]

> * 单击**下一步**
> - 设置权限：现在，您可以看到**策略列表**。
> - 在这里您**无需添加任何权限策略**
> - 现在点击 **下一页：标签**按钮。**无需更改**
> - 单击**"下一步：审核"**按钮。
> - **查看选择是否有误**，然后单击**"创建用户"**。
> - 会得到**访问密钥 ID-私有访问密钥**
> - 请**保存好它**

---

=== 创建 IAM 角色

> - 导航到**``IAM``**
> - 在**左侧菜单**中，单击``角色`` 。单击``创建角色``该按钮以**创建新的 IAM 角色**。
> - 在创建角色部分，为角色选择**可信实体类型**：
> * **AWS 账户**
> * **AWS 账户:此账户**

image::/图片2/137图片/创建IAM.png[创建IAM]

> * 单击**下一步**
> - 添加权限：现在，您可以看到**策略列表**。按名称**``AmazonS3ReadOnlyAccess``**搜索权限并**添加**。
> - 单击**下一步**
> - 角色名称：输入 **``Stroll``**
> - 您**已成功**按名称 Stroll 创建了一个 IAM 角色。
> * 注意：您可以使用**其他名称创建角色**
> - 点击新创建的角色**``Stroll``**，可以看到目前该**角色只有一个``AmazonS3ReadOnlyAccess``的访问策略**
> - **信任关系**:**委托人``Principal``的内容为**，所有在这个**账户ID下的用户**，**允许执行``sts:AssumeRole``动作**

image::/图片2/137图片/信任关系.png[信任关系]

---

=== 配置 IAM 用户权限

> - 为了能够**让``zhangsan``执行``sts:AssumeRole``**，我们**添加一个内联策略**
> - **服务选择``STS``**，**操作选择``AssumeRole``**,资源**选择特定**，需要**指定允许``zhangsan``承担的角色的ARN**
> - 添加我们之前**创建的角色的ARN**

image::/图片2/137图片/创建的角色的ARN.png[创建的角色的ARN]

> - 下一步**查看策略**，然后策略**名称输入``AssumeRole``**，然后点击**创建策略**。

---

=== 验证

> - **切换到本地电脑终端中**
> - **使用AWS CLI**，**运行``aws sts assume-role``命令**，**为``zhangsan``用户**生成我们**创建角色Stroll的临时安全凭证**。
> - **运行以下命令**
> * 输入**``aws configure``**命令
> - 配置**访问密钥 ID-私有访问密钥**：
> * 将**张三用户**的**访问密钥 ID**与**私有访问密钥**复制到**相应的命令**中，然后按 [Enter] 键**确认**

image::/图片2/137图片/配置cli.png[配置cli]

> - **生成临时安全凭证**
> * **``aws sts assume-role --role-arn arn:aws:iam::270112070180:role/Stroll --role-session-name Stroll``**
> ** 注意：**将IAM角色ARN**和名称**替换为自己账户的**

image::/图片2/137图片/生成临时安全凭证.png[生成临时安全凭证]

> - 命令成功将**临时凭证返回**，**包括``accesskey`` ``secretkey``以及``会话Token``等等**。
> - 我们现在**执行下 ``aws s3 ls``**，**返回``Access Denied``**，还是**禁止访问**。

image::/图片2/137图片/还是禁止访问.png[还是禁止访问]

> - 因为我们这个**``zhangsan``的用户**，目前拥有的**唯一权限策略就是``sts:AssumeRole``**，他本身**没有S3相关权限**。
> - zhangsan需要通过以上这个**``aws sts assume-role``**命令返回Stroll角色的**临时凭证**，然后使用这个**临时凭证才可以访问S3**。
> - 所以我们现在**编辑下``credentials``文件**，将命令**返回的临时凭证信息放进去**，我们**新建一个``zhangsansts``字段**，然后将**凭证复制进去**。

image::/图片2/137图片/新建一个.png[新建一个]

> - 最后**按 ``ESC``+``:wq``**，以**保存 ``credentials`` 文件**。
> - 然后执行**``aws s3 ls --profile zhangsansts``**

image::/图片2/137图片/profile.png[profile]

> - 可以看到**我们现在可以访问S3存储桶**。
> - 以上这种授权**访问AWS资源的方式是AWS推荐的最佳实践**。
> - 将凭证安全**维持到了一个很高的级别**，而**不是通过将持久性凭证**分配给用户**使用这种粗放的方式**。

---

=== 获取临时凭证的自动化执行

> - 上方**访问AWS资源的方式**，当获取**角色临时凭证后**，需要**手动将``access key``、``secret key``以及``会话Token``复制到aws的``credentials``文件**。
> - 而**默认情况下**临时凭证的**有效期是一个小时**，也就是说**如果开发人员需要定期访问aws资源**，就需要在**凭证过期后再次运行``sts assume-role``命令**
> - 然后在将获取的**新的临时凭证**复制到aws的**``credentials``文件**中，这显然是一个**低效的方式**
> - 而作为**解决方案架构师来讲**，如果您**提供了这种方案给开发人员**，开发人员恐怕**不会遵循这个办法**。
> - 那怎么**解决这个问题呢**？AWS提供了一个**自动化上述过程的一个方法**

==== 指定AWS CLI承担角色的配置方法

> - 我们现在**这个用户案例**，需要在**本地CLI调用``AssumeRole``**，在使用**返回的临时凭证访问AWS资源**
> - 所以您需要**进行配置**，**指定AWS CLI承担的角色**，然后AWS CLI就会**自动为您进行相应的``AssumeRole``调用**
> * 需要在AWS CLI的**``credentials``**文件中**增加一个``profile``** ，包括**两个配置项**：
> ** **``role_arn``**，需要配置为**您需要承担角色的ARN**，所以我们这里**需要配置成我们新建的角色Stroll的ARN**
> ** **``source_profile``**，这里**配置执行assume-role的IAM用户凭证所在的``profile``**
> - **现在切换到本地电脑终端中**
> * **``vim credentials``**
> * 按 **``i``** 进入**插入模式**
> ** **新建了一个名**为**``automate``的``profile``**，里面有**包括``role_arn``和``source_profile``两个配置项**，将**复制的角色ARN粘贴到role_arn这里**
> ** **``source_profile``**，这里需要**配置执行assume-role的IAM用户凭证所在的profile**，对应我们这个案例就是**开发人员的IAM用户``zhangsan``**
> ** **``zhangsan``用户凭证所在的profile就是这里的``default``**

image::/图片2/137图片/default.png[default]

> - 最后**按 ``ESC``+``:wq``**，以**保存 ``credentials`` 文件**。
> - 通过这**两个配置项**，AWS会**自动使用``default``字段的zhangsan的安全凭证**，**返回``role_arn``配置项配置的角色``Stroll``的凭证**
> - 所以我们就可以**通过AWS CLI命令**，通过**指定``automate``的``profile``执行命令**。
> - **``aws s3 ls --profile automate``**

image::/图片2/137图片/automate.png[automate]


> - 可以看到**成功列出了S3存储桶**。
> - **通过配置AWS CLI承担角色这种方式**，我们就**不必在临时凭证过期时在手动执行``assume-role``命令获取临时凭证**
> - **这一切都将由AWS自动帮您搞定**。

---
