
## 使用AWS Systems Manager在EC2上安装httpd

=== AWS Systems Manager

> - AWS Systems Manager 提供了一个**统一的用户界面**，可以**简化资源和应用程序管理**，**缩短检测和解决操作问题的时间**，并使您能够**轻松安全地大规模操作和管理基础设施**。
> - 此服务包含了**丰富的功能**。它定义了**围绕使用 Amazon EC2 Systems Manager (SSM) 等**产品中的功能**进行分组**、**可视化**和**问题响应**的新体验，支持**大量跨资源的操作**。

=== 架构图

image::/图片2/112图片/架构图.png[架构图]

== 实验步骤

=== 创建 IAM 角色

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域
> - 导航到**``IAM``**
> - 在**左侧菜单**中，单击**``角色``** 。单击**``创建角色``**该按钮以**创建新的 IAM 角色**。
> - 在创建角色部分，为角色选择**可信实体类型**：
> * **AWS 服务**
> * **使用案例:EC2**

image::/图片/25图片/创建IAM.png[创建IAM]

> * 单击**下一步**
> - 添加权限：现在，您可以看到**策略列表**。按名称**``AmazonEC2RoleforSSM``**搜索权限并添加。
> - 单击**下一步**
> - 角色名称：输入 **``EC2_SSM_Role``**
> - 您**已成功**按名称 EC2_SSM_Role 创建了一个 IAM 角色。
> * 注意：您可以使用**其他名称创建角色**，然后将其**附加到 EC2 实例**

---

=== 启动 2 个 EC2 实例

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域。
> - 顶部菜单**导航到 EC2**
> - 左侧面板，单击**"实例"**，然后单击**"启动新实例"**。

==== (1)控制台启动实例

image::/图片/07图片/控制台2.png[控制台启动实例]

==== (2)选择系统镜像

image::/图片/07图片/控制台3.png[选择系统镜像]

==== (3)选择实例类型

image::/图片/07图片/配置1.png[选择实例类型]

==== (4)配置实例

> - 实例数：**输入 ``2``**
> - IAM角色 ：从下拉列表中选择**``EC2_SSM_Role``**
> - 将所有**其他设置保留为默认值**。单击**"下一步：添加存储"**

==== (5)添加存储

image::/图片/07图片/配置2.png[添加存储]

==== (6)添加标签

> - 添加标签：点击**添加标签**按钮
> * 键：**``Name``**
> * 值：**``EC2_SSM``**
> ** 注意：标签对于**本练习是必需的**，因为我们将在**SSM中使用它**。**两个实例的标签应相同**。
> * 点击**``下一步:配置安全组``**

==== (7) 配置安全组

> - 添加 HTTP：

----
  . 选择类型： 选择 HTTP
  . 协议：TCP
  . 端口范围：80
  . 源：选择"任何位置"
----

> - 注意：我们**不会为 EC2 实例添加 SSH 端口**。
> - 点击下一步 `审核和启动`

==== (8) 审核启动

> - **检查**所有选定的设置，**无误点击启动**
> * 选择**“在没有密钥对的情况下继续”**。
> * **选中复选框** - **我确认**。
> - 单击**启动新实例**以**启动 EC2 实例**。

---

=== 创建资源组

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域
> - 导航到**``AWS Resource Groups``**
> - 单击**创建资源组**
> * 组类型：**``基于标签``**
> * 分组条件：选择 **``AWS::EC2::Instance``**
> * 标签：
> ** 键：输入**``Name``**
> ** 值：输入**``EC2_SSM``**
> * 注意：由于我们**通过指定资源共享的标签**来**创建组资源**，因此**输入与 EC2 实例相同的标签键和值**，或从**下拉列表中进行选择**。
> - 单击**“查看组资源”**按钮。单击该选项后，您将看到**根据所选标签**显示的**实例**。

image::/图片2/112图片/预览组资源.png[预览组资源]

> - 输入**组名和组描述**，然后单击**创建组**
> * 组名：输入**``EC2_SSM_Group``**
> * 组描述：输入**``Creating a New Resource Group``**
> - 已成功**创建资源组**。

image::/图片2/112图片/已成功创建资源组.png[已成功创建资源组]

---

=== 创建命令文档并运行命令

> - 菜单导航到**``AWS Systems Manager``**。
> - 在左侧面板上，向下滚动到**已共享的资源**，然后单击**文档**。
> - 选择**“我拥有的”**，然后单击**“Create Command or Session”**。

image::/图片2/112图片/创建命令或会话.png[创建命令或会话]

> - 在**“文档详细信息”**下，将名称命名为**“InstallApache”**。
> - 在内容下，选择**``YAML``**并按原样**粘贴以下脚本**，然后单击**创建文档**。

```yaml
---
schemaVersion: '2.2'
description: Sample YAML template to install Apache
parameters: 
  Message:
    type: "String"
    description: "Welcome Message"
    default: "Hello World"
mainSteps:
- action: aws:runShellScript
  name: configureApache
  inputs:
    runCommand:
    - 'sudo yum update -y'
    - 'sudo yum install -y httpd'
    - 'sudo systemctl start httpd.service'
    - 'sudo systemctl enable httpd.service'
    - 'echo "{{Message}} from $(hostname -f)" > /var/www/html/index.html'
```

image::/图片2/112图片/粘贴以下脚本.png[粘贴以下脚本]

> - 创建文档后，单击**“我拥有的”**选项卡。搜索您**创建的文档**，然后**单击它**。
> - 单击右上角的**“运行命令”**选项。将**打开一个新窗口**。

image::/图片2/112图片/运行命令.png[运行命令]

> - 在**“运行命令”**页中，向下滚动并选择**“目标”**为**“选择一个资源组”**，然后从下拉列表中**选择前面创建的资源组**。

image::/图片2/112图片/选择资源组.png[选择资源组]

> - 将**所有其他选项保留为默认值**，然后单击**运行**按钮。
> - **等待大约一分钟**。命令 ID 将**成功创建并执行**。如果是**“进行中”**，请单击**“刷新”**。

image::/图片2/112图片/成功创建并执行.png[成功创建并执行]

---

=== 测试命令

> - **命令 ID 已创建并已成功执行**。
> - 为了**测试命令是否被执行**，让我们在**浏览器中复制公有IP并检查响应**。
> - 导航到 **EC2 左侧面板上的实例**。将实例**公有 IP 复制并粘贴到浏览器中**。
> - 您将看到**测试页面的输出**。

image::/图片2/112图片/测试命令1.png[测试命令1]

image::/图片2/112图片/测试命令2.png[测试命令2]

---
