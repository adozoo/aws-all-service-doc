
## AWS SQS消息队列

=== AWS SQS

==== 趣闻：这是第一个公开提供的 AWS 服务产品。

> - Amazon SQS 是一种**可靠、易于管理、可扩展的**消息队列服务。SQS 是一个**简单且经济高效的云应用程序**。
> - AWS SQS 可用于以**任何吞吐量级别**传输**任意数量的数据**，而**不会丢失消息**。连续运行时，它**不会中断其他服务**。
> - SQS 通过**扩展高可用消息**传递集群来帮助**减少管理任务**。虽然我们只为我们**使用的东西付费**。AWS SQS 帮助我们**保存重要数据**，如果整个应用程序**出现故障或任何组件不可用**，这些数据**可能会丢失**。
> - SQS 队列**充当接收数据的应用程序组件**与处理系统中数据的**其他部分之间的缓冲区**。
> - SQS 用于**面向消息的体系结构**。如果处理服务器无法以足够快的速度（无论出于何种原因）**处理工作**，则**工作将排队**，以便**处理服务器**在有可用资源来处理请求时可以处理它。这意味着工作**不会因资源不足而丢失**。
> - 默认 Amazon SQS 确保**每条消息至少传递一次**。
> - 有**两种类型**的队列：

image::/图片2/103图片/两种类型的队列.png[两种类型的队列]

=== 架构图

image::/图片2/103图片/架构图.png[架构图]

=== 个案研究：

> - 考虑一个电子商务网站上的重大闪购实例，人们在其中购买和销售各种产品。要求是所有关于**买方和卖方**的请求都应**按照队列接收的顺序进行处理**。为了满足此要求，我们将**使用 FIFO 队列**。

image::/图片2/103图片/FIFO 队列.png[FIFO 队列]

> - 一家移动公司正在以**最优惠的价格为其具有强大功能的新型号举行闪购**。预计会有**大量买家下订单**。该公司在**有限的时间内销售**，因此跟踪**首先到达的订单非常重要**。
> - 您的闪购会**收到巨大的反响**，现在预测只有**先下订单的买家才会收到产品**。
> - 让我们了解消息如何**进出我们的 FIFO 队列**。假设使用**应用程序请求一批最多 300 条消息**，AWS SQS 将开始使用**最旧的消息 （REQ A1） 填充该批**，并一直填充队列，直到**批处理已满**。
> - 在我们的例子中，假设批处理只**包含三个请求**，现在**队列是空的**。消息批离开队列后，SQS 会认为该**批处理处于运行中状态**，直到**批处理完全完成**或**可见性超时过期**。

image::/图片2/103图片/正常.png[正常]

> - 当您有一个用于**队列输出**的应用程序时，这很**容易处理**。它将**接收消息**，执行其**处理并删除消息**。现在，使用应用程序已准备好处理下一批消息。
> - 您还可以**添加自动扩展组**，以根据要求**扩展处理能力**。

==== 注意： 在删除第一批消息之前，SQS 不会释放下一批消息。

== 实验步骤

=== 使用控制台创建 FIFO 和标准队列

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域
> - 顶部菜单**导航到 SQS**，单击**创建队列**按钮。
> - **详细信息**：
> * 类型 ： 选择**``FIFO（先进先出）``**
> * 名称 ： 输入**``MyawsQueue.fifo``**
> * 注意 FIFO 队列的名称必须以**``.fifo``**后缀结尾。
> - 将所有内容**保留为默认值**，然后单击**创建队列**按钮

image::/图片2/103图片/FIFO.png[FIFO]

> - 单击**“创建队列”**后，您将收到**一条成功消息**。返回到**队列面板**
> - 我们还将**创建一个标准队列**，其中包含**所有默认选项**。唯一的区别是，我们在创建队列时**不提供后缀** **``.fifo``**。

image::/图片2/103图片/标准队列.png[标准队列]

> - **“类型”**列可帮助您**一目了然**地将**标准队列与 FIFO 队列区分开来**。对于 FIFO 队列，**“基于内容的重复数据删除”**列显示**每封消息是否启用了唯一的正文**。
> - 单击**``MyawsQueue.fifo``**以获取有关**所有重要参数**的详细信息，包括队列的**ARN、名称和 URL**。
> - 现在，我们将从 **FIFO 队列发送消息**。
> - 单击**发送和接收消息**按钮。

image::/图片2/103图片/发送和接收消息.png[发送和接收消息]

> - **发送消息**：
> * 消息正文：输入 **``My first queue message``**
> * 消息组 ID：输入 **``group123``**
> * 消息去重 ID：输入 **``id23``**
> - 现在点击 **发送消息**
> - 发送消息后，您将收到**成功发送的确认消息**。

image::/图片2/103图片/发送消息.png[发送消息]

> - 发送消息后，我们可以看到**可用消息更改为 1**。
> - 同样，使用**不同的消息正文**、**消息组 ID **和**消息去重 ID **发送更多消息。
> - 发送消息后，可用消息将**更改为已发送的消息数**。
> - 现在，要获取我们发送的**所有消息**，请单击**“接收消息”**部分中的**“轮询消息”**。
> - 现在，我们可以看到**消息列已填充了消息**。
> - 然后单击**消息**以**查看其正文**。

image::/图片2/103图片/已填充了消息.png[已填充了消息]

image::/图片2/103图片/查看其正文.png[查看其正文]

> - 我们已经在控制台中**成功发送和接收了消息**。
> - 同样，我们将**尝试使用标准队列来发送消息**。
> - 单击**发送和接收消息**。

image::/图片2/103图片/标准队列来发送消息.png[标准队列来发送消息]

> - 发送消息：
> * 消息正文：输入**``My first standard message queue``**
> * 现在**点击发送消息**按钮
> - 发送消息后，您将收到**成功发送的确认消息**。

image::/图片2/103图片/成功送达的确认.png[成功送达的确认]

> - 发送消息后，我们可以看到**可用消息更改为 1**。
> - 同样，使用**不同的消息正文**发送**更多消息**。
> - 发送消息后，可用消息将**更改为已发送的消息数**。
> - 现在，要获取我们发送的**所有消息**，请单击**“接收消息”**部分中的**“轮询消息”**。
> - 然后单击**消息**以**查看其正文**。

image::/图片2/103图片/单击消息以查看其正文.png[单击消息以查看其正文]

> - 我们已经在控制台中**成功发送和接收了消息**。
> - 让我们尝试**了解其他参数**，如**长轮询**以及它在 SQS 中的**工作原理**。

---

=== 什么是长轮询和配置长轮询

> - 长轮询： 让我们试着了解**轮询工作多长时间**以及为什么**我们应该使用它**。
> * 例如，如果我们的应用程序需要 SQS 消息，它将在后台**调用 RecieveMessage 函数**。ReceiveMessage 将**检查队列**中是否**存在**任何消息，并立即返回，无论是否**包含消息**。
> * 根据要求，在我们的应用程序中调用 ReceiveMessage 函数是可以的，但是如果 SQS 客户端**反复检查队列中**的消息是否有**任何新消息**，该怎么办？
> ** 这是一个问题，因为对 ReceiveMessage 函数的**连续调用**将需要**大量的 CPU 周期并占用线程**。在这种情况下，我们将使用**长轮询**。我们唯一需要做的修改是**将 WaitTimeSeconds 参数更新为 1-20 秒**。
> * 现在，如果队列为空，则调用将**等待时间秒**，等待队列中的**消息进入队列**，然后再返回。如果消息在**超时之前传入**，则呼叫将**立即返回消息**。
> - 请记住，如果 ReceiveMessage API 操作的等待时间**大于 0**，则**长轮询**有效。长轮询具有**成本效益**，因为您**不会经常轮询空队列**。
> - 默认情况下，Amazon SQS **使用短轮询**，仅查询**其服务器的子集 （基于加权随机分布）** 以确定是否有**任何消息可用于响应**。
> - 让我们尝试通过配置**长轮询**在现有队列中**完成此工作**。从列表中选择**任何队列（标准或 FIFO）**，然后单击**“编辑”**以在我们的队列中进行**配置更改**。我们将**选择 FIFO 队列作为示例**。

image::/图片2/103图片/作为示例.png[作为示例]

> - 选择**“编辑队列”**后，更新**“接收消息等待时间”**参数。它可以是 0 到 20 秒之间的任何值。在我们的示例中，我们已将其**更改为 10 秒**。
> - 这将使我们的**长轮询生效**。如果我们将值**保留为 0 或默认值**，则将其视为**短轮询**。进行更改后，单击**“保存”**。

image::/图片2/103图片/长轮询生效.png[长轮询生效]

---

=== 什么是可见性超时和配置可见性超时

> - 可见性超时是 AWS SQS **避免其他组件接收和处理消息的时间段**。
> - 个案研究：
> * 让我们尝试通过一个例子来理解定义。如果将大数据作业的**可见性超时保持在 1 分钟**，则会发生的情况是，消息将**返回到队列中**，因为它**不会在 1 分钟内完成**。
> * 假设实际处理**大量数据需要五分钟**。该消息将在**队列中变为可见**，然后**另一个 EC2 实例将选取它**。因此，您可能会**多次传递消息**，因为**可见性超时太低**。
> - 默认可见性**超时为 30 秒**。
> - 如果您的任务需要时间超过 30 秒，请**增加它**。
> - 最长**可达 12 小时**。
> - 让我们尝试通过**配置可见性超时**在现有队列中执行此操作。从列表中选择**任何队列（标准或 FIFO）**，然后单击**“编辑”**以在我们的队列中进行**配置更改**。我们将**选择 FIFO 队列作为示例**。

image::/图片2/103图片/作为示例.png[作为示例]

> - 选择**“编辑”**后，更新**“可见性超时”**参数。它可以是 0 秒到 12 小时之间的任何值。在我们的示例中，我们已将其**更改为 5 分钟**。
> - 进行更改后，单击底部的**“保存”**以使**更改生效**。

image::/图片2/103图片/可见性超时.png[可见性超时]

---

=== 什么是延迟队列和配置延迟队列

> - 延迟队列允许我们在**给定的时间段内延迟/推迟新消息的传递**。我们可以通过**配置 SetQueueAttributes 来**设置队列的 DelaySeconds 属性，轻松地将**任何队列转换为延迟队列**。
> * 如果我们创建一个延迟队列，则在**配置的延迟时间内**，发送到此**队列的任何消息**对**使用者都是不可见的**。
> * 若要**创建延迟队列**，请将 DelaySeconds 属性设置为**介于 0 到 900 秒之间的值**。
> - 个案研究：
> * 让我们尝试通过一个例子来理解定义。考虑一个应用程序尝试将数百万个数据**插入到数据库**中的情况。
> * 应用程序将发送一条有关**最近插入到其他子系统的新数据的可用性的消息**，这些子系统又处理此消息并**随后对同一行进行更新**。
> * 现在有一个**依赖关系**，在第一个批完成其作业并在更新后**提交之前**，下一批**不应被触发**。如果在**更新完成之前触发消息**，则**下一批将失败**。在这种情况下，**交付延迟**会有所帮助。
> - 让我们尝试通过配置**交付延迟**在现有队列中执行此操作。从列表中选择**任何队列（标准或 FIFO）**，然后单击**“编辑”**以在我们的队列中进行**配置更改**。我们将**选择 FIFO 队列作为示例**。

image::/图片2/103图片/作为示例.png[作为示例]

> - 选择**“编辑”**后，更新**“交付延迟”**参数。它可以是 0 秒到 15 分钟之间的任何值。在我们的示例中，我们已将其**更改为 60 秒**。
> - 更改后，单击底部的**“保存”**以使**更改生效**。

image::/图片2/103图片/交付延迟.png[交付延迟]

---

=== 清除队列并验证

> - 我们将尝试**清除队列**。在进入清除之前，让我们先了解一下**清除队列时会发生什么情况**。
> * 清除队列选项**允许我们删除队列中的消息**。
> * 消息删除过程**最多可能需要 60 秒**，具体**取决于队列的大小**。
> * 注： 调用**“清除队列”**操作后，无法从**队列中检索消息**。
> - 让我们尝试对现有队列进行此更改。 单击**“操作”**选择**“清除”**。

image::/图片2/103图片/清除.png[清除]

> - 选择**清除选项**后，它将要求**确认**。输入短语清除，然后单击**清除**按钮。
> - 它**不会显示**任何验证清除**是否成功的消息**。
> - 要**验证 ``FIFO`` 队列上是否发生了清除**，请单击**“发送和接收消息”**，然后单击**“轮询消息”**。

image::/图片2/103图片/验证.png[验证]

> - 同样，在标准队列上**重复清除步骤**并验证。

---

=== 要记住的知识点

> - 延迟队列和可见性超时之间的**基本区别**是，**延迟队列在首次将消息添加到队列中时隐藏消息**，而**可见性超时仅在从队列中检索消息后隐藏消息**。
> - 队列中最多可以**保留 120，000 条消息**。
> - 消息**大小为 256KB**。
> - 它具有**默认保留期**。
> - SQS 是基于**拉取**的，而**不是基于推送**的。

---
