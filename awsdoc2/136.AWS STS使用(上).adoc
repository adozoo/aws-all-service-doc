
## AWS STS使用

=== AWS Security Token Service

> - AWS STS 创建**可控制对您的 AWS 资源**的访问的**临时安全凭证**，并将这些凭证**提供给受信任用户**。
> - 临时安全凭证是**短期凭证**，可将这些凭证的**有效时间配置几分钟到几小时**，在**一定时间后失效**。临时安全凭证一直会**保持轮转**，**过期时间后**，**旧的凭证将会失效**。
> - 使用**临时安全凭证**，您就**不必**随应用程序分配或嵌入长期 AWS 安全凭证，我们要知道**嵌入长期AWS安全凭证是不安全的**。
> - 可**允许用户访问您的 AWS 资源**，而**不必为这些用户定义 AWS 身份**。**临时凭证是角色和联合身份验证的基础**。
> - 一般来讲，**安全凭证的轮换**在我们日常工作中是**一个挑战性的工作**，尤其是当我们**生成了一个永久访问的凭证时**， 出于**安全考虑**，我们要**定期对凭证进行轮换**
> - 这样的话即使**安全凭证泄露或者被公开**，也可以**降低安全风险**。而使用**临时安全凭证**，我们就**不需要太关注凭证的轮换**。
> - 临时安全凭证的**使用期限有限**，因此，在**不需要这些凭证时不必轮换或显式撤销这些凭证**。临时安全凭证**到期后无法重复使用**。

=== 架构图

image::/图片2/136图片/架构图.png[架构图]

== 实验步骤

=== 创建 IAM 角色

> - 导航到**``IAM``**
> - 在**左侧菜单**中，单击``角色`` 。单击``创建角色``该按钮以**创建新的 IAM 角色**。
> - 在创建角色部分，为角色选择**可信实体类型**：
> * **AWS 服务**
> * **使用案例:EC2**

image::/图片/25图片/创建IAM.png[创建IAM]

> * 单击**下一步**
> - 添加权限：现在，您可以看到**策略列表**。按名称**``AmazonS3ReadOnlyAccess``**搜索权限并**添加**。
> - 单击**下一步**
> - 角色名称：输入 **``S3ReadOnly``**
> - 您**已成功**按名称 S3ReadOnly 创建了一个 IAM 角色。
> * 注意：您可以使用**其他名称创建角色**，然后将其**附加到 EC2 实例**
> - 您已成功**创建角色以访问 S3 存储桶**。

---

=== 创建 S3 存储桶

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域。
> - 顶部菜单**导航到 S3**

image::/图片/09图片/导航到S3.png[导航到S3]

> - 在 S3 页面上，单击**``创建存储桶``**并**填写存储桶详细信息**。
> - 桶名称：输入**``mys3bucket-test-sts``**
> * 注意： S3 存储桶名称是**全局唯一**的，请**选择一个可用的名称**。
> - AWS 区域：选择**美国东部（弗吉尼亚北部）美国东部-1**
> - 将**其他设置保留**为默认值。
> - **创建存储桶按钮**
> - S3 **存储桶已创建**。

image::/图片2/136图片/成功创建存储桶.png[成功创建存储桶]

---

=== 启动 EC2 实例

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域。
> - 顶部菜单**导航到 EC2**
> - 左侧面板，单击**"实例"**，然后单击**"启动新实例"**。

==== (1)控制台启动实例

image::/图片/07图片/控制台2.png[控制台启动实例]

==== (2)选择系统镜像

image::/图片/07图片/控制台3.png[选择系统镜像]

==== (3)选择实例类型

image::/图片/07图片/配置1.png[选择实例类型]

==== (4)配置实例

> - 实例数：**输入 ``1``**
> - IAM 角色：**选择我们在上述步骤中创建的角色**
> - 将所有**其他设置保留为默认值**。单击**"下一步：添加存储"**

==== (5)添加存储

image::/图片/07图片/配置2.png[添加存储]

==== (6)添加标签

> - 添加标签：点击**添加标签**按钮
> * 键：**``Name``**
> * 值：**``STS_EC2``**
> * 点击**``下一步:配置安全组``**

==== (7) 配置安全组

> - 添加 **SSH**：

----
  . 选择类型： 选择 SSH
  . 协议：TCP
  . 端口范围：22
  . 源：选择"任何位置"
----

> - 点击下一步 **``审核和启动``**

==== (8) 审核启动

> - **检查**所有选定的设置，**无误点击启动**
> - 选择**现有密钥对**，确认并单击**启动实例**

image::/图片/07图片/现有密钥.png[现有密钥]

---

=== 通过 metadata 检索 IAM 角色临时安全凭证

> - **SSH 连接到 EC2 实例**
> - **切换到 root 用户**：**``sudo su``**
> - 我们在这个EC2实例上**执行以下命令获取元数据**：
> * **``curl http://169.254.169.254/latest/meta-data/iam/security-credentials/S3ReadOnly/``**

image::/图片2/136图片/元数据.png[元数据]

> - 看一下命令以及**返回结果**。**通过curl命令**，获得实例**元数据条目 ``iam/security-credentials/S3ReadOnly``**
> - **这里的``S3ReadOnly``**就是我们之前**附加在这个EC2的IAM角色名称**，最终命令**检索角色``S3ReadOnly``提供的安全证书**。
> - 我们在看下命令的**返回内容**，这个命令主要**返回三个信息**，**accessKeyId、SecretAccessKey以及会话Token**，还有**过期时间**
> - 表明以上**临时安全凭证在过期时间之后将会失效**，我们这台EC2实例，就是**使用以上临时安全凭证获得S3的只读访问权限的**。
> - 我们也可以将**这些安全凭证拷贝到自己本地电脑**，然后在**本地电脑通过这个临时安全凭证**也可以**获得同这个实例一样的只读访问S3存储桶权限**。
> - 有一点需要**注意**的是，我们在这个EC2的meta data中获取**accessKeyId、SecretAccessKey以及会话Token临时安全凭证**，并**不是 IAM 角色生成的**
> - 它们**是``AWS STS``服务生成的**，STS是**负责提供上述这些临时安全凭证的服务**。**IAM角色与STS服务之间会建立信任关系**，**通过STS服务获得这些凭证**。
> - 我们**验证一下**，导航到**``IAM``**
> - **点击``S3ReadOnly``角色**，会看到有一个信任关系选项卡，我们**看下策略内容**：

image::/图片2/136图片/信任关系.png[信任关系]

> - **``Principal``委托人指定了一个``Service``**，**``ec2.amazonaws.com``这个Service**；
> - **Action是``sts:AssumeRole``**，整个策略的意思为**允许``ec2.amazonaws.com``服务执行``sts:AssumeRole``来获取临时安全凭证**。
> - **``sts:AssumeRole``这个动作非常关键**，如果我们将这部分内容**去掉**，那么将**无法生成访问密钥等安全凭证**，**EC2也将无法访问S3存储桶**

---

=== 迁移EC2的凭证

> - **切换到本地电脑终端中**
> - **看下目前aws的``credentials``文件内容**,使用**以下命令查看**
> * **``cd``**
> * **``cd .aws``**
> * **``vim credentials``**
> - 注意：本地电脑需**事先安装 AWS CLI**

image::/图片2/136图片/credentials.png[credentials]

> - 我们**执行 ``aws s3 ls`` 命令**，目前**无法列出S3存储桶**。我们现在需要**将EC2中``sts服务``为角色生成的临时凭证复制到电脑的``credentials``文件中**。

image::/图片2/136图片/查看s31.png[查看s31]

> - 首先我们**配置 AWS CLI**
> * 输入**``aws configure``**命令
> - 配置**访问密钥 ID-私有访问密钥**：
> * 将 **EC2元数据**的**访问密钥 ID**与**私有访问密钥**复制到**相应的命令**中，然后按 [Enter] 键**确认**

image::/图片2/136图片/配置cli.png[配置cli]

> - 最后**编辑本地电脑中的``credentials``文件**，**新增一个字段**，**``aws_session_token``**。
> - 然后我们**将EC2中的角色``会话Token``复制过来**
> * **``vim credentials``**
> * 按 **``i``** 进入**插入模式**

image::/图片2/136图片/aws_session_token.png[aws_session_token]

> - 最后**按 ``ESC``+``:wq``**，以**保存 ``credentials`` 文件**。
> - 现在**再次执行 ``aws s3 ls`` 命令**进行验证

image::/图片2/136图片/列出1.png[列出1]

> - 可以看到我们**已经成功列出 S3 的存储桶**，我的本地电脑现在**拥有和 EC2 的 IAM 角色同样的权限**。

---
