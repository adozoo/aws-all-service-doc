
## SQS 触发 Lambda 函数并将消息存储在 S3 存储桶中

=== 架构图

image::/图片2/105图片/架构图.png[架构图]

== 实验步骤

=== 创建S3存储桶

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域。
> - 顶部菜单**导航到 S3**

image::/图片/09图片/导航到S3.png[导航到S3]

> - 在 S3 页面上，单击**``创建存储桶``**并**填写存储桶详细信息**。
> - 桶名称：输入**``mysqslambdatest``**
> * 注意： S3 存储桶名称是**全局唯一**的，请**选择一个可用的名称**。
> - AWS 区域：选择**美国东部（弗吉尼亚北部）美国东部-1**
> - 对于对象所有权：选择**ACL 已禁用(推荐)**
> - 对于此存储桶的**“阻止公有访问”**设置部分
> * **取消选中**"阻止所有公共访问"选项，然后**选中确认**选项。
> - 将**其他设置保留**为默认值。
> - **创建存储桶按钮**
> - S3 **存储桶已创建**。

image::/图片2/105图片/存储桶已创建.png[存储桶已创建]

---

=== 创建 IAM 角色

> - 导航到**``IAM``**
> - 在**左侧菜单**中，单击**``角色``** 。单击**``创建角色``**该按钮以**创建新的 IAM 角色**。
> - 在**创建角色**部分，为角色选择**可信实体类型**：
> * **AWS 服务**
> * **使用案例:Lambda**

image::/图片/09图片/IAM创建角色2.png[IAM创建角色2]

> * 单击**下一步**
> - 添加权限：现在，您可以看到**策略列表**。按名称**``AmazonSQSFullAccess``**搜索权限并添加。
> - 按名称**``AWSLambdaExecute``**搜索权限并添加。
> - 按名称**``AmazonS3FullAccess``**搜索权限并添加。
> - 单击**下一步**
> - 角色名称：输入 **``lambda_sqs_role``**
> - 您**已成功**按名称 lambda_sqs_role 创建了一个 IAM 角色。
> * 注意：您可以使用**其他名称创建角色**，然后将其**附加到 Lambda 函数**

---

=== 创建 Lambda 函数

> - 确保您位于**美国东部（弗吉尼亚北部）区域**。
> - 转到菜单，然后单击 **Lambda**。

image::/图片/09图片/导航到Lambda.png[导航到Lambda]

> - 单击**创建函数**该按钮。
> - 选择**``从头开始创建``**
> - 函数名称：输入 **``my_sqs_Lambda``**
> - 运行时：**``Python 3.9``**
> - 角色：在权限部分中，单击**"更改默认执行角色"**，然后单击**"使用现有角色"**。
> - 现有角色：选择**``lambda_sqs_role``**
> - 点击**创建函数**该按钮。
> - 配置页面：在此页面上，我们需要**配置我们的 Lambda 函数**。
> - 向下滚动，可以看到**"代码源"**部分。
> - **删除 lambda_function.py 中的现有代码**。
> - 复制以下代码并将其**粘贴到您的 ``lambda_function.py`` 文件中**。

```py
  import json
  import boto3
  def lambda_handler(event, context):
      sqs_msg = json.loads(event['Records'][0]['body'])
      print("SQS Message : ", sqs_msg)
      bucket_name = "mysqslambdatest"
      try:
          s3Client = boto3.client("s3", region_name= "us-east-1")
          Response = s3Client.put_object(Bucket= bucket_name, Key= "Message.json", Body= json.dumps(sqs_msg))
          print("S3 upload success !")
          return {
              "status" : 200,
              "body" : "S3 upload success"
          }
      except Exception as e:
          print("Client connection to S3 failed because ", e)
          return{
              "status" : 500,
              "body" : "S3 upload failed"
          }
```


> - 注意：请将**代码中的存储桶**名称**替换为您在上述步骤中创建的存储桶名称**。
> - 通过单击**“部署”**按钮来**保存函数**。

---

=== 创建 SQS 队列

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域
> - 顶部菜单**导航到 SQS**，单击**创建队列**按钮。
> - **详细信息**：
> * 类型 ： 选择**``标准``**
> * 名称 ： 输入**``awslabs-sqs``**
> - 将所有内容**保留为默认值**，然后单击**创建队列**按钮

image::/图片2/104图片/创建队列.png[创建队列]

> - 单击**“创建队列”**后，您将收到**一条成功消息**。

---

=== 添加 Lambda 触发器

> - 现在**向下滚动**并**单击 Lambda 触发器选项卡**。您会发现一个 **Lambda 触发器是自动创建的**。
> - 但它将处于**禁用状态**。因此，您需要**先启用它**。

image::/图片2/105图片/禁用状态.png[禁用状态]

> - **选择 Lambda 触发器**，然后单击**在 Lambda 中查看按钮**。
> - 它将在新选项卡中**打开 Lambda 页面**。
> - 现在，单击**“配置”**选项卡，然后单击左侧菜单中的**“触发器”**。
> - 选择**``awslabs_sqs``**触发器，然后单击**启用**按钮。
> - 在**“启用触发器”**弹出消息中，单击**“关闭”**。
> - 要**检查 Lambda 触发器是否已启用**，请**关闭当前 Lambda 选项卡**并**返回到 SQS 选项卡**。
> - 现在**刷新页面**，查看 Lambda 触发器状态**是否更改为已启用**。

image::/图片2/105图片/已启用.png[已启用]

---

=== 测试实验室

> - **导航到 SQS 队列**，单击右上角的**发送和接收消息**按钮。
> - 在**“发送消息”**下：
> - 消息正文 ： 输入**``{"Name" : "Paul", "Course" : "Amazon Web Services", "Cost" : "$20"}``**
> - 点击**发送消息**按钮。
> - 现在**导航到 S3 控制台**，打开您**创建的 S3 存储桶**。
> - 您将能够**看到名为 ``Message.json`` 的对象**。

image::/图片2/105图片/Message.png[Message]

> - **选择对象**，然后单击**下载**按钮。**S3 对象将下载到本地计算机**。
> - 现在**打开文件**，您将能够看到您**刚刚传递给 SQS 的消息**。

image::/图片2/105图片/SQS.png[SQS]

---
