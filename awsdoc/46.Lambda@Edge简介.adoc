
## Lambda@Edge简介

=== 什么是Lambda@edge？

> - Lambda@Edge是 **Amazon CloudFront 的一项功能**，可让您在更**靠近用户的位置运行应用程序代码**，从而**提高性能并减少延迟**。
> - 您**不必在全球多个位置预置或管理基础架构**。
> - 您只需**为 Lambda 函数时间付费**，无需进行**其他额外更改**。
> - Lambda@Edge运行您的代码以**响应 Amazon CloudFront 内容交付网络 （CDN） 生成的事件**。只需将代码**上传到 AWS Lambda**，即可在最靠近最终用户的 **AWS 位置使用 HA 运行和扩展代码**。
> - **没有要管理的服务器**，您可以**自定义内容交付**。
> - 您可以在**四个不同的事件**中**添加您的 lambda 代码**，它们是：
> * 查看器请求：将**查看器请求传递给 lambda 函数**，对其**进行处理**，然后将其**传递给分发**。
> * 查看器响应：将**来自分发的响应传递给 lambda 函数进行处理**，然后将其**发送给用户**。
> * 源请求：将**来自分发的请求传递给 lambda 函数**，对其**进行处理**，然后将其**传递到源**。
> * 源响应：将**来自源的响应传递给 lambda 函数**进行**处理**。

=== 架构图

image::/图片/46图片/架构图.png[架构图]

=== 个案研究

> - 在本实验中，我们将**根据源请求实现Lambda@edge**。lambda 将**根据用户 URL 将路径重定向到相应的 HTML 页面**。
> - 进入 S3 存储桶的 cloudfront 请求将被**重定向到 lambda**，一旦**执行 lambda**，则只有该请求才会进入**放置在 Origin 的 S3 存储桶**。

=== 案例研究图

image::/图片/46图片/案例研究图.png[案例研究图]

== 实验步骤

=== 创建 S3 存储桶

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域。
> - 顶部菜单**导航到 S3**

image::/图片/09图片/导航到S3.png[导航到S3]

> - 在 S3 页面上，单击**``创建存储桶``**并**填写存储桶详细信息**。
> - 桶名称：输入**``edge-bucket-test``**
> * 注意： S3 存储桶名称是**全局唯一**的，请**选择一个可用的名称**。
> - AWS 区域：选择美国东部（弗吉尼亚北部）美国东部-1
> - 对于对象所有权：选择**ACL 已启用**
> * 对象所有权选项：选择**对象编写者**
> - 注意：请选择对象编写者，否则将**不允许编辑存储桶 ACL**。
> - 对于此存储桶的**“阻止公有访问”**设置部分
> * **取消选中**"阻止所有公共访问"选项，然后**选中确认**选项。
> - 将**其他设置保留**为默认值。
> - **创建存储桶按钮**
> - S3 **存储桶已创建**。

---


=== 将文件上传到 S3 存储桶并公开


> - **单击**您的存储桶名称。
> - 在对象中，您可以看到**以下消息**
> * 此存储桶中**没有任何对象**。

image::/图片/41图片/没有对象.png[没有对象]

> - 您可以从本地计算机**本实验所需文件**

==== **``本实验所需文件``**位于此仓库**附件目录**

> - 将文件**上传到我们的 S3 存储桶**
> * 点击**上传**按钮。
> * 点击**添加文件**按钮。
> * 浏览您的本地文件**并选择它**
> * 单击上传按钮**上传**。
> - 您可以从屏幕顶部的传输面板中**查看上传进度**。
> - 上传文件后，它将**显示在存储桶中**。
> - 现在**使对象公开**。
> - **分别单击上传的对象名称**。
> - 单击**"操作"**按钮，然后单击**下拉列表中的最后一个选项"使用ACL公开"**。
> - 单击**"设为公开"**按钮，然后单击**"关闭"**。
> - 单击存储桶名称以**导航回您的 S3 存储桶主页**。

---


=== 创建 Lambda 函数

> - 确保您位于**美国东部（弗吉尼亚北部）区域**。
> - 转到菜单，然后单击 **Lambda**。

image::/图片/09图片/导航到Lambda.png[导航到Lambda]

> - 单击**创建函数**该按钮。
> - 选择**``从头开始创建``**
> - 函数名称：输入 **``edge_lambda``**
> - 运行时 ：**Python 3.9**
> - 角色：在权限部分中，单击"更改默认执行角色"，然后单击**"从 AWS 策略模板创建新角色"**。
> - 角色名称：输入**edgeIAM**
> - 策略模板：选择**``基本 Lambda@Edge 权限 (适用于 CloudFront 触发器)``**
> - 然后点击**创建函数**该按钮。
> - 配置页面：在此页面上，我们需要**配置我们的 lambda 函数**。
> - 向下滚动，可以看到**"代码源"**部分。在这里，我们需要**编写一个 Python 函数**。
> - **删除 lambda_function.py 中的现有代码**。复制以下代码并将其**粘贴到lambda_function.py文件中**。

```py
  import json
  def lambda_handler(event, context):
      request = event['Records'][0]['cf']['request']
      headers = request['headers']
      if request['uri'] == '/site/admin' or request['uri'] == '/site/admin/':
          # Not an A/B Test
          request['uri'] = '/admin.html'
          return request
      else:
          request['uri'] = '/user.html'
          return request
```

> - 单击"部署"按钮**保存函数**。

==== 代码说明：

> - **此 lambda 函数与 CloudFront Distribution 集成**。
> - 客户端请求详细信息将由 CloudFront **传递给 lambda 函数事件**。
> - 我们从**事件变量中获取请求详细信息**。
> - 如果**请求 URI 包含 /site/admin 路径**，则 lambda 会**更新 URI 以重定向到 admin.html 文件**。
> - 否则，它将**始终重定向到user.html页面**。

---

=== 创建 Lambda 版本

> - 成功**部署 Lambda 函数代码后**。
> - 导航到**源代码**上方的**"版本"**选项卡，然后单击**"发布新版本"**按钮。
> - 现在点击**发布**按钮。

image::/图片/46图片/发布版本.png[发布版本]


> - **创建 lambda 函数的版本后**，**复制版本的ARN 并将其放在文本编辑器中**。

image::/图片/46图片/函数ARN.png[函数ARN]

---


=== 创建 Amazon CloudFront 分配

> - 从菜单中**导航到 CloudFront**。
> - 导航到**左侧面板**，选择**"分配"**选项卡。
> - 现在点击**创建分配**按钮
> - 现在按如下方式**配置CloudFront分发**
> * **源域**
> ** 选择**您的 S3 存储桶**：**``edge-bucket-test.s3.us-east-1.amazonaws.com``**
> - 默认**缓存行为设置** ：
> * 向下滚动到**缓存键和源请求**：选择**旧版缓存设置(Legacy cache settings)**
> * 对象缓存：选择**自定义(Customize)**
> * 最大 TTL：输入 **10**
> * 默认 TTL：输入 **6**
> - 注意：TTL **设置为较小的值以减少缓存时间**，为**练习演示目的**。

image::/图片/46图片/源请求.png[源请求]

> - 滚动到**函数关联**
> * CloudFront 事件：选择**源请求**
> * Lambda 函数 ARN ：**粘贴您复制的 Lambda 版本的ARN**。

image::/图片/46图片/函数关联.png[函数关联]

> - 无需**更改配置中的其他任何内容**，向下滚动并**单击创建分配按钮**
> - 您可以看到 **CloudFront 已启用**
> * 注意：此过程大约需要**5-10分钟**。
> - Amazon CloudFront 分配给您的**分配的域名将显示在分配列表中**。它看起来与**``df10hrgsq1pdx.cloudfront.net``**相似

---

=== 测试CloudFront分发

> - 复制 CloudFront 分配域名**并将其粘贴到浏览器中**，然后**点击 [enter]**。
> - 您将能够**看到用户登录页面**。


image::/图片/46图片/user.png[user]

> - 现在**添加``/site/admin/``在域名后**。
> * 语法：**<CloudFront分配域名>/site/admin/**
> * 例：**df10hrgsq1pdx.cloudfront.net/site/admin/**

image::/图片/46图片/admin.png[admin]

> - 此处，页面**重定向由 Lambda 函数根据您的 URL 完成**。


---
