
## 弹性负载均衡ELB

=== 什么是弹性负载均衡？

> - ELB 是一种**自动分配传入应用程序流量**并**扩展资源**以满足流量需求的服务。
> - ELB 有助于根据传入的应用程序和网络流量**调整容量**。
> - ELB 可以在单个可用区内启用，也可以**跨多个可用区启用**，以保持**一致的应用程序性能**。
> - ELB 提供以下功能：
> * 检测运行状况不佳的 EC2 实例。
> * 仅将 EC2 实例分布在正常运行的通道中。
> * 集中管理 SSL 证书。
> * 可选的公钥身份验证。
> * 同时支持 IPv4 和 IPv6。
> - ELB 接受来自客户端的传入流量，并将请求路由到其注册的目标。
> - 当检测到运行状况不佳的目标或实例时，ELB 会**停止向其路由流量**，并且仅在实例再次**正常运行时恢复**。
> - ELB 监控其注册目标的运行状况，并确保流量仅路由到运行状况良好的实例。
> - ELB 配置为通过指定一个或多个侦听器来接受传入流量。侦听器是**检查连接请求**的进程。
> - 侦听器配置了从客户端到 ELB 的协议和端口号，反之亦然，即从 ELB 返回到客户端。
> - ELB 支持 3 种类型的**负载均衡器**：
> * 应用程序负载均衡器
> * 网络负载均衡器
> * 传统负载均衡器
> - 每个负载均衡器的**配置方式**不同。
> - 对于应用程序和网络负载均衡器，您可以在目标组中注册目标并将流量路由到目标组。
> - 对于传统负载均衡器，您可以向**负载均衡器注册实例**。
> - AWS 建议用户使用应用程序负载均衡器使用多个可用区，因为如果一个**可用区出现故障**，负载均衡器可以**继续将流量路由到下一个可用区**。
> - 我们可以将负载均衡器设为内部负载均衡器，也可以是面向 Internet 的负载均衡器。
> - 面向 Internet 的负载均衡器的节点具有公共 IP 地址，并且 DNS 名称可公开解析为节点的公共 IP 地址。
> - 面向互联网的负载均衡器**可以通过互联网路由**来自**客户端的请求**。
> - **内部负载均衡器**的节点只有专用 IP 地址，并且 DNS 名称可公开解析为节点的专用 IP 地址。
> - **内部负载均衡器**只能**路由来自有权访问负载均衡器 VPC** 的客户端的请求。
> - 面向 Internet 的负载均衡器和内部负载均衡器都使用专用 IP 地址将**请求路由**到**您的目标**。
> - 目标**不需要公共 IP 地址**来接收来自内部或面向 Internet 的负载均衡器的请求。

=== 架构图


image::/图片/12图片/架构图1.png[架构图,300,500,float="left"]

image::/图片/12图片/架构图2.png[架构图2,300,500,float="right"]


== 实验步骤

=== 启动第一个 EC2 实例

==== (1)控制台启动实例

image::/图片/07图片/控制台2.png[控制台启动实例]

==== (2)选择系统镜像

image::/图片/07图片/控制台3.png[选择系统镜像]

==== (3)选择实例类型

image::/图片/07图片/配置1.png[选择实例类型]

==== (4)配置实例

> - 实例的数量：**选择 1**
> - 高级详细信息
> - 用户数据：以文本形式

```shell
  #!/bin/bash
  sudo su
  yum update -y
  yum install httpd -y
  echo "<html><h1> Welcome to AWS 1 </h1><html>" >> /var/www/html/index.html
  systemctl start httpd
  systemctl enable httpd
```

==== (5)添加存储

image::/图片/07图片/配置2.png[添加存储]

==== (6)添加标签

image::/图片/07图片/配置3.png[添加标签]

==== (7) 配置安全组

> - 添加 SSH：

----
  . 选择类型： 选择 SSH
  . 协议：TCP
  . 端口范围：22
  . 源：选择"任何位置"
----

> - 添加 HTTP：

----
  . 选择类型：选择 HTTP
  . 协议：TCP
  . 端口范围：80
  . 源：选择"任何位置"
----

> - 添加 HTTPS：

----
  . 选择类型：选择 HTTPS
  . 协议：TCP
  . 端口范围：443
  . 源：选择"任何位置"
----

image::/图片/07图片/安全组.png[安全组]

> - 点击下一步 `审核和启动`

==== (8) 审核启动

> - **检查**所有选定的设置，**无误点击启动**
> - 选择现有密钥对，确认并单击**启动实例**

image::/图片/07图片/现有密钥.png[现有密钥]

---

=== 启动第二个 EC2 实例

==== (1)控制台启动实例

image::/图片/07图片/控制台2.png[控制台启动实例]

==== (2)选择系统镜像

image::/图片/07图片/控制台3.png[选择系统镜像]

==== (3)选择实例类型

image::/图片/07图片/配置1.png[选择实例类型]

==== (4)配置实例

> - 实例的数量：**选择 1**
> - 高级详细信息
> - 用户数据：以文本形式

```shell
  #!/bin/bash
  sudo su
  yum update -y
  yum install httpd -y
  echo "<html><h1> Welcome to AWS 2 </h1><html>" >> /var/www/html/index.html
  systemctl start httpd
  systemctl enable httpd
```

==== (5)添加存储

image::/图片/07图片/配置2.png[添加存储]

==== (6)添加标签

image::/图片/07图片/配置3.png[添加标签]

==== (7) 配置安全组

> - 单击"选择一个现有的安全组"，选择"EC2SG"，

image::/图片/12图片/现有安全组.png[现有安全组]

> - 点击下一步 `审核和启动`

==== (8) 审核启动

> - **检查**所有选定的设置，**无误点击启动**
> - 选择现有密钥对，确认并单击**启动实例**

image::/图片/07图片/现有密钥.png[现有密钥]

---

=== 创建目标组和负载均衡器

==== 在 EC2 控制台中，**导航到**左侧面板中**负载平衡**下的**目标群组**。
> - 单击``创建目标组``按钮。
> - 步骤 1，指定组**详细信息**
> * 在"基本配置"下，
> ** 选择目标类型：选择**实例**
> ** 目标组**名称**：输入"MyTargetGroup"
> * 将所有设置保留为**默认值**。
> * 滚动到页面**末尾**，然后单击"下一步"按钮。

> - 步骤 2，注册目标
> * **选中**这两个实例，然后单击"在下面以待注册的形式添加"按钮。
> * 实例将出现在"查看目标"部分中，运行状况**状态为"待处理"**。
> * 单击**创建目标组**按钮。

image::/图片/12图片/注册目标.png[注册目标]

> - **现在已创建目标组**。


==== 在 EC2 控制台中，**导航到**左侧面板中**负载平衡**下的**负载均衡器**。

> - 单击左上角``创建负载均衡器``按钮，为我们的 Web 服务器创建负载均衡器。
> - 选择负载均衡器**类型**：选择"应用程序负载均衡器（Application Load Balancer）"，单击"创建"按钮。
> - 要创建应用程序负载均衡器，请按如下方式**配置负载均衡器**
> * 对于**基本配置**部分
> ** 负载均衡器**名称**：输入"MyLoadBalancer"
> ** 模式：选择**面向互联网**
> ** IP 地址类型：**选择 IPv4**
> * 对于**网络映射**部分：
> ** VPC：保持**默认**
> ** 映射：选择**所有存在的可用区**
> * 对于"安全组"部分，
> ** 从下拉列表中**选择 EC2SG 安全组**，然后**删除默认安全组**。
> * 对于**侦听器和路由**部分，
> * 侦听器已随协议 HTTP 和端口 80 一起存在。
> ** 为"默认操作转发到"选项**选择目标组** MyTargetGroup。
> - 将其他选项保留为**默认值**，然后单击"创建负载均衡器"按钮。 
> - **您已成功创建应用程序负载均衡器。 单击查看负载均衡器按钮**。
> - 等待 2 到 3 分钟，让负载均衡器变为**活动**状态。


---


=== 测试弹性负载均衡器

> - 接下来，**导航到**左侧面板中**负载平衡**下的**负载均衡器**
> - 并注意到 ELB 的状态为**活动**状态。
> - 复制 ELB 的 **DNS 名称**，然后在浏览器中**输入地址**。
> * 域名解析示例：``MyLoadBalancer-76825594.us-east-1.elb.amazonaws.com``

image::/图片/12图片/负载均衡器.png[负载均衡器]

> - 您应该看到 Web 服务器 1 或 Web 服务器 2 的index.html**页面内容**

image::/图片/12图片/AWS1.png[AWS1]

> - 现在**刷新页面几次**。您会注意到索引页在**每次刷新时都会更改**。
> * 注意： ELB 以**轮循机制**方式平均**分配到两个服务器**的传入流量。

> - 继续进行测试，如果某一台EC2**工作不正常**
> * 在左侧菜单中，向上滚动并**导航回实例**页面。
> * 选择任意一台EC2实例，单击实例状态，然后单击**停止实例**以停止 EC2 实例

image::/图片/12图片/停止EC2.png[停止EC2]

> - 停止 EC2 实例后，**导航到**左侧面板中**负载平衡**下的**目标群组**。
> - 选择"我的目标组"，单击"目标"。
> - 它会说实例**已停止未使用**。

image::/图片/12图片/查看目标组.png[查看目标组]


> - 在浏览器中**刷新 ELB 域名 URL**，请注意 HTML 网页**仍然可见**。ELB 仅从**可用EC2实例呈现HTML 页面**。

image::/图片/12图片/AWS2.png[AWS2]

---
































