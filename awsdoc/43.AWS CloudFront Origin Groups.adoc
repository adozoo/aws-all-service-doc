
## AWS CloudFront Origin Groups

=== 架构图

image::/图片/43图片/架构图.png[架构图]

== 实验步骤

=== 创建 S3 存储桶

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域。
> - 顶部菜单**导航到 S3**

image::/图片/09图片/导航到S3.png[导航到S3]

> - 在 S3 页面上，单击**``创建存储桶``**并**填写存储桶详细信息**。
> - 桶名称：输入**``mys3bucket-lab``**
> * 注意： S3 存储桶名称是**全局唯一**的，请**选择一个可用的名称**。
> - AWS 区域：选择**美国东部（弗吉尼亚北部）美国东部-1**
> - 对于对象所有权：选择**ACL 已禁用(推荐)**
> - 对于此存储桶的**“阻止公有访问”**设置部分
> * **取消选中**"阻止所有公共访问"选项，然后**选中确认**选项。
> - 将**其他设置保留**为默认值。
> - **创建存储桶按钮**
> - S3 **存储桶已创建**。


image::/图片/41图片/成功创建存储桶.png[成功创建存储桶]


---

=== 将对象上传到 S3 存储桶


> - **单击**您的存储桶名称。
> - 在对象中，您可以看到**以下消息**
> * 此存储桶中**没有任何对象**。

image::/图片/41图片/没有对象.png[没有对象]

> - 您可以从本地计算机**上传index.html**

==== ``index.html``位于此仓库附件目录

> - 将文件上传到我们的 S3 存储桶
> * 点击**上传**按钮。
> * 点击**添加文件**按钮。
> * 浏览您的本地文件**并选择它**
> * 单击上传按钮**上传**。
> - 您可以从屏幕顶部的传输面板中**查看上传进度**。
> - 上传文件后，它将**显示在存储桶中**。

---

=== 使对象可公开访问


> - 单击**权限选项卡**。
> - 向下滚动到**存储桶策略**，然后单击**编辑**。复制并**粘贴以下策略并保存策略**。
> - 注意： 在代码中的**"Resource"**选项中，使用您的**存储桶 ARN **进行更改。


```json
  { 
     "Id":"Policy1",
     "Version":"2012-10-17",
     "Statement":[ 
        { 
           "Sid":"Stmt1",
           "Action":[ 
              "s3:GetObject"
           ],
           "Effect":"Allow",
           "Resource":"replace-this-string-with-your-bucket-arn/*",
           "Principal":"*"
        }
     ]
  }
```

> - 点击**保存更改**

---

=== 创建CloudFront分发

> - 从菜单中**导航到 CloudFront**。
> - 导航到**左侧面板**，选择**"分配"**选项卡。
> - 现在点击**创建分配**按钮
> - 现在按如下方式**配置CloudFront分发**
> * **源域**
> ** 选择**您的 S3 存储桶**：**``mys3bucket-lab.s3.us-east-1.amazonaws.com``**
> - 无需**更改配置中的其他任何内容**，向下滚动并**单击创建分配按钮**
> - 您可以看到 **CloudFront 已启用**
> * 注意：此过程大约需要**5-10分钟**。
> - Amazon CloudFront 分配给您的**分配的域名将显示在分配列表中**。它看起来与**``https://d20umzcw20c8l3.cloudfront.net/``**相似
> - 将 CloudFront 分配的域名**复制并粘贴到浏览器**的**新选项卡中**。
> - 它将**引发错误**，因为 **S3 存储桶具有对象index.html**
> - 将 CloudFront 分配的域名**复制并粘贴到浏览器的新选项卡中**，然后在 URL 中**添加 ``/index.html``**。
> - 它应该显示 S3 存储桶中**存在的index.html页面**。

image::/图片/43图片/s3index.png[s3index]

---

=== 启动 EC2 实例

==== (1)控制台启动实例

image::/图片/07图片/控制台2.png[控制台启动实例]

==== (2)选择系统镜像

image::/图片/07图片/控制台3.png[选择系统镜像]

==== (3)选择实例类型

image::/图片/07图片/配置1.png[选择实例类型]

==== (4)配置实例

> - 实例的数量：**选择 1**
> - 高级详细信息
> - 用户数据：以**文本形式**

```shell
  #!/bin/bash
  yum update -y
  yum install -y httpd.x86_64
  systemctl start httpd
  systemctl enable httpd
  echo "<h1>Hello, this index.html page from $(hostname -f)</h1>" > /var/www/html/index.html
  echo "<h1>Hello, this index2.html page from $(hostname -f)</h1>" > /var/www/html/index2.html
```

> - 将其余设置**保留为默认值**，然后单击**下一步按钮**。

==== (5)添加存储

image::/图片/07图片/配置2.png[添加存储]

==== (6)添加标签

image::/图片/07图片/配置3.png[添加标签]

==== (7) 配置安全组

> - 添加 SSH：

----
  . 选择类型： 选择 SSH
  . 协议：TCP
  . 端口范围：22
  . 源：选择"任何位置"
----

> - 添加 HTTP：

----
  . 选择类型： 选择 HTTP
  . 协议：TCP
  . 端口范围：80
  . 源：选择"任何位置"
----


> - 点击下一步 `审核和启动`

==== (8) 审核启动

> - **检查**所有选定的设置，**无误点击启动**
> - 选择现有密钥对，确认并单击**启动实例**

image::/图片/07图片/现有密钥.png[现有密钥]

=== 测试

> - 记下 EC2 实例的示例**公有 IPv4 DNS 地址**。
> - 尝试**通过粘贴到**浏览器中来**访问公共IPv4 DNS地址**，您将看到**如下所示的响应**。

image::/图片/43图片/ec2.png[ec2]

> - 现在，在 URL 中**添加 ``/index.html``**。

image::/图片/43图片/ec2index.png[ec2index]

> - 现在，将 ``/index.html`` **修改为 ``/index2.html``**

image::/图片/43图片/ec2index2.png[ec2index2]

---


=== 添加 EC2 作为源并创建源组


> - 在将 EC2 实例添加为源之前，请**确保 CloudFront **分配**处于"已启用"**状态。
> - CloudFront 分配处于**"已启用"**状态，请**单击 ID 以添加源**。

image::/图片/43图片/cloudfront启用.png[cloudfront启用]


> - 切换到**"源"**选项卡，然后单击**"创建源"**按钮

image::/图片/43图片/源.png[源]

> - 在第一个选项**"源域**"中，**复制粘贴的 EC2 实例的公有 IPv4 DNS**。
> - 粘贴后，Origin域的所有**详细信息将在下面列出**。
> - 将所有选项**保留为默认值**，然后单击**"创建源"**按钮。
> - 现在有**两个源**。

image::/图片/43图片/源添加完成.png[源添加完成]


> - **滚动下方**，然后单击**创建源组**按钮。
> - **选择 EC2 实例的公有 IPv4 DNS**，然后单击**添加按钮**。
> - 同样，**选择 S3 存储桶终端节点**，然后**单击添加按钮**。
> - **添加两个源后**，在下一个字段中将**名称命名**为 **aws-Origin-Group**。
> - 对于**故障转移条件**，请**选择"404 未找到"**。
> - 完成后，单击**创建源组**按钮。
> - 现**已创建源组**。
> - 现在切换到**"行为"**选项卡。
> - 选择当前行为，然后单击**"编辑"**按钮。
> - 在**"编辑行为"**页上，对于**"源和源组"**选项，从**下拉列表中选择当前源组**，即**aws-Origin-Group**。
> - 滚动到**页面末尾**，然后单击**"保存更改"**按钮。
> - **默认缓存行为**现在**已更新为"Origin-Group"**。
> - 返回到**"常规"**选项卡，您将看到**这些更改正在部署**。
> - **等待 5-10 分钟**，直到看到"正在部署状态更改"更改**为"上次修改时间"**。

image::/图片/43图片/上次修改时间.png[上次修改时间]


> - 现在，您可以**测试源组**

---


=== 测试源组

> - **复制分配域名**并将其**粘贴到浏览器的新选项卡中**。
> - 现在，这应**显示 EC2 实例中的index.html页面**，因为它具有**私有 IP DNS 名称**。

image::/图片/43图片/cloudfront.png[cloudfront]

> - 现在，将 ``/index.html`` **添加到 URL 中**。这将**显示 S3 存储桶中存在的index.html文件的内容**。

image::/图片/43图片/cloudfrontindex.png[cloudfrontindex]

> - 现在，通过**将 ``/index.html`` 更改为 ``/index2.html``**

image::/图片/43图片/cloudfrontindex2.png[cloudfrontindex2]


---
