
## 用Kinesis Firehose传输数据到S3

=== 架构图

image::/图片/96图片/架构图.png[架构图]

== 实验步骤

=== 创建S3存储桶

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域。
> - 顶部菜单**导航到 S3**

image::/图片/09图片/导航到S3.png[导航到S3]

> - 在 S3 页面上，单击**``创建存储桶``**并**填写存储桶详细信息**。
> - 桶名称：输入**``kinesisfirehose-awslabs``**
> * 注意： S3 存储桶名称是**全局唯一**的，请**选择一个可用的名称**。
> - AWS 区域：选择**美国东部（弗吉尼亚北部）美国东部-1**
> - 对于对象所有权：选择**ACL 已禁用(推荐)**
> - 对于此存储桶的“阻止公有访问”设置部分
> * **取消选中**"阻止所有公共访问"选项，然后**选中确认**选项。
> - 将**其他设置保留**为默认值。
> - **创建存储桶按钮**
> - S3 **存储桶已创建**。

---

=== 创建 Kinesis Data Firehose

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域。
> - 顶部菜单**导航到 Kinesis**
> - 在**"入门"**下，选择**"Kinesis Data Firehose"**，然后单击**"创建传输流"**
> - 在**"选择源和目标"**下
> * 源： 选择**``Direct PUT``**
> * 目标： 选择**``Amazon S3``**
> - 在**"传输流名称"**下，提供您选择的名称。
> * 传输流名称 ：输入**``demo-stream``**
> - 将**"变换和转换记录"**保留为**默认值**。
> - 在**"目标设置"**下
> * 单击**"浏览"**按钮。
> * 从弹出窗口中，选择我们**之前创建的 S3 存储桶**（在我的情况下是 kinesisfirehose-awslabs）。
> * 单击**"选择"**按钮。
> - **展开**缓冲区提示、压缩和加密部分。
> * 缓冲区大小：**``1 MB``**
> * 在缓冲时间间隔下，将其设置为**``60``**秒。
> - 展开**"高级设置"**
> * Amazon CloudWatch 错误日志记录信息：**已禁用**
> * 在权限下，将其设置为**默认值**，即**创建或更新 IAM 角色**。将创建具有所需权限的**新 IAM 角色**，并将其**分配给此 Kinesis 传输流**。
> - 点击**创建传输流**。

image::/图片/96图片/创建传输流.png[创建传输流]

---

=== 创建CloudWatch Logs

> - 顶部的服务菜单**导航到 CloudWatch**。
> - 单击左侧面板中的**日志组**，单击**创建日志组**。
> - 输入日志组**名称：awsvpclogs**，然后**单击创建**

image::/图片/35图片/创建logs.png[创建logs]

image::/图片/35图片/logs成功.png[logs成功]

---

=== 创建 VPC 流日志 IAM 角色

> - 导航到``IAM``
> - 在**左侧菜单**中，单击``角色`` 。单击**``创建角色``**该按钮以**创建新的 IAM 角色**。
> - 在创建角色部分，为角色选择**可信实体类型**：
> * **AWS 服务**
> * **使用案例:EC2**
> - 注意：通过选择 EC2 **作为使用案例**，您也可以将此角色**用于 VPC 流日志**。

image::/图片/25图片/创建IAM.png[创建IAM]

> * 单击**下一步**
> - 添加权限：现在，您可以看到**策略列表**。
> - 选择**"创建策略"**，将**打开一个新选项卡**，然后将**代码复制并粘贴到 JSON 下**。

```json
  {
      "Version": "2012-10-17",
      "Statement": [
          {
              "Action": [
                  "logs:CreateLogGroup",
                  "logs:CreateLogStream",
                  "logs:PutLogEvents",
                  "logs:DescribeLogGroups",
                  "logs:Describe*",
                  "logs:DescribeLogStreams"
              ],
              "Effect": "Allow",
              "Resource": "*"
          }
      ]
  }
```

> - 现在点击 **下一页：标签** 按钮。**无需更改**
> - 单击**"下一步：查看"**按钮。
> - 输入策略名称：**awspolicy**，然后单击**"创建策略"**。
> - 创建策略后，返回**"创建角色"**选项卡，然后单击右上角的**"刷新"**按钮。
> - 在"筛选策略"部分中**搜索"awspolicy"**并将其**选中**。
> - 单击**下一步**
> - 角色名称：输入 **awsrole**
> - 您**已成功**按名称 awsrole 创建了一个 IAM 角色。
> - 选择到刚刚创建的 **awsrole IAM 角色** 点击**"信任关系"**，然后单击**"编辑信任关系"**。

image::/图片/36图片/信任策略.png[信任策略]

> - **删除现有代码**，**复制并粘贴以下代码**，然后单击**"更新信任策略"**。

```json
  {
    "Version": "2012-10-17",
    "Statement": [
      {
        "Sid": "demo",
        "Effect": "Allow",
        "Principal": {
          "Service": "vpc-flow-logs.amazonaws.com"
        },
        "Action": "sts:AssumeRole"
      }
    ]
  }
```

---

=== 创建 CloudWatchLogs IAM 角色

> - 导航到``IAM``
> - 在**左侧菜单**中，单击``角色`` 。单击**``创建角色``**该按钮以**创建新的 IAM 角色**。
> - 在创建角色部分，为角色选择**可信实体类型**：
> * **AWS 服务**
> * **使用案例:EC2**
> - 注意：通过选择 EC2 **作为使用案例**，您也可以将此角色**用于 CloudWatchLogs**。

image::/图片/25图片/创建IAM.png[创建IAM]

> * 单击**下一步**
> - 添加权限：现在，您可以看到**策略列表**。
> - 选择**"创建策略"**，将**打开一个新选项卡**，然后将**代码复制并粘贴到 JSON 下**。

```json
  {
      "Statement": [
          {
              "Effect": "Allow",
              "Action": [
                  "firehose:*"
              ],
              "Resource": [
                  "arn:aws:firehose:*:*:*"
              ]
          }
      ]
  }
```

> - 现在点击 **下一页：标签** 按钮。**无需更改**
> - 单击**"下一步：查看"**按钮。
> - 输入策略名称：**CWLtoKinesisFirehosepolicy**，然后单击**"创建策略"**。
> - 创建策略后，返回**"创建角色"**选项卡，然后单击右上角的**"刷新"**按钮。
> - 在"筛选策略"部分中**搜索"CWLtoKinesisFirehosepolicy"**并将其**选中**。
> - 单击**下一步**
> - 角色名称：输入 **CWLtoKinesisFirehoseRole**
> - 您**已成功**按名称 CWLtoKinesisFirehoseRole 创建了一个 IAM 角色。
> - 选择到刚刚创建的 **CWLtoKinesisFirehoseRole IAM 角色** 点击**"信任关系"**，然后单击**"编辑信任关系"**。
> - **删除现有代码**，**复制并粘贴以下代码**，然后单击**"更新信任策略"**。

```json
  {
      "Version": "2008-10-17",
      "Statement": [
          {
              "Effect": "Allow",
              "Principal": {
                  "Service": "logs.us-east-1.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
          }
      ]
  }
```

---

=== 创建VPC

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域
> - 顶部菜单**导航到 VPC**
> - 单击左侧菜单中的**您的 VPC**
> - 在这里，您可以**看到所有 VPC 的列表**，无需对现有和默认 VPC **执行任何操作**，我们将**创建一个新的 VPC**。
> - 单击**``创建 VPC``**按钮。
> * 名称标签： **输入用于向您的 VPC 标识的 VPC 名称**。例如：MyVPC
> * IPv4 CIDR 块： 输入 **10.1.0.0/16**
> * IPv6 CIDR 块： 无需更改此设置，请确保选中**"无 IPv6 CIDR 块"**
> * 租期： 无需更改此设置，请确保**选中"默认"**。
> - 现在单击**``创建 VPC``**按钮

---

=== 创建并附加互联网网关

> - 单击左侧菜单中的**互联网网关**，然后单击**创建互联网网关**。
> * 名称标签：**MyInternetGateway**。
> * 单击**创建互联网网关**。
> - 从列表中**选择您创建的互联网网关**
> * 单击**"操作"**。
> * 单击**附加到VPC**
> * 从列表中**选择您创建的MyVPC**，然后单击**连接互联网网关**。

image::/图片/30图片/igw.png[igw]

---

=== 创建子网

> * 单击左侧菜单中的**子网**，然后单击**创建子网**。
> ** VPC ID ：从您之前创建的列表中选择 **MyVPC**。
> ** 子网名称 ：输入名称 **awssub**
> ** 可用区 ： 选择 **us-east-1a**
> ** IPv4 CIDR 块：输入范围 **10.1.1.0/24**
> ** 单击**"创建子网"按钮**。

---

=== 配置路由表

> - 单击左侧面板上的**路由表**，然后**选择您的 VPC 的主路由表**，即 **MyVPC**。
> - 转到**"路由"**选项卡，然后单击**``编辑路由``**按钮。
> - 然后单击**``添加路由``**按钮。
> - 指定以下值：
> * 目标：输入 **0.0.0.0/0**
> * 目标：从下拉菜单中**选择互联网网关**，选择**``MyInternetGateway``**。
> * 点击**保存更改**。

---

=== 创建 VPC 流日志

> - 单击**进入 MyVPC 内部**，**向下滚动**并单击**"流日志"选项卡**，然后单击**"创建流日志"**按钮。
> - **MyVPC流日志设置：**
> * 名称：**MyVPCFlowLog**
> * 选择**"筛选条件"**为**接受**，
> * **最大聚合间隔**：选择 **1 分钟**
> * 选择**"目标"**为发送到 **CloudWatch Logs**
> * 选择上面的**创建CloudWatch Logs"awsvpclogs"**
> * 选择 IAM 角色**"awsrole"**
> * 并将其他设置**保留为默认值**。单击**"创建流日志"**。
> - 创建流日志后，向下滚动可以**查看到创建的"流日志"**。

image::/图片/36图片/流日志.png[流日志]

---

=== 创建 EC2 实例

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域。
> - 顶部菜单**导航到 EC2**
> - 左侧面板，单击**"实例"**，然后单击**"启动新实例"**。

==== (1)控制台启动实例

image::/图片/07图片/控制台2.png[控制台启动实例]

==== (2)选择系统镜像

image::/图片/07图片/控制台3.png[选择系统镜像]

==== (3)选择实例类型

image::/图片/07图片/配置1.png[选择实例类型]

==== (4)配置实例

> - 实例数：**输入 1**
> - 网络 ： 选择**MyVPC**
> - 子网 ：保留为**默认值**
> - 自动分配公共 IP：**"启用"**
> - 将所有**其他设置保留为默认值**。单击**"下一步：添加存储"**

==== (5)添加存储

image::/图片/07图片/配置2.png[添加存储]

==== (6)添加标签

image::/图片/07图片/配置3.png[添加标签]

==== (7) 配置安全组

> - 添加 SSH：

----
  . 选择类型： 选择 SSH
  . 协议：TCP
  . 端口范围：22
  . 源：选择"任何位置"
----

> - 添加 HTTP：

----
  . 选择类型： 选择 HTTP
  . 协议：TCP
  . 端口范围：80
  . 源：选择"任何位置"
----

> - 添加 HTTPS：

----
  . 选择类型： 选择 HTTPS
  . 协议：TCP
  . 端口范围：443
  . 源：选择"任何位置"
----

> - 点击下一步 **``审核和启动``**

==== (8) 审核启动

> - **检查**所有选定的设置，**无误点击启动**
> - 选择现有密钥对，确认并单击**启动实例**

image::/图片/07图片/现有密钥.png[现有密钥]

---

=== 生成流量

> - **SSH 进入 EC2 实例**。
> - SSH **连接到实例后**，**安装 Apache 服务器**。要安装它，请**按照以下步骤操作**。逐个**运行这些命令**

----
  sudo su
  yum -y update
  yum install httpd -y
  cd /var/www/html
  echo "Response coming from server" > /var/www/html/index.html
  systemctl start httpd
  systemctl enable httpd
  systemctl status httpd 
----

image::/图片/36图片/shell.png[shell]

> - **复制实例的 Public-IP/index.html**，将其**粘贴到浏览器中**，然后**按 [Enter] 键**

image::/图片/36图片/index.png[index]

---

=== 查看CloudWatch Logs中的日志事件

> - 顶部菜单**导航到 CloudWatch**。
> - 单击左侧面板中的**"日志组"**，然后单击**"awsvpclogs"**。
> - 转到**"日志流"**部分，然后单击**已创建的日志流** [我的情况 - eni-03327bbb0e2a68ccb-accept]

image::/图片/36图片/界面.png[界面]

> - 您将**能够查看所有日志事件**，即**定向到我们的 EC2 实例的流量**。

image::/图片/36图片/详情.png[详情]

---

=== 创建 CloudWatch 日志订阅筛选条件并检查 S3 存储桶中的流数据

> - **单击 ``awsvpclogs`` 并切换到"订阅筛选条件"选项卡**。
> - 通过单击**"创建"**并选择**"创建 Kinesis Firehose 订阅筛选条件"**选项，为**``Kinesis Firehose``创建订阅筛选条件**。
> - 对于**选择目标**部分，
> * 目标帐户：选择**``当前帐户``**
> * Kinesis Firehose delivery stream：选择 **``demo-stream``**
> - 对于**"授予权限"**部分，
> * 选择现有角色：搜索 **``CWLtoKinesisFirehoseRole``**
> - 对于配置**日志格式**和**筛选条件**部分，
> * 日志格式：选择**``Amazon VPC 流日志``**
> * 订阅筛选条件模式：将其**保留为默认值**
> * 订阅筛选条件名称：输入**``DemoFilter``**
> - 保持**"测试模式"**选项不变。
> - 通过单击**"开始流式传输"**按钮**创建订阅筛选条件**。
> - 创建订阅筛选条件后，流数据大约**需要 10 分钟**才能在 **S3 存储桶中可见**。
> - 现在**导航到S3存储桶**，您将看到，一个文件夹是**使用year_name即2022创建的**。

image::/图片/96图片/创建的.png[创建的]

> - 点击**存在的文件夹**，在4个文件层次结构之后，它将**显示S3存储桶**中**存在的对象**。

image::/图片/96图片/存在的对象.png[存在的对象]

---
