
## 使用 VPC 终端节点从私有 EC2 实例访问 S3

=== 堡垒实例

> - 堡垒主机是**暴露在互联网上的系统**。
> - 在安全性方面，**Bastion是唯一暴露在互联网上的服务器**，应该**高度保护恶意攻击**。
> - 堡垒主机也称为**跳板机**。它是**一台计算机**，其作用**类似于代理服务器**，并**允许客户端计算机连接到远程服务器**。
> - 它通常**位于防火墙外部**。
> - 在本实验中，我们将**堡垒实例用作公有实例**，**使用 SSH 连接到私有实例**。

=== 适用于 S3 的 VPC 终端节点

> - **VPC 终端节点**允许我们**安全地连接您的 VPC 和由 AWS PrivateLink 提供支持的受支持的 AWS 服务**。
> - **AWS PrivateLink** 是一项**允许您使用私有 IP 地址访问 AWS 服务的服务**。
> - **VPC 终端节点** **不需要 NAT 网关、NAT 实例、互联网网关或任何 VPN 服务**即可**访问 AWS 服务**。
> - 有**两种类型**的 VPC 终端节点：**网关和接口**。
> - S3 的 VPC **终端节点位于网关终端节点**下。
> - 当您为 S3 **创建 VPC 终端节点**时，它会要求**输入路由表**，然后将**前缀列表添加到该路由表**。您**无法修改/删除由 Endpoint 创建的路由表中存在的条目**。

=== 架构图

image::/图片/37图片/架构图.png[架构图]

== 实验步骤

=== 创建VPC

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域
> - 顶部菜单**导航到 VPC**
> - 单击左侧菜单中的**您的 VPC**
> - 在这里，您可以**看到所有 VPC 的列表**，无需对现有和默认 VPC **执行任何操作**，我们将**创建一个新的 VPC**。
> - 单击**``创建 VPC``**按钮。
> * 名称标签： **输入用于向您的 VPC 标识的 VPC 名称**。例如：MyVPC
> * IPv4 CIDR 块： 输入 **192.168.0.0/26**
> * IPv6 CIDR 块： 无需更改此设置，请确保选中**"无 IPv6 CIDR 块"**
> * 租期： 无需更改此设置，请确保**选中"默认"**。
> - 现在单击**``创建 VPC``**按钮

---

=== 创建并附加互联网网关

> - 单击左侧菜单中的**互联网网关**，然后单击**创建互联网网关**。
> * 名称标签：**MyInternetGateway**。
> * 单击**创建互联网网关**。
> - 从列表中**选择您创建的互联网网关**
> * 单击**"操作"**。
> * 单击**附加到VPC**
> * 从列表中**选择您创建的MyVPC**，然后单击**连接互联网网关**。

image::/图片/30图片/igw.png[igw]

---

=== 创建公有子网和私有子网

> * 对于公有子网，单击左侧菜单中的**子网**，然后单击**创建子网**。
> ** VPC ID ：从您之前创建的列表中选择 **MyVPC**。
> ** 子网名称 ：输入名称 **MyPublicSubnet**
> ** 可用区 ： 选择 **us-east-1a**
> ** IPv4 网段：输入范围 **192.168.0.1/27**
> ** 单击**"创建子网"**。
> * 让我们**启用自动将公有 IP 分配给在此子网中创建的实例**，
> ** 选择 MyPublicSubnet ，单击**"操作"**。
> ** 单击**"编辑子网设置"**。
> ** 启用自动分配公有 IPv4 地址：**选中**
> ** 点击**保存**。
> * 现在，**默认情况**下，在 MyPublicSubnet 中**启动的实例将分配公有 IP**。
> * 对于私有子网，再次单击**"创建子网"**。
> ** VPC ID ：从您之前创建的列表中选择 **MyVPC**。
> ** 子网名称 ：输入名称 **MyPrivateSubnet**
> ** 可用区 ： 选择 **us-east-1b**
> ** IPv4网段：输入范围**192.168.0.32/27**
> ** 单击**"创建子网"**。

image::/图片/33图片/subok.png[subok]

---

=== 在主路由表中添加一个条目

> - 主路由表：添加允许公网流量**流向 VPC 的路由**。
> - 选择**"MyVPC主路由表"**。
> - 转到"路由"选项卡，然后单击**``编辑路由``**按钮。
> - 然后单击**``添加路由``**按钮。
> - 指定以下值：
> * 目标：输入 **0.0.0.0/0**
> * 目标：从下拉菜单中选择互联网网关，选择**``MyInternetGateway``**。
> * 点击**保存更改**。

---

=== 为私有子网创建路由表

> - 从左侧菜单中**转到路由表**，然后单击**创建路由表**。
> * 名称： 输入**"PrivateRouteTable"**。
> * VPC： 从列表中选择**"MyVPC"**。
> * 单击**创建路由表**。
> - 现在，将子网**关联到路由表**。
> - 单击 **PrivateRouteTable**，单击**``操作``**。
> * 然后转到**"子网关联"**选项卡
> * 从列表中选择 **MyPrivateSubnet**。
> * 单击**保存关联**。
> - **私有子网现在与我们的自定义路由表（即私有子网的 RT）相关联**。
> - 这里需要**注意的另一件事是**，当路由表在 Main 列为"否"时，您可以将该路由表**称为自定义路由**。
> - 而另一个是**主路由表**，因为它是在您**创建自定义 VPC 时默认创建的**。

---

=== 创建安全组

> - 在本实验中，我们将**创建两个安全组**，第一个安全组将**用于堡垒主机**，第二个**安全组用于有权访问 S3 的 VPC 终端节点的私有实例**
> - 从左侧菜单中**转到"安全"下的"安全组"**，然后单击**创建安全组**。
> - 安全组名称：输入**Bastion-SG**
> - 描述：**Security group for the bastion host**
> - VPC：选择**MyVPC**
> - 在"入站规则"下，单击**"添加规则"**。
> - 添加 SSH

----
  . 选择类型： 选择 SSH
  . 协议：TCP
  . 端口范围：22
  . 源：选择"任何位置"
----

> - 添加 HTTP

----
  . 选择类型： 选择 HTTP
  . 协议：TCP
  . 端口范围：80
  . 源：选择"任何位置"
----


> - 添加 HTTPS

----
  . 选择类型： 选择 HTTPS
  . 协议：TCP
  . 端口范围：443
  . 源：选择"任何位置"
----


> - 将其他内容**保留为默认值**，然后单击**创建安全组按钮**。
> - 现**已创建堡垒主机的安全组**。


---

> - 继续单击**创建安全组**。
> - 安全组名称：输入**Endpoint-SG**
> - 描述：**Security group for S3 endpoint**
> - VPC：选择**MyVPC**
> - 在"入站规则"下，单击**"添加规则"**。
> - 我们将为 S3 终端节点**安全组添加 1 条规则**，即**仅 SSH**。 
> - 但在这里，我们的源**将是堡垒主机安全组**，您将选择**Bastion-SG安全组的ID**。

----
  . 选择类型： 选择 SSH
  . 协议：TCP
  . 端口范围：22
  . 源：选择为自定义，然后键入Bastion，堡垒主机的安全组将显示，选择该安全组
----

image::/图片/37图片/第二个安全组.png[第二个安全组]

> - 将其他内容**保留为默认值**，然后单击**创建安全组按钮**。
> - 现已创建第二个安全组

---


=== 创建堡垒主机（可公开访问的 EC2 实例）

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域。
> - 顶部菜单**导航到 EC2**
> - 左侧面板，单击**"实例"**，然后单击**"启动新实例"**。

==== (1)控制台启动实例

image::/图片/07图片/控制台2.png[控制台启动实例]

==== (2)选择系统镜像

image::/图片/07图片/控制台3.png[选择系统镜像]

==== (3)选择实例类型

image::/图片/07图片/配置1.png[选择实例类型]

==== (4)配置实例

> - 实例数：**输入 1**
> - 网络 ： 选择**MyVPC**
> - 子网 ：选择**"MyPublicSubnet"**
> - 自动分配公共 IP：**使用子网设置（启用）**
> - 将所有**其他设置保留为默认值**。单击**"下一步：添加存储"**

==== (5)添加存储

image::/图片/07图片/配置2.png[添加存储]

==== (6)添加标签

image::/图片/07图片/配置3.png[添加标签]

==== (7) 配置安全组

> - 分配安全组：选择**"选择现有安全组"**
> - **选择**刚在上述步骤中创建的**Bastion-SG**安全组。
> - 点击下一步 **`审核和启动`**

==== (8) 审核启动

> - **检查**所有选定的设置，**无误点击启动**
> - 选择现有密钥对，确认并单击**启动实例**

image::/图片/07图片/现有密钥.png[现有密钥]

---

=== 创建终端节点实例（可私下访问的 EC2 实例）

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域。
> - 顶部菜单**导航到 EC2**
> - 左侧面板，单击**"实例"**，然后单击**"启动新实例"**。

==== (1)控制台启动实例

image::/图片/07图片/控制台2.png[控制台启动实例]

==== (2)选择系统镜像

image::/图片/07图片/控制台3.png[选择系统镜像]

==== (3)选择实例类型

image::/图片/07图片/配置1.png[选择实例类型]

==== (4)配置实例

> - 实例数：**输入 1**
> - 网络 ： 选择**MyVPC**
> - 子网 ：选择**"MyPrivateSubnet"**
> - 自动分配公共 IP：**使用子网设置（禁用）**
> - IAM 角色: **创建新的 IAM 角色**

===== 创建 IAM 角色

> - 单击**``创建角色``**该按钮以**创建新的 IAM 角色**。
> - 在创建角色部分，为角色选择**可信实体类型**：
> * **AWS 服务**
> * **使用案例:EC2**

image::/图片/25图片/创建IAM.png[创建IAM]

> * 单击**下一步**
> - 添加权限：现在，您可以看到**策略列表**。
> - 选择**"创建策略"**，将**打开一个新选项卡**，然后将**代码复制并粘贴到 JSON 下**。

```json
  {
      "Version": "2012-10-17",
      "Statement": [
          {
              "Sid": "p3",
              "Effect": "Allow",
              "Action": [
                  "s3:List*",
                  "s3:Get*"
              ],
              "Resource": "*"
          }
      ]
  }
```

> - 现在点击 **下一页：标签** 按钮。**无需更改**
> - 单击**"下一步：查看"**按钮。
> - 输入策略名称：**s3policy**，然后单击**"创建策略"**。
> - 创建策略后，返回**"创建角色"**选项卡，然后单击右上角的**"刷新"**按钮。
> - 在"筛选策略"部分中**搜索"s3policy"**并将其**选中**。
> - 单击**下一步**
> - 角色名称：输入 **s3role**
> - 您**已成功**按名称 s3role 创建了一个 IAM 角色。
> - 现在**回到EC2创建界面**
> - IAM 角色:**选择创建的 `s3role` IAM 角色**。
> - 将所有**其他设置保留为默认值**。单击**"下一步：添加存储"**

==== (5)添加存储

image::/图片/07图片/配置2.png[添加存储]

==== (6)添加标签

image::/图片/07图片/配置3.png[添加标签]

==== (7) 配置安全组

> - 分配安全组：选择**"选择现有安全组"**
> - **选择**刚在上述步骤中创建的**Endpoint-SG**安全组。
> - 点击下一步 **`审核和启动`**

==== (8) 审核启动

> - **检查**所有选定的设置，**无误点击启动**
> - 选择现有密钥对，确认并单击**启动实例**

image::/图片/07图片/现有密钥.png[现有密钥]

> - 然后单击每个实例，然后输入**名称为 Bastion-host 和 Endpoint-instance **以便**分辨EC2**

---

=== 通过堡垒主机 SSH 进入终端节点实例

> - 使用**堡垒主机 PEM 密钥** SSH **进入堡垒实例**：test1.pem
> - 要通过堡垒实例 **SSH 进入到 Endpoint 实例**，我们需要 test1.pem **密钥出现在堡垒实例上**。
> - 在**本地系统上打开 test1.pem 文件**，然后**复制密钥文本内容**。
> - 回到**堡垒实例**，并使用以下命令**创建一个名为 test1.pem 的文件**：

----
  vim test1.pem
----

> - 粘贴内容并通过**按esc后跟``:wq``**，然后**保存您的密钥**。
> - 确保已将密钥文件的**权限更改为 400**。您可以使用以下命令**更改权限**：

----
  chmod 400 test1.pem
----

image::/图片/37图片/chmod.png[chmod]

> - 现在，您可以**借助以下命令**，**使用复制到堡垒服务器的密钥登录到Web服务器**。
> * 注意：您**没有 Web 服务器的公共 IP**，因为我们在**私有子网中创建了它们**。
> * 语法：**ssh -i "test1.pem" ec2-user@<端点实例的私有 IP>**
> * 示例：**ssh -i "test1.pem" ec2-user@192.168.0.52**

image::/图片/37图片/sshi.png[sshi]

> - 尽管**分配的 IAM 角色有权访问 S3 读取**，但**通过 AWS CLI 命令列出存储桶失败**，**表示 S3 终端节点上的连接超时**。

image::/图片/37图片/s3ls失败.png[s3ls失败]


> - 因为，此实例的安全组**只允许执行 SSH**，**运行任何其他命令，将失败**。
> - 让我们**添加使用适用于 S3 的 VPC 终端节点访问 S3 终端节点的权限**。

---

=== 为 S3 创建 VPC 终端节点，并将其附加到私有子网的路由表。

> - 通过单击顶部的菜单**导航到 VPC**，然后在单击**终端节点**。
> - 单击**创建终端节点**该按钮。
> - 确保**服务类别**为 AWS 服务。在服务名称搜索栏中，**键入 s3**，然后**按 Enter 键**

image::/图片/37图片/endpoint1.png[endpoint1]


> - 将列出**"类型"**、**"服务名称为 **com.amazonaws.us-east-1.s3** 的网关(Gateway)"的终端节点**，将其**选中**。
> - 更改VPC，选择**MyVPC**。
> - 然后**选中名称为私有子网的路由表选项**。

image::/图片/37图片/endpoint2.png[endpoint2]


> - 最后，单击**创建终端节点**该按钮。
> - **将创建一个终端节点**。
> - **几分钟后**，您将看到**终端节点**。

image::/图片/37图片/endpoint可用.png[endpoint可用]


> - （可选）**检查终端节点是否与自定义路由表（RT for 私有子网）相关联**。
> - 请**转到路由表**，**选择自定义路由表**，然后单击**下面的路由选项**，您将**看到 S3 条目**。

image::/图片/37图片/路由表检查.png[路由表检查]

---

=== 列出所有 S3 存储桶

> - 使用**以下 AWS CLI 命令**列出**所有存储桶**：

----
  aws s3 ls
----

image::/图片/37图片/s3ls成功.png[s3ls成功]

---
