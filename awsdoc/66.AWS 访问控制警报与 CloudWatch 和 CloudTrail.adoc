
## AWS 访问控制警报与 CloudWatch 和 CloudTrail

=== CloudWatch

> - AWS Cloudwatch 是用于**定期监控和收集**服务中的**指标的服务**。这有助于为用户**提供更清晰的画面**，以**了解资源的性能**。
> - 它以**日志、事件和指标**的形式**收集数据**，并为您提供在 AWS 上运行的 AWS 资源、服务和应用程序的**组织视图**。
> - 您可以使用 CloudWatch 来**检测环境中的异常行为**并**设置警报**，您可以通过**可视化日志中**的**数据**并采取措施来**解决问题**。
> - 您可以使用 CloudWatch **监控 AWS 资源**，例如 Amazon EC2、Amazon RDS、Amazon DynamoDB 表以及许多其他资源。
> - 您可以通过**设置规则**和**事件**来阻止或终止未充分利用的资源，从而监控账户中的资源利用率，从而**减少不必要的成本**。
> - 在自动扩展中，服务器将**根据我们在 CloudWatch 中创建的事件停止或启动**。
> - CloudWatch 还提供了一项功能，用于**存储我们账户中服务的运行日志**。例如，lambda 函数的日志将**存储在 CloudWatch 的日志组中**。在这里，我们可以从任何特定函数中**获取详细的错误日志**。

=== CloudTrail

> - AWS CloudTrail 是一项**帮助我们监控**、**调查**和**审核 AWS 账户**的**服务**。
> - 在 AWS CloudTrail 的帮助下，用户将**能够记录、监控和保留与 AWS 基础设施**中的**操作相关的账户活动**。
> - CloudTrail 提供 Amazon Web Services 的**完整帐户活动记录**。在CloudTrail服务的帮助下可以轻松管理 AWS 管理控制台、程序工具、AWS 开发工具包和其他各种 AWS 服务的**功能**。
> - 事件历史记录**简化了安全分析**、**资源修正跟踪**和**故障排除**。

=== 架构图

image::/图片/66图片/架构图.png[架构图]

== 实验步骤

=== 配置 CloudTrail 和 S3 存储桶

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域
> - 通过菜单**导航到 CloudTrail**,单击**创建跟踪**。
> - 在创建跟踪下，输入以下详细信息：
> * 跟踪名称 ： 进入**My_cloudtrail**
> * 存储位置 ： 选择**创建新的 S3 存储桶**
> ** 跟踪日志存储桶和文件夹：将其**保留为默认值**
> * 日志文件 SSE-KMS 加密：**取消选中**已启用
> * 其他设置：
> ** 日志文件验证：**取消选中**已启用
> ** SNS 通知发送 ：将其**保留为默认值**

image::/图片/66图片/创建trail.png[创建trail]

> - CloudWatch Logs ：将其**选中已启用**
> * 日志组：将其**保留为默认值**（即默认日志组名称)
> * IAM 角色：选择**新建**并将角色名称**指定为``aws_role``**

image::/图片/66图片/创建日志组.png[创建日志组]

> - 标签 - 可选：
> * 键：输入**Name**
> * 值：输入**my_logs**
> - 单击**"下一步"**。
> - 选择**"日志事件"**：
> ** 将**所有内容保留为默认值**，然后单击**"下一步"**。
> * 查看并单击**创建跟踪**按钮。
> - 现已创建将日志传送到 S3 存储桶的** CloudTrail 实例**。

image::/图片/66图片/创建完成.png[创建完成]

---

=== 在 Cloudwatch 中为日志组创建指标筛选条件

> - 通过菜单**导航到 CloudWatch**。
> - 点击左侧面板的**日志**。
> - 单击我们**刚刚创建的日志组**，然后单击**"操作"**。
> - 点击**``创建筛选条件``**按钮：
> - 在**"创建筛选条件模式"**下，提供需要筛选的模式。对于此实验，我们将筛选**已停止的实例**。
> * 筛选模式： 输入**模式** **``{ $.eventName= "StopInstances" }``**
> * 选择要测试的日志数据 ：下拉列表**选择``cloudtrail log``**。
> * 完成上述步骤后，单击**下一步**。

image::/图片/66图片/筛选条件.png[筛选条件]

> - 接下来，我们将使用以下**详细信息**创建一个**筛选器**：
> * 筛选名称：输入**``stoppedInstancecount``**
> * 指标详细信息：
> ** 指标命名空间：输入 **``CloudTrailMetrics``**
> ** 指标名称：输入 **``EC2stoppedInstanceEventCount``**
> ** 指标值：输入 **``1``**
> ** 默认值：保留**默认值**
> * 最后，单击下一步并查看给定的**详细信息**。单击**创建筛选条件**按钮以**完成指标筛选条件的创建**

---

=== 创建警报

> - 单击底部的**指标筛选条件**。
> - **选择在上述步骤中创建的指标筛选条件**，然后单击**创建警报**，如下所示：

image::/图片/66图片/创建警报.png[创建警报]


> - 指定指标和条件，如下所示：
> * 命名空间 ： **``CloudTrailMetrics（默认）``**
> * 指标名称：**``EC2stoppedInstanceEventCount（默认值）``**
> * 统计：**``总计（默认）``**
> * 周期 ： **``5 分钟（默认）``**
> * 条件：
> ** 阈值类型：选择**静态**
> ** 每当 EC2stoppedInstanceEventCount 为 ：  **``大于 1``**。
> * 单击下一步。
> - 接下来，我们将配置操作
> * 警报状态触发器：选择**警报中**
> * 选择 SNS 主题：选择**创建新主题**
> * 创建新主题：输入主题名称为**``My_Ec2count_topic``**
> * 将收到通知的电子邮件终端节点… ：输入**您的电子邮件地址**以接收警报
> * 提供这些详细信息后，单击**创建主题**按钮。
> ** AWS 将向上面提供的电子邮件地址发送一封确认电子邮件。您需要**确认电子邮件订阅**，如下所示：

image::/图片/66图片/订阅.png[订阅]

image::/图片/66图片/确认订阅.png[确认订阅]

> - 单击**下一步**按钮以**完成警报创建**。
> - 为警报命名，如下所示：
> * 警报名称 ：输入**``My_stopped_ec2_alarm``**
> * 警报描述：输入**``Alarm to count the stopped instances count``**
> * 单击**下一步**查看详细信息，然后单击**创建警报**按钮。
> - 导航到 CloudWatch 控制面板，然后**单击警报**。您应该看到在上述步骤中**创建的警报**，如下所示：

image::/图片/66图片/创建警报完成.png[创建警报完成]

---

=== 创建 EC2 实例以触发警报

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域
> - 通过菜单**导航到 EC2**,单击**启动新实例**。

==== (1)控制台启动实例

image::/图片/07图片/控制台2.png[控制台启动实例]

==== (2)选择系统镜像

image::/图片/07图片/控制台3.png[选择系统镜像]

==== (3)选择实例类型

image::/图片/07图片/配置1.png[选择实例类型]

==== (4)配置实例

> - 实例的数量：**选择 1**
> - 将其余设置**保留为默认值**，然后单击**下一步按钮**。

==== (5)添加存储

image::/图片/07图片/配置2.png[添加存储]

==== (6)添加标签

image::/图片/07图片/配置3.png[添加标签]

==== (7) 配置安全组

> - 添加 SSH：

----
  . 选择类型： 选择 SSH
  . 协议：TCP
  . 端口范围：22
  . 源：选择"任何位置"
----

> - 点击下一步 `审核和启动`

==== (8) 审核启动

> - **检查**所有选定的设置，**无误点击启动**
> - 选择现有密钥对，确认并单击**启动实例**

image::/图片/07图片/现有密钥.png[现有密钥]

> - EC2 实例**成功启动后**，**启动和停止实例 2 到 3 次**，如下面的**屏幕截图**所示：

image::/图片/66图片/停止实例.png[停止实例]

> - 导航到 CloudWatch 控制台，然后单击**左侧面板**下的**告警中**，以**查看新创建的警报**。它应将状态显示为**"警报中"**，如下所示：

image::/图片/66图片/警报中.png[警报中]

> - 检查您提供给 SNS 的**电子邮件**，**电子邮件**如下所示：

image::/图片/66图片/警报邮件.png[警报邮件]

---
