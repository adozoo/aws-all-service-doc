
## Dockerfile 创建 Docker 容器并将映像存储在 ECR


=== 架构图

image::/图片/83图片/架构图.png[架构图]

== 实验步骤

=== 为 ECS 集群创建安全组

> - 单击**创建安全组**。
> - 安全组名称：输入**ECS-SG**
> - 描述：**Security group for ECS Cluster**
> - VPC：选择**默认VPC**
> - 在"入站规则"下，单击**"添加规则"**。
> - 添加 **HTTP**

----
  . 选择类型： 选择 HTTP
  . 协议：TCP
  . 端口范围：80
  . 源：选择"任何位置"
----

> - 添加 **SSH**

----
  . 选择类型： 选择 SSH
  . 协议：TCP
  . 端口范围：22
  . 源：选择"任何位置"
----

> - 将其他内容**保留为默认值**，然后单击**创建安全组按钮**。

---

=== 为 ECS 集群创建 IAM 角色


> - 导航到``IAM``
> - 在**左侧菜单**中，单击``角色`` 。单击``创建角色``该按钮以**创建新的 IAM 角色**。
> - 在创建角色部分，为角色选择**可信实体类型**：
> * **AWS 服务**
> * **使用案例:EC2**


image::/图片/25图片/创建IAM.png[创建IAM]


> * 单击**下一步**
> - 添加权限：现在，您可以看到**策略列表**。
> - 选择**"创建策略"**，将**打开一个新选项卡**，然后将**代码复制并粘贴到 JSON 下**。

```json
  {
      "Version": "2012-10-17",
      "Statement": [
          {
              "Sid": "RolePolicyAccess",
              "Effect": "Allow",
              "Action": [
                  "ec2:Describe*",
                  "ecs:*",
                  "ecr:*",
                  "logs:CreateLogStream",
                  "logs:PutLogEvents"
              ],
              "Resource": "*"
          }
      ]
  }
```

> - 现在点击 **下一页：标签** 按钮。**无需更改**
> - 单击**"下一步：查看"**按钮。
> - 输入策略名称：**dockerpolicy**，然后单击**"创建策略"**。
> - 创建策略后，返回**"创建角色"**选项卡，然后单击右上角的**"刷新"**按钮。
> - 在"筛选策略"部分中**搜索"dockerpolicy"**并将其**选中**。
> - 单击**下一步**
> - 角色名称：输入 **dockerrole**
> - 您**已成功**按名称 dockerrole 创建了一个 IAM 角色。
> * 注意：您可以使用**其他名称创建角色**

---

=== 启动 ECS 集群

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域
> - 菜单**导航到 ECS**。
> - 在左上角，单击 Amazon ECS 下的**集群选项**。
> - 单击**"创建集群"**按钮。
> - 步骤 1：集群模板
> * 选择集群模板为**``EC2 Linux + 联网``**
> * 单击**下一步**
> - 步骤 2：配置集群
> * 配置集群
> ** 群集名称：输入 **``aws``**
> * 实例配置
> ** 预配置模型：选择**``按需实例``**
> ** EC2 实例类型：选中 **``t2.micro``**
> ** 实例数：输入 **``1``**
> ** EC2 AMI Id：选择 **``Amazon Linux 2 AMI（默认）``**
> ** 根 EBS 卷大小 （GiB）：输入 **``30（默认值）``**
> ** 密钥对：选择**账户存在的密钥对(没有可以创建一个)**

image::/图片/80图片/实例配置.png[实例配置]

> - 联网
> * VPC：选择**``默认VPC``**
> * 子网：选择 **``us-east-1a 和 us-east-1b``**
> * 自动分配公用 IP：选择**``使用子网设置（默认）``**
> * 安全组：选择 **``ECS-SG 安全组``**

image::/图片/80图片/联网.png[联网]

> - 容器实例 IAM 角色：选择**``dockerrole``**
> - 将其他选项**保留为默认值**。
> - 单击**创建**按钮，**创建 aws ECS 集群**
> - ECS 集群将**在 2 分钟内创建**。
> - 点击**查看集群**按钮
> - 预置 ECS 实例**需要几分钟时间**。
> - ECS 集群将**创建 1 个容器实例**

image::/图片/80图片/预置实例.png[预置实例]

---


=== 导航到容器实例

> - 在左侧边栏上，单击**Amazon ECS**部分下的**集群**选项。
> - aws ECS 集群将在此处列出，单击该**aws**。
> - 要**查看 ECS 实例**，请**切换到 ECS 实例选项卡**。

image::/图片/83图片/ECS实例.png[ECS实例]

> - **单击 ECS 实例**，您将被重定向到**正在运行的 EC2 实例**。
> - 单击**EC2实例 ID**。
> - **复制实例的公有 IP**。将其保存到记事本，我们需要它进入到 EC2 实例中。

---

=== SSH 进入到 EC2 实例

==== 创建 Dockerfile 并构建 Docker 映像

> - **SSH 进入到 EC2 实例**。
> - 使用以下命令**获取根权限**：
> * **``sudo su``**
> - 现在使用以下命令**运行更新**：
> * **``yum -y update``**
> - 通过运行以下命令**检查 Docker 版本**：
> * **``docker version``**
> - 检查 ECS 集群中运行的**所有 Docker 进程**：
> * **``docker ps``**
> - 通过运行以下命令**安装 AWS CLI**：
> * **``yum install awscli -y``**
> - 通过运行以下命令**创建 Dockerfile**：
> * **``touch Dockerfile``**
> - 通过运行以下命令将指令**放入 Dockerfile 文件中**
> * **``vi Dockerfile``**
> - 按 **``i``** 进入**插入模式**后将以下**代码粘贴到 Dockerfile 中**

----
#This is a sample Image
FROM ubuntu
MAINTAINER someone@example.com
RUN apt-get update
RUN apt-get install nginx -y
CMD ["echo","Image created"]
----

image::/图片/83图片/dockerfile.png[dockerfile]

> - 通过按 **``esc``** 然后输入 **``:wq``** **保存文件并关闭 vi 编辑器**。
> - 运行**"生成"**命令：
> * **``docker build -t aws .``**
> * 注意：**不要忘记在后面添加（.）点**。
> - 通过运行以下命令**检查新映像的可用性**：
> * **``docker images``**

---


=== 在 ECR 中创建存储库并运行推送命令


> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域
> - 菜单**导航到 ECS**。
> - 单击左侧菜单**"Amazon ECR"**。
> - 单击**创建存储库**按钮
> - 填写以下详细信息以**创建 ECR 存储库**。
> * 可见性设置：选择**"私有"**
> * 存储库名称：输入**aws**
> * 将**其他选项保留为默认值**。

image::/图片/83图片/创建储存库.png[创建储存库]

> - 最后，单击**创建存储库**按钮以创建 ECR 存储库。
> - 存储库现已创建，单击**查看推送命令**按钮，将创建的**自定义镜像上传到 ECR 存储库中**。

image::/图片/83图片/查看推送命令.png[查看推送命令]

> - **逐个复制命令**，并将其**粘贴到终端上以执行**。
> - 由于我们已经**将 Dockerfile 构建到 docker 镜像**。我们可以**跳过复制和粘贴第二个命令**。

image::/图片/83图片/推送命令.png[推送命令]

> - **运行完全部3个命令后**，可以单击**存储库名称**来**检查创建的镜像**。

image::/图片/83图片/上传成功.png[上传成功]

> - 镜像现在**已推送到 ECR 存储库**，现在可以在**任务定义**中**使用它来创建服务和任务**。

---
