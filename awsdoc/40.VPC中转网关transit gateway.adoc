
## VPC中转网关transit gateway


=== 什么是中转网关？

> - AWS 中转网关**可帮助您通过中央集线器** **连接多个 VPC 和本地网络**。它**通过 VPC 和本地连接**简化了您的网络，并**解决了复杂的对等关系**问题。
> - 使用**中转网关进行 VPC 对等互连时**，您的数据将**始终处于加密状态**，**不再使用公共互联网进行通信**。
> - 使用中转网关的**好处**：
> * 易于连接
> * 完全控制
> * 更高的安全性
> * 多播功能
> - **通过 VPC 对等互连使用中转网关**的原因：
> * VPC 对等连接**不支持传递对等**的含义，您**一次只能对等两个 VPC**。
> * 要将您的 **VPC 与本地网络对等互连**，您**不能使用 VPC 对等互连**。**中转网关支持连接本地网络**。
> - 中转网关**限制**：
> * 每个中转网关可以**有 20 个中转网关路由表**。
> * 每个中转网关可以**有 10000 个路由**。
> * 每个中转网关可以**有 50 个中转网关附件**。
> * 每个 VPC 可以**有 5 个唯一的中转网关**。

=== 中转网关如何帮助您简化网络？

> - 中转网关**充当云路由器**，**支持与以下资源连接**：
> * Amazon VPC
> * 具有客户网关的 VPN 连接
> * AWS Direct Connect Gateway
> - **不使用中转网关**：
> * VPC 对等互连在两个 VPC 之间**只能有一对一的关系**。**复杂性会随着连接数的扩展而增加**。
> * 在扩展时，**维护路由表**是另一**大挑战**，您必须使路由表**具有到 VPC 的路由**，并使用**单独的网络网关**为每个**新连接使用本地网络**进行连接。

image::/图片/40图片/开始1.png[开始1]

> - **使用中转网关**：
> * 将 **Amazon VPC 与本地网络互连**，我们**可以使用中转网关**。
> * 该网络是**标准化的**，**易于扩展**。使用中转网关，您可以**在一个位置管理和监控**每个网络的**活动连接数**。

image::/图片/40图片/开始2.png[开始2]

> - 由于无法**虚拟连接到本地网络**，因此在本实验中，您将学习**如何创建中转网关**并将其**用于对等 VPC**。


=== 中转网关使用案例

> - 应用程序可以**交付到世界各地**。
> - 将网络设计从**多可用区移动到多区域**。
> - 快速扩展并顺利**响应流量高峰**。
> - 在一个位置**连接到所有类型的网络**。

=== 架构图

image::/图片/40图片/架构图.png[架构图]

=== 创建第一个 VPC

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域
> - 顶部菜单**导航到 VPC**
> - 单击左侧菜单中的**您的 VPC**
> - 在这里，您可以**看到所有 VPC 的列表**，无需对现有和默认 VPC **执行任何操作**，我们将**创建一个新的 VPC**。
> - 单击**``创建 VPC``**按钮。
> * 名称标签： **输入用于向您的 VPC 标识的 VPC 名称**。例如：First_VPC
> * IPv4 CIDR 块： 输入 **10.0.0.0/24**
> * IPv6 CIDR 块： 无需更改此设置，请确保选中**"无 IPv6 CIDR 块"**
> * 租期： 无需更改此设置，请确保**选中"默认"**。
> - 现在单击**``创建 VPC``**按钮
> - **启用 DNS 主机名选项**，请单击**"操作"**按钮，然后选择**"编辑 DNS 主机名"**选项。
> - **选中"DNS 主机名"选项**，然后单击**"保存更改"**选项。

image::/图片/38图片/dns主机名.png[dns主机名]

> - 同样，单击**"操作"**按钮并选择**"编辑 DNS 解析"**选项。
> - 确保**"DNS 解析"下的**复选框**"启用"**，然后单击**保存更改**该按钮。

image::/图片/39图片/dns解析.png[dns解析]

---

=== 在第一个 VPC 中创建公有子网

> - 单击左侧菜单中的**子网**，然后单击**创建子网**。
> ** VPC ID ：从您之前创建的列表中选择 **First_VPC**。
> ** 子网名称 ：输入名称 **Public_subnet_first_VPC**
> ** 可用区 ： 选择 **无首选项**
> ** IPv4 网段：输入范围 **10.0.0.0/25**
> ** 单击**"创建子网"**。

---

=== 创建和配置互联网网关

> - 单击左侧菜单中的**互联网网关**，然后单击**创建互联网网关**。
> * 名称标签：**IGW**。
> * 单击**创建互联网网关**。
> - 从列表中**选择您创建的互联网网关**
> * 单击**"操作"**。
> * 单击**附加到VPC**
> * 从列表中**选择您创建的First_VPC**，然后单击**连接互联网网关**。

---

=== 创建公有路由表并将其与子网关联

> - 从左侧菜单中**转到路由表**，然后单击**创建路由表**。
> * 名称： 输入**"PublicRT"**。
> * VPC： 从列表中选择**"First_VPC"**。
> * 单击**创建路由表**。
> - 现在，将子网**关联到路由表**。
> - 单击 **PublicRT**，单击**``操作``**。
> * 然后转到**"子网关联"**选项卡
> * 从列表中选择**"Public_subnet_first_VPC"**。
> * 单击**保存关联**。

---

=== 在路由表中添加公共路由

> - PublicRT：添加允许公网流量**流向 VPC 的路由**。
> - 选择**"PublicRT"**。
> - 转到"路由"选项卡，然后单击**``编辑路由``**按钮。
> - 然后单击**``添加路由``**按钮。
> - 指定以下值：
> * 目标：输入 **0.0.0.0/0**
> * 目标：从下拉菜单中选择互联网网关，选择**``IGW``**。
> * 点击**保存更改**。

---

=== 在第一个 VPC 中启动 EC2 实例

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域。
> - 顶部菜单**导航到 EC2**
> - 左侧面板，单击**"实例"**，然后单击**"启动新实例"**。

==== (1)控制台启动实例

image::/图片/07图片/控制台2.png[控制台启动实例]

==== (2)选择系统镜像

image::/图片/07图片/控制台3.png[选择系统镜像]

==== (3)选择实例类型

image::/图片/07图片/配置1.png[选择实例类型]

==== (4)配置实例

> - 实例数：**输入 1**
> - 网络 ：选择**First_VPC**
> - 子网 ：**"保留为默认值"**
> - 自动分配公共 IP：**启用**
> - 现在向下滚动到**用户数据**并**复制，粘贴脚本**：

```shell
  #!/bin/bash
  sudo su
  yum update -y
  yum install httpd -y
  systemctl start httpd
  systemctl enable httpd
  echo "<html><h1> Welcome to Public Server</h1><html>" > /var/www/html/index.html
```

> - 将所有**其他设置保留为默认值**。单击**"下一步：添加存储"**

==== (5)添加存储

image::/图片/07图片/配置2.png[添加存储]

==== (6)添加标签

image::/图片/07图片/配置3.png[添加标签]

==== (7) 配置安全组

> - 添加 SSH：

----
  . 选择类型： 选择 SSH
  . 协议：TCP
  . 端口范围：22
  . 源：选择"任何位置"
----

> - 添加 HTTP：

----
  . 选择类型： 选择 HTTP
  . 协议：TCP
  . 端口范围：80
  . 源：选择"任何位置"
----

> - 添加 HTTPS：

----
  . 选择类型： 选择 HTTPS
  . 协议：TCP
  . 端口范围：443
  . 源：选择"任何位置"
----

> - 点击下一步 `审核和启动`

==== (8) 审核启动

> - **检查**所有选定的设置，**无误点击启动**
> - 选择现有密钥对，确认并单击**启动实例**

image::/图片/07图片/现有密钥.png[现有密钥]

=== 测试

> - 记录下 EC2 实例的示例 IPv4 **公有 IP 地址**
> - 将 IPv4 公共 IP **粘贴到浏览器中并点击 [enter]**。您将能够**访问以下网页**。


image::/图片/40图片/index.png[index]

---

=== 创建第二个 VPC

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域
> - 顶部菜单**导航到 VPC**
> - 单击左侧菜单中的**您的 VPC**
> - 在这里，您可以**看到所有 VPC 的列表**，无需对现有和默认 VPC **执行任何操作**，我们将**创建一个新的 VPC**。
> - 单击**``创建 VPC``**按钮。
> * 名称标签： **输入用于向您的 VPC 标识的 VPC 名称**。例如：Second_VPC
> * IPv4 CIDR 块： 输入 **20.0.0.0/24**
> * IPv6 CIDR 块： 无需更改此设置，请确保选中**"无 IPv6 CIDR 块"**
> * 租期： 无需更改此设置，请确保**选中"默认"**。
> - 现在单击**``创建 VPC``**按钮
> - **启用 DNS 主机名选项**，请单击**"操作"**按钮，然后选择**"编辑 DNS 主机名"**选项。
> - **选中"DNS 主机名"选项**，然后单击**"保存更改"**选项。

image::/图片/38图片/dns主机名.png[dns主机名]

> - 同样，单击**"操作"**按钮并选择**"编辑 DNS 解析"**选项。
> - 确保**"DNS 解析"下的**复选框**"启用"**，然后单击**保存更改**该按钮。

image::/图片/39图片/dns解析.png[dns解析]

---


=== 在第二个 VPC 中创建私有子网

> - 单击左侧菜单中的**子网**，然后单击**创建子网**。
> ** VPC ID ：从您之前创建的列表中选择 **Second_VPC**。
> ** 子网名称 ：输入名称 **Private_subnet_second_VPC**
> ** 可用区 ： 选择 **无首选项**
> ** IPv4 网段：输入范围 **20.0.0.0/25**
> ** 单击**"创建子网"**。

---

=== 在第二个 VPC 中启动 EC2 实例

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域。
> - 顶部菜单**导航到 EC2**
> - 左侧面板，单击**"实例"**，然后单击**"启动新实例"**。

==== (1)控制台启动实例

image::/图片/07图片/控制台2.png[控制台启动实例]

==== (2)选择系统镜像

image::/图片/07图片/控制台3.png[选择系统镜像]

==== (3)选择实例类型

image::/图片/07图片/配置1.png[选择实例类型]

==== (4)配置实例

> - 实例数：**输入 1**
> - 网络 ：选择**Second_VPC**
> - 子网 ：**"保留为默认值"**
> - 自动分配公共 IP：**禁用**
> - 将所有**其他设置保留为默认值**。单击**"下一步：添加存储"**

==== (5)添加存储

image::/图片/07图片/配置2.png[添加存储]

==== (6)添加标签

image::/图片/07图片/配置3.png[添加标签]

==== (7) 配置安全组

> - 添加 SSH：

----
  . 选择类型： 选择 SSH
  . 协议：TCP
  . 端口范围：22
  . 源：选择"任何位置"
----

> - 点击下一步 `审核和启动`

==== (8) 审核启动

> - **检查**所有选定的设置，**无误点击启动**
> - 选择现有密钥对，确认并单击**启动实例**

image::/图片/07图片/现有密钥.png[现有密钥]

==== 由于此 EC2 是**在私有子网中创建的**，因此计算机将**只有 IPv4 私有 IP**，因此，请**记录下 EC2 实例的 IPv4 私有 IP 地址**。

---

=== 创建中转网关

> - 顶部菜单**导航到 VPC**
> - 单击左侧边栏部分下的**中转网关**。
> - 单击**创建 Transit Gateway**该按钮**以创建中转网关**。
> * 名称标签：输入**DemoTG**
> * 描述：**TG for peering two VPCs**
> - 将其他选项**保留为默认值**，然后**单击创建 Transit Gateway按钮**。
> - 创建**请求将成功**。
> - 目前，中转网关的状态处于**挂起状态**。它最多**需要 5 分钟才能变为可用**。


image::/图片/40图片/demotg.png[demotg]


---

=== 为创建的 VPC 创建两个**中转网关连接**

> - 单击左侧边栏部分下的**中转网关连接**。
> - 单击**创建 Transit Gateway 挂载**。
> * 名称标签：输入**First_VPCs_TGA**
> * 中转网关 ID：选择**名称标记为 DemoTG 的中转网关**。
> * 挂载类型：选择**VPC**
> * VPC 挂载：
> * DNS 支持：**选中（默认）**
> * IPv6 支持：**未选中**
> * VPC ID：选择**名称First_VPC**
> * 子网 ID：**默认**
> - 单击**创建 Transit Gateway 挂载**该按钮。
> - 为第一个 VPC **创建中转网关连接成功**。
> - 它最多**需要 5 分钟才能进入可用状态**。


image::/图片/40图片/第一个tga.png[第一个tga]


> - **为第二个 VPC 创建中转网关连接**，请单击**创建 Transit Gateway 挂载**按钮。
> * 名称标签：输入**Second_VPCs_TGA**
> * 中转网关 ID：选择**名称标记为 DemoTG 的中转网关**。
> * 挂载类型：选择**VPC**
> * VPC 挂载：
> * DNS 支持：**选中（默认）**
> * IPv6 支持：**未选中**
> * VPC ID：选择**名称Second_VPC**
> * 子网 ID：**默认**
> - 单击**创建 Transit Gateway 挂载**该按钮。
> - 为**第二个 VPC 创建中转网关连接成功**。
> - 创建后，两个中转网关**连接都将存在**。

image::/图片/40图片/第二个tga.png[第二个tga]


---

=== 在第一个 VPC 的路由表中添加路由


> - 导航到**路由表**。
> - 将**存在 4 个路由表**
> - 对于**您创建的第一个 VPC**，您还**创建了一个名为 PublicRT 的路由表**，该表**具有子网关联**。
> - 此处的 PublicRT 路由表也**称为自定义**或**非默认路由表**。
> - 单击路由表 ID 以**查看存在的路由**。
> - 单击下面的**路由选项卡**，然后单击**编辑路由按钮**。
> - 对于此路由表，**存在两个路由**，首先是**本地路由**，即**第一个 VPC 的 CIDR 块**
> - 第二个条路由是关于以目标为 0.0.0.0/0 的**互联网路由为目标的互联网路由**。
> - 我们添加第三条路由，其目标为20.0.0.0/24，即第二个**VPC的网段范围和目标作为中转网关**。
> - 要**添加第三条路由**，请单击**添加路由**按钮。
> * 目标：输入 20.0.0.0/24
> * 目标：选择 中转网关

image::/图片/40图片/公有路由表.png[公有路由表]

> - 单击**保存更改**该按钮。

---

=== 在第二个 VPC 的路由表中添加路由


> - 导航到**路由表**。
> - 在第二个 VPC 中，我们**没有创建任何额外的路由表**，因此在创建 VPC 本身时**只会有一个路由表**，它被**称为默认路由表**或**主路由表**。
> - 单击**路由表 ID 以查看**存在的路由。
> - 单击下面的路由选项卡，然后单击**编辑路由**按钮。
> - 本地将**只有一个路由**，因为我们尚**未创建互联网网关**，因为这**是一个私有路由表**。
> - 我们将 ``10.0.0.0/24`` **添加到该条目**，即**第一个 VPC 的 CIDR 作为目标**，将**中转网关作为目标**。

image::/图片/40图片/私有路由表.png[私有路由表]

> - 单击保存更改该按钮。

---

=== 测试两个 VPC 之间的连接

> - 您已经**复制了在第一个 VPC 中创建的 EC2 实例的 IPv4 公有 IP**。
> - 请通过 **SSH 进入 EC2 实例**。
> - 运行以下**命令**：
> * 切换到 root 用户 ： **sudo su**
> * 更新 ： **yum update -y**
> * 创建一个文件 ： **vim test1.pem**
> - 在本地编辑器中**打开 test1.pem**，并**将其粘贴到终端文件中**。

image::/图片/40图片/复制密钥.png[复制密钥]

> - **按esc后跟``:wq``**，然后**保存您的密钥**。
> - 确保已将密钥文件的**权限更改为 400**。您可以使用以下命令**更改权限**：

----
  chmod 400 public_key.pem
----

> - **SSH 进入私有 EC2 实例**
> * 语法：**ssh -i "test1.pem" ec2-user@<端点实例的私有 IP>**
> * 示例：**ssh -i "test1.pem" ec2-user@20.0.0.74**

image::/图片/40图片/验证成功.png[验证成功]

> - 如您所见，IP 地址**已更改为私有 EC2 私有 IP 20.0.0.74**
> - 现在，您**已使用中转网关连接了两个 VPC**。

---
