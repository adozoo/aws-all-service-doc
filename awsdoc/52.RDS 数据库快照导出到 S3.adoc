
## RDS 数据库快照导出到 S3

=== 介绍

> - 所有类型的 RDS 备份都**可以导出到 S3**，无论是**自动备份**、**手动备份**还是由 AWS 备份服务**创建的备份**。
> - 导出到 s3 的**步骤**：
> - 我们必须创建具有所需 IAM 权限的 Amazon S3 存储桶，并创建**用于服务器端加密 （SSE） 的 KMS 密钥**。
> - 快照可以**通过控制台**或 **CLI 命令导出**。
> - 导出**在后台运行**。它**不会影响任何类型的数据库性能**。
> - 导出到 S3 的数据始终**采用 Apache Parquet 格式**。与**其他格式相比**，Parquet 格式的导出速度**提高了 2 倍**，在 Amazon S3 中**消耗的存储空间最多减少了 6 倍**。
> - 导出的数据可以由**其他 AWS 服务（如 Amazon Sagemaker、Amazon EMR 和 Amazon Athena）进行分析**。

=== 使用案例

> - **灾难恢复**
> - **数据迁移**
> - 使用 **Amazon Sagemaker**、**Amazon EMR** 和 **Amazon Athena** 等 AWS 服务对导出的**快照执行查询**。

=== 架构图

image::/图片/52图片/架构图.png[架构图]

=== 创建 S3 存储桶

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域。
> - 顶部菜单**导航到 S3**

image::/图片/09图片/导航到S3.png[导航到S3]

> - 在 S3 页面上，单击**``创建存储桶``**并**填写存储桶详细信息**。
> - 桶名称：输入**``export-snapshot-demo``**
> * 注意： S3 存储桶名称是**全局唯一**的，请**选择一个可用的名称**。
> - AWS 区域：选择**美国东部（弗吉尼亚北部）美国东部-1**
> - 对于对象所有权：选择**ACL 已禁用**
> - 将**其他设置保留**为默认值。
> - **创建存储桶按钮**
> - S3 **存储桶已创建**。

image::/图片/52图片/存储桶创建.png[存储桶创建]


---

=== 创建 KMS 密钥

> - 顶部菜单**导航到 KMS**
> - 在 KMS 控制台中，导航到**客户管理的密钥**，然后单击**创建密钥**。
> - 选择**"密钥类型"**作为**"对称"**，然后单击**"下一步"**。
> - 在**"添加标签"**下，提供以下**详细信息**：
> * 别名：输入**``kmskey_1``**
> * 描述：输入**``Used for RDS Snapshot exports to S3 of the "database-demo" DB Instance``**
> * 单击**"下一步"**。
> - 将**"定义关键管理权限"**保留为**默认值**，然后单击**"下一步"**。
> - 将**"定义密钥使用权限"**保留为**默认值**，然后单击**"下一步"**。
> - 单击**"完成"**。
> - 单击创建的 KMS 密钥。**复制 ARN 并将其保留以供将来参考**。

image::/图片/52图片/kmsarn.png[kmsarn]

---

=== 为 RDS 数据库实例创建安全组

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域
> - 顶部菜单**导航到 EC2**
> - 左侧面板，单击**"网络和安全"**，然后单击**"创建安全组"**。
> - 安全组名称：输入**RDS_lab_sg**
> - 描述：**Security group for RDS**
> - VPC：选择**默认VPC**
> - 在**"入站规则"**下，单击**"添加规则"**。
> - 添加 **MYSQL/Aurora**

----
  . 选择类型： 选择 MYSQL/Aurora
  . 协议：TCP
  . 端口范围：3306
  . 源：选择"任何位置"
----

> - 将其他内容**保留为默认值**，然后单击**创建安全组按钮**。
> - 现**已创建安全组**。

---

=== 创建 RDS 数据库实例


> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域
> - 通过菜单**导航到 RDS**。
> - 单击**"数据库"**部分中的**"创建数据库"**按钮。
> - 指定数据库**详细信息**：
> * 实例**规格**
> ** 数据库创建方法：**标准创建**
> ** 引擎选项：选择 **MySQL**
> ** 版本 ： **默认**
> ** 模板 ：选择**开发/测试**
> ** 数据库实例标识符：**demo-db**
> ** 主用户名：**awslabs**
> ** 主密码和确认密码：**awslabs123**
> ** 注意：这是用于登录数据库的用户名/密码组合。请记下它们。
> ** 数据库实例类 ： **db.t3.micro**
> ** 存储类型 ： **通用型 （SSD）**
> ** 分配的存储：**20（默认值）**
> ** 启用存储空间自动缩放：**取消选中**
> ** 公共访问 ： 选择**是**
> ** VPC 安全组： 选择**现有**
> ** 安全组注意：**删除默认安全组**，然后**选择RDS_lab_sg**

image::/图片/47图片/rds安全组.png[rds安全组]

> - 转到**其他配置**选项
> * 初始数据库名称：**demodb**
> * 数据库参数组：**默认**
> * 选项组：**默认**
> * 启用自动备份：**取消选中**
> * 日志导出：本练习**不需要日志导出**。
> * 注意：将**其他所有设置保留为默认值**
> - 单击**"创建数据库"**
> - 导航到**"数据库"**。
> - 在 RDS 控制台上，将**显示新数据库实例的详细信息**。数据库实例的状态为**"正在创建"**，直到数据库实例**可供使用**。
> - 当状态更改为可用时，您**可以连接到数据库实例**。新实例状态变为**"可用"**之前最多可能**需要 20 分钟**。

image::/图片/52图片/数据库创建成功.png[数据库创建成功]

==== 单击数据库标识符**``demo-db``**并**复制数据库终端节点**。

---

=== 使用 MySQL 工具连接到数据库实例上的 RDS 数据库

> - 使用 MySQL 图形化连接工具**连接到数据库实例上的数据库**，请**查找数据库实例的终端节点（DNS 名称）和端口号**。
> - 导航到并单击**"demo-db"**。
> - 在**"连接和安全"**部分下，**复制并记下终端节点和端口**。
> * 终端节点：**复制终端节点**
> * 端口：**3306**
> * 您需要**终端节点**和**端口号**才能**连接到数据库实例**。
> - 打开 MySQL 图形化**连接工具**。单击**加号图标**

==== 本机情况

> - 连接名称：输入示例名称 **MyDatabseConnection**
> - 主机名：**已复制的终端节点**
> - 端口： **3306**
> - 用户名： **awslabs**
> - 密码： **awslabs123**

image::/图片/52图片/mysql连接.png[mysql连接]

> - 单击**"测试连接"**以**确保能够正确连接到数据库**。

image::/图片/47图片/测试成功.png[测试成功]

> - 单击**"保存"**以**保存连接**。
> - 成功连接并**打开数据库后**，**可以创建表并对连接的数据库执行各种查询**。

image::/图片/47图片/成功.png[成功]

---

=== 创建示例数据库和表

> - 在 SQL 编辑器中，让我们**创建一个示例数据库和一个表**，用于**练习目的**。
> - 现在**复制下面的MySQL命令**并将其**粘贴**到**"查询"选项卡**中。

```sql
  CREATE DATABASE SchoolDB;
  use SchoolDB;
  CREATE TABLE IF NOT EXISTS subjects ( 
  subject_id INT AUTO_INCREMENT,
                        subject_name VARCHAR(255) NOT NULL,
                        teacher VARCHAR(255),
                        lesson TEXT,
                        PRIMARY KEY (subject_id)
                   ) ENGINE=INNODB;
  INSERT INTO subjects(subject_name, teacher, lesson) VALUES ('English', 'John Taylor', 'Chapter one');
  INSERT INTO subjects(subject_name, teacher, lesson) VALUES ('Science', 'Mary Smith', 'Chapter four');
  INSERT INTO subjects(subject_name, teacher, lesson) VALUES ('Maths', 'Ted Miller', 'Chapter ten');
  INSERT INTO subjects(subject_name, teacher, lesson) VALUES ('Arts', 'Suzan Carpenter', 'Chapter seven');
  select * from subjects;
```

image::/图片/52图片/运行sql.png[运行sql]


> - 我们创建了一个**示例数据库和表**。

image::/图片/52图片/sql结果.png[sql结果]


---

=== 从现有数据库实例拍摄快照

> - 让我们**拍摄数据库的快照**。
> - 选择创建的数据库实例，然后单击**操作**。
> - 从选项中**单击拍摄快照**。

image::/图片/52图片/拍摄快照.png[拍摄快照]

> - 为快照命名，**``demo-db-snapshot``**，然后单击**"拍摄快照"**按钮。

image::/图片/52图片/快照名称.png[快照名称]

> - 创建快照**需要 3-5 分钟**。一段时间后**刷新**，快照创建状态将为**"可用"**。

image::/图片/52图片/快照拍摄完成.png[快照拍摄完成]


---

=== 将数据库快照导出到 S3

> - 让我们将快照**导出到 S3**。
> - 选择创建的快照，然后单击**操作**。
> - 从选项中单击**导出到 Amazon S3**。

image::/图片/52图片/导出到s3.png[导出到s3]

> - 在**"设置"**下，指定一个名称以**标识导出**：
> * 导出标识符：输入**``snap-export-s3``**
> * 将导出的数据保留为**默认值**。
> * 在 S3 下，从下拉列表中选择**创建的 S3**。
> * 在 IAM 角色下，选择从下拉列表中**创建新角色**，并将该角色的名称指定为**``export-iam-role``**。
> * 注意：请勿选择存在的任何其他 IAM 角色。选择仅**创建新角色**。

image::/图片/52图片/iam角色.png[iam角色]

> - 从下拉列表中选择**刚刚创建的 KMS 密钥**，或输入我们在创建密钥时**记下的 ARN**。
> - 查看所有设置，然后单击**导出到 Amazon S3**。
> - 这可能需要**长达 20-25 分钟**，因为它正在**导出整个数据库**。导出完成后，您可以看到**"完成"**状态。
> - 注意：您还将在导出到 Amazon S3 选项卡中看到**其他导出**。

image::/图片/52图片/导出成功.png[导出成功]

---

=== 检查 Amazon S3 中的导出数据

> - 导出完成后，导航到**创建的 S3 存储桶**。
> - 您将能够看到一个包含**导出标识符名称的文件夹**。
> - 单击该按钮时，您可以看到**2个JSON文件**。
> * 第一个 JSON 文件是**导出任务的最终报告**。
> * 第二个 JSON 文件为我们提供了有关**单个表的信息**，包括**总体大小**和**数据类型映射**。
> - 您可以看到我们**之前创建的 SchoolDB 数据库**。

image::/图片/52图片/验证s3.png[验证s3]

> - 这样，我们就将数据库快照**导出到了 S3 存储桶**。

---
