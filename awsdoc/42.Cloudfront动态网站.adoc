
## Cloudfront动态网站

=== 架构图

image::/图片/42图片/架构图.png[架构图]

== 实验步骤

=== 启动 EC2 实例

==== (1)控制台启动实例

image::/图片/07图片/控制台2.png[控制台启动实例]

==== (2)选择系统镜像

image::/图片/07图片/控制台3.png[选择系统镜像]

==== (3)选择实例类型

image::/图片/07图片/配置1.png[选择实例类型]

==== (4)配置实例


> - 实例的数量：**选择 2**
> - 高级详细信息
> - 用户数据：以**文本形式**

```shell
  #!/bin/bash
  sudo su
  yum update -y
  yum install httpd php -y
  systemctl start httpd
  systemctl enable httpd
  cd /var/www/html/
  wget https://wangzhan-test.s3.ap-east-1.amazonaws.com/index.php
  systemctl restart httpd
```

> - 将其余设置**保留为默认值**，然后单击**下一步按钮**。

==== (5)添加存储

image::/图片/07图片/配置2.png[添加存储]

==== (6)添加标签

image::/图片/07图片/配置3.png[添加标签]

==== (7) 配置安全组

> - 添加 SSH：

----
  . 选择类型： 选择 SSH
  . 协议：TCP
  . 端口范围：22
  . 源：选择"任何位置"
----

> - 添加 HTTP：

----
  . 选择类型： 选择 HTTP
  . 协议：TCP
  . 端口范围：80
  . 源：选择"任何位置"
----

> - 添加 HTTPS：

----
  . 选择类型： 选择 HTTPS
  . 协议：TCP
  . 端口范围：443
  . 源：选择"任何位置"
----

> - 点击下一步 `审核和启动`

==== (8) 审核启动

> - **检查**所有选定的设置，**无误点击启动**
> - 选择现有密钥对，确认并单击**启动实例**

image::/图片/07图片/现有密钥.png[现有密钥]

=== 测试

> - 将EC2实例的 IPv4 公共 IP **粘贴到浏览器中并加上``/index.php``**，以**查看PHP文件**
> - 例子：**``http://<IPv4公共IP>/index.php``**

image::/图片/42图片/index.png[index]

> - 您可以**传递查询字符串参数 ID**，该值将**显示在页面中**。
> - 例子：**``http://<IPv4公共IP>/index.php?id=AWS``**

image::/图片/42图片/index1.png[index1]

> - 如果您**刷新页面**，则**时间将递增**。

---


=== 创建目标组

==== 在 EC2 控制台中，**导航到**左侧面板中**负载平衡**下的**目标群组**。
> - 单击``创建目标组``按钮。
> - 步骤 1，指定组**详细信息**
> * 在"基本配置"下，
> ** 选择目标类型：选择**实例**
> ** 目标组**名称**：输入**"MyCloudFrontTargetGroup"**
> ** 协议：**选择 HTTP**
> ** 端口：**输入 80**
> ** VPC：**保持默认**
> * 健康检查
> ** 健康检查协议：**选择 HTTP**
> ** 运行状况检查路径：输入 **/index.php**
> ** 单击并展开**高级运行状况检查设置**
> ** 正常阈值 ： **输入 3**
> ** 不正常阈值：**2（默认值）**
> ** 超时：**5 秒（默认值）**
> ** 间隔：**输入6秒**
> ** 成功代码：**200（默认值）**
> * 将其他设置保留为**默认值**。
> * 滚动到页面**末尾**，然后单击**"下一步"**按钮。
>
> - 步骤 2，注册目标
> * **选中**这两个实例，然后单击**"在下面以待注册的形式添加"**按钮。
> * 实例将出现在**"查看目标"**部分中，运行状况**状态为"待处理"**。
> * 单击**创建目标组**按钮。

image::/图片/12图片/注册目标.png[注册目标]

> - **现在已创建目标组**。

---

=== 创建应用程序负载均衡器


==== 在 EC2 控制台中，**导航到**左侧面板中**负载平衡**下的**负载均衡器**。

> - 单击左上角**``创建负载均衡器``**按钮，为我们的 Web 服务器创建负载均衡器。
> - 选择负载均衡器**类型**：选择**"应用程序负载均衡器（Application Load Balancer）"**，单击"创建"按钮。
> - 要创建应用程序负载均衡器，请按如下方式**配置负载均衡器**
> * 对于**基本配置**部分
> ** 负载均衡器**名称**：输入**"MyCloudFrontLoadBalancer"**
> ** 模式：选择**面向互联网**
> ** IP 地址类型：**选择 IPv4**
> * 对于**网络映射**部分：
> ** VPC：保持**默认**
> ** 映射：选择**所有存在的可用区**
> * 对于"安全组"部分，
> ** 从下拉列表中**选择EC2实例的安全组**，然后**删除默认安全组**。
> * 对于**侦听器和路由**部分，
> * 侦听器已随协议 HTTP 和端口 80 一起存在。
> ** 为"默认操作转发到"选项**选择目标组** **MyCloudFrontTargetGroup**。
> - 将其他选项保留为**默认值**，然后单击"创建负载均衡器"按钮。 
> - **您已成功创建应用程序负载均衡器。 单击查看负载均衡器按钮**。
> - 等待 2 到 3 分钟，让负载均衡器变为**活动**状态。

---


=== 测试弹性负载均衡器

> - 接下来，**导航到**左侧面板中**负载平衡**下的**负载均衡器**
> - 并注意到 ELB 的状态为**活动**状态。
> - 复制 ELB 的 **DNS 名称**，然后在浏览器中**输入地址**。
> * 域名示例：**``MyCloudFrontLoadBalancer-1383777347.us-east-1.elb.amazonaws.com``**

image::/图片/42图片/负载均衡器.png[负载均衡器]

> - 现在继续**刷新页面**，您可以**观察到ELB在两个实例之间平均分配流量**。**（请注意，每次刷新页面时，实例 ID 和时间都会更改）**

image::/图片/42图片/负载均衡器2.png[负载均衡器2]

---

=== 创建CloudFront分发

> - 从菜单中**导航到 CloudFront**。
> - 导航到**左侧面板**，选择**"分配"**选项卡。
> - 现在点击**创建分配**按钮
> - 现在按如下方式**配置CloudFront分发**
> * **源域**
> ** 选择**选择您创建的负载均衡器**：**``mycloudfrontloadbalancer-1383777347.us-east-1.elb.amazonaws.com``**
> - 默认**缓存行为设置** ：
> * 向下滚动到**缓存键和源请求**：选择**旧版缓存设置(Legacy cache settings)**
> * 查询字符串：**全部**
> * Cookie： **全部**
> * 注意：我们正在**启用查询字符串转发**，因为我们的**服务器可以接受查询字符串参数id**
> * 对象缓存：选择**自定义(Customize)**
> * 最大 TTL：输入 **0**
> * 默认 TTL：输入 **0**

image::/图片/42图片/CloudFront分发.png[CloudFront分发]

> - 注意：TTL 选项将**设置为 0**，从而**禁用动态内容**。
> - 向下滚动到**"设置"**。
> - 价格等级：选择**使用所有边缘站点(最佳性能)**
> - 向下滚动并**单击创建分配按钮**
> - 您可以看到 **CloudFront 已启用**
> * 注意：此过程大约需要**15-20分钟**。
> - Amazon CloudFront 分配给您的**分配的域名将显示在分配列表中**。它看起来与 **``https://d3bu7aez8dykvy.cloudfront.net``相似**

---

=== 测试CloudFront分发

> - 复制 CloudFront 分配域名**并将其粘贴到浏览器中**，然后**点击 [enter]**。
> - 您将能够**看到实例 ID 和时间**。

image::/图片/42图片/CloudFront.png[CloudFront]

> - 现在**刷新页面并查看实例 ID 更改**，时间将**继续递增**

image::/图片/42图片/CloudFront1.png[CloudFront1]

> - 现在，**将查询字符串参数传递到 CloudFront**。
> - 语法：**``https://<域名>/?id=CloudFront``**
> - 例子：**``https://d3bu7aez8dykvy.cloudfront.net/?id=CloudFront``**


image::/图片/42图片/CloudFront2.png[CloudFront2]

---
