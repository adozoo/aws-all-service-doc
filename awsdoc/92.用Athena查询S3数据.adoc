
## 用Athena查询S3数据

=== 什么是Amazon Athena?

> - Amazon Athena 提供了**一个交互式查询编辑器**，您可以在**其中使用 SQL 语句**轻松**分析 S3 存储桶中存在的数据**。
> - 由于这是一项**无服务器服务**，因此**只需为运行的查询付费**。
> - 在后端，Amazon Athena **使用 Presto**，它支持**标准 SQL 语句**，并使用**不同风格的标准数据格式**，包括**``CSV``、``ORC``、``JSON``、``Arvo``和``Apache Parquet``**。
> - 您可以**使用``AWS 管理控制台``**、**``ODBC / JDBC 驱动程序``**或**``API``**访问 Athena。

=== 架构图

image::/图片/92图片/架构图.png[架构图]

== 实验步骤

=== 创建S3存储桶

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域。
> - 顶部菜单**导航到 S3**

image::/图片/09图片/导航到S3.png[导航到S3]

> - 在 S3 页面上，单击**``创建存储桶``**并**填写存储桶详细信息**。
> - 桶名称：输入**``mys3athenatest``**
> * 注意： S3 存储桶名称是**全局唯一**的，请**选择一个可用的名称**。
> - AWS 区域：选择**美国东部（弗吉尼亚北部）美国东部-1**
> - 对于对象所有权：选择**ACL 已启用**
> - 对于此存储桶的“阻止公有访问”设置部分
> * **取消选中**"阻止所有公共访问"选项，然后**选中确认**选项。
> - 将**其他设置保留**为默认值。
> - **创建存储桶按钮**
> - S3 **存储桶已创建**。

---

=== 将文件上传到 S3 存储桶

> - **单击**存储桶名称**``mys3athenatest``**。
> - 在对象中，您可以看到**以下消息**
> * 此存储桶中**没有任何对象**。

image::/图片/41图片/没有对象.png[没有对象]

> - 您可以从本地计算机上传**本实验所需文件**

==== **``本实验所需文件``**位于此仓库**附件目录**

> - 将文件**上传到我们的 S3 存储桶**
> * 点击**上传**按钮。
> * 点击**添加文件**按钮。
> * 浏览您的本地文件**并选择它**
> * 单击上传按钮**上传**。
> - 您可以从屏幕顶部的传输面板中**查看上传进度**。
> - 上传文件后，它将**显示在存储桶中**。

image::/图片/92图片/显示在存储桶中.png[显示在存储桶中]

---

=== 设置工作组

> - 确保您位于**弗吉尼亚北部**区域。
> - 通过菜单导航到**"Athena"**。
> - 单击左侧菜单中的**工作组**选项
> - 若要**创建工作组**，请单击**"创建工作组"**按钮。
> - 提供创建工作组的**详细信息**：
> * 工作组名称：输入 **``awsWorkgroup``**
> * 描述：输入**``Workgroup for Athena lab``**
> * 查询结果的位置：选择上述步骤中**创建的 S3 存储桶**
> * 将**其他设置保留为默认值**
> * 单击**"创建工作组"**按钮。
> * 现在，它将**列出所有工作组**

image::/图片/92图片/列出所有工作组.png[列出所有工作组]

> - 通过选中**``awsWorkgroup``**，然后单击**操作**中的**"切换工作组"**按钮。

image::/图片/92图片/切换工作组.png[切换工作组]

> - 现在，可以**验证工作组已切换**。

image::/图片/92图片/验证工作组.png[验证工作组]

---

=== 在 Glue 中创建数据库

> - 确保您位于**弗吉尼亚北部**区域。
> - 通过菜单导航到**"AWS Glue"**。
> - 单击左侧菜单中的**数据库**选项
> - 若要**创建数据库**，请单击**"添加数据库"**按钮。
> - 在弹出式菜单中，输入数据库名称为**``awsgluedatabase``**，然后单击**"创建"**按钮。

image::/图片/92图片/添加数据库.png[添加数据库]

> - 现在**已创建数据库**。

image::/图片/92图片/已创建数据库.png[已创建数据库]

---

=== 在 Glue 中创建表

> - 在左侧边栏中单击**"表"**
> - 要**创建表**，请单击**添加表**按钮，然后选择**手动添加表**
> - 在设置表的**属性部分**中，执行以下操作：
> * 将表名称输入为 **``aws-sample-table``**
> * 选择数据库，选择 **``awsgluedatabase``**
> * 单击**"下一步"**按钮。

image::/图片/92图片/添加表.png[添加表]

> - 在**添加数据存储**部分中，执行以下操作：
> * 选择源类型：**``S3（默认）``**
> * 数据位于：**``我的账户中的指定路径（默认）``**
> * 包含路径：选择上述步骤中**创建的 S3 存储桶**
> * 单击下面的**"下一步"**按钮以继续
> - 在**"选择数据格式"**部分中，执行以下操作：
> * 选择分类为 **``CSV``**
> * 选择分隔符为：**``逗号``**
> * 单击**"下一步"**按钮。
> - 在**定义架构**部分中，我们将**添加 2 列**。
> * 单击**添加列**该按钮。
> * 列名：输入**``Expense_Type``**和列类型：选择**``字符串``**
> * 单击下面的**"添加"**按钮。
> * 再次单击**添加列**该按钮。
> * 列名：输入**``Expense_Category``**和列类型：选择**``字符串``**
> * 单击下面的**"添加"**按钮。
> * 添加两列后，单击**"下一步"**按钮。

image::/图片/92图片/添加列.png[添加列]

> - **添加分区索引**：将**所有内容保留为默认值**，然后单击**"下一步"**按钮。
> - **查看表的配置**，然后单击**"完成"**按钮。
> - 现在**已创建该表**。

image::/图片/92图片/已创建该表.png[已创建该表]

---

=== 在 Athena 中查询表

> - 确保您位于**弗吉尼亚北部**区域。
> - 通过菜单导航到**"Athena"**。
> - 单击左侧菜单中的**查询编辑器**选项
> - 在查询编辑器中的**"数据"**部分，选择数据库为**``awsgluedatabase``**。
> - 然后你会看到我们创建的表，**``aws-sample-table``**。
> - 要预览**``aws-sample-table``**表的数据，请单击**三点图标**并选择**"预览表"**。

image::/图片/92图片/预览表.png[预览表]

> - 查询编辑器将**自动生成用于查询前 10 列的 SQL 语句**。

image::/图片/92图片/查询前 10 列.png[查询前 10 列]

> - **查询结果如下所示**。

image::/图片/92图片/查询结果.png[查询结果]

> - 若要**获取食物"expense_category"所有类型的结果**，请将**以下 SQL 语句粘贴到查询编辑器**中。
> * **``SELECT * FROM "awsgluedatabase"."aws-sample-table" where expense_category = 'Food';``**

image::/图片/92图片/查询食物.png[查询食物]

> - 您可以尝试一些其他查询，例如：
> - 通过在**查询编辑器中运行以下 SQL 语句**来**获取存在的行总数**。
> * **``SELECT count(*) FROM "awsgluedatabase"."aws-sample-table";``**

image::/图片/92图片/行总数.png[行总数]

---
