
## VPC NACL案例研究

=== 架构图

image::/图片/31图片/架构图.png[架构图]

== 实验步骤

=== 创建新的VPC

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域
> - 顶部菜单**导航到 VPC**
> - 单击左侧菜单中的**您的 VPC**
> - 在这里，您可以**看到所有 VPC 的列表**，无需对现有和默认 VPC **执行任何操作**，我们将**创建一个新的 VPC**。
> - 单击**``创建 VPC``**按钮。
> * 名称标签： **输入用于向您的 VPC 标识的 VPC 名称**。例如：MyVPC
> * IPv4 CIDR 块： 输入 **10.0.0.0/16**
> * IPv6 CIDR 块： 无需更改此设置，请确保选中**"无 IPv6 CIDR 块"**
> * 租期： 无需更改此设置，请确保**选中"默认"**。
> - 现在单击**``创建 VPC``**按钮

image::/图片/30图片/vpc.png[vpc]

> - 创建VPC后，它将显示**详细信息**，**如下所示**：

image::/图片/30图片/vpcok.png[vpcok]

---

=== 创建子网

> - 我们将分别在 **us-east-1a** 和 **us-east-1b** 可用区中**创建一个公有子网**和**一个私有子网**，如下所示：
> * 对于公有子网，单击左侧菜单中的子网，然后单击**创建子网**。
> ** VPC ID ：从您之前创建的列表中选择 **MyVPC**。
> ** 子网名称 ：输入名称 **MyPublicSubnet**
> ** 可用区 ： 选择 **us-east-1a**
> ** IPv4 网段：输入范围 **10.0.1.0/24**
> ** 单击**"创建子网"**。
> * 对于私有子网，再次单击**"创建子网"**。
> ** VPC ID ：从您之前创建的列表中选择 **MyVPC**。
> ** 子网名称 ：输入名称 **MyPrivateSubnet**
> ** 可用区 ： 选择 **us-east-1b**
> ** IPv4网段：输入范围**10.0.2.0/24**
> ** 单击**"创建子网"**。

image::/图片/30图片/subnetok.png[subnetok]

---

=== 创建和配置互联网网关

> - 单击左侧菜单中的**互联网网关**，然后单击**创建互联网网关**。
> * 名称标签：**MyInternetGateway**。
> * 单击**创建互联网网关**。
> - 从列表中**选择您创建的互联网网关**
> * 单击**"操作"**。
> * 单击**附加到VPC**
> * 从列表中**选择您创建的MyVPC**，然后单击**连接互联网网关**。

image::/图片/30图片/igw.png[igw]

---

=== 创建路由表

> - 从左侧菜单中**转到路由表**，然后单击**创建路由表**。
> * 名称： 输入**"PublicRouteTable"**。
> * VPC： 从列表中选择**"MyVPC"**。
> * 单击**创建路由表**。
> - 重复相同的步骤，为私有子网**创建路由表**。
> * 名称： 输入 **PrivateRouteTable**。
> * VPC： 从列表中选择**"MyVPC"**。
> * 单击**创建路由表**。

image::/图片/30图片/routetable.png[routetable]

> - 现在，将子网**关联到路由表**。
> - 单击 **PublicRouteTable**，单击**``操作``**。
> * 然后转到**"子网关联"**选项卡
> * 从列表中选择**"MyPublicSubnet"**。
> * 单击**保存关联**。
> - 单击 **PrivateRouteTable**，单击**``操作``**。
> * 然后转到**"子网关联"**选项卡
> * 从列表中选择 **MyPrivateSubnet**。
> * 单击**保存关联**。
> - 确保**不要将任何子网与主路由表关联**。

---


=== 更新路由表并配置公网网关

> - PublicRouteTable：添加允许公网流量**流向 VPC 的路由**。
> - 选择**"PublicRouteTable"**。
> - 转到"路由"选项卡，然后单击**``编辑路由``**按钮。
> - 然后单击**``添加路由``**按钮。
> - 指定以下值：
> * 目标：输入 **0.0.0.0/0**
> * 目标：从下拉菜单中选择互联网网关，选择**``MyInternetGateway``**。
> * 点击**保存更改**。

image::/图片/30图片/route.png[route]

---

=== 为公有子网启用自动分配公有 IP

> - **注意：此设置将允许您在公有子网中启动的所有 EC2 实例自动分配公有 IP**
> - 单击 VPC 左侧菜单中的**子网**。
> - 从"子网"列表中选择**"MyPublicSubnet"**
> - 单击**"操作"**，单击**"编辑子网设置"**，然后找到**"自动分配 IP 设置"**选项
> - 选中**启用自动分配 IPv4 地址**复选框
> - 现在点击**保存**

---

=== 在公有子网中启动 EC2 实例

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域。
> - 顶部菜单**导航到 EC2**
> - 左侧面板，单击**"实例"**，然后单击**"启动新实例"**。

==== (1)控制台启动实例

image::/图片/07图片/控制台2.png[控制台启动实例]

==== (2)选择系统镜像

image::/图片/07图片/控制台3.png[选择系统镜像]

==== (3)选择实例类型

image::/图片/07图片/配置1.png[选择实例类型]

==== (4)配置实例

> - 实例数：**输入 1**
> - 网络 ： 选择**MyVPC**
> - 子网 ：选择**"MyPublicSubnet"**
> - 自动分配公共 IP：**使用子网设置**
> - 在"高级详细信息>用户数据"部分下，**输入以下脚本**以创建由 Apache 提供的 HTML 页面

```shell
  #!/bin/bash
  sudo su
  yum update -y
  yum install httpd -y
  echo "<html><h1>Welcome to AWS </h1><html>" >> /var/www/html/index.html
  systemctl start httpd
  systemctl enable httpd
```

> - 将所有**其他设置保留为默认值**。单击**"下一步：添加存储"**

==== (5)添加存储

image::/图片/07图片/配置2.png[添加存储]

==== (6)添加标签

image::/图片/07图片/配置3.png[添加标签]

==== (7) 配置安全组

> - 添加 SSH：

----
  . 选择类型： 选择 SSH
  . 协议：TCP
  . 端口范围：22
  . 源：选择"任何位置"
----

> - 添加 HTTP：

----
  . 选择类型： 选择 HTTP
  . 协议：TCP
  . 端口范围：80
  . 源：选择"任何位置"
----

> - 点击下一步 `审核和启动

==== (8) 审核启动

> - **检查**所有选定的设置，**无误点击启动**
> - 选择现有密钥对，确认并单击**启动实例**

image::/图片/07图片/现有密钥.png[现有密钥]

---

=== 在私有子网中启动 EC2 实例

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域。
> - 顶部菜单**导航到 EC2**
> - 左侧面板，单击**"实例"**，然后单击**"启动新实例"**。

==== (1)控制台启动实例

image::/图片/07图片/控制台2.png[控制台启动实例]

==== (2)选择系统镜像

image::/图片/07图片/控制台3.png[选择系统镜像]

==== (3)选择实例类型

image::/图片/07图片/配置1.png[选择实例类型]

==== (4)配置实例

> - 实例数：**输入 1**
> - 网络 ： 选择**MyVPC**
> - 子网 ：选择**"MyPrivateSubnet"**
> - 自动分配公共 IP：**使用子网设置（禁用）**
> - 将所有**其他设置保留为默认值**。单击**"下一步：添加存储"**

==== (5)添加存储

image::/图片/07图片/配置2.png[添加存储]

==== (6)添加标签

image::/图片/07图片/配置3.png[添加标签]

==== (7) 配置安全组

> - 添加 SSH：

----
  . 选择类型： 选择 SSH
  . 协议：TCP
  . 端口范围：22
  . 源：选择"任何位置"
----

> - 添加 所有 ICMP IPv4：

----
  . 选择类型： 选择 所有 ICMP IPv4
  . 协议：ICMP
  . 端口范围：0 - 65535
  . 源：选择"任何位置"
----

> - 点击下一步 `审核和启动

==== (8) 审核启动

> - **检查**所有选定的设置，**无误点击启动**
> - 选择现有密钥对，确认并单击**启动实例**

image::/图片/07图片/现有密钥.png[现有密钥]

---

=== 测试两个 EC2 实例

> - **公有 EC2 实例**：我们已在此服务器上**安装了 Web 应用程序**。
> - 从实例列表中**选择 公有子网的 EC2 实例**。
> - 从"详细信息"选项卡中，**复制 IPv4 公共 IP**。

image::/图片/31图片/公有ip.png[公有ip]


> - 现在将此IP**粘贴到您的Web浏览器中**，然后**访问**
> - 您将能够看到**以下页面**：

image::/图片/31图片/页面.png[页面]

> - 接下来，我们将尝试从**公有 EC2 实例** ping **私有 EC2**。
> - **SSH 进入公有 EC2 实例**
> - **切换到根用户**

----
  sudo -s
----

> - 从**"详细信息"**选项卡复制 私有子网的 EC2 实例 的**"私有 IPv4 地址"**。

image::/图片/31图片/私有ip.png[私有ip]

> - 使用私有 IPv4 对私有实例**执行 Ping 操作**

image::/图片/31图片/ping.png[ping]

=== 注意：之所以能够执行这些任务，是因为在 VPC 创建期间创建的默认 NACL 默认允许入站和出站。

---

=== 创建自定义 NACL 并将其关联到子网

> - 注意：默认情况下，两个子网都将与 MyVPC 的默认 NACL **相关联**。创建自定义 NACL 并将其**附加到公有子网和私有子网**。

==== 导航到**"VPC"**。"安全性"下单击**"网络 ACL"**

> - **创建网络 ACL**
> * 名称：输入**MyPublicNACL**
> * VPC：从下拉列表中选择**MyVPC**。
> * 单击**"创建网络 ACL"**。
> - 将 MyPublicNACL **关联到子网**
> * 选择"操作"选项卡，然后单击**"编辑子网关联"**
> * **同时选择** **公有子网**和**私有子网**。
> * 点击**保存更改**

---

=== 测试公有 EC2 实例和私有 EC2 实例

> - **公有 EC2 实例**：
> * 导航到 EC2 实例控制面板。单击左侧菜单中的**实例**。
> * 从实例列表中**选择 公有子网的 EC2 实例**。
> * 从"详细信息"选项卡中，**复制 IPv4 公共 IP**。

image::/图片/31图片/公有ip.png[公有ip]


> - 现在将此IP**粘贴到您的Web浏览器中**，然后**访问**
> - 您将能够看到**以下页面**：

image::/图片/31图片/无法访问.png[无法访问]


> - 注意：这是因为附加到**公有子网的自定义 NACL** 会**限制入站和出站流量**。
> - **私有 EC2 实例**：
> * 由于公有 NACL **限制所有流量**，因此您将**无法通过 SSH 进入公有 EC2 实例**以 ping 私有实例。
> * 接下来，我们将**解决这个问题**。

---


=== 向自定义 NACL 添加规则 （MyPublicNACL）


> - 导航到**"VPC"**。单击"安全性下的**"网络 ACL"**
> - 从列表中选择**"MyPublicNACL"**。
> - 在"入站规则"中，单击**"编辑入站规则"**
> - 添加**以下规则**：
> * **HTTP** 单击"添加规则"，
> ** 规则编号 ：输入 **100**
> ** 类型：选择 **HTTP （80）**
> ** 源：输入 **0.0.0.0/0**
> ** 允许/拒绝：选择**"允许"**
> * 对于**所有 ICMP- IPv4**，请单击"添加规则"，
> ** 规则编号 ：输入 **150**
> ** 类型：选择**所有 ICMP - IPv4**
> ** 源：输入 **0.0.0.0/0**
> ** 允许/拒绝：选择**"允许"**
> * 对于 **SSH**，单击"添加规则"，
> ** 规则编号 ： 输入 **200**
> ** 类型： 选择 **SSH （22）**
> ** 源：输入 **0.0.0.0/0**
> ** 允许/拒绝：选择**"允许"**
> * 点击**保存更改**


image::/图片/31图片/acl入展规则.png[acl入展规则]


> - 在出站规则选项卡中，单击**编辑出站规则**
> - 添加**以下规则**：
> * 对于**自定义端口**
> ** 规则编号：输入 **100**
> ** 类型：选择**自定义 TCP 规则**
> ** 端口范围：输入 **1024 - 65535**
> ** 源：输入 **0.0.0.0/0**
> ** 允许/拒绝：选择**"允许"**
> * 对于所有 **ICMP- IPv4**，请单击"添加规则"，
> ** 规则编号 ：输入 **150**
> ** 类型：选择**所有 ICMP - IPv4**
> ** 源：输入 **0.0.0.0/0**
> ** 允许/拒绝：选择**"允许"**
> * 对于 **SSH**，请单击"添加规则"，
> ** 规则编号：输入 **200**
> ** 类型： 选择 **SSH （22）**
> ** 源：输入 **0.0.0.0/0**
> ** 允许/拒绝：选择**"允许"**
> * 点击**保存**

image::/图片/31图片/acl出站规则.png[acl出站规则]

---

=== 测试两个 EC2 实例

> - 我们将尝试从**公有 EC2 实例 ping 私有 EC2**。
> * **SSH 进入公有 EC2 实例**
> * **连接到服务器后**：
> ** **切换到根用户**

----
  sudo -s
----

> - 从**"详细信息"**选项卡复制 私有子网的 EC2 实例 的**"私有 IPv4 地址"**。

image::/图片/31图片/私有ip.png[私有ip]

> - 使用私有 IPv4 对私有实例**执行 Ping 操作**

image::/图片/31图片/ping.png[ping]


> - 注意：之所以**能够执行这些任务**，是因为我们**添加了 NACL 规则**。

---
