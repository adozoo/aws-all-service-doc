## 阶段变量构建API 网关

== 实验步骤

=== 创建 IAM 角色

> - 导航到**``IAM``**
> - 在**左侧菜单**中，单击**``角色``** 。单击**``创建角色``**该按钮以**创建新的 IAM 角色**。
> - 在创建角色部分，为角色选择**可信实体类型**：
> * **AWS 服务**
> * **使用案例:EC2**

image::/图片/25图片/创建IAM.png[创建IAM]

> * 单击**下一步**
> - 添加权限：现在，您可以看到**策略列表**。按名称**``AWSLambda_FullAccess``**搜索权限并添加。
> - 按名称**``AmazonAPIGatewayAdministrator``**搜索权限并添加。
> - 单击**下一步**
> - 角色名称：输入 **``EC2-CLI-role``**
> - 您**已成功**按名称 EC2-CLI-role 创建了一个 IAM 角色。
> * 注意：您可以使用**其他名称创建角色**，然后将其**附加到 EC2 实例**

---

=== 启动 EC2 实例

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域。
> - 顶部菜单**导航到 EC2**
> - 左侧面板，单击**"实例"**，然后单击**"启动新实例"**。

==== (1)控制台启动实例

image::/图片/07图片/控制台2.png[控制台启动实例]

==== (2)选择系统镜像

image::/图片/07图片/控制台3.png[选择系统镜像]

==== (3)选择实例类型

image::/图片/07图片/配置1.png[选择实例类型]

==== (4)配置实例

> - 实例数：**输入 1**
> - IAM 角色：选择我们上面创建的 IAM 角色**（EC2-CLI-role）**
> - 将所有**其他设置保留为默认值**。单击**"下一步：添加存储"**

==== (5)添加存储

image::/图片/07图片/配置2.png[添加存储]

==== (6)添加标签

image::/图片/07图片/配置3.png[添加标签]

==== (7) 配置安全组

> - 添加 SSH：

----
  . 选择类型： 选择 SSH
  . 协议：TCP
  . 端口范围：22
  . 源：选择"任何位置"
----

> - 点击下一步 `审核和启动`

==== (8) 审核启动

> - **检查**所有选定的设置，**无误点击启动**
> - 选择现有密钥对，确认并单击**启动实例**

image::/图片/07图片/现有密钥.png[现有密钥]

---

=== 创建两个 Lambda 函数

> - 确保您位于**美国东部（弗吉尼亚北部）区域**。
> - 转到菜单，然后单击 **Lambda**。

image::/图片/09图片/导航到Lambda.png[导航到Lambda]

> - 单击**创建函数**该按钮。
> - 选择**``从头开始创建``**
> - 函数名称：输入 **``ProductionLambda``**
> - 运行时：**``Python 3.9``**
> - 角色：在权限部分中，单击**"更改默认执行角色"**，然后单击**"从 AWS 策略模板创建新角色"**。
> - 输入角色名称为**``awslabsAPI``**，选择策略模板为**``基本 Lambda@Edge 权限（适用于 CloudFront 触发器）``**
> * 点击**创建函数**该按钮。
> - **成功创建 Lambda 函数后**，它将类似于下面的**屏幕截图**：

image::/图片/73图片/lambda.png[lambda]

> - 函数代码 ：将现有代码**替换为以下内容**，然后单击**"部署"**。

```py
  import json
  def lambda_handler(event, context):
      # TODO implement
      return {
          'statusCode': 200,
          'body': json.dumps('Message from production Lambda.')
      }
```

==== 重复步骤以创建另一个 Lambda 函数

> - 函数名称：输入 **``TestingLambda``**
> - 运行时：**``Python 3.9``**
> - 角色：在权限部分中，单击**"更改默认执行角色"**，然后单击**"使用现有角色"**。
> - 现有角色 ： 选择**``awslabsAPI``**
> * 点击**创建函数**该按钮。
> - 函数代码 ：将现有代码**替换为以下内容**，然后单击**"部署"**。

```py
  import json
  def lambda_handler(event, context):
      # TODO implement
      return {
          'statusCode': 200,
          'body': json.dumps('Message from testing Lambda.')
      }
```

---

=== 创建 API

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域
> - 顶部菜单**导航到 ``API Gateway``**
> - 向下滚动找到**REST API**并单击**"构建"**按钮。

image::/图片/70图片/1.png[1]

> - 忽略弹出窗口**"创建您的第一个 API"**，然后选择**协议为 REST**。
> - 然后选择"设置"下的**"新建 API "**。输入 API 名称为**``awslab API``**，然后单击**"创建 API"**
> - 单击左侧面板中的**API**，**查看您创建的 awslab API**

image::/图片/70图片/2.png[2]

> - 注意： 如果出现任何弹出窗口，请**忽略它们**。

---

=== 创建资源

> - 创建 API 后，单击**``awslab API``**，然后单击**操作**按钮
> - 在操作中选择**创建资源**选项。
> * 资源名：输入**``awslabsapi``**
> - 输入资源名称后，单击**"创建资源"**按钮

---


=== 创建方法

> - 创建资源后，单击**"操作"**，然后选择**创建方法**。从下拉列表中选择**``GET``**，然后单击**``√``**。
> - 选择集成类型为**Lambda 函数**
> - 输入以下**详细信息**：
> * 使用 Lambda 代理集成：**选中复选框**
> * Lambda 区域：**``us-east-1``**
> * Lambda 函数：**``${stageVariables.functionName}``**
> * 注意：不要输入 Lambda 函数名称，只能输入**``${stageVariables.functionName}``**
> * 将**其他选项保留为默认值**，然后单击**保存**。

image::/图片/73图片/设置方法.png[设置方法]

> - 将**弹出一个窗口**，**询问权限**，**不要单击"确定"**。在弹出消息中将**显示一个 CLI 命令**，我们需要**在 EC2 实例中执行 CLI 命令**，以便为我们**创建的两个 Lambda 函数授予权限**。

image::/图片/73图片/不保存.png[不保存]

> - 您需要**将命令复制到文本编辑器**，我们将在**下一步中编辑此命令并执行此命令**。

---

=== 使用 EC2 实例运行 CLI 命令以向 API 授予 Lambda 权限

> - **通过SSH连接到EC2实例**
> - 在上面**复制的 API Gateway CLI 命令中**，将**``${stageVariables.functionName}``**替换为**``ProductionLambda``**。
> * （您创建的第一个 Lambda 函数。然后在 CLI 命令的末尾添加**``--region us-east-1``**）
> - 并将其**粘贴到 EC2 命令行中**，然后**按 [Enter] 键**，您将能够**看到 JSON 成功输出**。

image::/图片/73图片/授权1.png[授权1]

> - 同样，运行相同的命令，但将函数名称更改为**``TestingLambda**``（您创建的第二个 Lambda 函数）。最后不要忘记添加**``--region us-east-1``**。
> - 并将其**粘贴到 EC2 命令行中**，然后**按 [Enter] 键**，您将能够**看到 JSON 成功输出**。

image::/图片/73图片/授权2.png[授权2]

> - 现在导航到**API网关浏览器选项卡**，然后单击弹出消息中的**"确定"**按钮。

image::/图片/73图片/保存.png[保存]

---

=== 使用两个不同的阶段部署 API 网关

==== 测试 Lambda 阶段

> - 成功**创建资源和方法**后，即可**部署 API**。
> - 单击操作选择**部署API**。
> - 将下拉列表中的**"部署阶段"**选择为**"新阶段"**。
> - 输入阶段名称 ： **``TestingAPI``**
> - 输入描述 ： **``Testing environment for my awslabsAPI``**
> - 单击**部署**。
> - 部署 API 后，导航到**"阶段"**。

==== 生产 Lambda 阶段

> - 单击左侧菜单的**资源**选项。
> - 选择已**创建的 GET 方法**。
> - 单击操作选择**部署API**。
> - 将下拉列表中的**"部署阶段"**选择为**"新阶段"**。
> - 输入阶段名称 ： **``ProductionAPI``**
> - 输入描述 ： **``Production environment for my awslabsAPI``**
> - 单击**部署**。
> - 部署 API 后，导航到**"阶段"**。

---

=== 向两个阶段添加阶段变量

> - 现在，在**"阶段"**中单击**"测试 API"**阶段。
> - 选择右侧页面中的**阶段变量**选项卡，然后单击**添加阶段变量**按钮
> * 名称 ： 输入**``functionName``**
> * 值 ： 输入**``TestingLambda ``**
> * 注意：在值字段中，输入**测试 Lambda 函数的名称**。
> * 现在点击**``√``**按钮。

image::/图片/73图片/阶段测试.png[阶段测试]


> - 现在，在**"阶段"**中单击**"生产 API"**阶段。
> - 选择右侧页面中的**阶段变量**选项卡，然后单击**添加阶段变量**按钮
> * 名称 ： 输入**``functionName``**
> * 值 ： 输入**``ProductionLambda``**
> * 注意：在值字段中，输入**生产 Lambda 函数的名称**。
> * 现在点击**``√``**按钮。

image::/图片/73图片/阶段生产.png[阶段生产]

---

=== 测试 API 网关

> - 单击**"生产 API"**阶段，**打开该阶段**
> - 单击**GET 方法**。
> - 单击**调用 URL链接**以**发出GET请求**。
> - 您将收到**来自 API 的 GET 响应**。下面是一个**示例截图**：

image::/图片/73图片/生产页面.png[生产页面]

> - 同样，单击**"测试 API"**阶段，**打开该阶段**
> - 单击**GET 方法**。
> - 单击**调用 URL链接**以**发出GET请求**。
> - 您将收到**来自 API 的 GET 响应**。下面是一个**示例截图**：

image::/图片/73图片/测试页面.png[测试页面]


---

