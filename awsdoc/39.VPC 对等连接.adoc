## VPC 对等连接

=== 什么是VPC 对等连接？

> - VPC（虚拟私有云）是在**云中创建的资源隔离网络**，基本上是您在云中创建的**隔离数据中心**。
> - 区域间 VPC 对等互连允许在**不同 AWS 区域内的 VPC 中运行的 EC2 实例**、**数据库**、**lambda 函数等资源**使用**私有地址相互通信**，而**无需网关或 VPN 连接**。
> - 使用**区域间对等互连**的流量实际上**保留在 AWS 全球骨干网络上**，并且**永远不会通过公共互联网**，使其**成为了一种更安全的通信方式**。
> - 这是在不同地区之间**共享资源**的一种**简单且具有成本效益**的方式。

=== DNS hostnames

> - AWS 在 VPC 中为您的实例提供与实例的**公有 IPv4 和私有 IPv4 地址**对应的**公有和私有 DNS 主机名**，但**不为 IPv6 地址提供 DNS 主机名**。
> - 公共域名系统格式： **ec2-public-ipv4-address.compute-1.amazonaws.com**
> - 私有 DNS 格式： **ip-private-ipv4-address.ec2.internal**
> - 如果您**启用 DNS 主机名**，AWS 将向在该 VPC 中**创建的 EC2 提供 DNS 主机名**。
> - **域名系统 （DNS） 是一种标准**，通过该标准，互联网上使用的名称将**解析为其相应的 IP 地址**。您需要在 VPC 中**启用 DNS 解析程序**，**以便将 DNS 主机名解析为相应的 IPv4 IP 地址**。

=== 架构图

image::/图片/39图片/架构图.png[架构图]

=== 个案研究

> - 随着**远程工作的普及**，总部位于**印度的公司 awslab 已将其面向客户的应用程序**的软件开发**外包给弗吉尼亚州的一个团队**。
> - **美国的 awslab 开发团队**在其**家乡区域** - 美国东部（弗吉尼亚北部）**创建了一个 VPC**，并为 EC2 实例中**面向 Internet 的 Web 应用程序配置**并**预置了该 VPC**。
> - 他们在**亚太地区（孟买）地区创建了一个VPC** - **公司总部所在地**。**作为监管、正常运行时间和 DevOps 架构要求的一部分**，需要在两个 EC2 之间**进行简单、低成本、安全的通信和资源共享**。
> - 在本实验中，我们将**在美国东部（弗吉尼亚北部）区域** **创建一个 VPC**，为面向 Internet 的**简单网站以及另一个区域** - 亚太地区 （孟买） **配置和预置该 VPC**。
> - 我们将**使用 EC2 实例创建和配置 VPC**，然后**执行区域间 VPC 对等互连**以**连接两个区域**，最后进行测试以确保两个 VPC 中的资源**可以相互通信**。因此，EC2 可以**彼此共享数据**。

=== 案例研究图

image::/图片/39图片/案例研究图.png[案例研究图]

== 实验步骤

=== 在弗吉尼亚北部区域创建VPC

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域
> - 顶部菜单**导航到 VPC**
> - 单击左侧菜单中的**您的 VPC**
> - 在这里，您可以**看到所有 VPC 的列表**，无需对现有和默认 VPC **执行任何操作**，我们将**创建一个新的 VPC**。
> - 单击**``创建 VPC``**按钮。
> * 名称标签： **输入用于向您的 VPC 标识的 VPC 名称**。例如：US_Region_VPC
> * IPv4 CIDR 块： 输入 **10.0.0.0/16**
> * IPv6 CIDR 块： 无需更改此设置，请确保选中**"无 IPv6 CIDR 块"**
> * 租期： 无需更改此设置，请确保**选中"默认"**。
> - 现在单击**``创建 VPC``**按钮
> - **启用 DNS 主机名选项**，请单击**"操作"**按钮，然后选择**"编辑 DNS 主机名"**选项。
> - **选中"DNS 主机名"选项**，然后单击**"保存更改"**选项。

image::/图片/38图片/dns主机名.png[dns主机名]

> - 同样，单击**"操作"**按钮并选择**"编辑 DNS 解析"**选项。
> - 确保**"DNS 解析"下的**复选框**"启用"**，然后单击**保存更改**该按钮。

image::/图片/39图片/dns解析.png[dns解析]

---

=== 创建公有子网


> - 单击左侧菜单中的**子网**，然后单击**创建子网**。
> ** VPC ID ：从您之前创建的列表中选择 **US_Region_VPC**。
> ** 子网名称 ：输入名称 **Public_subnet**
> ** 可用区 ： 选择 **无首选项**
> ** IPv4 网段：输入范围 **10.0.1.0/24**
> ** 单击**"创建子网"**。

---

=== 创建和配置互联网网关

> - 单击左侧菜单中的**互联网网关**，然后单击**创建互联网网关**。
> * 名称标签：**US_IGW**。
> * 单击**创建互联网网关**。
> - 从列表中**选择您创建的互联网网关**
> * 单击**"操作"**。
> * 单击**附加到VPC**
> * 从列表中**选择您创建的US_Region_VPC**，然后单击**连接互联网网关**。

---

=== 创建公有路由表并将其与子网关联

> - 从左侧菜单中**转到路由表**，然后单击**创建路由表**。
> * 名称： 输入**"PublicRT"**。
> * VPC： 从列表中选择**"US_Region_VPC"**。
> * 单击**创建路由表**。
> - 现在，将子网**关联到路由表**。
> - 单击 **PublicRT**，单击**``操作``**。
> * 然后转到**"子网关联"**选项卡
> * 从列表中选择**"Public_subnet"**。
> * 单击**保存关联**。

---

=== 在路由表中添加公共路由

> - PublicRT：添加允许公网流量**流向 VPC 的路由**。
> - 选择**"PublicRT"**。
> - 转到"路由"选项卡，然后单击**``编辑路由``**按钮。
> - 然后单击**``添加路由``**按钮。
> - 指定以下值：
> * 目标：输入 **0.0.0.0/0**
> * 目标：从下拉菜单中选择互联网网关，选择**``US_IGW``**。
> * 点击**保存更改**。


---

=== 启动 EC2 实例

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域。
> - 顶部菜单**导航到 EC2**
> - 左侧面板，单击**"实例"**，然后单击**"启动新实例"**。

==== (1)控制台启动实例

image::/图片/07图片/控制台2.png[控制台启动实例]

==== (2)选择系统镜像

image::/图片/07图片/控制台3.png[选择系统镜像]

==== (3)选择实例类型

image::/图片/07图片/配置1.png[选择实例类型]

==== (4)配置实例

> - 实例数：**输入 1**
> - 网络 ：选择**US_Region_VPC**
> - 子网 ：**"保留为默认值"**
> - 自动分配公共 IP：**启用**
> - 现在向下滚动到**用户数据**并**复制，粘贴脚本**：

```shell
  #!/bin/bash
  sudo su
  yum update -y
  yum install httpd -y
  systemctl start httpd
  systemctl enable httpd
  echo "<html><h1> Welcome to Server 1 </h1><html>" > /var/www/html/index.html
```
> - 将所有**其他设置保留为默认值**。单击**"下一步：添加存储"**

==== (5)添加存储

image::/图片/07图片/配置2.png[添加存储]

==== (6)添加标签

image::/图片/07图片/配置3.png[添加标签]

==== (7) 配置安全组

> - 添加 SSH：

----
  . 选择类型： 选择 SSH
  . 协议：TCP
  . 端口范围：22
  . 源：选择"任何位置"
----

> - 添加 HTTP：

----
  . 选择类型： 选择 HTTP
  . 协议：TCP
  . 端口范围：80
  . 源：选择"任何位置"
----

> - 添加 HTTPS：

----
  . 选择类型： 选择 HTTPS
  . 协议：TCP
  . 端口范围：443
  . 源：选择"任何位置"
----

> - 点击下一步 `审核和启动`

==== (8) 审核启动

> - **检查**所有选定的设置，**无误点击启动**
> - 选择现有密钥对，确认并单击**启动实例**

image::/图片/07图片/现有密钥.png[现有密钥]

=== 测试

> - 记录下 EC2 实例的示例 IPv4 **公有 IP 地址**
> - 将 IPv4 公共 IP **粘贴到浏览器中并点击 [enter]**。您将能够**访问以下网页**。


image::/图片/39图片/index.png[index]

---


=== 在孟买区域创建 VPC

> - 请确保您位于**亚太地区 (孟买)ap-south-1**区域
> - 请确保不要**更改亚太地区（孟买）区域**。在浏览器的**不同选项卡上维护这两个区域**。
> - 顶部菜单**导航到 VPC**
> - 单击左侧菜单中的**您的 VPC**
> - 在这里，您可以**看到所有 VPC 的列表**，无需对现有和默认 VPC **执行任何操作**，我们将**创建一个新的 VPC**。
> - 单击**``创建 VPC``**按钮。
> * 名称标签： **输入用于向您的 VPC 标识的 VPC 名称**。例如：AP_Region_VPC
> * IPv4 CIDR 块： 输入 **30.0.0.0/16**
> * IPv6 CIDR 块： 无需更改此设置，请确保选中**"无 IPv6 CIDR 块"**
> * 租期： 无需更改此设置，请确保**选中"默认"**。
> - 现在单击**``创建 VPC``**按钮
> - **启用 DNS 主机名选项**，请单击**"操作"**按钮，然后选择**"编辑 DNS 主机名"**选项。
> - **选中"DNS 主机名"选项**，然后单击**"保存更改"**选项。

image::/图片/38图片/dns主机名.png[dns主机名]

> - 同样，单击**"操作"**按钮并选择**"编辑 DNS 解析"**选项。
> - 确保**"DNS 解析"下的**复选框**"启用"**，然后单击**保存更改**该按钮。

image::/图片/39图片/dns解析.png[dns解析]

---

=== 创建私有子网


> - 单击左侧菜单中的**子网**，然后单击**创建子网**。
> ** VPC ID ：从您之前创建的列表中选择 **AP_Region_VPC**。
> ** 子网名称 ：输入名称 **Private_subnet1**
> ** 可用区 ： 选择 **ap-south-1a**
> ** IPv4 网段：输入范围 **30.0.1.0/24**
> ** 单击**"创建子网"**。

---

=== 启动 EC2 实例

> - 请确保您位于**亚太地区（孟买）区域**
> - 顶部菜单**导航到 EC2**
> - 左侧面板，单击**"实例"**，然后单击**"启动新实例"**。

==== (1)控制台启动实例

image::/图片/07图片/控制台2.png[控制台启动实例]

==== (2)选择系统镜像

image::/图片/07图片/控制台3.png[选择系统镜像]

==== (3)选择实例类型

image::/图片/07图片/配置1.png[选择实例类型]

==== (4)配置实例


> - 实例数：**输入 1**
> - 网络 ：选择**AP_Region_VPC**
> - 子网 ：**"保留为默认值"**
> - 自动分配公共 IP：**禁用**
> - 将所有**其他设置保留为默认值**。单击**"下一步：添加存储"**

==== (5)添加存储

image::/图片/07图片/配置2.png[添加存储]

==== (6)添加标签

image::/图片/07图片/配置3.png[添加标签]

==== (7) 配置安全组

> - 添加 SSH：

----
  . 选择类型： 选择 SSH
  . 协议：TCP
  . 端口范围：22
  . 源：选择"任何位置"
----

> - 点击下一步 `审核和启动`

==== (8) 审核启动

> - **检查**所有选定的设置，**无误点击启动**
> - 密钥对：**创建新的密钥对**，密钥对类型：**RSA**，密钥对名称：**public_key**，然后单击**下载密钥对**，然后**单击启动新实例**

==== 由于此 EC2 是**在私有子网中创建的**，因此计算机将**只有 IPv4 私有 IP**，因此，请**记录下 EC2 实例的 IPv4 私有 IP 地址**。

---

=== 测试两个区域之间的连接

> - 您已经复制了在**弗吉尼亚北部区域**中**创建的 EC2 实例的 IPv4 公有 IP**。
> - 请**通过 SSH 进入 EC2 实例**。
> - 运行以下命令：
> * 切换到 root 用户 ： **sudo su**
> * 更新 ： **yum update -y**
> - 现在，我们需要**复制在孟买区域**创建的 **EC2 实例的.pem 密钥**。
> * 创建一个文件 ： **vim public_key.pem**
> - 在本地编辑器中**打开 public_key.pem**，并**将其粘贴到终端文件中**。

image::/图片/39图片/密钥.png[密钥]

> - **按esc后跟``:wq``**，然后**保存您的密钥**。
> - 确保已将密钥文件的**权限更改为 400**。您可以使用以下命令**更改权限**：

----
  chmod 400 public_key.pem
----

> - **SSH 进入私有 EC2 实例**
> * 语法：**ssh -i "public_key.pem" ec2-user@<端点实例的私有 IP>**
> * 示例：**ssh -i "public_key.pem" ec2-user@30.0.1.119**
> - **不会有任何响应**，并且一段时间后**连接将超时**。这是因为每个 VPC 都是一个**私有隔离网络**，我们**无法访问两个不同 VPC 中的任何 AWS 资源**。

image::/图片/39图片/ssh超时.png[ssh超时]


> - 为了**进行访问**，您需要对两个VPC**进行对等连接**

---

=== 执行 VPC 对等互连

> - 首先**转到您的孟买区域 VPC**，**复制您创建的AP_Region_VPC的 VPC ID**，并将其**保存在文本编辑器**中。
> - 现在**导航到您的弗吉尼亚北部区域 VPC 页面**
> - 在左侧菜单中，选择**"对等连接"**，然后单击**创建对等连接**按钮。
> * 对等连接**名称**：输入**Peer_Mumbai_Nvirginia**
> * **VPC（请求者）*** ： 选择**US_Region_VPC**
> * 帐户：保留为**默认值**
> * 区域 ：选择**"其他区域"**，然后选择**"亚太地区（孟买）（ap-south-1）"**作为区域。
> * VPC ID（接受者）* ：**粘贴**您在上述步骤中**复制的AP_Region_VPC的 ID**。
> - 单击**创建对等连接**该按钮。


image::/图片/39图片/对等连接设置.png[对等连接设置]


> - 现在，对等连接的状态将**处于"等待接受"**状态。

image::/图片/39图片/对等连接待接受.png[对等连接待接受]

> - 现在**导航到您的孟买区域 VPC 页面**。
> - 在左侧菜单中，选择**"对等连接"**，您**也可以在此处看到对等连接**。
> - **选择对等互连连接**，单击**"操作"**，然后单击**接受请求**。
> - 单击**弹出消息中**的**接受请求**按钮。
> - 完成此**操作**后，"状态"将更改为**"活动"**。如果没有，请**刷新页面**。

image::/图片/39图片/对等连接活动.png[对等连接活动]

> - 现在，您**需要在孟买和弗吉尼亚北部区域 VPC 的路由表**中**添加对等规则**。
> - 这是因为如果**没有此路由**，流量将**无法通过路由表并到达 EC2 实例**。
> - 在**孟买地区**，导航到**左侧面板上的路由表**。
> - 选择将 VPC ID 显示为**AP_Region_VPC**的路由表。
> - 转到下面的**路由选项卡**，然后单击**编辑路由**按钮。
> - 单击**添加路由**按钮，
> * 目标：输入 **10.0.0.0/16**
> * 目标：选择并选择**对等连接 ID**。
> * 单击**保存更改**按钮。

image::/图片/39图片/孟买路由表.png[孟买路由表]


> - 现在**转到弗吉尼亚北部地区**，导航到左侧面板上的**路由表**。
> - 从列表中选择**"PublicRT"**。
> - 转到下面的**路由选项卡**，然后单击**编辑路由**按钮。
> - 单击添加**添加路由**
> * 目标：输入 **30.0.0.0/16**
> * 目标：选择 **对等连接 ID**
> * 单击**保存更改**按钮。

image::/图片/39图片/美国路由表.png[美国路由表]

> - 现在**对等连接已完成**。

---

=== 测试两个区域之间的连接

> - 您已经**复制了在弗吉尼亚北部区域中创建的 EC2 实例的 IPv4 公有 IP**。
> - 请通过 **SSH 进入 EC2 实例**。
> - 运行以下**命令**：
> * 切换到 root 用户 ： **sudo su**
> - SSH **进入私有 EC2 实例**
> * 语法：**ssh -i "public_key.pem" ec2-user@<端点实例的私有 IP>**
> * 示例：**ssh -i "public_key.pem" ec2-user@30.0.1.119**

image::/图片/39图片/ssh成功连接.png[ssh成功连接]

> - 如您所见，IP 地址**已更改为私有 EC2 私有 IP 30.0.1.119**
> - 现在，您已**连接了两个不同区域**中的**两个隔离的 VPC**。

---
