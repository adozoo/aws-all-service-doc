
## 创建一个动态数据分析演示应用

=== 架构图

image::/图片/95图片/架构图.png[架构图]

== 实验步骤

=== 创建S3存储桶

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域。
> - 顶部菜单**导航到 S3**

image::/图片/09图片/导航到S3.png[导航到S3]

> - 在 S3 页面上，单击**``创建存储桶``**并**填写存储桶详细信息**。
> - 桶名称：输入**``aws-demo-logstest``**
> * 注意： S3 存储桶名称是**全局唯一**的，请**选择一个可用的名称**。
> - AWS 区域：选择**美国东部（弗吉尼亚北部）美国东部-1**
> - 将**其他设置保留**为默认值。
> - 单击**创建存储桶按钮**
> - S3 **存储桶已创建**。

image::/图片/94图片/存储桶已创建.png[存储桶已创建]

---

=== 创建 Kinesis Firehose Delivery 流

> - 由于我们将把**输出分析存储到 S3 存储桶中**，因此让我们**配置一个 Firehose 传输流**。
> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域。
> - 顶部菜单**导航到 Kinesis**
> - 在**"入门"**下，选择**"Kinesis Data Firehose"**，然后单击**"创建传输流"**
> - 在**"选择源和目标"**下
> * 源： 选择**``Direct PUT``**
> * 目标： 选择**``Amazon S3``**
> - 在**"传输流名称"**下，提供您选择的名称。
> * 传输流名称 ：输入**``demo-delivery-stream``**
> - 将**"变换和转换记录"**保留为**默认值**。
> - 在**"目标设置"**下
> * 单击**"浏览"**按钮。
> * 从弹出窗口中，选择我们**之前创建的 S3 存储桶**（在我的情况下是 aws-demo-logstest）。
> * 单击**"选择"**按钮。
> - **展开**缓冲区提示、压缩和加密部分。
> * 在缓冲时间间隔下，将其设置为**``60``**秒。
> - 展开**"高级设置"**
> * 在权限下，将其设置为**默认值**，即**创建或更新 IAM 角色**。将创建具有所需权限的**新 IAM 角色**，并将其**分配给此 Kinesis 传输流**。
> - 点击**创建传输流**。

image::/图片/95图片/创建传输流.png[创建传输流]

---

=== 创建 Kinesis 数据分析应用程序

> - 让我们**创建一个数据分析应用程序**。使用此应用程序，我们可以**实时获取并分析流数据**。
> - 在 Kinesis 中单击**"分析应用程序"**选项，然后再次单击**"分析应用程序"**下的**"SQL 应用程序（旧版）"**。
> - 然后点击**创建 SQL 应用程序(旧版)**按钮
> - 在**"应用程序配置"**下
> * 应用程序名称：输入**``test-data-analytics``**
> * 描述 ：输入**任何描述**
> * 标签 - 单击**添加标签**。
> ** 键 ：输入**``Name``**
> ** 值 ：输入**``test-data-analytics``**
> - 单击**创建旧式 SQL 应用程序**按钮。

image::/图片/95图片/数据分析应用程序.png[数据分析应用程序]

> - 已设置**测试应用程序**。**展开**配置应用程序的步骤。 我们将**经历3个步骤**。
> * 步骤 1：**配置源流**
> * 步骤 2：**使用 SQL 代码运行实时分析**
> * 步骤 3：**配置目标**

---

=== 配置输入流

> - 让我们为 Kinesis Analytics 应用程序**配置输入流**。
> - 展开**配置应用程序的步骤**。
> - 单击**步骤 1"配置源流"**。
> - 在**源**下，我们可以**创建数据流**或**数据传送系统**，但我们将**创建一个演示流**。
> - 通过**使用演示流**，我们将**不断收到测试生成的数据**。
> - 点击**使用演示流按钮**。
> - 演示流将**由 AWS 预置**，在该演示流中，它将**创建一个 Kinesis IAM 角色**、**Kinesis 流**以及一个**自动生成和填充 Kinesis 流的方法**。

image::/图片/95图片/演示流.png[演示流]

> - 默认**使用 AWS Lambda **和** IAM 角色保留记录预处理**，以**读取源流**。
> - 在**"架构"**下，单击**"发现架构"**。
> - 架构发现可以**使用源中的记录生成架构**。您可以**观察到 Kinesis 分析流**中**填充了股票行情图数据**。传入流的**示例数据显示在表中**。表列表示**单个记录**中**检测到的每个属性**。
> - 单击**保存更改**。
> - 完成后，可以看到**步骤 1 处于"已配置"状态**。

---

=== 配置实时分析查询

> - 让我们**使用 Kinesis 数据分析 SQL 编辑器**和**内置模板**来**编写查询进行处理流数据**。
> - 在**步骤 2"使用 SQL 代码运行实时分析"**下，单击**"配置 SQL"**。
> - 我们将被**跳转到 Kinesis Analytics SQL 编辑器**。在**这个SQL编辑器**中，我们可以**创建自己的查询**。一旦我们**编写了SQL查询**并**运行了应用程序**，它将**不断应用于我们传入的源数据流**。
> - 出于**演示目的**，我们将使用**模板**中的**预构建 SQL 查询**。
> - 单击**"从模板添加 SQL"**。
> - 下拉菜单中，我们将能够**看到许多模板**。
> - 在这里，**选择模板**，**``滚动时间窗口内的聚合函数``**。选择模板后，您将**看到 SQL 代码**。**浏览 SQL 代码说明**。
> - 向下滚动并选择**"将 SQL 附加到编辑器"**。
> - 让我们通过单击**"保存并运行应用程序"**来**保存并运行实时流分析 SQL 查询**。这将**需要一些时间**来**更新和运行应用程序**。
> - 单击**"输出"**。选择**``DESTINATION_SQL_STREAM``**。您将能够看到**结果每 5-10 秒添加一次**。
> - 在**"输出"**中，选择**``error_stream``**，您可以在其中**查看流中遇到的错误**。由于它是一个**演示流**，我们**找不到任何错误**。
> - 现在，我们**已经使用 SQL 代码配置了实时分析**。向下滚动并单击**"返回"**以**继续执行第三步**。
> - 展开**配置应用程序的步骤**，可以看到**步骤 2 处于"已配置"状态**。

---

=== 设置传输流以将结果存储在 S3 存储桶中

> - 让我们指向要**加载 SQL 代码结果的目标**。
> - 在步骤 3**"配置目标"**下，单击**"添加目标"**。
> - 由于我们将把**输出分析存储**到 **S3 存储桶中**，因此让我们选择**Firehose 传输流作为目标**。
> - 在**"目标"**下，选择**"Kinesis Data Firehose Delivery Stream"**。
> - 点击**浏览**，然后选择我们之前**创建的传输流**。如果**传输流不存在**，您可以单击**刷新**图标。
> - 选择**传输流**后，点击**选择**。
> - 在**"写入输出流的访问权限"**下，将其**保留为默认值**。
> - 在**应用程序内部流名称**下，从下拉列表中选择**``DESTINATION_SQL_STREAM``**，因为我们将在 **S3 存储桶中存储该特定输出**。
> - 将**输出格式保留为 ``JSON``**。
> - 点击**保存更改**。
> - 这将**需要一些时间**来**更新数据分析应用程序**。
> - 现在，我们有一个**从源（数据流）到目标（传输流）的 Kinesis 管道**，AWS 在其中**自动生成股票代码数据**并将其**放入源流**。
> - 我们配置的**聚合函数**使用**滚动时间窗口**对**传入的数据连续运行查询**。分析结果**以 JSON 格式显示**，并将**通过 Firehose 交付系统**传送到**配置的 S3 存储桶中**。

---

=== 测试目标

> - 确保您位于**美国东部（弗吉尼亚北部）us-east-1 区域**。
> - 菜单**导航到 S3**。
> - 单击我们在**Firehose 传输流**中**创建和使用的存储桶**。
> - 我们必须等到**日志显示在 S3 存储桶中**，因为我们在**创建 Firehose 传输系统**时**更改了缓冲区间隔**。同时，通过**定期单击刷新图标**来继续**刷新存储桶**。
> - 注意：如果您**无法看到日志**，请**等待3-5分钟**。
> - 您将看到一个**文件夹层次结构**，其中包含**``年>月>日期>小时``**。
> - 单击文件以**查看创建的结果**。

image::/图片/95图片/查看创建的结果.png[查看创建的结果]

> - 单击**结果**，然后选择**"打开并保存文件"**。
> - 在本地计算机的**任何文本编辑器**中**打开该文件**，**检查分析结果**。

image::/图片/95图片/检查分析结果.png[检查分析结果]

---
