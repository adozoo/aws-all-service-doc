
## CloudWatch 进行资源监控

=== 架构图

image::/图片/63图片/架构图.png[架构图]

== 实验步骤

=== 启动 EC2 实例

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域
> - 通过菜单**导航到 EC2**,单击**启动新实例**。

==== (1)控制台启动实例

image::/图片/07图片/控制台2.png[控制台启动实例]

==== (2)选择系统镜像

image::/图片/07图片/控制台3.png[选择系统镜像]

==== (3)选择实例类型

image::/图片/07图片/配置1.png[选择实例类型]

==== (4)配置实例

> - 实例的数量：**选择 1**
> - 将其余设置**保留为默认值**，然后单击**下一步按钮**。

==== (5)添加存储

image::/图片/07图片/配置2.png[添加存储]

==== (6)添加标签

image::/图片/07图片/配置3.png[添加标签]

==== (7) 配置安全组

> - 添加 SSH：

----
  . 选择类型： 选择 SSH
  . 协议：TCP
  . 端口范围：22
  . 源：选择"任何位置"
----

> - 点击下一步 `审核和启动`

==== (8) 审核启动

> - **检查**所有选定的设置，**无误点击启动**
> - 选择现有密钥对，确认并单击**启动实例**

image::/图片/07图片/现有密钥.png[现有密钥]


==== 注意：复制实例 ID 并将其**保存以供日后使用**，我们需要基于此**在 CloudWatch 中搜索指标**。

---


=== SSH 到 EC2 实例中并安装必要的软件

> - **通过SSH连接到EC2实例**
> - 连接到**服务器后**：
> * 更改为 root 用户：输入 **``sudo su``**
> * 更新：**``yum update -y``**
> * 压力工具：Amazon Linux 2 AMI 默认情况下**没有安装压力工具**，我们**需要安装**
> ** **``sudo amazon-linux-extras install epel -y``**
> ** **``yum install stress -y``**
> - 压力工具将用于**模拟 EC2 指标**。创建 CloudWatch 警报后，我们将**返回到 SSH **使用它**触发 CPU 的利用率**。

---

=== 创建 SNS 主题

> - 确保您位于**弗吉尼亚北部**区域。
> - 通过菜单导航到**"SNS"**。
> - 单击左侧面板中的**主题**，然后单击**创建主题**。
> - 在**"详细信息"**下：
> * 类型：选择**标准**
> * 名称 ： 输入**``MyServerMonitor``**
> * 显示名称 ： 输入**``MyServerMonitor``**
> - 将其他选项**保留为默认值**，然后单击**创建主题**。
> - 现已**创建一个 SNS 主题**。

image::/图片/63图片/sns主题创建完成.png[sns主题创建完成]

---

=== 订阅 SNS 主题

> - 创建 SNS 主题后，单击 SNS 主题**"MyServerMonitor"**。
> - 单击**创建订阅**。
> - 在**"详细信息"**下：
> * 协议 ：选择**电子邮件**
> * 终端节点 ：输入**您的电子邮件地址**
> * 注意： 请确保**提供正确的电子邮件地址**，因为这是将传递您的**通知的地方**。
> - 您的电子邮件地址将**收到订阅确认**

image::/图片/63图片/sns邮件.png[sns邮件]

> - 单击**"确认订阅"**。

image::/图片/63图片/确认sns.png[确认sns]


> - 您的电子邮件地址现**已订阅 SNS 主题**MyServerMonitor。

---


=== 使用CloudWatch在CloudWatch指标中检查 EC2 CPU 使用率指标

> - 通过菜单**导航到 CloudWatch**。
> - 点击左侧面板中指标下的**全部指标**。
> - 您应该能够在所有指标下**看到 EC2**。如果 EC2 不可见，请等待 5-10 分钟
> - CloudWatch 通常在创建 EC2 后大约**需要 5-10 分钟**才能**开始获取指标详细信息**。
> - 单击**EC2**。选择**每个实例的指标**。
> - 在这里，您可以看到**各种指标**。选择** CPU 使用率**指标以**查看图表**。

image::/图片/63图片/每个指标.png[每个指标]

> - 现在，在屏幕顶部，您可以看到**CPU利用率图**（由于我们尚未对CPU施加压力，因此该图为零）。

---

=== 创建CloudWatch告警

> - 单击 CloudWatch 控制面板左侧面板中**警报**下的在**告警中**。
> - 单击右上角的**"创建警报"**。
> - 在**"指定指标和条件"**页中：
> * 点击选择**指标**。它将打开**"选择指标"**页面。
> * 向下滚动并**选择 EC2**。
> * 选择**每个实例的指标**
> * 在搜索栏中**输入您的 EC2 实例 ID** 以**获取 EC2 服务器的指标**
> * 选择**"CPU 使用率"**指标。
> * 单击**"选择指标"**按钮。
> - 现在，使用以下**详细信息配置警报**：
> * 在"指标"下
> ** 周期：选择** 1 分钟**
> * 在条件下
> ** 阈值类型：选择**静态**
> ** 每当 CPU Utilization 为... ：选择**"大于"**
> ** 比 ：输入 **30**
> * 将**其他值保留为默认值**，然后单击**"下一步"**。
> - 在**"配置操作"**页中：
> * 在通知下
> ** 警报状态触发器：选择**警报中**
> ** 选择 SNS 主题 ：选择**现有 SNS 主题**
> ** 发送通知到... ：选择之前创建的**MyServerMonitor SNS 主题**。
> * 将**其他字段保留为默认值**。单击**"下一步"**。
> - 在**"添加名称和描述"**页：
> * 定义唯一名称：输入唯一名称**MyServerCPUUtilizationAlarm**
> * 单击**"下一步"**。
> - 将显示警报的**预览**。向下滚动并**单击创建警报**。
> - 现在**创建了一个新的 CloudWatch 警报**。

image::/图片/63图片/警报创建完成.png[警报创建完成]


> - 每当 CPU 使用率**超过 30 且超过 1 分钟时**，就会**触发 SNS 通知**，您将**收到一封电子邮件**。

---


=== 通过增加 CPU 利用率来测试 CloudWatch 警报

> - **SSH 返回到 EC2 实例**
> - 压力工具**已安装**。让我们运行命令以**手动提高 CPU 使用率**。
> * **``sudo stress --cpu 10 -v --timeout 400s``**
> - 它将运行6分40秒。它将提升 CPU 使用率，在该时间段内，CPU 使用率应保持在非常**接近 100% 的水平**。

image::/图片/63图片/开始测试cpu.png[开始测试cpu]

> - 在本地计算机上**打开另一个终端**，并**重新通过 SSH 连接到 EC2 实例**
> - 运行以下命令以**查看 CPU 利用率**：
> * **``top``**

image::/图片/63图片/cpu使用率.png[cpu使用率]

> - 现在可以**看到 %Cpu 为 100**。通过运行**此压力命令**，我们**手动提高了 EC2 实例的 CPU 利用率**。
> - **400 秒后，%CPU 将减回 0**。

---

=== 检查来自 SNS 主题的电子邮件


> - 导航到您的**邮箱并刷新它**。您应该会**看到**``MyServerCPUUtilizationAlarm``**的新电子邮件通知**。

image::/图片/63图片/邮件通知.png[邮件通知]

> - 我们可以看到，我们收到的邮件**包含有关 CloudWatch 警报的详细信息（警报的名称、触发时间等）**。

---

=== 检查 CloudWatch 警报图


> - 导航回CloudWatch页面，单击**告警**。
> - 单击**"MyServerCPUUtilizationAlarm"**。
> - 在图表上，您可以**看到 CPU 利用率已超过 30% 阈值的位置**。

image::/图片/63图片/图表.png[图表]

> - 我们可以**多次触发``CPUUtilization``以查看图形上的峰值**。
> - 您已**成功触发``CPUUtilization``CloudWatch警报**。

---

=== 创建CloudWatch控制面板

==== 我们可以创建一个简单的 Cloudwatch 控制面板来查看 CPU 利用率和各种**其他指标小部件**。

> - 单击 CloudWatch 页面左侧面板中的**控制面板**。
> - 单击**创建控制面板**。
> * 控制面板名称：输入**``MyEC2ServerDashboard``**
> * 单击**"创建控制面板"**
> * 添加小组件 ：选择**线形图**。
> * 选择**指标**。
> * 在下一页上，在指标选项卡下选择**EC2**。选择**每个实例的指标**。
> * 在搜索栏中，输入**您的 EC2 实例 ID**，选择** CPU 使用率**。
> * 单击**创建小组件**。
> - 根据**触发``stress``命令**的次数，您将在**时间线**中看到**不同的峰值**。

image::/图片/63图片/小组件.png[小组件]

> - 现在单击**"保存控制面板"**按钮。
> - 您还可以通过单击**添加小组件**按钮向**同一控制面板**添加**多个小组件**。

---
