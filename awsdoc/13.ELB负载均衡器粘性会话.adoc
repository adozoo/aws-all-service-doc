

## ELB负载均衡器粘性会话

=== 什么是弹性负载均衡？


> - ELB 是一种**自动分配传入应用程序流量**并**扩展资源**以满足流量需求的服务。
> - ELB 有助于根据传入的应用程序和网络流量**调整容量**。
> - ELB 可以在单个可用区内启用，也可以**跨多个可用区启用**，以保持**一致的应用程序性能**。
> - ELB 提供以下功能：
> * 检测运行状况不佳的 EC2 实例。
> * 仅将 EC2 实例分布在正常运行的通道中。
> * 集中管理 SSL 证书。
> * 可选的公钥身份验证。
> * 同时支持 IPv4 和 IPv6。
> - ELB 接受来自客户端的传入流量，并将请求路由到其注册的目标。
> - 当检测到运行状况不佳的目标或实例时，ELB 会**停止向其路由流量**，并且仅在实例再次**正常运行时恢复**。
> - ELB 监控其注册目标的运行状况，并确保流量仅路由到运行状况良好的实例。
> - ELB 配置为通过指定一个或多个侦听器来接受传入流量。侦听器是**检查连接请求**的进程。
> - 侦听器配置了从客户端到 ELB 的协议和端口号，反之亦然，即从 ELB 返回到客户端。
> - ELB 支持 3 种类型的**负载均衡器**：
> * 应用程序负载均衡器
> * 网络负载均衡器
> * 传统负载均衡器
> - 每个负载均衡器的**配置方式**不同。
> - 对于应用程序和网络负载均衡器，您可以在目标组中注册目标并将流量路由到目标组。
> - 对于传统负载均衡器，您可以向**负载均衡器注册实例**。
> - AWS 建议用户使用应用程序负载均衡器使用多个可用区，因为如果一个**可用区出现故障**，负载均衡器可以**继续将流量路由到下一个可用区**。
> - 我们可以将负载均衡器设为内部负载均衡器，也可以是面向 Internet 的负载均衡器。
> - 面向 Internet 的负载均衡器的节点具有公共 IP 地址，并且 DNS 名称可公开解析为节点的公共 IP 地址。
> - 面向互联网的负载均衡器**可以通过互联网路由**来自**客户端的请求**。
> - **内部负载均衡器**的节点只有专用 IP 地址，并且 DNS 名称可公开解析为节点的专用 IP 地址。
> - **内部负载均衡器**只能**路由来自有权访问负载均衡器 VPC** 的客户端的请求。
> - 面向 Internet 的负载均衡器和内部负载均衡器都使用专用 IP 地址将**请求路由**到**您的目标**。
> - 目标**不需要公共 IP 地址**来接收来自内部或面向 Internet 的负载均衡器的请求。


=== 架构图

image::/图片/13图片/架构图.png[架构图]


== 实验步骤

=== 启动 EC2 实例

==== (1)控制台启动实例

image::/图片/07图片/控制台2.png[控制台启动实例]

==== (2)选择系统镜像

image::/图片/07图片/控制台3.png[选择系统镜像]

==== (3)选择实例类型

image::/图片/07图片/配置1.png[选择实例类型]

==== (4)配置实例


> - 实例的数量：**选择 2**
> - 子网：**选择可用性区域 us-east-1a 的子网**
> - 高级详细信息
> - 用户数据：以**文本形式**

```shell
  #!/bin/bash
  sudo su
  yum update -y
  yum install httpd -y
  echo "Hello World from $(hostname -f)" > /var/www/html/index.html
  systemctl start httpd
  systemctl enable httpd
```


==== (5)添加存储

image::/图片/07图片/配置2.png[添加存储]

==== (6)添加标签

image::/图片/07图片/配置3.png[添加标签]

==== (7) 配置安全组

> - 添加 HTTP：

----
  . 选择类型：选择 HTTP
  . 协议：TCP
  . 端口范围：80
  . 源：选择"任何位置"
----

> - 点击下一步 `审核和启动`
> - 注意：**忽略SSH警告**，然后单击"继续"按钮。


==== (8) 审核启动

> - **检查**所有选定的设置，**无误点击启动**
> - 选择现有密钥对，确认并单击**启动实例**

image::/图片/07图片/现有密钥.png[现有密钥]

---


=== 创建目标组和应用程序负载均衡器

==== 在 EC2 控制台中，**导航到**左侧面板中**负载平衡**下的**目标群组**。
> - 单击``创建目标组``按钮。
> - 步骤 1，指定组**详细信息**
> * 在"基本配置"下，
> ** 选择目标类型：选择**实例**
> ** 目标组**名称**：输入"EC2-TG"
> * 将所有设置保留为**默认值**。
> * 滚动到页面**末尾**，然后单击"下一步"按钮。
>
> - 步骤 2，注册目标
> * **选中**这两个实例，然后单击"在下面以待注册的形式添加"按钮。
> * 实例将出现在"查看目标"部分中，运行状况**状态为"待处理"**。
> * 单击**创建目标组**按钮。
> - **现在已创建目标组**。


==== 在 EC2 控制台中，**导航到**左侧面板中**负载平衡**下的**负载均衡器**。


> - 单击左上角``创建负载均衡器``按钮，为我们的 Web 服务器创建负载均衡器。
> - 选择负载均衡器**类型**：选择"应用程序负载均衡器（Application Load Balancer）"，单击"创建"按钮。
> - 要创建应用程序负载均衡器，请按如下方式**配置负载均衡器**
> * 对于**基本配置**部分
> ** 负载均衡器**名称**：输入"Web-server-LB"
> ** 模式：选择**面向互联网**
> ** IP 地址类型：**选择 IPv4**
> * 对于**网络映射**部分：
> ** VPC：保持**默认**
> ** 映射：选择**所有存在的可用区**
> * 对于"安全组"部分，
> ** 从下拉列表中**选择刚刚启动EC2时候的安全组**，然后**删除默认安全组**。
> * 对于**侦听器和路由**部分，
> * 侦听器已随协议 HTTP 和端口 80 一起存在。
> ** 为"默认操作转发到"选项**选择目标组** EC2-TG。
> - 将其他选项保留为**默认值**，然后单击"创建负载均衡器"按钮。 
> - **您已成功创建应用程序负载均衡器。 单击查看负载均衡器按钮**。
> - 等待 2 到 3 分钟，让负载均衡器变为**活动**状态。

---


=== 通过修改"目标群组"属性启用粘性会话

==== 在 EC2 控制台中，**导航到**左侧面板中**负载平衡**下的**目标群组**。

> - **单击创建的目标组的名称** **EC2-TG**
> - 在"目标"选项卡中，**确保两个实例的状态**均为"健康"。
> - 现在切换到**属性**选项卡，然后单击**编辑按钮**。

image::/图片/13图片/粘性回话属性.png[粘性回话属性]

> - 在"编辑属性"页上，**选中**"粘性"选项。
> - 将粘性类型保留为**负载均衡器生成的 Cookie**，并将**粘性持续时间** **更新为 2 分钟**。

image::/图片/13图片/粘性会话修改.png[粘性会话修改]


> - 完成后，单击**保存更改**按钮。

---

=== 测试粘性会话

> - 接下来，**导航到**左侧面板中**负载平衡**下的**负载均衡器**
> - 并注意到 ELB 的状态为**活动**状态。
> - 复制 ELB 的 **DNS 名称**，然后在浏览器中**输入地址**。
> * 域名解析示例：``Web-server-LB-1543735642.us-east-1.elb.amazonaws.com``
> - 负载均衡器粘性会话**将持续 2 分钟时间**，**即使刷新**，**展示的实例也不会更改**。

image::/图片/13图片/粘性会话1.png[粘性会话1]


> - **等待 2 分钟后**，**会重定向到新实例的展示页面**

image::/图片/13图片/粘性会话2.png[粘性会话2]


---


