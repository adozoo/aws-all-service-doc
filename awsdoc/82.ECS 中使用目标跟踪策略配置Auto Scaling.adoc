
## ECS 中使用目标跟踪策略配置Auto Scaling

=== 架构图

image::/图片/82图片/架构图.png[架构图]

== 实验步骤

=== 为负载均衡器创建安全组

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域
> - 顶部菜单**导航到 EC2**
> - 从左侧菜单中**转到"网络和安全"下的"安全组"**，然后单击**创建安全组**。
> - 安全组名称：输入**ALB-SG**
> - 描述：**Security group for the load balancer**
> - VPC：选择**默认VPC**
> - 在"入站规则"下，单击**"添加规则"**。
> - 添加 **所有TCP**

----
  . 选择类型： 选择 所有 TCP
  . 协议：TCP
  . 端口范围：0 - 65535
  . 源：选择"任何位置"
----

> - 将其他内容**保留为默认值**，然后单击**创建安全组按钮**。

---

=== 为 ECS 集群创建安全组

> - 单击**创建安全组**。
> - 安全组名称：输入**ECS-SG**
> - 描述：**Security group for ECS Cluster**
> - VPC：选择**默认VPC**
> - 在"入站规则"下，单击**"添加规则"**。
> - 添加 **负载均衡器安全组的所有 TCP 流量**

----
  . 选择类型： 选择 所有 TCP
  . 协议：TCP
  . 端口范围：0 - 65535
  . 源：选择"ALB-SG安全组"
----

> - 添加 **SSH**

----
  . 选择类型： 选择 SSH
  . 协议：TCP
  . 端口范围：22
  . 源：选择"任何位置"
----

> - 将其他内容**保留为默认值**，然后单击**创建安全组按钮**。

---

=== 创建目标组和负载均衡器

==== 在 EC2 控制台中，**导航到**左侧面板中**负载平衡**下的**目标群组**。

> - 单击``创建目标组``按钮。
> - 步骤 1，指定组**详细信息**
> * 在"基本配置"下，
> ** 选择目标类型：选择**实例**
> ** 目标组**名称**：输入**"ecs-TG"**
> ** 协议：**选择 HTTP**
> ** 端口：**输入 80**
> ** VPC：**保持默认**
> * 健康检查
> ** 运行状况检查协议：**选择 HTTP**
> ** 运行状况检查路径：输入 **/**
> * 将其他设置保留为**默认值**。
> * 滚动到页面**末尾**，然后单击"下一步"按钮。
>
> - 步骤 2，注册目标
> * **将此页面保留为默认值**
> * 单击**创建目标组**按钮。
> - **现在已创建目标组**。

==== 在 EC2 控制台中，**导航到**左侧面板中**负载平衡**下的**负载均衡器**。

> - 单击左上角``创建负载均衡器``按钮，为我们的 Web 服务器创建负载均衡器。
> - 选择负载均衡器**类型**：选择"应用程序负载均衡器（Application Load Balancer）"，单击**"创建"**按钮。
> - 要创建应用程序负载均衡器，请按如下方式**配置负载均衡器**
> * 对于**基本配置**部分
> ** 负载均衡器**名称**：输入"httpd-LB"
> ** 模式：选择**面向互联网**
> ** IP 地址类型：**选择 IPv4**
> * 对于**网络映射**部分：
> ** VPC：保持**默认**
> ** 映射：选择**所有存在的可用区**
> * 对于"安全组"部分，
> ** 从下拉列表中**选择 ALB-SG 安全组**，然后**删除默认安全组**。
> * 对于**侦听器和路由**部分，
> * 侦听器已随协议 HTTP 和端口 80 一起存在。
> ** 为"默认操作转发到"选项**选择目标组** **ecs-TG**。
> - 将其他选项保留为**默认值**，然后单击**"创建负载均衡器"**按钮。 
> - 您已**成功创建应用程序负载均衡器**。 单击**查看负载均衡器**按钮。
> - 等待 2 到 3 分钟，让负载均衡器变为**活动**状态。

---

=== 启动 ECS 集群

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域
> - 菜单**导航到 ECS**。
> - 在左上角，单击 Amazon ECS 下的**集群选项**。
> - 单击**"创建集群"**按钮。
> - 步骤 1：集群模板
> * 选择集群模板为**``EC2 Linux + 联网``**
> * 单击**下一步**
> - 步骤 2：配置集群
> * 配置集群
> ** 群集名称：输入 **``aws``**
> * 实例配置
> ** 预配置模型：选择**``按需实例``**
> ** EC2 实例类型：选中 **``t2.micro``**
> ** 实例数：输入 **``1``**
> ** EC2 AMI Id：选择 **``Amazon Linux 2 AMI（默认）``**
> ** 根 EBS 卷大小 （GiB）：输入 **``30（默认值）``**
> ** 密钥对：选择**账户存在的密钥对(没有可以创建一个)**

image::/图片/80图片/实例配置.png[实例配置]

> - 联网
> * VPC：选择**``默认VPC``**
> * 子网：选择 **``us-east-1a 和 us-east-1b``**
> * 自动分配公用 IP：选择**``使用子网设置（默认）``**
> * 安全组：选择 **``ECS-SG 安全组``**

image::/图片/80图片/联网.png[联网]

> - 将其他选项**保留为默认值**。
> - 单击**创建**按钮，**创建 aws ECS 集群**
> - ECS 集群将**在 2 分钟内创建**。
> - 点击**查看集群**按钮
> - 预置 ECS 实例**需要几分钟时间**。
> - ECS 集群将**创建 1 个容器实例**

image::/图片/80图片/预置实例.png[预置实例]

---

=== 创建任务定义

> - 在左侧边栏上，单击 Amazon ECS 部分下的**任务定义**选项。
> - 点击**创建新任务定义**按钮
> - 步骤 1：选择启动类型兼容性
> * 选择启动类型兼容性为**``EC2``**
> * 单击**"下一步"**按钮
> - 步骤 2：配置任务和容器定义
> * 任务定义名称：输入**``ecs-demo``**
> * 需要兼容性： **``EC2``**
> * 任务角色：**``默认``**
> * 网络模式：选择**``桥接``**

image::/图片/80图片/任务定义.png[任务定义]

> - 任务执行 IAM 角色：**``默认``**
> - 在"任务大小"部分中，
> * 任务内存 （MiB）：输入 **``250``**
> * 任务 CPU (单元) ：输入 **``250``**
> - 在"容器定义"部分中，单击**添加容器**按钮。
> * 容器名称：输入 **``httpd``**
> * 映像：输入**``httpd:2.4``**
> * 内存限制 （MiB）：输入 **``250``**
> * 在**"端口映射"**字段中，填写以下信息：
> ** 主机端口：输入 **``0``**
> ** 容器端口：输入 **``80``**
> ** 协议：选择 **``tcp``**
> * 点击**添加**按钮。

image::/图片/81图片/添加容器.png[添加容器]

> - 有关容器的**详细信息**现**已添加到容器定义**中。
> - 将**其他选项保留为默认值**，然后单击**"创建"**按钮。
> - 任务定义**ecs-demo**现**已创建**。

---


=== 在ECS中创建服务并启动HTTPD容器

> - 在左侧边栏上，单击**Amazon ECS**部分下的**集群**选项。
> - aws ECS 集群将在此处列出，单击该**aws**。
> - 要创建服务，请单击**"创建"**按钮。
> - 步骤 1：配置服务
> * 启动类型：选择**``EC2``**
> * 任务定义：选择**``ecs-demo``**
> * 修订版：选择 **``1（最新）``**
> * 集群：选择**``aws``**
> * 服务名称：输入 **``httpd-ecs``**
> * 服务类型：选择**``REPLICA复制副本``**
> * 任务数：输入 **``1``**
> * 最小正常运行百分比：输入 **``100``**
> * 最大百分比：输入 **``200``**
> * 在"部署"部分中：
> ** 部署类型：选择**``滚动更新``**
> * 在"任务放置"部分中：
> ** 放置模板选择 **``AZ 均衡分散``**
> * 将其他选项**保留为默认值**，然后单击**下一步**按钮。
> - 步骤 2：网络配置
> * 在"负载平衡"部分中：
> * 负载均衡器类型： 选择**``Application Load Balancer``**
> * IAM 角色：选择**``创建新角色``**
> * 负载均衡器名称：选择 **``httpd-LB``**
> * 注意：确保选择**"创建新角色"**。
> * 用于负载均衡的容器：单击**``添加到负载均衡器``**按钮
> * 生产侦听器端口：选择 **``80:HTTP``**
> * 目标组名称：选择 **``ecs-TG``**

image::/图片/81图片/负载均衡容器.png[负载均衡容器]

> - 然后单击**下一步**按钮。
> - 步骤 3：设置 Auto Scaling (可选)
> * 服务 Auto Scaling：**配置服务 Auto Scaling 以调整您的服务的预期计数**
> * 最小任务数：**``1``**
> * 所需任务数：**``1``**
> * 最大任务数：**``3``**
> * 与服务 Auto Scaling 配合使用的 IAM 角色：**``创建新角色``**

image::/图片/82图片/拓展.png[拓展]

> - 在自动任务扩展策略中，输入**以下信息**
> * 扩展策略类型：**``目标跟踪``**
> * 策略名称：**``awsPolicy``**
> * ECS 服务指标：**``ALBRequestCountPerTarget``**
> * 目标值：**``1000``**
> * 扩展冷却时间： **``60 ``**
> * 缩减冷却时间： **``60 ``**
> * 禁用缩减：**``取消选中``**

image::/图片/82图片/策略.png[策略]

> - 然后单击**下一步**按钮。
> - 步骤 4：审核
> * 查看所有内容，然后单击**创建服务**按钮。
> - 现**已创建服务**，单击右下角的**"查看服务"**按钮。
> - 任务现在**正在运行**，即HTTPD容器现在**已经启动**，让我们**测试一下**。

image::/图片/82图片/任务.png[任务]

> - 通过切换到**"Auto Scaling"**选项卡来**查看详情**。

image::/图片/82图片/事件.png[事件]

---

=== 在 ECS 集群中测试 HTTPD 容器

> - 在左侧边栏上，单击**Amazon ECS**部分下的**集群**选项。
> - aws ECS 集群将在此处列出，单击该**aws**。
> - 要**查看 ECS 实例**，请**切换到 ECS 实例选项卡**。

image::/图片/82图片/ECS实例.png[ECS实例]

> - **单击 ECS 实例**，您将被重定向到**正在运行的 EC2 实例**。
> - 单击**EC2实例 ID**。
> - **复制实例的公有 IP**。将其保存到记事本，我们需要它进入到 EC2 实例中。

---

=== SSH 进入到 EC2 实例触发Auto Scaling

> - **SSH 进入到 EC2 实例**。
> - 使用以下命令**获取根权限**：
> * **``sudo su``**
> - 现在使用以下命令**运行更新**：
> * **``yum -y update``**
> - 通过运行以下命令**检查 Docker 版本**：
> * **``docker version``**
> - 检查 ECS 集群中运行的**所有 Docker 进程**：
> * **``docker ps``**
> - 安装 httpd-tools for ApacheBench （ab） 实用程序，在**短时间内向您的负载均衡器发出数千个 HTTP 请求**。
> * **``yum install -y httpd-tools``**
> - **运行以下命令**，**替换负载均衡器的 DNS 名称**。
> * **``ab -n 1000000 -c 1000 http://httpd-lb-1714146195.us-east-1.elb.amazonaws.com/``**
> * 在**替换负载均衡器名称**时，请确保在最后添加**``/``**
> - 等待您的 ab HTTP 请求**在 CloudWatch 控制台中触发横向扩展警报**。
> - 您应该会看到**您的 Amazon ECS 服务横向扩展**，并将**两个任务添加**到**服务的所需计数中**。
> - 在 ab HTTP 请求**完成后不久（1 到 2 分钟之间）**，将**触发缩减警报**，并且缩减策略会将服务的**所需计数减小到 1**。
> - 缩放活动**可能需要超过 20 分钟的时间**。

image::/图片/82图片/压力测试.png[压力测试]

---

=== 检查服务事件中的Auto Scaling活动

> - 在左侧边栏上，单击**Amazon ECS**部分下的**集群**选项。
> - aws ECS 集群将在此处列出，单击该**aws**。
> - 转到**服务页面**

image::/图片/82图片/验证.png[验证]

> - 检查事件，**自动缩放已触发警报**，并且**预期数量现在为 3**。

image::/图片/82图片/验证事件.png[验证事件]

---
