

## AWS 网络负载均衡器简介（NLB）


=== 什么是弹性负载均衡器？

> - 弹性负载均衡是 AWS 提供的服务之一，用于在多个目标（如 EC2 实例、容器和 IP 地址）之间**分配传入的应用程序或网络流量**。
> - ELB 根据一段时间内的流量**扩展负载均衡器**。
> - ELB 使您的应用程序具有**高可用性和容错能力**。
> - 它使用运行状况检查来检测哪些实例运行状况良好，并**仅跨这些实例定向流量**。
> - 您可以根据需要在负载均衡器中**添加和删除资源**，而**不会中断**对应用程序的**请求流**。


=== 弹性负载均衡器的类型

> - 弹性负载均衡支持**三种类型的负载均衡器**：
> * 应用程序负载均衡器
> * 网络负载均衡器
> * 传统负载均衡器

---

> - 应用程序负载均衡器**最适合 HTTP 和 HTTPS 流量**的负载均衡
> - 网络负载均衡器用于**使用 TCP/UDP 协议分配流量**或负载
> - 传统负载均衡器提供**跨多个 Amazon EC2 实例的基本负载均衡**。



=== 网络负载均衡器

> - 网络负载均衡器 （NLB） 根据网络变量（如 IP 地址和目标端口）**分配流量**。
> - NLB 能够有比应用程序负载均衡器高得多的**速率处理流量**和**缩放**。
> - **不能使用应用程序负载均衡器**的某些功能，例如 SSL 卸载、基于主机的路由、跨区域负载均衡等。
> - 可以在链接 https://aws.amazon.com/cn/elasticloadbalancing/features/[负载平衡器差异] 中找到**负载均衡器之间的完整比较**。
> - 它的设计不考虑**应用程序层的任何内容**，例如内容类型、Cookie 数据、自定义标头、用户位置或应用程序行为。
> - 对于 TCP 流量，NLB 根据协议类型、源 IP 地址、源端口、目标 IP 地址和目标端口，使用**哈希算法**选择目标。
> - 与 NLB 相比，来自客户端的 TCP 连接具有**不同的源端口**和**序列号**，并且可以路由到不同的目标。
> - 每个单独的 TCP 连接都路由到**一个连接的单个目标**。
> - UDP 流具有相同的源和目标，因此在其整个生存期内，它**始终路由到单个目标**。
> - 不同的 UDP 流具有不同的源 IP 地址和端口，因此可以将它们**路由到不同的目标**。
> - NLB 的优点是，它可以**管理到同一实例的不同端口的流量**。
> - 我们可以使用网络负载均衡器将**基于端口**的请求**拆分到不同的服务**，因此 NLB 允许您在**同一服务器上运行的多个应用程序**之间**路由流量**。


=== 架构图


image::/图片/14图片/架构图.png[架构图]


== 实验步骤

=== 启动 EC2 实例

==== (1)控制台启动实例

image::/图片/07图片/控制台2.png[控制台启动实例]

==== (2)选择系统镜像

image::/图片/07图片/控制台3.png[选择系统镜像]

==== (3)选择实例类型

image::/图片/07图片/配置1.png[选择实例类型]

==== (4)配置实例


> - 实例的数量：**选择 1**
> - 高级详细信息
> - 用户数据：以**文本形式**

```shell
  #!/bin/bash
  sudo su
  yum update -y
  yum install httpd -y
  systemctl start httpd
  systemctl enable httpd
  echo “<html> <h1> Response coming from server </h1> </ html>” /var/www/html/index.html
```

==== (5)添加存储

image::/图片/07图片/配置2.png[添加存储]

==== (6)添加标签

image::/图片/07图片/配置3.png[添加标签]

==== (7) 配置安全组

> - 添加 SSH：

----
  . 选择类型： 选择 SSH
  . 协议：TCP
  . 端口范围：22
  . 源：选择"任何位置"
----

> - 添加 HTTP：

----
  . 选择类型：选择 HTTP
  . 协议：TCP
  . 端口范围：80
  . 源：选择"任何位置"
----

> - 对于 NGINX：

----
  . 选择类型：自定义 TCP 规则
  . 协议：TCP
  . 端口范围：8080
  . 源：选择"任何位置"
----

> - 点击下一步 `审核和启动`


==== (8) 审核启动

> - **检查**所有选定的设置，**无误点击启动**
> - 选择现有密钥对，确认并单击**启动实例**

image::/图片/07图片/现有密钥.png[现有密钥]

---

=== 创建目标组和网络负载均衡器

==== 在 EC2 控制台中，**导航到**左侧面板中**负载平衡**下的**目标群组**。
> - 单击``创建目标组``按钮。
> - 步骤 1，指定组**详细信息**
> * 在"基本配置"下，
> ** 选择目标类型：选择**实例**
> ** 目标组**名称**：输入"Apache-TG"
> ** 协议**选择**：**TCP**
> ** 端口**选择**：**80**
> * 将其他设置保留为**默认值**。
> * 滚动到页面**末尾**，然后单击"下一步"按钮。
>
> - 步骤 2，注册目标
> * **选中**这个EC2实例，然后单击"在下面以待注册的形式添加"按钮。
> * 实例将出现在"查看目标"部分中，运行状况**状态为"待处理"**。
> * 单击**创建目标组**按钮。
> - **现在已创建目标组**。

==== 在 EC2 控制台中，**导航到**左侧面板中**负载平衡**下的**负载均衡器**。

> - 单击左上角``创建负载均衡器``按钮，为我们的 Web 服务器创建负载均衡器。
> - 选择负载均衡器**类型**：选择"网络负载均衡器（Network Load Balancer）"，单击"创建"按钮。
> - 要创建应用程序负载均衡器，请按如下方式**配置负载均衡器**
> * 对于**基本配置**部分
> ** 负载均衡器**名称**：输入"MyNetwork-LB"
> ** 模式：选择**面向互联网**
> ** IP 地址类型：**选择 IPv4**
> * 对于**网络映射**部分：
> ** VPC：保持**默认**
> ** 映射：选择**所有存在的可用区**
> * 对于"安全组"部分，
> ** 从下拉列表中**选择刚刚启动EC2时候的安全组**，然后**删除默认安全组**。
> * 对于**侦听器和路由**部分，
> * 侦听器已随协议 TCP 和端口 80 一起存在。
> ** 为"默认操作转发到"选项**选择目标组** Apache-TG。
> - 将其他选项保留为**默认值**，然后单击"创建负载均衡器"按钮。 
> - **您已成功创建网络负载均衡器。 单击查看负载均衡器按钮**。
> - 等待 2 到 3 分钟，让负载均衡器变为**活动**状态。

---


=== 为Nginx创建目标组

==== 在 EC2 控制台中，**导航到**左侧面板中**负载平衡**下的**目标群组**。
> - 单击``创建目标组``按钮。
> - 步骤 1，指定组**详细信息**
> * 在"基本配置"下，
> ** 选择目标类型：选择**实例**
> ** 目标组**名称**：输入"Nginx-TG"
> ** 协议**选择**：**TCP**
> ** 端口**选择**：**8080**
> * 将其他设置保留为**默认值**。
> * 滚动到页面**末尾**，然后单击"下一步"按钮。
>
> - 步骤 2，注册目标
> * **选中**这个EC2实例，然后单击"在下面以待注册的形式添加"按钮。
> * 实例将出现在"查看目标"部分中，运行状况**状态为"待处理"**。
> * 单击**创建目标组**按钮。
> - **现在已创建目标组**。

---

=== 在端口 8080 上为 Nginx 创建新侦听器

> - *现在我们需要为Nginx添加一个新的侦听器，以侦听端口8080上的流量*。

==== 在 EC2 控制台中，**导航到**左侧面板中**负载平衡**下的**负载均衡器**。

> - 选中 **MyNetwork-LB**。 点击**添加侦听器**，如下图所示：

image::/图片/14图片/添加侦听器.png[添加侦听器]

==== 现在添加新的侦听器，如下所示：

> - **协议：选择 TCP**
> - **端口： 8080**
> ** 为"默认操作转发到"选项**选择目标组** Nginx-TG。

image::/图片/14图片/添加侦听器2.png[添加侦听器2]

> - 点击**添加**按钮

---

===  安装和配置Nginx

==== (1)SSH 进入 EC2 实例

==== (2)使用以下命令切换到 root 用户：

----
  sudo su
----

==== (3)您将看到 Apache 已安装并侦听端口 80。为此，请运行以下命令：

----
  查看httpd版本
  httpd -v
----

----
  要查找正在运行的 HTTPD，请执行以下操作
  lsof -i tcp：80
----

image::/图片/14图片/httpd查看.png[httpd查看]


==== (4)现在使用以下命令安装Nginx

----
  sudo amazon-linux-extras install nginx1 -y
----

==== (5)现在我们需要将Nginx服务的端口号更改为8080，因为HTTPD服务已经在此端口上运行。为此，请键入以下命令：

----
  cd /etc/nginx
  vi  nginx.conf
----

> - 向下滚动并将"侦听"行编辑为端口号 8080。要在 vi 中编辑，请按 ``i`` 进行插入。
> - 编辑后，按 esc 并给出命令``:wq``，这将**保存文件并从 vi 退出**。

image::/图片/14图片/修改nginx.png[修改nginx]

==== (6)使用以下命令启动 Nginx 服务

----
  service nginx start
----

==== (7)您可以使用以下命令检查Nginx服务的状态

----
  lsof -i tcp:8080
----

image::/图片/14图片/检查8080.png[检查8080]

---

=== 测试网络负载均衡器

> - **等待 3 到 4 分钟**，直到目标达到**正常状态**
> - 然后导航到负载均衡器控制台并复制 DNS 名称。在浏览器中**输入地址**
> * 域名解析示例：``MyNetwork-LB-f7c5592b81b18ca5.elb.us-east-1.amazonaws.com``

image::/图片/14图片/阿帕奇.png[阿帕奇]


> - 您将看到**默认的 Apache 页面**。默认情况下，网络负载均衡器会将**流量路由到端口 80**
> - 现在，通过在负载均衡器的末尾附加**端口号8080（如下所示）重复**上述步骤，您将获得**Nginx默认页面**
> * 域名解析示例：``MyNetwork-LB-f7c5592b81b18ca5.elb.us-east-1.amazonaws.com:8080``

image::/图片/14图片/nginx.png[nginx]


> - 从上述步骤中，我们已经成功**创建了网络负载均衡器**，并将流量**路由到两个不同的服务**（Apache和Nginx），在两个**不同的端口（80和8080）上侦听**。
> - 我们还成功创建并测试了**网络负载均衡器**。

---
