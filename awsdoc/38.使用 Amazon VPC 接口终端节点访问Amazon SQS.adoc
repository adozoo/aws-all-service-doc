
## 使用 Amazon VPC 接口终端节点访问Amazon SQS


=== 适用于 SQS 的 VPC 终端节点

> - VPC 终端节点允许我们**安全地连接您的 VPC 和由 AWS PrivateLink 提供支持的受支持的 AWS 服务**。
> - AWS PrivateLink 是一项允许您**使用私有 IP 地址访问 AWS 服务的服务**。
> - VPC 终端节点**不需要 NAT 网关、NAT 实例、互联网网关或任何 VPN 服务**即**可访问 AWS 服务**。
> - 有**两种类型**的 VPC 终端节点：**网关和接口**。
> - 适用于 SQS 的 VPC 终端节点位于**接口终端节点**下。
> - 当您**为 SQS 创建 VPC 终端节点时**，它会**要求输入 VPC、子网、安全组以及启用 DNS 终端节点**的选项。

=== 架构图

image::/图片/38图片/架构图.png[架构图]

== 实验步骤

=== 创建 SQS 队列并复制队列 URL

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域
> - 顶部菜单**导航到 SQS**
> - 单击**创建队列**该按钮。
> - 现在，在**"详细信息"**下，选择**"类型为标准队列"**。

image::/图片/38图片/sqs队列.png[sqs队列]

> - 名称：输入**MyawsQueue**
> - 将其他设置保留为**默认值**，然后单击**创建队列**该按钮。
> - 将**创建一个SQS队列**
> - 单击复制按钮以**复制队列 URL** 并将其**保存到记事本**。

image::/图片/38图片/队列url.png[队列url]

> - **不要关闭此选项卡**，请在**新选项卡中执行后续任务**。

---

=== 创建 VPC 并启用 DNS 主机名选项

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域
> - 顶部菜单**导航到 VPC**
> - 单击左侧菜单中的**您的 VPC**
> - 在这里，您可以**看到所有 VPC 的列表**，无需对现有和默认 VPC **执行任何操作**，我们将**创建一个新的 VPC**。
> - 单击**``创建 VPC``**按钮。
> * 名称标签： **输入用于向您的 VPC 标识的 VPC 名称**。例如：MyVPC
> * IPv4 CIDR 块： 输入 **192.168.0.0/26**
> * IPv6 CIDR 块： 无需更改此设置，请确保选中**"无 IPv6 CIDR 块"**
> * 租期： 无需更改此设置，请确保**选中"默认"**。
> - 现在单击**``创建 VPC``**按钮
> - **启用 DNS 主机名选项**，请单击**"操作"**按钮，然后选择**"编辑 DNS 主机名"**选项。
> - **选中"DNS 主机名"选项**，然后单击**"保存更改"**选项。

image::/图片/38图片/dns主机名.png[dns主机名]


---

=== 创建和配置互联网网关

> - 单击左侧菜单中的**互联网网关**，然后单击**创建互联网网关**。
> * 名称标签：**MyInternetGateway**。
> * 单击**创建互联网网关**。
> - 从列表中**选择您创建的互联网网关**
> * 单击**"操作"**。
> * 单击**附加到VPC**
> * 从列表中**选择您创建的MyVPC**，然后单击**连接互联网网关**。

image::/图片/30图片/igw.png[igw]

---

=== 创建子网


> - 单击左侧菜单中的**子网**，然后单击**创建子网**。
> ** VPC ID ：从您之前创建的列表中选择 **MyVPC**。
> ** 子网名称 ：输入名称 **Subnet**
> ** 可用区 ： 选择 **us-east-1a**
> ** IPv4 网段：输入范围 **192.168.0.0/27**
> ** 单击**"创建子网"**。
> - 让我们**启用自动将公有 IP 分配给在此子网中创建的实例**，
> ** 选择 **Subnet** ，单击**"操作"**。
> ** 单击**"编辑子网设置"**。
> ** 启用自动分配公有 IPv4 地址：**选中**
> ** 点击**保存**。
> - 现在，**默认情况**下，在 Subnet 中**启动的实例将分配公有 IP**。

---

=== 在主路由表中添加一个条目

> - 主路由表：添加允许公网流量**流向 VPC 的路由**。
> - 选择**"MyVPC主路由表"**。
> - 转到"路由"选项卡，然后单击**``编辑路由``**按钮。
> - 然后单击**``添加路由``**按钮。
> - 指定以下值：
> * 目标：输入 **0.0.0.0/0**
> * 目标：从下拉菜单中选择互联网网关，选择**``MyInternetGateway``**。
> * 点击**保存更改**。

---


=== 创建安全组

> - 从左侧菜单中**转到"安全"下的"安全组"**，然后单击**创建安全组**。
> - 安全组名称：输入**EI-SG**
> - 描述：**Security group for the EC2 instance and VPC Endpoint**
> - VPC：选择**MyVPC**
> - 在"入站规则"下，单击**"添加规则"**。
> - 添加 SSH

----
  . 选择类型： 选择 SSH
  . 协议：TCP
  . 端口范围：22
  . 源：选择"任何位置"
----

> - 添加 所有流量

----
  . 选择类型： 选择 所有流量
  . 协议：全部
  . 端口范围：全部
  . 源：输入"192.168.0.0/26"
----

image::/图片/38图片/安全组入站.png[安全组入站]


> - 现在，**修改出站规则**
> - 第一条规则的**目标位置**，**删除0.0.0.0/0**，并**添加VPC的CIDR块**，即**192.168.0.0/26**

image::/图片/38图片/安全组出站.png[安全组出站]


> - 将其他内容**保留为默认值**，然后单击**创建安全组按钮**。
> - 现**已创建安全组**。

---

=== 启动 EC2 实例

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域。
> - 顶部菜单**导航到 EC2**
> - 左侧面板，单击**"实例"**，然后单击**"启动新实例"**。

==== (1)控制台启动实例

image::/图片/07图片/控制台2.png[控制台启动实例]

==== (2)选择系统镜像

image::/图片/07图片/控制台3.png[选择系统镜像]

==== (3)选择实例类型

image::/图片/07图片/配置1.png[选择实例类型]

==== (4)配置实例

> - 实例数：**输入 1**
> - 网络 ： 选择**MyVPC**
> - 子网 ：选择**"Subnet"**
> - 自动分配公共 IP：**使用子网设置（启用）**
> - IAM 角色: **创建新的 IAM 角色**

==== 创建 IAM 角色

> - 单击**``创建角色``**该按钮以**创建新的 IAM 角色**。
> - 在创建角色部分，为角色选择**可信实体类型**：
> * **AWS 服务**
> * **使用案例:EC2**

image::/图片/25图片/创建IAM.png[创建IAM]

> * 单击**下一步**
> - 添加权限：现在，您可以看到**策略列表**。
> - 添加权限：按名称**AmazonSQSFullAccess**搜索权限后添加
> - 单击**下一步**
> - 角色名称：输入 **SQSRole**
> - 您**已成功**按名称 SQSRole 创建了一个 IAM 角色。
> - 现在**回到EC2创建界面**
> - IAM 角色:**选择创建的 `SQSRole` IAM 角色**。
> - 将所有**其他设置保留为默认值**。单击**"下一步：添加存储"**

==== (5)添加存储

image::/图片/07图片/配置2.png[添加存储]

==== (6)添加标签

image::/图片/07图片/配置3.png[添加标签]

==== (7) 配置安全组

> - 分配安全组：选择**"选择现有安全组"**
> - **选择**刚在上述步骤中创建的**EI-SG**安全组。
> - 点击下一步 **`审核和启动`**

==== (8) 审核启动

> - **检查**所有选定的设置，**无误点击启动**
> - 选择现有密钥对，确认并单击**启动实例**

image::/图片/07图片/现有密钥.png[现有密钥]


---

=== SSH 进入终端节点实例

> - **使用 PEM 密钥** SSH **进入实例：test1.pem**
> - 由于 EC2 实例**附加了 IAM 角色**，因此**我们可以向 SQS 队列发送消息**。
> - 要将消息发送到 SQS 队列，请**复制并粘贴以下命令**。**替换队列 URL 值(queue-url值)**

----
  aws sqs send-message --region us-east-1 --endpoint-url https://sqs.us-east-1.amazonaws.com/ --queue-url https://sqs.us-east-1.amazonaws.com/144976996549/MyawsQueue --message-body "Hello from Amazon SQS."
----

> - 尽管分配的 IAM 角色**具有对 SQS 的完全访问权限**，但向队列**发送消息失败**，表示 SQS 终端节点上的**连接超时**。

image::/图片/38图片/sqs超时.png[sqs超时]


> - 因为，此实例的**安全组只允许执行 SSH**，**运行任何其他命令，将失败**。
> - 让我们添加使用**适用于 SQS 的 VPC 终端节点**访问 SQS 的权限。

---

=== 为 SQS 创建 VPC 终端节点

> - 通过单击顶部的菜单**导航到 VPC**，然后在单击**终端节点**。
> - 单击**创建终端节点**该按钮。
> - 确保**服务类别**为 AWS 服务。在服务名称搜索栏中，**键入 sqs**，然后**按 Enter 键**

image::/图片/38图片/终端节点.png[终端节点]

> - 将列出**"类型"**、**"服务名称为 **com.amazonaws.us-east-1.sqs** 的接口(Interface)"的终端节点**，将其**选中**。
> - 更改VPC，选择**MyVPC**。
> - 由于您**只创建了一个子网**，因此**请保留此选项作为默认值**。

image::/图片/38图片/终端节点VPC.png[终端节点VPC]


> - **删除默认安全组**，然后**选择存在的 EI-SG 安全组**


image::/图片/38图片/终端节点安全组.png[终端节点安全组]


> - 最后，单击**创建终端节点**该按钮。
> - **将创建一个终端节点**。
> - **几分钟后**，您将看到**终端节点**。

image::/图片/38图片/可用.png[可用]

---

=== 将消息发送到 SQS 队列

> - 将消息**发送到 SQS 队列**，请**复制并粘贴以下命令**。**替换队列 URL 值(queue-url值)**

----
  aws sqs send-message --region us-east-1 --endpoint-url https://sqs.us-east-1.amazonaws.com/ --queue-url https://sqs.us-east-1.amazonaws.com/144976996549/MyawsQueue --message-body "Hello from Amazon SQS."
----

image::/图片/38图片/sqs发送成功.png[sqs发送成功]


> - **消息将发送到队列**。
> - 要**检查该消息**，请按照以下步骤操作：
> - **切换到"SQS 控制台"页面（如果未关闭其他选项卡）**。
> - 否则，导航到顶部的"服务"菜单，搜索"SQS"并将其选中。您将被重定向到 SQS 控制台页面。
> - **单击存在的队列，即MyawsQueue**。
> - 从**菜单栏**中，单击**发送和接收消息**。

image::/图片/38图片/接收消息.png[接收消息]


> - 单击**"轮询消息"**选项以**查看消息**。

image::/图片/38图片/轮训消息.png[轮训消息]

---
