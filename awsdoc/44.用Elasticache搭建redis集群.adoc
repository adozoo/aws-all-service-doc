
## 用Elasticache搭建redis集群

=== 什么是ElastiCache中的Redis集群？

> - ElastiCache 是一种**内存数据存储**，由 **AWS 完全托管**。
> - 目前，它与**Redis和Memcached兼容**，此实验是关于**使用Redis**。

=== 架构图

image::/图片/44图片/架构图.png[架构图]

== 实验步骤

=== 创建安全组

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域。
> - 顶部菜单**导航到 EC2**
> - 从左侧菜单中**转到"安全"下的"安全组"**，然后单击**创建安全组**。
> - 安全组名称：输入**ElastiCache-SG**
> - 描述：**Security group for ElastiCache**
> - VPC：**保持默认**
> - 在"入站规则"下，单击**"添加规则"**。
> - 添加 SSH

----
  . 选择类型： 选择 SSH
  . 协议：TCP
  . 端口范围：22
  . 源：选择"任何位置"
----

> - 添加 HTTP

----
  . 选择类型： 选择 HTTP
  . 协议：TCP
  . 端口范围：80
  . 源：选择"任何位置"
----


> - 添加 Redis

----
  . 选择类型： 选择 自定义 TCP
  . 协议：TCP
  . 端口范围：6379
  . 源：选择"任何位置"
----


> - 将其他内容**保留为默认值**，然后单击**创建安全组按钮**。
> - 现**已创建安全组**。我们将其**用于 EC2 和 Redis 集群**。

---


=== 创建 Redis 集群

> - 顶部菜单**导航到 ElastiCache**
> - 单击**"立即开始"**按钮**继续**。
> - 我们现在将**创建一个 Redis 集群**
> * 集群引擎：选择 **Redis**
> * 已启用集群模式：**选中**
> * 选择位置：**Amazon 云**

image::/图片/44图片/创建1.png[创建1]


> - 在 Redis 设置部分中，按如下方式**填写详细信息**：
> * 名称：输入**MyRedisCluster**
> * 描述： 输入 **Redis Cluster for awsProject**
> * 引擎版本兼容性：**6.x（默认）**
> * 端口：**6379（默认）**
> * 参数组：**default.redis6.x.cluster.on**

image::/图片/44图片/创建2.png[创建2]

> - 节点类型：**cache.t2.micro（0.5 GiB）**
> - 分片数量：**1**
> - 每个分片的副本：**1**
> - 多可用区：**选中**

image::/图片/44图片/创建3.png[创建3]

> - 子网组：**新建**
> * 名称：输入**elasticache-subnet-group**
> * 描述：输入**Subnet group for ElastiCache**
> * VPC ID：**默认VPC**
> * 子网：**全选**

image::/图片/44图片/子网组.png[子网组]

> - 单击**高级 Redis 设置**
> - 在**"安全性"**中，**更改安全组**：
> * 选择 **ElastiCache-SG**，**取消选择默认安全组**

image::/图片/44图片/安全组.png[安全组]

> - 在**"备份"**部分中：
> - 启用自动备份：**取消选中**
> - 将其他选项**保留为默认值**
> - 最后，单击**"创建"**按钮。
> - 此集群从创建状态转到**可用状态最多需要 10 分钟**。

image::/图片/44图片/redis成功.png[redis成功]

> - 同时，让**我们创建一个 EC2 实例**，该实例将**用于访问 Redis 集群**。 

---

=== 启动 EC2 实例

==== (1)控制台启动实例

image::/图片/07图片/控制台2.png[控制台启动实例]

==== (2)选择系统镜像

image::/图片/07图片/控制台3.png[选择系统镜像]

==== (3)选择实例类型

image::/图片/07图片/配置1.png[选择实例类型]

==== (4)配置实例

> - 将设置**保留为默认值**，然后单击**下一步按钮**。

==== (5)添加存储

image::/图片/07图片/配置2.png[添加存储]

==== (6)添加标签

image::/图片/07图片/配置3.png[添加标签]

==== (7) 配置安全组

> - 分配安全组：**选择一个现有的安全组**
> - **选择 ElastiCache-SG 安全组**
> - 点击下一步 `审核和启动`

==== (8) 审核启动

> - **检查**所有选定的设置，**无误点击启动**
> - 选择现有密钥对，确认并单击**启动实例**

image::/图片/07图片/现有密钥.png[现有密钥]

> - 注意：**复制 EC2 实例的 IPv4 公有 IP 地址**。

---

=== 复制配置终端节点


> - 顶部菜单**导航到 ElastiCache**
> - 单击选中**集群**。
> - **复制配置终端节点**，并将其**保存在记事本中**，我们将在**后面的步骤中使用它**。

image::/图片/44图片/配置终端节点.png[配置终端节点]

> - 确保从末尾**删除端口号**。**删除端口号后**，它将是：
> - 例如：**``myrediscluster.2yyrem.clustercfg.use1.cache.amazonaws.com``**

---

=== 测试 ElastiCache 集群

> - **SSH 进入 EC2 实例**。

==== 安装所需的软件包并**连接到 ElastiCache 集群**

> - 通过在终端中输入以下命令来**安装 gcc**： 

----
  sudo yum install gcc -y
----

> - 现在，通过**逐个输入以下命令来安装 Redis 集群**：

----
  wget http://download.redis.io/redis-stable.tar.gz
  tar xvzf redis-stable.tar.gz
  cd redis-stable
  make
----

> - 完成后，**连接您的 Redis 集群**

----
  src/redis-cli -c -h ENDPOINT -p 6379
----

> - 将**``ENDPOINT``替换为复制的终端节点**。
> - 确保粘贴的终端节点**不带冒号(:)和端口号**
> - 示例： **``src/redis-cli -c -h myrediscluster.2yyrem.clustercfg.use1.cache.amazonaws.com -p 6379``**

image::/图片/44图片/连接redis.png[连接redis]

==== 通过运行示例命令测试 ElastiCache 集群

> - 输入**命令为**

----
  set a "hello" 
----

> - 此命令会**将 a 的值设置为"hello"**，即字符串值，**没有过期时间**

----
  get a
----
> - **获取 a 的值**

image::/图片/44图片/get a.png[get a]

---

----
  set b "aws" EX 10 
----

> - 此命令会**将 b 的值设置为"aws"**，一个字符串值，**有效期为 10 秒**

----
  get b
----

> - 如果您**在 10 秒内执行此命令**，您将**能够看到 b 的值**

----
  get b
----

> - **在 10 秒后重新输入此命令**，以**查看 b 的值是否可见**。

---
