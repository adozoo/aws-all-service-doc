
## SNS简单消息通知实例

=== 什么是 SNS?

> - SNS 代表 **简单通知服务**。
> - 为大量**传递消息（主要面向移动用户）**提供**低成本基础结构**。
> - SNS 充当**单个消息总线**，可以向**各种设备和平台发送消息**。
> - SNS 使用**发布/订阅**模型来**推送消息传递消息**。
> - SNS 使我们能够**使用完全托管**的**发布/订阅**来**分离微服务**、**分布式系统**和**无服务器应用程序**。
> - 发布者通过**生成消息**并将其**发送到主题（逻辑访问点和通信通道）**与订阅者进行**异步通信**。
> - **订阅者（即 Web 服务器、电子邮件地址、SQS 队列等）在订阅主题时**，通过受**支持的协议之一**使用或**接收消息或通知**。
> - 收件人订阅 SNS 中的**一个或多个"主题"**。
> - 使用 SNS 主题，**发布者系统**可以将**消息扇出到大量订阅者终端节点**进行**并行处理**，包括**``Amazon SQS 队列``**、**``AWS Lambda函数``**和**``HTTP/S Webhooks``**。
> - SNS 在传递具有**持久性的消息**方面**非常可靠**。
> - SNS 可以**自动扩展工作负载**。
> - 使用**主题策略**，您可以**保持邮件**的**私密性和安全性**。

=== 架构图

image::/图片/99图片/架构图.png[架构图]

== 实验步骤

=== 创建 SNS 主题

> - 确保您位于**弗吉尼亚北部**区域。
> - 通过菜单导航到**"SNS"**。
> - 单击左侧面板中的**主题**，然后单击**创建主题**。
> - 在**"详细信息"**下：
> * 类型：选择**标准**
> * 名称 ： 输入**``mysnsnotification``**
> * 显示名称 ： 输入**``mysnsnotification``**
> - 将其他选项**保留为默认值**，然后单击**创建主题**。
> - 现已**创建一个 SNS 主题**。

image::/图片/90图片/sns主题创建完成.png[sns主题创建完成]

==== 复制 ARN 并将其保存以供日后使用。

---

=== 订阅 SNS 主题

> - 创建 SNS 主题后，单击 SNS 主题**"mysnsnotification"**。
> - 单击**创建订阅**。
> - 在**"详细信息"**下：
> * 协议 ：选择**电子邮件**
> * 终端节点 ：输入**您的电子邮件地址**
> * 注意： 请确保**提供正确的电子邮件地址**，因为这是将传递您的**通知的地方**。
> - 您的电子邮件地址将**收到订阅确认**

image::/图片/90图片/sns邮件.png[sns邮件]

> - 单击**"确认订阅"**。

image::/图片/90图片/确认sns.png[确认sns]

> - 您的电子邮件地址现**已订阅 SNS 主题**mysnsnotification。

---

=== 创建S3存储桶

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域。
> - 顶部菜单**导航到 S3**

image::/图片/09图片/导航到S3.png[导航到S3]

> - 在 S3 页面上，单击**``创建存储桶``**并**填写存储桶详细信息**。
> - 桶名称：输入**``mys3buckettestingsns-jack``**
> * 注意： S3 存储桶名称是**全局唯一**的，请**选择一个可用的名称**。
> - AWS 区域：选择**美国东部（弗吉尼亚北部）美国东部-1**
> - 将**其他设置保留**为默认值。
> - **创建存储桶按钮**
> - S3 **存储桶已创建**。

image::/图片/99图片/存储桶已创建.png[存储桶已创建]

==== 选择创建的存储桶，然后单击顶部的复制 ARN 按钮。保存 ARN。

---

=== 更新 SNS 主题访问策略

> - 通过菜单导航到**"SNS"**。
> - 单击**"主题"**。
> - 点击**``mysnsnotification``**。
> - 单击右上角的**编辑**以**编辑 SNS 主题**的**访问策略**。
> - 展开**"访问策略"**。
> - 更新**存储桶策略**，如下所示：
> * 注意：在这里，我们需要在粘贴以下策略后**做两件事**。
> * 下面**"Resource"**部分中的 **SNS 主题 ARN**
> * **S3 存储桶 ARN** 修改为**正确的 ARN**

```json
  {
      "Version": "2008-10-17", 
      "Id": "__default_policy_ID", 
      "Statement": [
          {
              "Sid": "__default_statement_ID", 
              "Effect": "Allow", 
              "Principal": {
                  "AWS": "*"
              }, 
              "Action": [
                  "SNS:GetTopicAttributes", 
                  "SNS:SetTopicAttributes", 
                  "SNS:AddPermission", 
                  "SNS:RemovePermission", 
                  "SNS:DeleteTopic", 
                  "SNS:Subscribe", 
                  "SNS:ListSubscriptionsByTopic", 
                  "SNS:Publish", 
                  "SNS:Receive"
              ], 
              "Resource": "<Your_SNS_Topic_ARN>", 
              "Condition": {
                  "ArnLike": {
                      "aws:SourceArn": "<Your_Bucket_ARN>"
                  }
              }
          }
      ]
  }
```

> - 注意：请务必更新**上述策略**中的**存储桶 ARN **和 **SNS 主题 ARN**。
> - 单击**"保存更改"**。
> - 现在，您的 SNS 主题**有权根据 S3 存储桶事件**发送**通知事件**。

---

=== 创建 S3 存储桶事件

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域。
> - 顶部菜单**导航到 S3**
> - 通过**单击您的存储桶**名称**进入S3存储桶**
> - 选择**属性选项卡**并**向下滚动**
> - 您将看到**事件通知（0）**选项，单击**``创建事件通知``**按钮。
> - 填写**详细信息：**
> * 名称 ： 输入**``myemaileventforput``**
> * 前缀 - 可选：将其**留空**
> * 后缀 - 可选：将其**留空**
> * 事件类型 ：选择**``发送(PUT)``**
> * 目标：**选择 SNS 主题**
> * 指定 SNS 主题：选择之前**创建的SNS主题名称**。
> * 点击**保存更改**
> - 现在，S3 存储桶**已启用事件通知**。

image::/图片/99图片/事件通知.png[事件通知]

---

=== 测试 SNS 通知

> - 通过单击您的存储桶名称**进入S3存储桶**
> - 在存储桶中的**"对象"**下，单击**"上传"**
> - 现在，单击**"添加文件"**并从本地系统**上传任意图像**。
> - 将图像成功**上传到 S3 存储桶后**，单击**关闭**。现在，您可以在**"对象"**下**看到上传的图像**。

image::/图片/99图片/上传的图像.png[上传的图像]

> - 登录您的电子邮件以**查看新消息**。
> - 您已成功收到**基于 S3 存储桶**中的 **PUT 对象事件的 SNS 通知**

image::/图片/99图片/对象事件.png[对象事件]

---
