
## 用KinesisDataStream和Agent搭建实时数据流系统

=== Amazon Kinesis Agent

> - Amazon Kinesis Agent 是**一款 Java 软件应用程序**，它**提供了一种收集数据**并将其**发送到 Kinesis Data Firehose 的简单方法**。
> - **代理会持续监控一组文件**，并将**新数据发送到 Kinesis Data Firehose 传输流**。

=== 架构图

image::/图片/94图片/架构图.png[架构图]

== 实验步骤

=== 创建 IAM 用户

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域
> - 顶部菜单**导航到 IAM**
> - 单击**``添加用户``**该按钮以**创建新的 IAM 用户**。

image::/图片/59图片/创建用户.png[创建用户]

> - 在**添加用户**部分，**设置用户详细信息**：
> - 用户名：**``KinesisTEST``**
> - 在选择 **AWS 访问类型**部分，选择 **AWS 凭证类型**为**``访问密钥 - 编程访问和密码 - AWS 管理控制台访问``**

image::/图片/94图片/添加用户.png[添加用户]

> * 单击**下一步**
> - 设置权限：现在，您可以看到**策略列表**。
> - 单击**直接附加现有策略**，搜索**``AdministratorAccess``**并选择它
> - 现在点击 **下一页：标签**按钮。**无需更改**
> - 单击**"下一步：审核"**按钮。
> - **查看选择是否有误**，然后单击**"创建用户"**。
> - 会得到**访问密钥 ID-私有访问密钥和用户密码**
> - 请**保存好它**

---

=== 创建 IAM 角色

> - 导航到**``IAM``**
> - 在**左侧菜单**中，单击**``角色``** 。单击**``创建角色``**该按钮以**创建新的 IAM 角色**。
> - 在创建角色部分，为角色选择**可信实体类型**：
> * **AWS 服务**
> * **使用案例:EC2**

image::/图片/25图片/创建IAM.png[创建IAM]

> * 单击**下一步**
> - 添加权限：现在，您可以看到**策略列表**。按名称**``AmazonS3FullAccess``**搜索权限并添加。
> - 按名称**``AmazonKinesisFullAccess``**搜索权限并添加。
> - 单击**下一步**
> - 角色名称：输入 **``kinesis-datastream-role``**
> - 您**已成功**按名称 kinesis-datastream-role 创建了一个 IAM 角色。
> * 注意：您可以使用**其他名称创建角色**，然后将其**附加到 EC2 实例**

---


=== 启动 EC2 实例

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域。
> - 顶部菜单**导航到 EC2**
> - 左侧面板，单击**"实例"**，然后单击**"启动新实例"**。

==== (1)控制台启动实例

image::/图片/07图片/控制台2.png[控制台启动实例]

==== (2)选择系统镜像

image::/图片/07图片/控制台3.png[选择系统镜像]

==== (3)选择实例类型

image::/图片/07图片/配置1.png[选择实例类型]

==== (4)配置实例

> - 实例的数量：**选择 1**
> - IAM角色：**选择刚刚创建的 ``kinesis-datastream-role``**
> - 在**"高级详细信息"**下，将以下脚本**粘贴到"用户数据"**中。

```shell
  #!/bin/bash
  sudo -s
  yum update -y
  sudo amazon-linux-extras install -y lamp-mariadb10.2-php7.2 php7.2
  sudo yum install -y httpd mariadb-server
  sudo systemctl start httpd
  sudo systemctl enable httpd
```

> - 将其余设置**保留为默认值**，然后单击**下一步按钮**。

==== (5)添加存储

image::/图片/07图片/配置2.png[添加存储]

==== (6)添加标签

> - 添加标签：点击**添加标签**按钮
> * 键：**``Name``**
> * 值：**``demo_instance``**
> * 点击**``下一步:配置安全组``**

==== (7) 配置安全组

> - 添加 SSH：

----
  . 选择类型： 选择 SSH
  . 协议：TCP
  . 端口范围：22
  . 源：选择"任何位置"
----

> - 添加 HTTP：

----
  . 选择类型： 选择 HTTP
  . 协议：TCP
  . 端口范围：80
  . 源：选择"任何位置"
----

> - 点击下一步 `审核和启动`

==== (8) 审核启动

> - **检查**所有选定的设置，**无误点击启动**
> - 选择现有密钥对，确认并单击**启动实例**

image::/图片/07图片/现有密钥.png[现有密钥]

---

=== 测试

> - **验证 Web 服务器**是否**已正确安装**。为此，请**复制实例的公有 IPv4 地址**。
> - 将 IP 地址**粘贴到浏览器窗口**中，然后**按 [Enter] 键**。
> * **``http://Your_IPv4_Address/``**
> - 您应该能够**看到测试页面**。**示例如下所示**。

image::/图片/94图片/测试页面.png[测试页面]

---

=== SSH 进入到 EC2 实例

==== 下载并托管一个示例网站

> - **SSH 进入到 EC2 实例**。
> - **导航到路径**
> * **``cd /var/www/html``**
> - **下载一个示例网站模板**。在这里，我正在**使用wget从网站下载一个zip文件**
> * **``sudo wget https://www.free-css.com/assets/files/free-css-templates/download/page270/marvel.zip``**
> - 使用ls命令**检查它是否下载到html路径中**。
> - **解压缩下载的 html 模板**。使用 zip 文件名**解压缩**。
> * **``sudo unzip marvel.zip``**
> - 使用ls**命令检查**

image::/图片/94图片/解压缩.png[解压缩]

> - 您将能够**看到一个zip文件和一个文件夹**。当我们解压marvel.zip的时，我们得到了**文件夹，``2115_marvel``**。
> - 将文件夹名称**复制到文本编辑器**。
> - 要**验证示例网站是否托管**，请将**``http:// IP_Address/folder_name``**粘贴到浏览器中，然后**按 [Enter] 键**。
> * **``http://3.218.252.225/2115_marvel/``**

image::/图片/94图片/验证示例网站是否托管.png[验证示例网站是否托管]

> - 您可以看到该网站**已成功托管**。
> - 网站日志将位于路径**"/var/log/httpd/access_log"**中。对于网站的**每次点击和使用**，**相关日志**将被**收集并存储在此处**。
> - 您可以使用**以下命令检查日志**
> * **``cd``**
> * **``sudo -s``**
> * **``cd /var/log/httpd/``**
> * **``tail -10 access_log``**

---

=== 将文件权限设置为 httpd

> - 现在，让我们看看如何存储**这些连续日志**。在**继续之前**，请**更改 httpd 文件夹**的权限，以**便 ec2 用户**将文件**置于可读、可写和可执行模式**。
> - 使用命令将 httpd 组**添加到您的 EC2 实例**
> * **``cd``**
> * **``groupadd httpd``**
> - 使用命令**将 ec2 用户**添加**到 httpd 组**
> * **``usermod -a -G httpd ec2-user``**
> - 要**刷新您的权限**并**包括新的 httpd 组**，请使用**以下命令完全注销**
> * **``exit``**
> * **``exit``**（如果你在sudo中，你必须退出两次）
> - **SSH 进入到 EC2 实例**。
> - **验证 httpd 组**
> * **``groups``**

image::/图片/94图片/验证 httpd 组.png[验证 httpd 组]

> - 将**/var/log/httpd**目录的组**所有权及其内容更改为 httpd 组**
> * **``sudo chown -R root:httpd /var/log/httpd``**
> - 更改**/var/log/httpd**及其子目录的**目录权限以添加组写入权限**，并在将来**创建的子目录上设置组 ID**，
> * **``sudo chmod 2775 /var/log/httpd``**
> * **``find /var/log/httpd -type d -exec sudo chmod 2775 {} +``**


---

=== 创建 Kinesis 数据流

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域。
> - 顶部菜单**导航到 Kinesis**
> - 在**"入门"**下，选择**"Kinesis Data Streams"**，然后单击**"创建数据流"**
> - 在**"数据流名称"**下，输入名称**``aws-data-stream``**。
> - 容量模式：选择**预置**
> - 在**预置分区**中，输入**``1``**。
> - 单击**"创建数据流"**。

image::/图片/93图片/创建数据流.png[创建数据流]

> - 创建数据流后，单击将其**打开**。
> - 单击**配置选项卡**。
> - 向下滚动到**加密**，然后单击**编辑**按钮。
> - 选中**启用服务器端加密**并**使用默认加密密钥类型**，即**``使用 AWS 托管的 CMK``**。
> - 点击**保存更改**。

image::/图片/93图片/加密.png[加密]

> - 您**已使用 AWS KMS 加密您的数据**。

---

=== 创建S3存储桶

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域。
> - 顶部菜单**导航到 S3**

image::/图片/09图片/导航到S3.png[导航到S3]

> - 在 S3 页面上，单击**``创建存储桶``**并**填写存储桶详细信息**。
> - 桶名称：输入**``aws-demo-logstest``**
> * 注意： S3 存储桶名称是**全局唯一**的，请**选择一个可用的名称**。
> - AWS 区域：选择**美国东部（弗吉尼亚北部）美国东部-1**
> - 在**默认加密**中
> * 服务器端加密：选择**"启用"**
> * 加密密钥类型：将密钥类型选择为**``Amazon S3 托管密钥(SSE-S3)``**。
> - 将**其他设置保留**为默认值。
> - 单击**创建存储桶按钮**
> - S3 **存储桶已创建**。

image::/图片/94图片/存储桶已创建.png[存储桶已创建]

---

=== 创建 Kinesis Data Firehose

> - 一旦**流服务从日志中获取数据**，我们就需要**将数据推送到某个地方**。无法**从 Kinesis 数据流中发布数据**。因此，我们**将使用 Kinesis Data Firehose**。
> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域。
> - 顶部菜单**导航到 Kinesis**
> - 在**"入门"**下，选择**"Kinesis Data Firehose"**，然后单击**"创建传输流"**
> - 在**"选择源和目标"**下
> * 源： 选择**``Amazon Kinesis Data Streams``**
> * 目标： 选择**``Amazon S3``**
> - 在**"源"**设置下，
> * 单击**"浏览"**按钮。
> * 从弹出窗口中，**选择我们之前创建的数据流**
> * 单击**"选择"**按钮。
> - 在**"传输流名称"**下，提供您选择的名称。
> * 传输流名称 ：输入**``aws-delivery-stream``**
> - 将**"变换和转换记录"**保留为**默认值**。
> - 在**"目标设置"**下
> * 单击**"浏览"**按钮。
> * 从弹出窗口中，选择我们**之前创建的 S3 存储桶**（在我的情况下是 aws-demo-logstest）。
> * 单击**"选择"**按钮。
> - **展开**缓冲区提示、压缩和加密部分。
> * 在缓冲时间间隔下，将其设置为**``60``**秒。
> - 展开**"高级设置"**
> * 在权限下，将其设置为**默认值**，即**创建或更新 IAM 角色**。将创建具有所需权限的新 IAM 角色，并将其分配给此 Kinesis 传输流。
> - 点击**创建传输流**。

image::/图片/94图片/创建传输流.png[创建传输流]

---

=== 创建和配置 Kinesis 代理

> - 让我们**配置一个 Kinesis 代理**，该代理将**收集数据**并将其**发送到 Kinesis 数据流**。
> - **SSH 进入到 EC2 实例**。
> - 让我们在实例上**安装最新版本的 Kinesis 代理**。
> * **``sudo yum install –y https://s3.amazonaws.com/streaming-data-agent/aws-kinesis-agent-latest.amzn2.noarch.rpm``**
> * 如果在安装过程中**询问**，请按**"y"**。
> - 安装 Kinesis 代理后，让我们**更新路径 ``/etc/aws-kinesis/agent.json`` 中的 json 文件**。
> * **``sudo nano /etc/aws-kinesis/agent.json``**
> * **删除所有内容并粘贴以下 JSON 内容**。
> * 注意：确保"filePattern"由**日志文件路径组成**，在这种情况下是默认的，而"kinesisStream"由创建的 Kinesis 数据流名称组成。
> * 按**"ctrl + x"**保存。按**"y"**保存修改后的更改，然后**按 [Enter]（按照命令仔细保存文件）**。

```json
  {
    "cloudwatch.emitMetrics": true,
    "kinesis.endpoint": "",
    "firehose.endpoint": "",
    "awsAccessKeyId": "AKIAT5Y7PDISKFJ5AEMJ",
    "awsSecretAccessKey": "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",
    "flows": [
      {
        "filePattern": "/var/log/httpd/access_log",
        "kinesisStream": "aws-data-stream",
        "partitionKeyOption": "RANDOM"
      }
    ]
  }
```

> - 确保**"awsAccessKeyId""awsSecretAccessKey"**正确。
> - 根据您**创建的名称更改 kinesisStream 名称**。代理向其**发送数据**的 kinesis 流（"kinesisStream"）的名称。
> - 每当**更改配置文件** （agent.json） 时，都必须**使用命令停止和启动代理**。
> * **``sudo service aws-kinesis-agent stop``**
> * **``sudo service aws-kinesis-agent start``**
> - 首次**启动代理**后，将创建一个日志文件。使用**命令检查日志文件**
> * **``cd /var/log/aws-kinesis-agent/``**
> * **``ls -ltr``**

image::/图片/94图片/命令检查日志文件.png[命令检查日志文件]

> - 您可以通过**浏览日志**来**检查服务是否已正确启动**。
> * **``head -10 aws-kinesis-agent.log``**

image::/图片/94图片/代理已成功启动.png[代理已成功启动]

> - 我们可以看到**代理已成功启动**。

---

=== 测试数据的实时流

> - 让我们通过在上述**示例网站**进行一些**点击活动**来**进行测试**。**相关日志**将在**列出的 S3 存储桶上收集**。
> - 要**测试数据流**，请将**``IP_Address/folder_name``**粘贴到浏览器中，然后**按 [Enter] 键**。
> * **``http://3.218.252.225/2115_marvel/``**
> * 注意：folder_name是示例网站的**解压缩文件夹**
> - 完成上述步骤后，单击显示的**网站链接**以**创建更多日志**

image::/图片/94图片/创建更多日志.png[创建更多日志]

> - 注意：我们正在**单击示例网站**中的**链接以生成日志**，这些日志将**传输到创建的 S3 存储桶**。
> - 菜单**导航到 S3**。
> * 注意：如果您无法看到日志，请**等待3-5分钟**。
> - 您将看到**一个文件夹层次**结构，其中包含**``年>月>日期>小时``**。
> - 单击日期以**查看创建的日志**。

image::/图片/94图片/查看创建的日志.png[查看创建的日志]

> - 单击日志，然后选择**打开并保存文件**。
> - 在本地的**任何文本编辑器**中**打开日志文件并检查日志**。

image::/图片/94图片/检查日志.png[检查日志]

> - 注意：页面中的**点击次数越多**，**生成的日志就越多**。在这个演示网页中，我们**只有1个页面**。因此，请尝试在**许多浏览器**中打开网页，然后**单击链接以生成日志**。

---

=== 检查 Kinesis Data Stream 和 Firehose 的 CloudWatch 指标

> - 让我们**检查一下记录数据的 Kinesis Data Stream **和从数据流读取数据的** Kinesis Delivery 流**的 CloudWatch 指标。
> - 确保您**位于美国东部（弗吉尼亚北部）us-east-1 区域**。
> - 菜单**导航到 Kinesis**。
> - 单击**创建的数据流**，然后导航到**"监控"**选项卡。您将能够**根据生成的日志看到图形**。

image::/图片/94图片/数据流.png[数据流]

> - 在左侧**导航面板**上，单击**传输流**。
> - 单击创建的传输流，然后导航到**监控**选项卡。您将能够**看到该图表**。

image::/图片/94图片/传输流.png[传输流]

---
