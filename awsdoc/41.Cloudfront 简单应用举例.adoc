
## Cloudfront 简单应用举例


=== 什么是 CloudFront？

> - Amazon CloudFront 是由 AWS **提供的内容交付网络 （CDN）**。
> - CDN**提供了一个全球分布的代理服务器网络**，这些服务器**将内容（即Web视频或其他笨重的媒体）缓存在本地**，从而**提高了下载内容的访问速度**。
> - CloudFront 服务以**即用即付**的方式工作。
> - CloudFront 可与 S3、EC2 等源服务器**配合使用**，在 S3、EC2 中**存储内容**，并在请求内容时**推送到多个 CloudFront 服务器**。
> - 启用 CloudFront 后，内容将**存储在主 S3 服务器上**。
> - 此内容的副本是在称为 CDN 的**全球服务器网络上创建的**。
> - 此网络中的每个服务器称为**边缘服务器**，它只有**内容的副本**。
> - 对内容发出**请求时，将从最近的边缘服务器为用户提供用户**。
> - CloudFront 具有**类似于动态站点加速的功能**，动态站点加速是一种用于**改善在线内容交付的方法**。
> - CloudFront 通过**将动态内容移近用户的位置来加速动态内容的交付**，从而最大限度地**减少检索内容时**涉及的**互联网跃点**。
> - CloudFront 的 Web 分发版支持**"渐进式"**下载，即**缓存来自 S3 的数据**，然后在**没有中断的情况下**进行**流式传输**。
> - 因此，用户无法在视频中**向前或向后移动**，即**视频被逐位处理**。
> - CloudFront 的 Web 分发支持**"流式处理**"允许用户**直接观看**，**无需任何下载**。
> - 因此，用户可以在视频中**向前或向后移动**，延迟**取决于文件大小和客户的Internet带宽**。
> - 这项服务对那些**分发大量内容**并**需要扩展的网站**是**有益的**。
> - 它通过提供**高数据传输速度**和**低延迟**来帮助**降低成本**并**提高网站的性能**。


=== 架构图

image::/图片/41图片/架构图.png[架构图]

== 实验步骤

=== 创建 S3 存储桶

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域。
> - 顶部菜单**导航到 S3**

image::/图片/09图片/导航到S3.png[导航到S3]

> - 在 S3 页面上，单击``创建存储桶``并**填写存储桶详细信息**。
> - 桶名称：输入``mys3bucket-lab``
> * 注意： S3 存储桶名称是**全局唯一**的，请**选择一个可用的名称**。
> - AWS 区域：选择美国东部（弗吉尼亚北部）美国东部-1
> - 对于对象所有权：选择**ACL 已启用**
> * 对象所有权选项：选择**对象编写者**
> - 注意：请选择对象编写者，否则将**不允许编辑存储桶 ACL**。
> - 对于此存储桶的**“阻止公有访问”**设置部分
> * **取消选中**"阻止所有公共访问"选项，然后**选中确认**选项。
> - 将**其他设置保留**为默认值。
> - **创建存储桶按钮**
> - S3 **存储桶已创建**。


image::/图片/41图片/成功创建存储桶.png[成功创建存储桶]


---


=== 将对象上传到 S3 存储桶


> - **单击**您的存储桶名称。
> - 在对象中，您可以看到**以下消息**
> * 此存储桶中**没有任何对象**。

image::/图片/41图片/没有对象.png[没有对象]


> - 您可以从本地计算机**上传任何图像**
> - 将文件上传到我们的 S3 存储桶
> * 点击**上传**按钮。
> * 点击**添加文件**按钮。
> * 浏览您的本地图像**并选择它**
> * 单击上传按钮**上传**。
> - 您可以从屏幕顶部的传输面板中**查看上传进度**。
> - 上传文件后，它将**显示在存储桶中**。


---

=== 创建自定义错误页


> - 我们可以**为 CloudFront 创建**自定义**错误页面**，以便在**源返回 HTTP 4xx 或 5xx 错误时**显示。
> - 为此，我们必须**将错误页面保存**在 CloudFront 可**访问的位置**。
> - 我们将使用**相同的 S3 存储桶**来**创建错误**页面。
> - 要配置**自定义错误页面**，请**选择您的 S3 存储桶**
> - 单击**"创建文件夹"**，然后按名称**"CustomErrors"**创建一个文件夹。
> - 选择**"服务器端加密"**作为**"禁用"**。
> - 单击**"创建文件夹"**按钮。

image::/图片/41图片/创建文件夹.png[创建文件夹]


> - 单击新的**"CustomErrors"**文件夹。
> - 创建**error.html**
> * 使用**记事本在本地系统**中**创建error.html**文件。
> * 此自定义 HTML 页面将**用于在 CloudFront 中显示错误**。
> * 示例**error.html**内容：

----
  <html><h1>This is Error Page</h1></html>
----

> - 上传**error.html 到 S3 存储桶的CustomErrors文件夹中**。
> - 创建**block.html**
> * 使用**记事本在本地创建block.html文件**。
> * 此自定义 HTML 页面将用于在 CloudFront 中**显示地理限制的内容**。
> * 示例**block.html**内容：

----
  <html><h1>This content is blocked in your location!!!</h1></html>
----

> - 将**block.html上传到S3 存储桶的CustomErrors文件夹中**。

---

=== 使对象公开

> - 单击**图像名称**。您可以查看**图像详细信息**，例如**所有者，大小，链接等**。
> - 在新选项卡中打开**"对象 URL"**。
> - 示例对象 URL：**https://mys3bucket-lab.s3.amazonaws.com/95159676_p0.png**
> * 您将看到 **AccessDenied** 消息，这意味着该对象**不可公开访问**。

image::/图片/41图片/xml.png[xml]

> - **返回存储桶**，然后单击**权限选项卡**。
> - 向下滚动到**存储桶策略**，然后单击**编辑**。复制并**粘贴以下策略并保存策略**。
> - 注意： 在代码中的**"Resource"**选项中，使用您的**存储桶 ARN **进行更改。


```json
  {
    "Version": "2012-10-17",
    "Statement": [
      {
        "Effect": "Allow",
        "Action": [
          "s3:ListBucket"
        ],
        "Principal": {
          "AWS": "*"
        },
        "Resource": "arn:aws:s3:::mys3bucket-lab"
      },
      {
        "Effect": "Allow",
        "Action": [
          "s3:GetObject",
          "s3:PutObject"
        ],
        "Principal": {
          "AWS": "*"
        },
        "Resource": "arn:aws:s3:::mys3bucket-lab/*"
      }
    ]
  }
```

> - 再次**打开图像 URL **或**刷新已打开的图像 URL**。
> - 如果您可以在浏览器中**看到上传的图片**，则表示您的图片**可以公开访问**。如果没有，请**再次检查您的存储桶策略**。

image::/图片/41图片/储存桶访问.png[储存桶访问]


---


=== 创建CloudFront分发


> - 从菜单中**导航到 CloudFront**。
> - 导航到**左侧面板**，选择**"分配"**选项卡。
> - 现在点击**创建分配**按钮
> - 现在按如下方式**配置CloudFront分发**
> * **源域**
> ** 选择**您的 S3 存储桶**：**mys3bucket-lab.s3.us-east-1.amazonaws.com**
> - 无需**更改配置中的其他任何内容**，向下滚动并**单击创建分配按钮**
> - 您可以看到 **CloudFront 已启用**
> * 注意：此过程大约需要**5-10分钟**。
> - Amazon CloudFront 分配给您的**分配的域名将显示在分配列表中**。它看起来与 **https://d44zcd5yim4k1.cloudfront.net 相似**


---

=== 通过 CloudFront 访问图像


> - Amazon CloudFront 现在**指向 Amazon S3 存储桶源**，并且您知道与分配**关联的域**名。
> - 您可以**使用该域名在 Amazon S3 存储桶中**创建**指向该图像的链接**。
> - 要**测试您的分发**，请**复制您的域名并将您的图像名称附加到域名之后**。
> * 示例：**https://d44zcd5yim4k1.cloudfront.net/95159676_p0.png**
> - 在新选项卡中**打开 CloudFront URL**。您可以**看到上传的图片**。
> - 您可以看到与 S3 URL 相比，CloudFront URL 图像的加载**速度变快**。
> - 当最终用户使用 CloudFront 域名**请求对象时**，他们会**自动路由到最近的边缘站点**，以便**高性能地交付您的内容**。

image::/图片/41图片/cloudfront访问.png[cloudfront访问]

---

=== 配置自定义错误页


> - 导航回 **CloudFront 控制面板**，然后选择**创建的分配**。
> - 选择**"错误页面"**选项卡。
> * 单击**创建自定义错误**响应
> * 现在我们**需要设置自定义错误页面**
> ** HTTP 错误代码 ：选择 **404：找不到**
> ** 错误缓存最小 TTL：输入 **10**
> ** 自定义错误响应：选择**"是"**
> ** 响应页路径 ：输入 **/CustomErrors/error.html**
> ** HTTP 响应代码：选择 **404：找不到**
> ** 单击**创建自定义错误响应**。

image::/图片/41图片/404设置.png[404设置]

> - 导航回**"常规"**，并等待分发完成状态**更改为"已部署"**。
> * 注意：此过程大约**需要5-10分钟**。
> * 将状态更改为**"部署"**后，我们将**测试错误页**。
> ** 使用 CloudFront 域名输入 S3 存储桶中**不存在的图像的 URL**
> *** **https://d44zcd5yim4k1.cloudfront.net/abc.png**

image::/图片/41图片/error page.png[error page]


> - 如果您在浏览器中可以**看到您的 HTML 错误页面**，则表示您**已成功设置自定义错误页面**。

---


=== 限制地理位置的内容分布


> - 如果您需要**阻止选定国家/地区**的**用户访问您的内容**，可以使用**限制指定白名单**（他们可以访问您的内容的国家/地区）或**黑名单**（他们无法访问的国家/地区）。
> - 在**"分发设置"**页上，选择并选定**地理限制**，然后单击**编辑**按钮。
> * 限制类型 ：选择**阻止列表**
> * **选择您当前所在的国家/地区**，然后单击以**选中此选项**。
> * 启用此选项后，将不会显示来自**指定国家/地区（已列入黑名单）的请求**，并显示**默认错误消息**。
> * 点击**保存更改**。

image::/图片/41图片/地理限制.png[地理限制]

> - 导航回"常规"，并**等待分发完成状态更改为"已部署"**。
> * 将状态更改为**已部署后**，我们将在浏览器中**通过 CloudFront 测试限制**。
> ** **https://d44zcd5yim4k1.cloudfront.net/95159676_p0.png**
> * 您可以看到以下**错误消息**：
> ** 403：错误 Amazon CloudFront 分配配置为**阻止来自您所在国家/地区的**访问。

image::/图片/41图片/403原生.png[403原生]



> - 让我们**配置自定义错误页面**
> * 导航回 **CloudFront 控制面板**，然后选择**错误页面** 。
> * 单击**创建自定义错误响应**
> ** 现在我们需要设置自定义**错误页面**：
> *** HTTP 错误代码 ：选择 **403：禁止**
> *** 错误缓存最小 TTL：输入 **10**
> *** 自定义错误响应：选择**"是"**
> *** 响应页路径 ：输入 **/CustomErrors/block.html**
> *** HTTP 响应代码：选择 403：**禁止**
> *** 单击**创建自定义错误响应**。
> - 导航回**"常规"**，并等待分发完成状态**更改为"已部署"**。
> * 注意：此过程大约**需要5-10分钟**。
> - 状态更改为**"已部署"**后，我们将在**浏览器中通过 CloudFront 测试限制**。
> * **https://d44zcd5yim4k1.cloudfront.net/95159676_p0.png**


image::/图片/41图片/403自定义.png[]

> - 如果您看到该**错误**，则表示您**已成功配置自定义错误页面**并**限制从您所在国家/地区访问图像**。


---
