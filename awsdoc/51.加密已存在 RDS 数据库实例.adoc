
## 加密已存在 RDS 数据库实例

=== 介绍

> - Amazon RDS 可以**加密您的 Amazon RDS 数据库实例**。
> - 为 AWS RDS 资源**启用加密选项后**，我们能够**加密数据库实例**、**自动备份**、**只读副本**、**快照**和**日志**。
> - Amazon RDS 加密数据库实例**使用 AES-256 加密算法**对托管 Amazon RDS 数据库实例的**服务器上的数据进行加密**。
> - 加密选项只能在**您启动数据库实例时启用**，在**启动后无法启用**。但是，**可以加密未加密快照的副本**。

=== 架构图

image::/图片/51图片/架构图.png[架构图]

== 实验步骤

=== 创建 RDS 数据库实例（不启用加密）

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域
> - 通过菜单**导航到 RDS**。
> - 单击**"数据库"**部分中的**"创建数据库"**按钮。
> - 指定数据库**详细信息**：
> * 实例**规格**
> ** 数据库创建方法：**标准创建**
> ** 引擎选项：选择 **MySQL**
> ** 版本 ： **默认**
> ** 模板 ：选择**开发/测试**
> ** 数据库实例标识符：**test-db**
> ** 主用户名：**master**
> ** 主密码和确认密码：**awslabs123**
> ** 注意：这是用于登录数据库的用户名/密码组合。请记下它们。
> ** 数据库实例类 ： **db.t3.micro**
> ** 存储类型 ： **通用型 （SSD）**
> ** 分配的存储：**20（默认值）**
> ** 启用存储空间自动缩放：**取消选中**
> ** 公共访问 ： 选择**否**
> - 转到**其他配置**选项
> * 初始数据库名称：**projectdb**
> * 数据库参数组：**默认**
> * 选项组：**默认**
> * 启用自动备份：**取消选中**
> - 重要说明：**取消选中启用加密选项**
> * 日志导出：本练习**不需要日志导出**。
> * 注意：将**其他所有设置保留为默认值**
> - 单击**"创建数据库"**
> - 导航到**"数据库"**。
> - 在 RDS 控制台上，将**显示新数据库实例的详细信息**。数据库实例的状态为**"正在创建"**，直到数据库实例**可供使用**。
> - 当状态更改为可用时，您**可以连接到数据库实例**。新实例状态变为**"可用"**之前最多可能**需要 20 分钟**。

image::/图片/51图片/数据库创建完成.png[数据库创建完成]


> - 单击数据库并**导航到"配置"选项卡**。您可以注意到**加密未启用**，**正如我们希望的那样**

image::/图片/51图片/未启用加密.png[未启用加密]

> - 如果我们选择数据库并对其**进行修改**，我们将**找不到加密数据库的选项**。

---

=== 从现有数据库实例拍摄快照

> - 选择创建的**数据库实例**，然后单击**操作**。
> - 从选项中单击**拍摄快照**。

image::/图片/51图片/拍摄快照.png[拍摄快照]


> - 为**快照命名**，**``test-snapshot-01``**，然后单击**拍摄快照**按钮。

image::/图片/51图片/确认拍摄.png[确认拍摄]

> - 创建快照**需要 3-5 分钟**。刷新**一段时间后**，快照创建**状态将可用**。

---


=== 创建快照的副本并对其进行加密


> - 在此阶段**无法加密快照**。
> - 我们需要在获取**快照副本时**对其**进行加密**。
> - 在手动快照下，**选择创建的快照**，然后单击**操作**。
> - 从选项中单击**复制快照**。

image::/图片/51图片/复制快照.png[复制快照]

> - 在**"设置"**下，提供以下**详细信息**。
> * 确保**区域与原始数据库实例相同**，即**美国东部（弗吉尼亚北部）**
> * 新的**数据库快照标识符**：输入**``test-snapshot-encrypted``**
> * 在**"加密"**下，选中**"启用加密"**。将AWS KMS 密钥**保留为默认值**。（重要）
> * 单击**复制快照**按钮。

image::/图片/51图片/复制完成.png[复制完成]

---

=== 从加密快照还原数据库实例

> - 单击**加密的快照**，然后单击**操作**。
> - 单击选项中的**还原快照**。

image::/图片/51图片/还原快照.png[还原快照]

> - 在设置下，输入**数据库实例的名称**作为**``test-db-encrypted``**。
> - 使**其他设置与原始数据库实例完全相同**。
> - 在数据库实例类下，选择**可突增类（包括 t 类）**，然后选择**``db.t3.micro``**
> - 在**"加密"**下，您可以看到**"启用加密"**已启用，并且由于快照已加密，因此**无法进行更改**。

image::/图片/51图片/灰色加密.png[灰色加密]

> - 将数据库**参数组和选项组**保留为**默认值**。
> - 单击**还原数据库实例**按钮。创建数据库大约**需要 5-10 分钟**。

---

=== 更改原始数据库实例的名称


> - 我们必须**确保还原的数据库实例的终端节点**应与**原始数据库实例相同**。
> - 为此，我们**必须更改数据库实例的名称**，因为这些**名称是唯一的**。
> - 选择**原始数据库实例**，然后单击**修改**。
> - 将数据库实例标识符更改为**``test-db-unencrypted``**。

image::/图片/51图片/修改数据库名称.png[修改数据库名称]

> - 将**所有内容保留为默认值**，然后单击**"继续"**。
> - 验证**数据库实例标识符和终端节点的新值**。
> - 在**"修改的计划"**下，选择**"立即应用"**，然后单击**修改数据库实例**
> - 重启数据库实例可能**需要一些时间**

image::/图片/51图片/立即应用.png[立即应用]

---

=== 将还原的数据库实例的名称更改为原始数据库实例名称

> - 在还原的数据库上选择，然后单击**"修改"**。
> - 将**数据库实例标识符更改为``test-db``**。

image::/图片/51图片/修改数据库名称2.png[修改数据库名称2]


> - 将**所有内容保留为默认值**，然后单击**"继续"**。
> - **验证数据库实例标识符和终端节点的新值**。
> - 在**"修改的计划"**下，选择**"立即应用"**，然后单击**修改数据库实例**。
> - 重启数据库实例可能**需要一些时间**。

image::/图片/51图片/立即应用2.png[立即应用2]

> - 修改数据库后，单击并**打开``test-db``**，即**加密的数据库实例**。
> - 单击数据库并导航到**"配置"选项卡**。您可以**注意到加密已启用**。

image::/图片/51图片/test-db已加密.png[test-db已加密]

---

=== 删除未加密的 RDS 数据库实例和快照

> - 由于我们**有加密的数据库实例**，因此我们**将删除未加密的数据库实例**和**关联的快照**。
> - 单击屏幕左侧的**"数据库"**。
> - 选择**未加密的数据库实例**（即 test-db-unencrypted），然后单击**操作**。
> - 单击**"删除"**选项。
> - **取消选中**创建最终快照选项。
> - **选中确认框**。
> - 通过输入**``delete me``**并单击**"删除"**来确认删除。

image::/图片/51图片/删除数据库实例.png[删除数据库实例]

> - 单击屏幕左侧的**快照**。
> - 在**"手动快照"**下，选择**未加密的快照（即test-snapshot-01）**，然后单击**"操作"**。
> - 单击**删除快照**选项。
> - 单击**``删除``**按钮进行确认。

image::/图片/51图片/删除快照.png[删除快照]

> - 通过这种方式，您可以**加密未加密的 RDS 数据库实例**。

---
