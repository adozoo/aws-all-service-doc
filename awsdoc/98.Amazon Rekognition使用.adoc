
## Amazon Rekognition使用

=== 什么是 Amazon Rekognition？

> - Amazon Rekognition 是一个**基于云**的**软件即服务计算机视觉平台**。
> - 借助 Amazon Rekognition，您可以使用**经过验证的**、**高度可扩展**的**深度学习**技术轻松地**将图像和视频分析**添加到您的**应用程序**中，**无需机器学习专业知识**。
> - 它提供**高度准确的面部分析**和**面部搜索功能**，可用于**检测**、**分析**和**比较各种用户验证**、**人数统计**和**公共安全用例**的人脸。
> - 服务特色：
> * **标签**
> * **自定义标签**
> * **内容审核**
> * **文本检测**
> * **人脸检测和分析**
> * **人脸搜索和验证**
> * **名人认证**
> * **个人防护装备 （PPE） 检测**

=== 架构图

image::/图片/98图片/架构图.png[架构图]

== 实验步骤

=== 创建 IAM 角色

> - 导航到**``IAM``**
> - 在**左侧菜单**中，单击**``角色``** 。单击**``创建角色``**该按钮以**创建新的 IAM 角色**。
> - 在创建角色部分，为角色选择**可信实体类型**：
> * **AWS 服务**
> * **使用案例:Lambda**

image::/图片/09图片/IAM创建角色2.png[IAM创建角色2]

> * 单击**下一步**
> - 添加权限：现在，您可以看到**策略列表**。按名称**``AmazonS3FullAccess``**搜索权限并添加。
> - 按名称**``AmazonRekognitionFullAccess``**搜索权限并添加。
> - 单击**下一步**
> - 角色名称：输入 **``Lambda_rekognition_fullaccess``**
> - 您**已成功**按名称 Lambda_rekognition_fullaccess 创建了一个 IAM 角色。
> * 注意：您可以使用**其他名称创建角色**，然后将其**附加到 Lambda 函数**

---

=== 创建S3存储桶

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域。
> - 顶部菜单**导航到 S3**

image::/图片/09图片/导航到S3.png[导航到S3]

> - 在 S3 页面上，单击**``创建存储桶``**并**填写存储桶详细信息**。
> - 桶名称：输入**``aws-rekognitiontest``**
> * 注意： S3 存储桶名称是**全局唯一**的，请**选择一个可用的名称**。
> - AWS 区域：选择**美国东部（弗吉尼亚北部）美国东部-1**
> - 对于对象所有权：选择**ACL 已禁用(推荐)**
> - 对于此存储桶的**“阻止公有访问”**设置部分
> * **取消选中**"阻止所有公共访问"选项，然后**选中确认**选项。
> - 将**其他设置保留**为默认值。
> - **创建存储桶按钮**
> - S3 **存储桶已创建**。

image::/图片/98图片/存储桶已创建.png[存储桶已创建]

---

=== 将文件上传到 S3 存储桶

> - **单击**存储桶名称**``aws-rekognitiontest``**。
> - 在对象中，您可以看到**以下消息**
> * 此存储桶中**没有任何对象**。

image::/图片/41图片/没有对象.png[没有对象]

> - 您可以从本地计算机上传**本实验所需文件**
> - 注意：本实验中只**需要使用 jpg、jpeg 和 PNG 文件格式**。**不支持**其他格式。

==== **``本实验所需文件``**位于此仓库**附件目录**

> - 将文件**上传到我们的 S3 存储桶**
> * 点击**上传**按钮。
> * 点击**添加文件**按钮。
> * 浏览您的本地文件**并选择它**
> * 单击上传按钮**上传**。
> - 您可以从屏幕顶部的传输面板中**查看上传进度**。
> - 上传文件后，它将**显示在存储桶中**。

image::/图片/98图片/显示在存储桶中.png[显示在存储桶中]

---

=== 创建 Lambda 函数

> - 确保您位于**美国东部（弗吉尼亚北部）区域**。
> - 转到菜单，然后单击 **Lambda**。

image::/图片/09图片/导航到Lambda.png[导航到Lambda]

> - 单击**创建函数**该按钮。
> - 选择**``从头开始创建``**
> - 函数名称：输入 **``my_rekognition_Lambda``**
> - 运行时：**``Python 3.9``**
> - 角色：在权限部分中，单击**"更改默认执行角色"**，然后单击**"使用现有角色"**。
> - 现有角色：选择**``Lambda_rekognition_fullaccess``**
> - 点击**创建函数**该按钮。
> - 配置页面：在此页面上，我们需要**配置我们的 Lambda 函数**。
> - 向下滚动，可以看到**"代码源"**部分。
> - **删除 lambda_function.py 中的现有代码**。
> - 复制以下代码并将其**粘贴到您的 ``lambda_function.py`` 文件中**。

```py
  import json
  import boto3
  def lambda_handler(event, context):
      bucket_name = "aws-rekognitiontest"
      image_obj_name = "rose_flower.jpeg"
      try:
          rkClient = boto3.client("rekognition", region_name="us-east-1")
          try:
              rkResponse = rkClient.detect_labels(
                  Image={
                      'S3Object': {
                          'Bucket': bucket_name,
                          'Name': image_obj_name
                      }
                  },
              )
              print(rkResponse['Labels'])
              return rkResponse['Labels']
          except Exception as e:
              print("Get labels failed because ", e)
      except Exception as e:
          print("Client connection to Rekognition failed because ", e)
```

> - 注意：请将**存储桶名称**和**对象名称**替换为**您的名称**。
> - 注意：如果您**创建了具有不同名称的存储桶**或**上传了与实验室不同的对象**，则**输出/结果**可能**会有所不同**。
> - 通过单击**"部署"**按钮**保存函数**。

---

=== 测试 Lambda 函数

> - 注意：请确保**存储桶名称**和**对象名称**与您的 S3 **数据正确无误**。
> - 单击**"测试"**按钮，"事件名称"：输入**``LambdaTest``**，然后单击**保存**按钮。
> - 再次单击**"测试"**按钮。
> - 现在，在 Lambda **执行结果**中，Rekognition 将**基于图像返回标签**。
> - 它**以 JSON 格式**为您**提供数据**，其中**包含标签名称**以及从**图像中检测标签的可信度**。

image::/图片/98图片/检测标签1.png[检测标签1]

image::/图片/98图片/检测标签2.png[检测标签2]

> - 这就是我们**使用 Amazon Rekognition 服务**检测**图像中标签的方式**。

---
