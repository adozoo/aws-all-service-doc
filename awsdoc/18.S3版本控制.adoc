
## S3版本控制


=== 什么是版本控制？

> - 版本控制是一种在**存储桶**中**保留同一对象的多个变体**的方法。
> - 版本控制用于**保留、检索和还原**存储在 S3 存储桶中的每个对象的每个版本。
> - 版本控制在 S3 **存储桶级别**完成。
> - 可以从 AWS 控制台/ 开发工具包 / API 启用版本控制。
> - 版本控制**一旦启用**，将**无法完全禁用**。
> - 禁用版本控制的替代方法是将存储桶置于"版本控制挂起"状态。
> - 拥有多个版本的对象的缺点是您**需要多次计费**（因为对象每次都存储在 S3 中）。
> - 为了避免同一对象具有多个版本，S3 具有一项**名为"生命周期管理"的功能**。这使我们能够决定当一个对象的**多个版本堆积时**该怎么办。
> - 版本控制的一个优点是，我们可以为版本化对象**提供权限**，即我们可以**定义对象的哪个版本是公共的**，**哪个版本是私有的**。

=== 架构图

image::/图片/18图片/架构图.png[架构图]


== 实验步骤

=== 创建 S3 存储桶

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域。
> - 顶部菜单**导航到 S3**

image::/图片/09图片/导航到S3.png[导航到S3]

> - 在 S3 页面上，单击``创建存储桶``并**填写存储桶详细信息**。
> - 桶名称：输入``mys3bucket-test-abcd``
> * 注意： S3 存储桶名称是**全局唯一**的，请**选择一个可用的名称**。
> - AWS 区域：选择美国东部（弗吉尼亚北部）美国东部-1
> - 对于对象所有权：选择**ACL 已禁用(推荐)**
> - 对于此存储桶的“阻止公有访问”设置部分
> * **取消选中**"阻止所有公共访问"选项，然后**选中确认**选项。
> - 将**其他设置保留**为默认值。
> - **创建存储桶按钮**
> - S3 **存储桶已创建**。

image::/图片/17图片/成功创建存储桶.png[成功创建存储桶]


=== 在 S3 存储桶上启用版本控制

> - **单击**您的存储桶名称。
> - 单击**属性**选项卡。
> - 在存储桶**版本控制**下，单击**编辑**按钮。
> - 存储桶版本控制 ：选择**启用**
> - 现在点击**保存更改**按钮。
> - 现在，存储桶版本控制**已启用**。

image::/图片/18图片/版本控制已启用.png[版本控制已启用]


=== 上传对象并使存储桶公开

> - 点击**对象**选项卡，您可以看到**以下消息**
> * 此存储桶中**没有任何对象**。

image::/图片/17图片/没有对象.png[没有对象]

> - 您可以从本地计算机**上传测试文件.txt**
> * 测试文件**内容**为

```txt
  This is version 1
```

> - 将文件**上传**到我们的 S3 存储桶
> * 点击**上传**按钮。
> * 点击**添加文件**按钮。
> * 浏览您的本地测试文件.txt**并选择它**
> * 单击上传按钮**上传**。
> - 您可以从屏幕顶部的传输面板中**查看上传进度**。
> - 上传文件后，它将**显示在存储桶中**。

image::/图片/18图片/上传图片成功.png[上传图片成功]

> - 单击``权限``选项卡，然后**配置以下内容**
> * 向下滚动到**存储桶策略**，单击右侧的**编辑**按钮。
> * 此时将显示一个空白的**存储桶策略编辑器**。
> * 将存储桶的 ARN 复制到**剪贴板**。
> * 例如``arn:aws:s3:::mys3bucket-test-abcd``
> - 复制下方**整个策略**，将其粘贴到存储桶策略中，
> - 下面 JSON 中的 Resource **改为自己的存储桶ARN**

```json
  {
     "Id":"Policy1",
     "Version":"2012-10-17",
     "Statement":[
        {
           "Sid":"Stmt1",
           "Action":[
              "s3:GetObject"
           ],
           "Effect":"Allow",
           "Resource":"replace-this-string-from-your-bucket-arn/*",
           "Principal":"*"
        }
     ]
  }
```

image::/图片/17图片/存储桶策略.png[存储桶策略]

> - 点击``保存更改``按钮。
> - 现在**再次打开**"对象"选项卡
> - 选择对象名称，然后单击**"复制URL"**。
> - 打开一个新选项卡，粘贴URL，您将获得以下**输出**。


image::/图片/18图片/版本1.png[版本1]


---

=== 上传文件的不同版本

> - 现在，在本地文本编辑器中打开**测试文件.txt**文件，并将文件内容**更新为**

```txt
  This is version 2
```

> - 点击**上传**按钮。
> - 点击**添加文件**按钮。
> - 浏览您的本地测试文件.txt**并选择它**
> - 单击上传按钮**上传**。
> - 点击屏幕右上角的**关闭**按钮。
> - 成功上传文件后，复制对象 URL 并将其**粘贴到浏览器中**。
> - 您应该会看到所上传文件的**最新版本**。

image::/图片/18图片/版本2.png[版本2]


> - 同样，再次编辑**测试文件.txt**并将**内容更新为**

```txt
  This is version 3
```

> - 然后将文件**上传到存储桶**中，并在**浏览器中检查**

---


=== 测试对象的版本控制


> - 打开您的 S3 存储桶，单击**显示版本**。您将获得测试文件.txt的**版本列表**。


image::/图片/18图片/显示版本.png[显示版本]


> - 现在**删除第一个对象**，并尝试在**浏览器中查看对象**。


image::/图片/18图片/删除第一个文件.png[删除第一个文件]


> - 您将获得"This is version 2"的**输出**。
> - 因此，当您从存储桶中**删除对象时**，存储桶指针将**指向以前可用的版本**。



---



