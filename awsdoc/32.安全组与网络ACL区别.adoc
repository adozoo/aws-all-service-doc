
## 安全组与网络ACL区别


=== 什么是有状态防火墙？

> - **安全组是有状态的**：这意味着应用于传入规则的任何更改都将**自动应用于传出规则**。
> - 如果**允许传入端口 22**，则将**自动打开传出端口 22**。
> - 在数据包的流量**上下文中检查数据包**，**允许您使用更复杂的规则**，并允许您**记录网络流量**和**记录有关流量的网络防火墙警报**。
> - 有状态规则**考虑流量方向**。

=== 什么是无状态防火墙？

> - **网络 ACL 是无状态的**：这意味着应用于**传入规则的任何更改**都**不会应用于传出规则**。
> - 如果**允许传入端口 22**，则还需要对**传出流量应用规则**。
> - **隔离检查每个数据包**，而**不考虑流量方向等因素**，也**不考虑数据包是否是已批准的现有连接的一部分**。它采用**标准五元组连接**条件的规则。

=== 案例研究图

image::/图片/32图片/案例研究图1.png[案例研究图1]

image::/图片/32图片/案例研究图2.png[案例研究图2]

=== 架构图

image::/图片/32图片/架构图.png[架构图]

== 实验步骤

=== 创建新的VPC

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域
> - 顶部菜单**导航到 VPC**
> - 单击左侧菜单中的**您的 VPC**
> - 在这里，您可以**看到所有 VPC 的列表**，无需对现有和默认 VPC **执行任何操作**，我们将**创建一个新的 VPC**。
> - 单击**``创建 VPC``**按钮。
> * 名称标签： **输入用于向您的 VPC 标识的 VPC 名称**。例如：MyVPC
> * IPv4 CIDR 块： 输入 **10.0.0.0/16**
> * IPv6 CIDR 块： 无需更改此设置，请确保选中**"无 IPv6 CIDR 块"**
> * 租期： 无需更改此设置，请确保**选中"默认"**。
> - 现在单击**``创建 VPC``**按钮

image::/图片/30图片/vpc.png[vpc]

> - 创建VPC后，它将显示**详细信息**，**如下所示**：

image::/图片/30图片/vpcok.png[vpcok]

---

=== 创建公有子网

> * 单击左侧菜单中的子网，然后单击**创建子网**。
> ** VPC ID ：从您之前创建的列表中选择 **MyVPC**。
> ** 子网名称 ：输入名称 **Public_subnet**
> ** 可用区 ： 选择 **无首选项**
> ** IPv4 CIDR 块：输入范围 **10.0.1.0/24**
> ** 单击**"创建子网"按钮**。

---

=== 创建并附加互联网网关

> - 单击左侧菜单中的**互联网网关**，然后单击**创建互联网网关**。
> * 名称标签：**MyInternetGateway**。
> * 单击**创建互联网网关**。
> - 从列表中**选择您创建的互联网网关**
> * 单击**"操作"**。
> * 单击**附加到VPC**
> * 从列表中**选择您创建的MyVPC**，然后单击**连接互联网网关**。

image::/图片/30图片/igw.png[igw]

---

=== 创建公有路由表并将其与子网关联


> - 从左侧菜单中**转到路由表**，然后单击**创建路由表**。
> * 名称： 输入**"PublicRouteTable"**。
> * VPC： 从列表中选择**"MyVPC"**。
> * 单击**创建路由表**。
> - 现在，将子网**关联到路由表**。
> - 单击 **PublicRouteTable**，单击**``操作``**。
> * 然后转到**"子网关联"**选项卡
> * 从列表中选择**"Public_subnet"**。
> * 单击**保存关联**。

---

=== 在路由表中添加公共路由

> - PublicRouteTable：添加允许公网流量**流向 VPC 的路由**。
> - 选择**"PublicRouteTable"**。
> - 转到"路由"选项卡，然后单击**``编辑路由``**按钮。
> - 然后单击**``添加路由``**按钮。
> - 指定以下值：
> * 目标：输入 **0.0.0.0/0**
> * 目标：从下拉菜单中选择互联网网关，选择**``MyInternetGateway``**。
> * 点击**保存更改**。

image::/图片/30图片/route.png[route]

---

=== 创建安全组

> - 从左侧菜单中**转到"安全"下的"安全组"**，然后单击**创建安全组**。
> - 我们将**创建一个没有入站和出站规则的安全组**。
> - 安全组名称：输入**EC2_SG**
> - 描述：**Security group for EC2 Instance**
> - VPC：选择**MyVPC**
> - 在"入站"下，将所有内容**保留为默认值**
> - 在"出站"下，单击**"删除"**按钮以删除**"所有流量路由"**。
> - 将其他内容**保留为默认值**，然后单击**创建安全组按钮**。

---

=== 启动 EC2 实例


> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域。
> - 顶部菜单**导航到 EC2**
> - 左侧面板，单击**"实例"**，然后单击**"启动新实例"**。

==== (1)控制台启动实例

image::/图片/07图片/控制台2.png[控制台启动实例]

==== (2)选择系统镜像

image::/图片/07图片/控制台3.png[选择系统镜像]

==== (3)选择实例类型

image::/图片/07图片/配置1.png[选择实例类型]


==== (4)配置实例

> - 实例数：**输入 1**
> - 网络 ： 选择**MyVPC**
> - 子网 ：保留为**默认值**
> - 自动分配公共 IP：**"启用"**
> - 将所有**其他设置保留为默认值**。单击**"下一步：添加存储"**

==== (5)添加存储

image::/图片/07图片/配置2.png[添加存储]

==== (6)添加标签

image::/图片/07图片/配置3.png[添加标签]


==== (7) 配置安全组

> - 分配安全组：选择**"选择现有安全组"**
> - **选择**刚在上述步骤中创建的**EC2_SG安全组**。
> - 注意 ：它显示一条警告，指出您尚**未启用SSH端口**，请**单击"继续"**按钮。这是因为入站安全组没有 SSH 规则，因此请**忽略该警告**。


==== (8) 审核启动

> - **检查**所有选定的设置，**无误点击启动**
> - 选择现有密钥对，确认并单击**启动实例**

image::/图片/07图片/现有密钥.png[现有密钥]

---


=== 了解安全组规则

> - **SSH 进入 EC2 实例**，但您将**无法通过 SSH 进入到 EC2 实例**，因为在安全组中您尚**未添加任何规则**。

image::/图片/32图片/ssh无法连接.png[ssh无法连接]

> - 导航到**左侧面板**上的"网络和安全"下的**"安全组"**。
> - 从列表中选择**EC2_SG安全组**，单击**操作**，然后选择**编辑入站规则**。
> - 单击**添加规则**按钮。
> * 类型 选择 **SSH** 和 源 选择 **任何位置**

image::/图片/32图片/入站规则.png[入站规则]

> - 单击**保存规则**按钮。
> - 现在再次尝试**SSH 进入 EC2 实例**，您将能够**成功通过 SSH 进入到 EC2 实例**。

image::/图片/32图片/成功进入ec2.png[成功进入ec2]


> - 由于您已在 EC2 实例的入站中**添加了 SSH 端口**，因此将允许从客户端到服务器的**所有 SSH 请求**。
> - 现在尝试 **ping google.com**
> * **ping google.com**
> - ping 将**不起作用**，因为安全组出站**未添加任何规则**。

image::/图片/32图片/ping不成功.png[ping不成功]


> - 导航到**左侧面板**上的"网络和安全"下的**"安全组"**。
> - 从列表中选择**EC2_SG安全组**，单击**"操作"**，然后选择**"编辑出站规则"**。
> - 单击**添加规则**按钮。
> * 类型 选择**所有流量**，然后源 选择 **任何位置**

image::/图片/32图片/出站规则.png[出站规则]


> - 单击**保存规则**按钮。
> - 现在**回到 EC2 实例终端**，您可以**再次尝试 ping google.com**

image::/图片/32图片/ping成功.png[ping成功]

> - ping之所以有效，是因为现在我们**已经启用了**从服务器到任何目标的所有流量。
> - 现在**关闭 EC2 终端**。

---

=== 了解 NACL 规则


> - 当您**创建 VPC 时**，将创建一个**允许入站**和**出站的默认网络 ACL**。
> - 通过单击顶部的菜单**导航到 VPC**。
> - 导航到左侧面板上的**"网络 ACL"**。
> - 从列表中选择 VPC ID 显示为**MyVPC**的 NACL。

image::/图片/32图片/NACL.png[NACL]


> - 现在，单击**"操作"**，然后选择**"编辑入站规则"**。
> - 单击**"删除"**按钮以**删除规则编号 100**，然后单击**"保存更改"**。
> - 同样，**选择相同的 NACL**，然后单击**"操作"**，然后选择**"编辑出站规则"**。
> - 单击**"删除"**按钮以**删除规则编号 100**，然后单击**"保存更改"**。
> - 按照步骤**通过 SSH 进入 EC2 实例**，但您将**无法通过 SSH 进入到 EC2 实例**，因为在 NACL 中您尚**未添加任何规则**。

image::/图片/32图片/ssh无法连接.png[ssh无法连接]


> - 导航到**左侧面板**上的**"网络 ACL"**。
> - 从列表中选择 VPC ID 显示为**MyVPC**的 NACL。
> - 现在，单击**"操作"**，然后选择**"编辑入站规则"**。
> - 单击**"添加新规则"**按钮。
> * 规则编号：输入 **100**
> * 类型 ： 选择 **SSH（22）**
> * 源 ： 输入 **0.0.0.0/0**
> * 允许/拒绝：选择**允许**
> * 点击**保存更改**。
> - 现在**再次尝试 SSH 进入 EC2 实例**，SSH **仍然会失败**，因为 SSH 请求到达 EC2 **实例**，但**响应失败**，因为 NACL **出站不允许任何流量**。
> - 导航到左侧面板上的**"网络 ACL"**。
> - 从列表中选择 VPC ID 显示为**MyVPC**的 NACL。
> - 现在，单击**"操作"**，然后选择**"编辑出站规则"**。
> - 单击**"添加新规则"**按钮。
> * 规则编号：输入 **100**
> * 类型 ： 选择**自定义 TCP**
> * 端口范围：输入**1024-65535**
> * 源 ： 输入 **0.0.0.0/0**
> * 允许/拒绝：选择**允许**
> * 点击**保存更改**。
> - 现在**再次尝试通过SSH进入EC2实例**，并**取得成功**。

image::/图片/32图片/成功进入ec2.png[成功进入ec2]


> - 在**网络 ACL 中**，如果在**入站和出站中都启用了端口**，则**连接才会成功**。
> - 导航到**左侧面板**上的**"网络 ACL"**。
> - 从列表中选择 VPC ID 显示为**MyVPC**的 NACL。
> - 现在，单击**"操作"**，然后选择**"编辑入站规则"**。
> - 单击**"添加新规则"**按钮。
> * 规则编号：输入 **200**
> * 类型 ： 选择**所有 ICMP - IPv4**
> * 源 ： 输入 **0.0.0.0/0**
> * 允许/拒绝：选择**允许**
> * 点击**保存更改。**
> - 现在，单击**"操作"**，然后选择**"编辑出站规则"**。
> - 单击**"添加新规则"**按钮。
> * 规则编号：输入 **200**
> * 类型 ： 选择**所有 ICMP - IPv4**
> * 源 ： 输入 **0.0.0.0/0**
> * 允许/拒绝：选择**允许**
> * 点击**保存更改**。
> - 现在尝试 **ping google.com**
> * **ping google.com**

image::/图片/32图片/ping成功.png[ping成功]

> - **现在关闭 EC2 终端**。

---
