
## CodeBuild 构建项目

=== 什么是 AWS CodeBuild？

> - 一种**完全托管**的**生成服务**，可用于**编译源代码**、**运行单元测试**并**生成准备部署的项目**。
> - 由于它是**托管服务**，因此**无需预配**、**管理**和**缩放**自己的生成服务器。因为它为**编程语言**和**构建工具（如Apache Maven，Gradle等）**提供了**预打包的构建环境**。
> - 您还可以在**CodeBuild**中**自定义构建环境**。
> - 使用 CodeBuild 有 3 个主要**好处**：**完全托管**、**按需构建**和**面向所有人构建**。
> - **项目是一种资源**，为 AWS CodeBuild **设置构建生成的项目指定输出**。您可以**选择将项目存储在 S3 存储桶中**。

=== 架构图

image::/图片/88图片/架构图.png[架构图]

== 实验步骤

=== 创建 IAM 角色

> - 导航到**``IAM``**
> - 在**左侧菜单**中，单击**``角色``** 。单击**``创建角色``**该按钮以**创建新的 IAM 角色**。
> - 在创建角色部分，为角色选择**可信实体类型**：
> * **AWS 服务**
> * **使用案例:CodeBuild**


image::/图片/88图片/创建IAM.png[创建IAM]


> * 单击**下一步**
> - 添加权限：现在，您可以看到**策略列表**。
> - 选择**"创建策略"**，将**打开一个新选项卡**，然后将**代码复制并粘贴到 JSON 下**。

```json
  {
      "Version": "2012-10-17",
      "Statement": [
          {
              "Effect": "Allow",
              "Resource": [
                  "*"
              ],
              "Action": [
                  "logs:CreateLogGroup",
                  "logs:CreateLogStream",
                  "logs:PutLogEvents",
                  "logs:List*",
                  "logs:Get*",
                  "logs:Describe*"
              ]
          },
          {
              "Effect": "Allow",
              "Resource": [
                  "*"
              ],
              "Action": [
                  "s3:PutObject",
                  "s3:Get*",
                  "s3:List*"
              ]
          },
          {
              "Effect": "Allow",
              "Action": [
                  "codebuild:CreateReportGroup",
                  "codebuild:CreateReport",
                  "codebuild:UpdateReport",
                  "codebuild:BatchPutTestCases",
                  "codebuild:Get*",
                  "codebuild:Describe*",
                  "codebuild:Batch*",
                  "codebuild:List*",
                  "codebuild:BatchPutCodeCoverages"
              ],
              "Resource": [
                  "*"
              ]
          }
      ]
  }
```

> - 现在点击 **下一页：标签** 按钮。**无需更改**
> - 单击**"下一步：查看"**按钮。
> - 输入策略名称：**``CodeBuildpolicy``**，然后单击**"创建策略"**。
> - 创建策略后，返回**"创建角色"**选项卡，然后单击右上角的**"刷新"**按钮。
> - 在"筛选策略"部分中**搜索"CodeBuildpolicy"**并将其**选中**。
> - 单击**下一步**
> - 角色名称：输入 **``CodeBuildrole``**
> - 您**已成功**按名称 CodeBuildrole 创建了一个 IAM 角色。
> * 注意：您可以使用**其他名称创建角色**

---

=== 创建源存储桶

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域。
> - 顶部菜单**导航到 S3**

image::/图片/09图片/导航到S3.png[导航到S3]

> - 在 S3 页面上，单击**``创建存储桶``**并**填写存储桶详细信息**。
> - 桶名称：输入**``mys3source1``**（源存储桶）
> * 注意： S3 存储桶名称是**全局唯一**的，请**选择一个可用的名称**。
> - AWS 区域：选择美国东部（弗吉尼亚北部）美国东部-1
> - 对于对象所有权：选择**ACL 已启用**
> - 对于此存储桶的“阻止公有访问”设置部分
> * **取消选中**"阻止所有公共访问"选项，然后**选中确认**选项。
> - 将**其他设置保留**为默认值。
> - **创建存储桶按钮**
> - S3 **源存储桶已创建**。

---

=== 创建目标存储桶

> - 在 S3 页面上，单击**``创建存储桶``**并**填写存储桶详细信息**。
> - 桶名称：输入**``mys3target1``**（目标存储桶）
> * 注意： S3 存储桶名称是**全局唯一**的，请**选择一个可用的名称**。
> - AWS 区域：选择美国东部（弗吉尼亚北部）美国东部-1
> - 对于对象所有权：选择**ACL 已启用**
> - 对于此存储桶的“阻止公有访问”设置部分
> * **取消选中**"阻止所有公共访问"选项，然后**选中确认**选项。
> - 在存储桶**"版本控制选项**"中，选中**"启用选项**"。
> - 将**其他设置保留**为默认值。
> - **创建存储桶按钮**
> - S3 **目标存储桶已创建**。

---

=== 将文件上传到 S3 存储桶

> - **单击**源存储桶名称**``mys3source1``**。
> - 在对象中，您可以看到**以下消息**
> * 此存储桶中**没有任何对象**。

image::/图片/41图片/没有对象.png[没有对象]

> - 您可以从本地计算机上传**本实验所需文件**

==== **``本实验所需文件``**位于此仓库**附件目录**

> - 将文件**上传到我们的 S3 存储桶**
> * 点击**上传**按钮。
> * 点击**添加文件**按钮。
> * 浏览您的本地文件**并选择它**
> * 单击上传按钮**上传**。
> - 您可以从屏幕顶部的传输面板中**查看上传进度**。
> - 上传文件后，它将**显示在存储桶中**。

==== **``本实验所需文件``结构**

> - **``MessageUtil.zip``**
> * **``pom.xml``**
> * **``buildspec.yml``**
> * **``src``**
> ** **``main ``**
> *** **``java``**
> **** **``MessageUtil.java``**
> ** **``test ``**
> *** **``java``**
> **** **``TestMessageUtil.java``**
> - 了解**每个配置文件**
> * pom.xml 文件：项目对象模型（pom），它是maven中的**基本工作单元**。它包含有关 maven 用于**构建项目**的**配置详细信息**。
> * buildspec.yml 文件：它是 CodeBuild **运行构建**所需的**构建命令的集合**。
> * MessageUtil.java文件：此类文件**创建传入其中的字符串作为输出**。MessageUtil **构造函数设置字符串**。
> * TestMessageUtil.java 文件： 此类文件将 MessageUtil 类中的消息变量**设置为 Robert**。**Hi!Robert**会出现在**输出**中。

---

=== 在 CodeBuild 中创建构建项目

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域
> - 顶部菜单**导航到 CodeBuild**
> - 单击**"创建构建项目"**按钮以**开始创建构建项目**。
> - 对于**"项目配置"**部分
> * 项目名称：输入**``awsDemo``**
> * 将其他设置**保留为默认值**，并**向下滚动**。
> - 对于**"源"**部分，
> * 源提供程序：选择 **``Amazon S3``**
> * 存储桶：选择 **``mys3source1 ``**
> * S3 对象键或 S3 文件夹：输入**``MessageUtil.zip ``**
> * 保持**源版本不变**。
> - 对于**"环境"**部分，
> * 环境映像：选择**"托管映像"**
> * 操作系统：选择 **``Amazon Linux 2``**
> * 运行时：选择**"标准"**
> * 映像：选择 **``aws/codebuild/amazonlinux2-x86_64-standard:3.0``**
> * 映像版本：选择**"始终使用此运行时版本的最新映像"**
> * 环境类型：选择 **``Linux``**
> * 特权：**``未选中``**
> * 服务角色：选择**``现有服务角色``**
> * 角色 ARN：选择**``存在的角色``**
> * 确保**选中**"允许 AWS CodeBuild 修改此服务角色，以便可以与此构建项目一起使用"的设置。
> * 保持**其他配置不变**。
> - 对于**"生成规范"**（Buildspec）部分，
> * 保持**设置不变**。
> - 对于**"批处理配置"**部分，
> * 将其**保留为默认值**。
> - 对于**"构件"**部分，
> * 类型：选择**``Amazon S3``**
> * 存储桶名称：选择您创建的目标存储桶**``mys3target1``**
> * 将所有**其他设置保留为默认值**
> - 对于**"日志"**部分
> * 在**"CloudWatch"**下：
> ** 确保**选中**"CloudWatch 日志"选项
> ** 将所有**其他设置保留为默认值**。
> - 单击**"创建构建项目"**按钮以**最终创建构建项目**。
> - 现在**已创建项目**。

---

=== 运行并检查输出

> - 单击**开始构建**按钮。
> - 构建最多可能**需要 5 分钟才能完成**。
> - 同时，您可以**检查其中涉及的每个阶段**的**状态**以及**完成所需的时间**。

image::/图片/88图片/阶段详情.png[阶段详情]

> - 状态更改为**"成功"**后。
> - 滚动到下方，然后单击**"查看完整日志"**。
> - 您将被**重定向到 CloudWatch 日志页面**。
> - 输出现在**已准备就绪**。

image::/图片/88图片/日志输出.png[日志输出]

> - S3 输出存储桶中**存在的项目**具有**构建的输出**。您可以通过**访问您创建的 S3 存储桶**来**检查它们**。
> - 确保存储桶中**存在项目**。路径是：**``Bucket（由您创建）> awsDemo（构建项目的名称）>target> messageUtil-1.0.jar``**

image::/图片/88图片/s3验证.png[s3验证]

---
