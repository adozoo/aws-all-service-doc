
## EC2 上挂载弹性文件系统 EFS


=== 什么是EFS？

> - 弹性文件系统（Elastic File System，EFS）是AWS中的**一种存储服务**，可被用于在云端重新**创建网络文件系统**。
> - **基于网络文件系统v4（NFSv4）的EFS**，主要是针对基于Linux的应用**负载和程序而设计的**。您可以顺畅地将其与AWS的其他服务、以及本地资源**整合使用**。
> - 与其他存储服务相比，AWS EFS能够提供的功能**最接近本地现有的文件存储**。通过它，您可以轻松地将本地现有的文件结构**转移到云端**，并享有如同访问本地文件那些进行各种**流畅操作的体验**。
> - 为了达到该目的，您既可以通过在EC2（Elastic Compute Cloud）中**托管应用程序**，然后将实例**附加到EFS上**，也可以**将EFS用作独立的文件系统**。
> - 在EFS中，您可以选择如下**两种访问方式**：
> * **标准访问（Standard Access）**是针对您的**基本应用负载**而设计的。其特点是**以较高的成本换取较低的访问延迟**。
> * **不频繁访问（Infrequent Access）**专为需要**长时间存放**，却鲜少使用的文件而设计。其特点是：**以较低的成本换取较高的访问延迟**。
> - 当然，无论您选用哪一种访问方式，EFS都是**按照使用收费的**。也就是说，它仅收取您**实际使用的存储和传输带宽的费用**。

=== 架构图

image::/图片/27图片/架构图.png[架构图]

== 实验步骤

=== 启动两个 EC2 实例

> - 请确保您位于**美国东部（弗吉尼亚北部）**us-east-1 区域。
> - 顶部菜单**导航到 EC2**
> - 左侧面板，单击**"实例"**，然后单击**"启动新实例"**。

==== (1)控制台启动实例

image::/图片/07图片/控制台2.png[控制台启动实例]

==== (2)选择系统镜像

image::/图片/07图片/控制台3.png[选择系统镜像]

==== (3)选择实例类型

image::/图片/07图片/配置1.png[选择实例类型]

==== (4)配置实例

> - 实例数：**输入 2**
> - 其他保持**默认**

image::/图片/11图片/配置实例.png[配置实例]

==== (5)添加存储

image::/图片/07图片/配置2.png[添加存储]

==== (6)添加标签

image::/图片/07图片/配置3.png[添加标签]

==== (7) 配置安全组

> - 添加 SSH：

----
  . 选择类型： 选择 SSH
  . 协议：TCP
  . 端口范围：22
  . 源：选择"任何位置"
----

> - 添加 NFS：

----
  . 选择类型： 选择 NFS
  . 协议：TCP
  . 端口范围：2049
  . 源：选择"任何位置"
----

> - 点击下一步 `审核和启动

==== (8) 审核启动

> - **检查**所有选定的设置，**无误点击启动**
> - 选择现有密钥对，确认并单击**启动实例**

image::/图片/07图片/现有密钥.png[现有密钥]

> - 然后单击每个实例，然后输入名称为 MyEC2-1 和 MyEC2-2以便**分辨EC2**

image::/图片/27图片/ec2.png[ec2]

==== **记下 EC2 实例的 IPv4 公有 IP 地址**，并将其保存**以供日后使用**

---

=== 创建弹性文件系统

> - 顶部菜单**导航到 EFS**
> - 左侧面板，单击**"文件系统"**，然后单击**"创建文件系统"**。
> - 输入详细信息，键入名称为 **EFS-Demo**，并确保**已选择默认 VPC** 和**默认可用性和持久性**选项。

image::/图片/27图片/efs界面.png[efs界面]

> - 点击**自定义**按钮。
> - 由于这是一个**临时环境**，因此您可以**取消选中``启用自动备份``选项**
> - 默认情况下**保留其他内容**，然后单击下面的**"下一步"**按钮
> - 网络访问：
> * VPC
> ** Amazon EFS 文件系统由在其中一个 VPC 内运行的 EC2 **实例访问**。
> ** 选择您在启动 EC2 实例时选择的**同一 VPC （保留为默认值）**。
> * 挂载目标
> ** 实例使用称为挂载目标的网络接口连接到文件系统。每个挂载目标都有一个 IP 地址，我们会**自动分配该地址**，您也可以指定该地址。
> ** 我们将选择**所有可用区 （AZ）**，以便您的 VPC 中的 EC2 实例**可以访问文件系统**。
> ** **选择所有可用区**，然后在**安全组**中，选择**刚刚创建的安全组**而**不是默认值**。
> ** 请确保**删除默认安全组**并选择 **``刚刚创建的安全组``**，否则将在后续步骤中**收到错误**。
> - 点击**下一步**
> - 文件系统策略 - 可选，**保持默认设置**。单击**"下一步"**。
> - 审核和创建：在继续创建文件系统之前，请**检查配置选项**。点击 **创建** 按钮。
> - 恭喜您创建了 EFS 文件系统，现在是时候使用 EFS 文件系统**挂载您的 EC2 实例了**

image::/图片/27图片/efs成功.png[efs成功]


---

=== 将文件系统挂载到 MyEC2-1 实例

> - **SSH 进入 MyEC2-1 实例**
> - **切换到根用户**

----
  sudo -s
----

> - 使用以下命令**运行更新**：

----
  yum -y update
----

> - **安装 NFS 客户端** amazon-efs-utils

----
  yum install -y amazon-efs-utils
----

> - 按名称 efs **创建目录**

----
  mkdir efs
----

> - 我们必须**在此目录中挂载文件系统**。
> - 为此，请导航到 AWS 控制台，然后**单击创建的文件系统**。在右上角，单击**``连接``**按钮
> - 复制**"使用 EFS 挂载帮助程序"**的命令。
> - 并在**EC2实例中运行此命令**

----
  sudo mount -t efs -o tls fs-01d758289c31bea13:/ efs
----

> - 注意：**fs-01d758289c31bea13是我的情况**中的文件系统ID，在您的情况下可能会有所不同，请**务必替换它**。
> - 要显示所有当前**挂载的文件系统的信息**，我们将**使用下面的命令**：

----
  df -h
----

image::/图片/27图片/挂载efs.png[挂载efs]

> - 在我们当前位置**创建一个目录**：

----
  mkdir aws
----

image::/图片/27图片/mkdir.png[mkdir]

---

=== 将文件系统挂载到 MyEC2-2 实例


> - **SSH 进入 MyEC2-1 实例**
> - **切换到根用户**

----
  sudo -s
----

> - 使用以下命令**运行更新**：

----
  yum -y update
----

> - **安装 NFS 客户端** amazon-efs-utils

----
  yum install -y amazon-efs-utils
----

> - 按名称 efs **创建目录**

----
  mkdir efs
----

> - 我们必须**在此目录中挂载文件系统**。
> - 为此，请导航到 AWS 控制台，然后**单击创建的文件系统**。在右上角，单击**``连接``**按钮
> - 复制**"使用 EFS 挂载帮助程序"**的命令。
> - 并在**EC2实例中运行此命令**

----
  sudo mount -t efs -o tls fs-01d758289c31bea13:/ efs
----

> - 注意：**fs-01d758289c31bea13是我的情况**中的文件系统ID，在您的情况下可能会有所不同，请**务必替换它**。
> - 注意2：在上面的命令中，我们看到，它**以"sudo"开头**，因为你**已经是超级用户**，如果你**删除sudo**，也**没关系**。
> - 要显示所有当前**挂载的文件系统的信息**，我们将**使用下面的命令**：

----
  df -h
----

image::/图片/27图片/挂载efs.png[挂载efs]

---

=== 测试文件系统


> - 使用命令**导航到两个服务器中的 efs 目录**

----
  cd efs
----

> - 在**任何一台服务器中创建文件**。

----
  touch hello.txt
----

> - 使用**命令检查文件**

----
  ls -ltr
----

> - 现在**转到另一台服务器并发出命令**

----
  cd efs
  ls
----

> - 您还可以看到在**此服务器上创建的文件**。这证明我们的**EFS正在发挥作用**。
> - 您可以尝试在**其他服务器上创建文件**，以继续证明** EFS 实现**。


image::/图片/27图片/验证.png[验证]

---
