

## AWS S3 存储 ELB 访问日志

=== 什么是弹性负载均衡器？

> - 负载均衡器是**一项服务**，允许您跨多个目标（例如跨多个可用区分配 Amazon EC2 实例、容器和 IP 地址）的**传入应用程序或网络流量**。
> - AWS 目前提供**四种类型**的负载均衡器：
> * **应用程序负载均衡器**
> * **网络负载均衡器**
> * **传统负载均衡器**
> * **网关负载均衡器**
> - 应用程序负载均衡器最适合 **HTTP 和 HTTPS 流量**的负载均衡。
> - 网络负载均衡器用于使用 **TCP/UDP 协议**分配流量或负载。
> - 传统负载均衡器提供跨多个 **Amazon EC2 实例**的基本负载均衡。
> - 网关负载均衡器使用网关负载均衡器终端节点**跨 VPC 边界** **安全地交换流量**。


=== 在 S3 中存储 ELB 访问日志

> - ELB **访问日志**提供有关**负载均衡器**收到的**请求的详细信息**。
> - 日志文件包含**详细信息**，例如**请求的时间、客户端的 IP 地址、请求的路径和来自服务器的响应**。
> - ELB 访问日志功能是**可选功能**。
> - 您可以使用这些访问日志来**分析流量模式**并**解决问题**。
> - 存储在 S3 存储桶中的**日志文件使用唯一密钥**进行**加密**。
> - 访问日志**不收取额外费用**。您需要在 S3 中**支付存储成本**，但**不会**为弹性负载均衡用于将日志文件发送到 Amazon S3 的**带宽付费**。
> - 管理多个环境时，最好将**日志存储在**单独的 **S3 存储桶**中，以便轻松查找**特定环境**的日志。


=== 架构图


image::/图片/23图片/架构图.png[架构图]

== 实验步骤

=== 启动两个安装了 Apache 服务的 Web 服务器

==== (1)控制台启动实例

image::/图片/07图片/控制台2.png[控制台启动实例]

==== (2)选择系统镜像

image::/图片/07图片/控制台3.png[选择系统镜像]

==== (3)选择实例类型

image::/图片/07图片/配置1.png[选择实例类型]

==== (4)配置实例

> - 实例的数量：**选择 1**
> - 高级详细信息
> - 用户数据：以文本形式

```shell
  #!/bin/bash
  sudo su
  yum update -y
  yum install -y httpd
  systemctl start httpd
  systemctl enable httpd
  echo "Response coming from server A" > /var/www/html/index.html
```

==== (5)添加存储

image::/图片/07图片/配置2.png[添加存储]

==== (6)添加标签

image::/图片/07图片/配置3.png[添加标签]

==== (7) 配置安全组

> - 添加 SSH：

----
  . 选择类型： 选择 SSH
  . 协议：TCP
  . 端口范围：22
  . 源：选择"任何位置"
----

> - 添加 HTTP：

----
  . 选择类型：选择 HTTP
  . 协议：TCP
  . 端口范围：80
  . 源：选择"任何位置"
----

image::/图片/23图片/EC2SG.png[EC2SG]

> - 点击下一步 `审核和启动`

==== (8) 审核启动

> - **检查**所有选定的设置，**无误点击启动**
> - 选择现有密钥对，确认并单击**启动实例**

image::/图片/07图片/现有密钥.png[现有密钥]

---

=== 启动第二个 EC2 实例

==== (1)控制台启动实例

image::/图片/07图片/控制台2.png[控制台启动实例]

==== (2)选择系统镜像

image::/图片/07图片/控制台3.png[选择系统镜像]

==== (3)选择实例类型

image::/图片/07图片/配置1.png[选择实例类型]

==== (4)配置实例

> - 实例的数量：**选择 1**
> - 高级详细信息
> - 用户数据：以文本形式

```shell
  #!/bin/bash
  sudo su
  yum update -y
  yum install -y httpd
  systemctl start httpd
  systemctl enable httpd
  echo "Response coming from server B" > /var/www/html/index.html
```

==== (5)添加存储

image::/图片/07图片/配置2.png[添加存储]

==== (6)添加标签

image::/图片/07图片/配置3.png[添加标签]

==== (7) 配置安全组

> - 单击"选择一个现有的安全组"，选择"EC2SG"，

image::/图片/12图片/现有安全组.png[现有安全组]

> - 点击下一步 `审核和启动`

==== (8) 审核启动

> - **检查**所有选定的设置，**无误点击启动**
> - 选择现有密钥对，确认并单击**启动实例**

image::/图片/07图片/现有密钥.png[现有密钥]

---

=== 创建目标组和负载均衡器

==== 在 EC2 控制台中，**导航到**左侧面板中**负载平衡**下的**目标群组**。
> - 单击``创建目标组``按钮。
> - 步骤 1，指定组**详细信息**
> * 在"基本配置"下，
> ** 选择目标类型：选择**实例**
> ** 目标组**名称**：输入"web-server-TG"
> ** 协议：**选择 HTTP**
> ** 端口 ： **输入 80**
> * 健康检查
> ** 健康检查协议：**选择 HTTP**
> ** 运行状况检查路径：输入 **/index.html**
> ** 单击并展开**高级运行状况检查设置**
> ** 正常阈值 ： **输入 3**
> ** 不正常阈值：**2（默认值）**
> ** 超时：**5 秒（默认值）**
> ** 间隔：**输入6秒**
> ** 成功代码：**200（默认值）**
> * 将其他设置保留为**默认值**。
> * 滚动到页面**末尾**，然后单击"下一步"按钮。

---

> - 步骤 2，注册目标
> * **选中**这两个实例，然后单击**"在下面以待注册的形式添加"**按钮。
> * 实例将出现在"查看目标"部分中，运行状况**状态为"待处理"**。
> * 单击**创建目标组**按钮。

image::/图片/12图片/注册目标.png[注册目标]

> - **现在已创建目标组**。


==== 在 EC2 控制台中，**导航到**左侧面板中**负载平衡**下的**负载均衡器**。

> - 单击左上角``创建负载均衡器``按钮，为我们的 Web 服务器创建负载均衡器。
> - 选择负载均衡器**类型**：选择**"应用程序负载均衡器（Application Load Balancer）"**，单击"创建"按钮。
> - 要创建应用程序负载均衡器，请按如下方式**配置负载均衡器**
> * 对于**基本配置**部分
> ** 负载均衡器**名称**：输入"Web-server-LB"
> ** 模式：选择**面向互联网**
> ** IP 地址类型：**选择 IPv4**
> * 对于**网络映射**部分：
> ** VPC：保持**默认**
> ** 映射：选择**所有存在的可用区**
> * 对于"安全组"部分，
> ** 从下拉列表中**选择 EC2SG 安全组**，然后**删除默认安全组**。
> * 对于**侦听器和路由**部分，
> * 侦听器已随协议 HTTP 和端口 80 一起存在。
> ** 为"默认操作转发到"选项**选择目标组** **web-server-TG**。
> - 将其他选项保留为**默认值**，然后单击"创建负载均衡器"按钮。 
> - **您已成功创建应用程序负载均衡器。 单击查看负载均衡器按钮**。
> - 等待 2 到 3 分钟，让负载均衡器变为**活动**状态。


---

=== 配置负载均衡器以将访问日志存储在 S3 存储桶中


> - **导航到**左侧面板中**负载平衡**下的**负载均衡器**，然后**选择在上述步骤中创建的负载均衡器**。
> - 单击"操作"，然后单击**"编辑属性"**以**启用访问日志功能**。
> - 选中访问日志旁边的**复选框**，然后输入需要存储 ELB 访问日志的**存储桶的名称**。例如，下面屏幕截图中的存储桶名称是 mys3abcd。
> - 选中**``为我创建此位置``**的复选框，以在与 ELB 相同的区域中**创建 S3 存储桶**。
> - 如果您收到有关存储桶名称**不可用的错误**，请使用**其他的唯一名称**。
> - 最后，点击**保存**。

image::/图片/23图片/ELB日志.png[ELB日志]

> - 导航到 S3 控制台。在那里，您将能够**看到创建的新存储桶**。

image::/图片/23图片/s3.png[s3]

---

=== 测试负载均衡器和存储访问日志


> - 接下来，**导航到**左侧面板中**负载平衡**下的**负载均衡器**
> - 并注意到 ELB 的状态为**活动**状态。
> - 复制 ELB 的 **DNS 名称**，然后在浏览器中**输入地址**。
> * 域名解析示例：``Web-server-LB-1864218804.us-east-1.elb.amazonaws.com``

image::/图片/23图片/ELBDNS.png[ELBDNS]


> - 刷新**浏览器几次**，即您将看到以下**两个响应之一**：
> * Response coming from server A
> * Response coming from server B
> ** 注意：这意味着负载通过应用程序负载均衡器在两个 Web 服务器之间**共享**。
> - 导航到 S3 控制台，然后进入您创建的**用于存储 ELB 访问日志**的存储桶。您可以在 AWSLogs 文件夹下**找到访问日志**。

image::/图片/23图片/AWSLOGS.png[AWSLOGS]

> - 单击包含**负载均衡器 URL 的目录**，**查看访问日志**是否在存储桶中。您应该会看到一个**新文件夹**，如下所示：
> - 注意：创建弹性负载平衡文件夹**最多可能需要 5 分钟**。

image::/图片/23图片/ELBlog.png[ELBlog]

> - 您可以将**生成的访问日志文件**（.zip文件）**下载到本地计算机**进行查看。
> - 日志文件将存在于**层次结构**中，**如下所示**：
> * （Bucket_name） / AWSLogs / （Account_number） / elasticloadbalancing / us-east-1 / （年） / （月） / （日） / （日志文件）
> - 选择文件，然后单击上面的"操作"按钮，然后**选择"下载"**。
> - 提取**下载文件**。
> - 您的日志文件条目将**类似于下面的代码段**


image::/图片/23图片/log.png[log]


> - 注意：生成的日志文件**包含以下内容**：
> * 访问负载均衡器的**时间戳** （2022-03-19T10:06:40.410292Z）
> * 负载平衡器的**名称** （ Web-server-LB ）
> * 客户端 **IP 地址**（ 203.175.13.56 ）
> * 负载均衡器的 **DNS 名称** （ web-server-lb-1864218804.us-east-1.elb.amazonaws.com ）
> * **浏览器名称** （ Edg ）


---

